<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- Vectorise a modules type and class declarations.</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- This produces new type constructors and family instances top be included in the module toplevel</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- as well as bindings for worker functions, dfuns, and the like.</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Vectorise.Type.Env</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>  </span><a href="Vectorise.Type.Env.html#vectTypeEnv"><span class="hs-identifier hs-var">vectTypeEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Env.html"><span class="hs-identifier">Vectorise.Env</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Vect.html"><span class="hs-identifier">Vectorise.Vect</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Monad.html"><span class="hs-identifier">Vectorise.Monad</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Builtins.html"><span class="hs-identifier">Vectorise.Builtins</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Type.TyConDecl.html"><span class="hs-identifier">Vectorise.Type.TyConDecl</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Type.Classify.html"><span class="hs-identifier">Vectorise.Type.Classify</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Generic.PADict.html"><span class="hs-identifier">Vectorise.Generic.PADict</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Generic.PAMethods.html"><span class="hs-identifier">Vectorise.Generic.PAMethods</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Generic.PData.html"><span class="hs-identifier">Vectorise.Generic.PData</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Generic.Description.html"><span class="hs-identifier">Vectorise.Generic.Description</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Vectorise.Utils.html"><span class="hs-identifier">Vectorise.Utils</span></a><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUnfold.html"><span class="hs-identifier">CoreUnfold</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="MkId.html"><span class="hs-identifier">MkId</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="NameEnv.html"><span class="hs-identifier">NameEnv</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="OccName.html"><span class="hs-identifier">OccName</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="MonadUtils.html"><span class="hs-identifier">MonadUtils</span></a><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data.List</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-- Note [Pragmas to vectorise tycons]</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-57"></a><span class="hs-comment">--</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- All imported type constructors that are not mapped to a vectorised type in the vectorisation map</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- (possibly because the defining module was not compiled with vectorisation) may be used in scalar</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- code encapsulated in vectorised code. If a such a type constructor 'T' is a member of the</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- 'Scalar' class (and hence also of 'PData' and 'PRepr'), it may also be used in vectorised code,</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- where 'T' represents itself, but the representation of 'T' still remains opaque in vectorised</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- code (i.e., it can only be used in scalar code).</span><span>
</span><a name="line-64"></a><span class="hs-comment">--</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- An example is the treatment of 'Int'. 'Int's can be used in vectorised code and remain unchanged</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- by vectorisation.  However, the representation of 'Int' by the 'I#' data constructor wrapping an</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- 'Int#' is not exposed in vectorised code. Instead, computations involving the representation need</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- to be confined to scalar code.</span><span>
</span><a name="line-69"></a><span class="hs-comment">--</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- VECTORISE pragmas for type constructors cover four different flavours of vectorising data type</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- constructors:</span><span>
</span><a name="line-72"></a><span class="hs-comment">--</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- (1) Data type constructor 'T' that together with its constructors 'Cn' may be used in vectorised</span><span>
</span><a name="line-74"></a><span class="hs-comment">--     code, where 'T' and the 'Cn' are automatically vectorised in the same manner as data types</span><span>
</span><a name="line-75"></a><span class="hs-comment">--     declared in a vectorised module.  This includes the case where the vectoriser determines that</span><span>
</span><a name="line-76"></a><span class="hs-comment">--     the original representation of 'T' may be used in vectorised code (as it does not embed any</span><span>
</span><a name="line-77"></a><span class="hs-comment">--     parallel arrays.)  This case is for type constructors that are *imported* from a non-</span><span>
</span><a name="line-78"></a><span class="hs-comment">--     vectorised module, but that we want to use with full vectorisation support.</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">--     An example is the treatment of 'Ordering' and '[]'.  The former remains unchanged by</span><span>
</span><a name="line-81"></a><span class="hs-comment">--     vectorisation, whereas the latter is fully vectorised.</span><span>
</span><a name="line-82"></a><span class="hs-comment">--</span><span>
</span><a name="line-83"></a><span class="hs-comment">--     'PData' and 'PRepr' instances are automatically generated by the vectoriser.</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">--     Type constructors declared with {-# VECTORISE type T #-} are treated in this manner.</span><span>
</span><a name="line-86"></a><span class="hs-comment">--</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- (2) Data type constructor 'T' that may be used in vectorised code, where 'T' is represented by an</span><span>
</span><a name="line-88"></a><span class="hs-comment">--     explicitly given 'Tv', but the representation of 'T' is opaque in vectorised code (i.e., the</span><span>
</span><a name="line-89"></a><span class="hs-comment">--     constructors of 'T' may not occur in vectorised code).</span><span>
</span><a name="line-90"></a><span class="hs-comment">--</span><span>
</span><a name="line-91"></a><span class="hs-comment">--     An example is the treatment of '[::]'. The type '[::]' can be used in vectorised code and is</span><span>
</span><a name="line-92"></a><span class="hs-comment">--     vectorised to 'PArray'. However, the representation of '[::]' is not exposed in vectorised</span><span>
</span><a name="line-93"></a><span class="hs-comment">--     code. Instead, computations involving the representation need to be confined to scalar code.</span><span>
</span><a name="line-94"></a><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span class="hs-comment">--     'PData' and 'PRepr' instances need to be explicitly supplied for 'T' (they are not generated</span><span>
</span><a name="line-96"></a><span class="hs-comment">--     by the vectoriser).</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-comment">--     Type constructors declared with {-# VECTORISE type T = Tv #-} are treated in this manner</span><span>
</span><a name="line-99"></a><span class="hs-comment">--     manner. (The vectoriser never treats a type constructor automatically in this manner.)</span><span>
</span><a name="line-100"></a><span class="hs-comment">--</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- (3) Data type constructor 'T' that does not contain any parallel arrays and has explicitly</span><span>
</span><a name="line-102"></a><span class="hs-comment">--     provided 'PData' and 'PRepr' instances (and maybe also a 'Scalar' instance), which together</span><span>
</span><a name="line-103"></a><span class="hs-comment">--     with the type's constructors 'Cn' may be used in vectorised code. The type 'T' and its</span><span>
</span><a name="line-104"></a><span class="hs-comment">--     constructors 'Cn' are represented by themselves in vectorised code.</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-comment">--     An example is 'Bool', which is represented by itself in vectorised code (as it cannot embed</span><span>
</span><a name="line-107"></a><span class="hs-comment">--     any parallel arrays).  However, we do not want any automatic generation of class and family</span><span>
</span><a name="line-108"></a><span class="hs-comment">--     instances, which is why Case (1) does not apply.</span><span>
</span><a name="line-109"></a><span class="hs-comment">--</span><span>
</span><a name="line-110"></a><span class="hs-comment">--     'PData' and 'PRepr' instances need to be explicitly supplied for 'T' (they are not generated</span><span>
</span><a name="line-111"></a><span class="hs-comment">--     by the vectoriser).</span><span>
</span><a name="line-112"></a><span class="hs-comment">--</span><span>
</span><a name="line-113"></a><span class="hs-comment">--     Type constructors declared with {-# VECTORISE SCALAR type T #-} are treated in this manner.</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- (4) Data type constructor 'T' that does not contain any parallel arrays and that, in vectorised</span><span>
</span><a name="line-116"></a><span class="hs-comment">--     code, is represented by an explicitly given 'Tv', but the representation of 'T' is opaque in</span><span>
</span><a name="line-117"></a><span class="hs-comment">--     vectorised code and 'T' is regarded to be scalar &#8212; i.e., it may be used in encapsulated</span><span>
</span><a name="line-118"></a><span class="hs-comment">--     scalar subcomputations.</span><span>
</span><a name="line-119"></a><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span class="hs-comment">--     An example is the treatment of '(-&gt;)'. Types '(-&gt;)' can be used in vectorised code and are</span><span>
</span><a name="line-121"></a><span class="hs-comment">--     vectorised to '(:-&gt;)'.  However, the representation of '(-&gt;)' is not exposed in vectorised</span><span>
</span><a name="line-122"></a><span class="hs-comment">--     code. Instead, computations involving the representation need to be confined to scalar code</span><span>
</span><a name="line-123"></a><span class="hs-comment">--     and may be part of encapsulated scalar computations.</span><span>
</span><a name="line-124"></a><span class="hs-comment">--</span><span>
</span><a name="line-125"></a><span class="hs-comment">--     'PData' and 'PRepr' instances need to be explicitly supplied for 'T' (they are not generated</span><span>
</span><a name="line-126"></a><span class="hs-comment">--     by the vectoriser).</span><span>
</span><a name="line-127"></a><span class="hs-comment">--</span><span>
</span><a name="line-128"></a><span class="hs-comment">--     Type constructors declared with {-# VECTORISE SCALAR type T = Tv #-} are treated in this</span><span>
</span><a name="line-129"></a><span class="hs-comment">--     manner. (The vectoriser never treats a type constructor automatically in this manner.)</span><span>
</span><a name="line-130"></a><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- In addition, we have also got a single pragma form for type classes: {-# VECTORISE class C #-}.</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- It implies that the class type constructor may be used in vectorised code together with its data</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- constructor.  We generally produce a vectorised version of the data type and data constructor.</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- We do not generate 'PData' and 'PRepr' instances for class type constructors.  This pragma is the</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- default for all type classes declared in a vectorised module, but the pragma can also be used</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- explitly on imported classes.</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- Note [Vectorising classes]</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-140"></a><span class="hs-comment">--</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- We vectorise classes essentially by just vectorising their desugared Core representation, but we</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- do generate a 'Class' structure along the way (see 'Vectorise.Type.TyConDecl.vectTyConDecl').</span><span>
</span><a name="line-143"></a><span class="hs-comment">--</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- Here is an example illustrating the mapping &#8212; assume</span><span>
</span><a name="line-145"></a><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span class="hs-comment">--   class Num a where</span><span>
</span><a name="line-147"></a><span class="hs-comment">--     (+) :: a -&gt; a -&gt; a</span><span>
</span><a name="line-148"></a><span class="hs-comment">--</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- It desugars to</span><span>
</span><a name="line-150"></a><span class="hs-comment">--</span><span>
</span><a name="line-151"></a><span class="hs-comment">--   data Num a = D:Num { (+) :: a -&gt; a -&gt; a }</span><span>
</span><a name="line-152"></a><span class="hs-comment">--</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- which we vectorise to</span><span>
</span><a name="line-154"></a><span class="hs-comment">--</span><span>
</span><a name="line-155"></a><span class="hs-comment">--  data V:Num a = D:V:Num { ($v+) :: PArray a :-&gt; PArray a :-&gt; PArray a }</span><span>
</span><a name="line-156"></a><span class="hs-comment">--</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- while adding the following entries to the vectorisation map:</span><span>
</span><a name="line-158"></a><span class="hs-comment">--</span><span>
</span><a name="line-159"></a><span class="hs-comment">--   tycon  : Num   --&gt; V:Num</span><span>
</span><a name="line-160"></a><span class="hs-comment">--   datacon: D:Num --&gt; D:V:Num</span><span>
</span><a name="line-161"></a><span class="hs-comment">--   var    : (+) --&gt; ($v+)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- |Vectorise type constructor including class type constructors.</span><span>
</span><a name="line-164"></a><span class="hs-comment">--</span><span>
</span><a name="line-165"></a><span class="hs-identifier">vectTypeEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">]</span><span>                   </span><span class="hs-comment">-- Type constructors defined in this module</span><span>
</span><a name="line-166"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- All 'VECTORISE [SCALAR] type' declarations in this module</span><span>
</span><a name="line-167"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- All 'VECTORISE class' declarations in this module</span><span>
</span><a name="line-168"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- old TyCons ++ new TyCons</span><span>
</span><a name="line-169"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- New type family instances.</span><span>
</span><a name="line-170"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- New top level bindings.</span><span>
</span><a name="line-171"></a><a name="vectTypeEnv"><a href="Vectorise.Type.Env.html#vectTypeEnv"><span class="hs-identifier">vectTypeEnv</span></a></a><span> </span><a name="local-6989586621680338554"><a href="#local-6989586621680338554"><span class="hs-identifier">tycons</span></a></a><span> </span><a name="local-6989586621680338555"><a href="#local-6989586621680338555"><span class="hs-identifier">vectTypeDecls</span></a></a><span> </span><a name="local-6989586621680338556"><a href="#local-6989586621680338556"><span class="hs-identifier">vectClassDecls</span></a></a><span>
</span><a name="line-172"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;** vectTypeEnv&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338554"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-comment">-- {-# VECTORISE type T -#} (ONLY the imported tycons)</span><span>
</span><a name="line-175"></a><span>             </span><a name="local-6989586621680338573"><a href="#local-6989586621680338573"><span class="hs-identifier">impVectTyCons</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span>   </span><span class="hs-special">[</span><a href="#local-6989586621680338579"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621680338579"><a href="#local-6989586621680338579"><span class="hs-identifier">tycon</span></a></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338555"><span class="hs-identifier hs-var">vectTypeDecls</span></a><span class="hs-special">]</span><span>
</span><a name="line-176"></a><span>                                       </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680338580"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#VectClass"><span class="hs-identifier hs-var">VectClass</span></a><span> </span><a name="local-6989586621680338580"><a href="#local-6989586621680338580"><span class="hs-identifier">tycon</span></a></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338556"><span class="hs-identifier hs-var">vectClassDecls</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>                                      </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a><span> </span><a href="#local-6989586621680338554"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>               </span><span class="hs-comment">-- {-# VECTORISE type T = Tv -#} (imported &amp; local tycons with an /RHS/)</span><span>
</span><a name="line-180"></a><span>             </span><a name="local-6989586621680338574"><a href="#local-6989586621680338574"><span class="hs-identifier">vectTyConsWithRHS</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338581"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338582"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>                                      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621680338581"><a href="#local-6989586621680338581"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680338582"><a href="#local-6989586621680338582"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338555"><span class="hs-identifier hs-var">vectTypeDecls</span></a><span class="hs-special">]</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>               </span><span class="hs-comment">-- {-# VECTORISE SCALAR type T = Tv -#} (imported &amp; local tycons with an /RHS/)</span><span>
</span><a name="line-184"></a><span>             </span><a name="local-6989586621680338575"><a href="#local-6989586621680338575"><span class="hs-identifier">scalarTyConsWithRHS</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338583"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338584"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>                                      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a name="local-6989586621680338583"><a href="#local-6989586621680338583"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680338584"><a href="#local-6989586621680338584"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338555"><span class="hs-identifier hs-var">vectTypeDecls</span></a><span class="hs-special">]</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>               </span><span class="hs-comment">-- {-# VECTORISE SCALAR type T -#} (imported &amp; local /scalar/ tycons without an RHS)</span><span>
</span><a name="line-188"></a><span>             </span><a name="local-6989586621680338576"><a href="#local-6989586621680338576"><span class="hs-identifier">scalarTyConsNoRHS</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680338585"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621680338585"><a href="#local-6989586621680338585"><span class="hs-identifier">tycon</span></a></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338555"><span class="hs-identifier hs-var">vectTypeDecls</span></a><span class="hs-special">]</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span>               </span><span class="hs-comment">-- Check that is not a VECTORISE SCALAR tycon nor VECTORISE tycons with explicit rhs?</span><span>
</span><a name="line-191"></a><span>             </span><a name="local-6989586621680338577"><a href="#local-6989586621680338577"><span class="hs-identifier">vectSpecialTyConNames</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#mkNameSet"><span class="hs-identifier hs-var">mkNameSet</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-192"></a><span>                                        </span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-193"></a><span>                                        </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338574"><span class="hs-identifier hs-var">vectTyConsWithRHS</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338575"><span class="hs-identifier hs-var">scalarTyConsWithRHS</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>             </span><a name="local-6989586621680338578"><a href="#local-6989586621680338578"><span class="hs-identifier">notVectSpecialTyCon</span></a></a><span> </span><a name="local-6989586621680338586"><a href="#local-6989586621680338586"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680338586"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="NameSet.html#elemNameSet"><span class="hs-identifier hs-var">elemNameSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680338577"><span class="hs-identifier hs-var">vectSpecialTyConNames</span></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>         </span><span class="hs-comment">-- Build a map containing all vectorised type constructor. If the vectorised type</span><span>
</span><a name="line-197"></a><span>         </span><span class="hs-comment">-- constructor differs from the original one, then it is mapped to 'True'; if they are</span><span>
</span><a name="line-198"></a><span>         </span><span class="hs-comment">-- both the same, then it maps to 'False'.</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338587"><a href="#local-6989586621680338587"><span class="hs-identifier">vectTyCons</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Global.html#globalVectTyCons"><span class="hs-identifier hs-var">globalVectTyCons</span></a><span>
</span><a name="line-200"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338588"><a href="#local-6989586621680338588"><span class="hs-identifier">vectTyConBase</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#mapUFM_Directly"><span class="hs-identifier hs-var">mapUFM_Directly</span></a><span> </span><a href="#local-6989586621680338589"><span class="hs-identifier hs-var">isDistinct</span></a><span> </span><a href="#local-6989586621680338587"><span class="hs-identifier hs-var">vectTyCons</span></a><span>    </span><span class="hs-comment">-- 'True' iff tc /= V[[tc]]</span><span>
</span><a name="line-201"></a><span>             </span><a name="local-6989586621680338589"><a href="#local-6989586621680338589"><span class="hs-identifier">isDistinct</span></a></a><span> </span><a name="local-6989586621680338591"><a href="#local-6989586621680338591"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621680338592"><a href="#local-6989586621680338592"><span class="hs-identifier">tc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680338591"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a><span> </span><a href="#local-6989586621680338592"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-202"></a><span>             </span><a name="local-6989586621680338590"><a href="#local-6989586621680338590"><span class="hs-identifier">vectTyConFlavour</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680338588"><span class="hs-identifier hs-var">vectTyConBase</span></a><span>
</span><a name="line-203"></a><span>                                </span><span class="hs-special">`</span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span class="hs-special">`</span><span>
</span><a name="line-204"></a><span>                                </span><a href="NameEnv.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680338593"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>                                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680338593"><a href="#local-6989586621680338593"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338574"><span class="hs-identifier hs-var">vectTyConsWithRHS</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338575"><span class="hs-identifier hs-var">scalarTyConsWithRHS</span></a><span class="hs-special">]</span><span>
</span><a name="line-206"></a><span>                                </span><span class="hs-special">`</span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span class="hs-special">`</span><span>
</span><a name="line-207"></a><span>                                </span><a href="NameEnv.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680338594"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- original representation</span><span>
</span><a name="line-208"></a><span>                                          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680338594"><a href="#local-6989586621680338594"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span class="hs-special">]</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span>           </span><span class="hs-comment">-- Split the list of 'TyCons' into the ones (1) that we must vectorise and those (2)</span><span>
</span><a name="line-212"></a><span>           </span><span class="hs-comment">-- that we could, but don't need to vectorise.  Type constructors that are not data</span><span>
</span><a name="line-213"></a><span>           </span><span class="hs-comment">-- type constructors or use non-Haskell98 features are being dropped.  They may not</span><span>
</span><a name="line-214"></a><span>           </span><span class="hs-comment">-- appear in vectorised code.  (We also drop the local type constructors appearing in a</span><span>
</span><a name="line-215"></a><span>           </span><span class="hs-comment">-- VECTORISE SCALAR pragma or a VECTORISE pragma with an explicit right-hand side, as</span><span>
</span><a name="line-216"></a><span>           </span><span class="hs-comment">-- these are being handled separately.  NB: Some type constructors may be marked SCALAR</span><span>
</span><a name="line-217"></a><span>           </span><span class="hs-comment">-- /and/ have an explicit right-hand side.)</span><span>
</span><a name="line-218"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-219"></a><span>           </span><span class="hs-comment">-- Furthermore, 'par_tcs' are those type constructors (converted or not) whose</span><span>
</span><a name="line-220"></a><span>           </span><span class="hs-comment">-- definition, directly or indirectly, depends on parallel arrays. Finally, 'drop_tcs'</span><span>
</span><a name="line-221"></a><span>           </span><span class="hs-comment">-- are all type constructors that cannot be vectorised.</span><span>
</span><a name="line-222"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338595"><a href="#local-6989586621680338595"><span class="hs-identifier">parallelTyCons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="NameSet.html#extendNameSetList"><span class="hs-identifier hs-var">extendNameSetList</span></a><span class="hs-special">`</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680338574"><span class="hs-identifier hs-var">vectTyConsWithRHS</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-223"></a><span>                             </span><a href="Vectorise.Monad.Global.html#globalParallelTyCons"><span class="hs-identifier hs-var">globalParallelTyCons</span></a><span>
</span><a name="line-224"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338596"><a href="#local-6989586621680338596"><span class="hs-identifier">maybeVectoriseTyCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="#local-6989586621680338578"><span class="hs-identifier hs-var">notVectSpecialTyCon</span></a><span> </span><a href="#local-6989586621680338554"><span class="hs-identifier hs-var">tycons</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338573"><span class="hs-identifier hs-var">impVectTyCons</span></a><span>
</span><a name="line-225"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621680338597"><a href="#local-6989586621680338597"><span class="hs-identifier">conv_tcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680338598"><a href="#local-6989586621680338598"><span class="hs-identifier">keep_tcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680338599"><a href="#local-6989586621680338599"><span class="hs-identifier">par_tcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680338600"><a href="#local-6989586621680338600"><span class="hs-identifier">drop_tcs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="Vectorise.Type.Classify.html#classifyTyCons"><span class="hs-identifier hs-var">classifyTyCons</span></a><span> </span><a href="#local-6989586621680338590"><span class="hs-identifier hs-var">vectTyConFlavour</span></a><span> </span><a href="#local-6989586621680338595"><span class="hs-identifier hs-var">parallelTyCons</span></a><span> </span><a href="#local-6989586621680338596"><span class="hs-identifier hs-var">maybeVectoriseTyCons</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; known parallel : &quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338595"><span class="hs-identifier hs-var">parallelTyCons</span></a><span>
</span><a name="line-229"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; VECT SCALAR    : &quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621680338575"><span class="hs-identifier hs-var">scalarTyConsWithRHS</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; VECT [class]   : &quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338573"><span class="hs-identifier hs-var">impVectTyCons</span></a><span>
</span><a name="line-231"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; VECT with rhs  : &quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338574"><span class="hs-identifier hs-var">vectTyConsWithRHS</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338575"><span class="hs-identifier hs-var">scalarTyConsWithRHS</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; -- after classification (local and VECT [class] tycons) --&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable.empty</span></a><span>
</span><a name="line-233"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; reuse          : &quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338598"><span class="hs-identifier hs-var">keep_tcs</span></a><span>
</span><a name="line-234"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot; convert        : &quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338597"><span class="hs-identifier hs-var">conv_tcs</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>           </span><span class="hs-comment">-- warn the user about unvectorised type constructors</span><span>
</span><a name="line-237"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338601"><a href="#local-6989586621680338601"><span class="hs-identifier">explanation</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(They use unsupported language extensions&quot;</span><span>
</span><a name="line-238"></a><span>                          </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;or depend on type constructors that are&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-239"></a><span>                              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;not vectorised)&quot;</span><span>
</span><a name="line-240"></a><span>             </span><a name="local-6989586621680338602"><a href="#local-6989586621680338602"><span class="hs-identifier">drop_tcs_nosyn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span>
</span><a name="line-241"></a><span>                              </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680338600"><span class="hs-identifier hs-var">drop_tcs</span></a><span>
</span><a name="line-242"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680338602"><span class="hs-identifier hs-var">drop_tcs_nosyn</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-243"></a><span>           </span><a href="Vectorise.Monad.Base.html#emitVt"><span class="hs-identifier hs-var">emitVt</span></a><span> </span><span class="hs-string">&quot;Warning: cannot vectorise these type constructors:&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-244"></a><span>             </span><a href="Outputable.html#pprQuotedList"><span class="hs-identifier hs-var">pprQuotedList</span></a><span> </span><a href="#local-6989586621680338602"><span class="hs-identifier hs-var">drop_tcs_nosyn</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-6989586621680338601"><span class="hs-identifier hs-var">explanation</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680338557"><span class="hs-identifier hs-var">addParallelTyConAndCons</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680338599"><span class="hs-identifier hs-var">par_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-6989586621680338574"><span class="hs-identifier hs-var">vectTyConsWithRHS</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338603"><a href="#local-6989586621680338603"><span class="hs-identifier">mapping</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-249"></a><span>                    </span><span class="hs-comment">-- Type constructors that we found we don't need to vectorise and those</span><span>
</span><a name="line-250"></a><span>                    </span><span class="hs-comment">-- declared VECTORISE SCALAR /without/ an explicit right-hand side, use the same</span><span>
</span><a name="line-251"></a><span>                    </span><span class="hs-comment">-- representation in both unvectorised and vectorised code; they are not</span><span>
</span><a name="line-252"></a><span>                    </span><span class="hs-comment">-- abstract.</span><span>
</span><a name="line-253"></a><span>                  </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680338604"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338604"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680338604"><a href="#local-6989586621680338604"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338598"><span class="hs-identifier hs-var">keep_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span class="hs-special">]</span><span>
</span><a name="line-254"></a><span>                    </span><span class="hs-comment">-- We do the same for type constructors declared VECTORISE SCALAR /without/</span><span>
</span><a name="line-255"></a><span>                    </span><span class="hs-comment">-- an explicit right-hand side</span><span>
</span><a name="line-256"></a><span>               </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680338605"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338606"><span class="hs-identifier hs-var">vTycon</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680338605"><a href="#local-6989586621680338605"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680338606"><a href="#local-6989586621680338606"><span class="hs-identifier">vTycon</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338574"><span class="hs-identifier hs-var">vectTyConsWithRHS</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338575"><span class="hs-identifier hs-var">scalarTyConsWithRHS</span></a><span class="hs-special">]</span><span>
</span><a name="line-257"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338607"><a href="#local-6989586621680338607"><span class="hs-identifier">syn_tcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-6989586621680338558"><span class="hs-identifier hs-var">defTyConDataCons</span></a><span> </span><a href="#local-6989586621680338603"><span class="hs-identifier hs-var">mapping</span></a><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span>           </span><span class="hs-comment">-- Vectorise all the data type declarations that we can and must vectorise (enter the</span><span>
</span><a name="line-260"></a><span>           </span><span class="hs-comment">-- type and data constructors into the vectorisation map on-the-fly.)</span><span>
</span><a name="line-261"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338608"><a href="#local-6989586621680338608"><span class="hs-identifier">new_tcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Type.TyConDecl.html#vectTyConDecls"><span class="hs-identifier hs-var">vectTyConDecls</span></a><span> </span><a href="#local-6989586621680338597"><span class="hs-identifier hs-var">conv_tcs</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338609"><a href="#local-6989586621680338609"><span class="hs-identifier">dumpTc</span></a></a><span> </span><a name="local-6989586621680338611"><a href="#local-6989586621680338611"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680338612"><a href="#local-6989586621680338612"><span class="hs-identifier">vTc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;---&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338611"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338610"><span class="hs-identifier hs-var">dataConSig</span></a><span> </span><a href="#local-6989586621680338611"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-264"></a><span>                                            </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338612"><span class="hs-identifier hs-var">vTc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338610"><span class="hs-identifier hs-var">dataConSig</span></a><span> </span><a href="#local-6989586621680338612"><span class="hs-identifier hs-var">vTc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>             </span><a name="local-6989586621680338610"><a href="#local-6989586621680338610"><span class="hs-identifier">dataConSig</span></a></a><span> </span><a name="local-6989586621680338613"><a href="#local-6989586621680338613"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680338614"><a href="#local-6989586621680338614"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConSingleDataCon_maybe"><span class="hs-identifier hs-var">tyConSingleDataCon_maybe</span></a><span> </span><a href="#local-6989586621680338613"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConRepType"><span class="hs-identifier hs-var">dataConRepType</span></a><span> </span><a href="#local-6989586621680338614"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-266"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;dataConSig&quot;</span><span>
</span><a name="line-267"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM_"><span class="hs-identifier hs-var">zipWithM_</span></a><span> </span><a href="#local-6989586621680338609"><span class="hs-identifier hs-var">dumpTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span> </span><a href="#local-6989586621680338597"><span class="hs-identifier hs-var">conv_tcs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span> </span><a href="#local-6989586621680338608"><span class="hs-identifier hs-var">new_tcs</span></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span>           </span><span class="hs-comment">-- We don't need new representation types for dictionary constructors. The constructors</span><span>
</span><a name="line-270"></a><span>           </span><span class="hs-comment">-- are always fully applied, and we don't need to lift them to arrays as a dictionary</span><span>
</span><a name="line-271"></a><span>           </span><span class="hs-comment">-- of a particular type always has the same value.</span><span>
</span><a name="line-272"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338615"><a href="#local-6989586621680338615"><span class="hs-identifier">orig_tcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680338598"><span class="hs-identifier hs-var">keep_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338597"><span class="hs-identifier hs-var">conv_tcs</span></a><span>
</span><a name="line-273"></a><span>             </span><a name="local-6989586621680338616"><a href="#local-6989586621680338616"><span class="hs-identifier">vect_tcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680338598"><span class="hs-identifier hs-var">keep_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338608"><span class="hs-identifier hs-var">new_tcs</span></a><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span>           </span><span class="hs-comment">-- Build 'PRepr' and 'PData' instance type constructors and family instances for all</span><span>
</span><a name="line-276"></a><span>           </span><span class="hs-comment">-- type constructors with vectorised representations.</span><span>
</span><a name="line-277"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338617"><a href="#local-6989586621680338617"><span class="hs-identifier">reprs</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.Generic.Description.html#tyConRepr"><span class="hs-identifier hs-var">tyConRepr</span></a><span> </span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span>
</span><a name="line-278"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338618"><a href="#local-6989586621680338618"><span class="hs-identifier">repr_fis</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a><span> </span><a href="Vectorise.Generic.PAMethods.html#buildPReprTyCon"><span class="hs-identifier hs-var">buildPReprTyCon</span></a><span>  </span><a href="#local-6989586621680338615"><span class="hs-identifier hs-var">orig_tcs</span></a><span> </span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span> </span><a href="#local-6989586621680338617"><span class="hs-identifier hs-var">reprs</span></a><span>
</span><a name="line-279"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338619"><a href="#local-6989586621680338619"><span class="hs-identifier">pdata_fis</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a><span> </span><a href="Vectorise.Generic.PData.html#buildPDataTyCon"><span class="hs-identifier hs-var">buildPDataTyCon</span></a><span>  </span><a href="#local-6989586621680338615"><span class="hs-identifier hs-var">orig_tcs</span></a><span> </span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span> </span><a href="#local-6989586621680338617"><span class="hs-identifier hs-var">reprs</span></a><span>
</span><a name="line-280"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338620"><a href="#local-6989586621680338620"><span class="hs-identifier">pdatas_fis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a><span> </span><a href="Vectorise.Generic.PData.html#buildPDatasTyCon"><span class="hs-identifier hs-var">buildPDatasTyCon</span></a><span> </span><a href="#local-6989586621680338615"><span class="hs-identifier hs-var">orig_tcs</span></a><span> </span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span> </span><a href="#local-6989586621680338617"><span class="hs-identifier hs-var">reprs</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338621"><a href="#local-6989586621680338621"><span class="hs-identifier">fam_insts</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680338618"><span class="hs-identifier hs-var">repr_fis</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338619"><span class="hs-identifier hs-var">pdata_fis</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338620"><span class="hs-identifier hs-var">pdatas_fis</span></a><span>
</span><a name="line-283"></a><span>             </span><a name="local-6989586621680338622"><a href="#local-6989586621680338622"><span class="hs-identifier">repr_axs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a><span> </span><a href="#local-6989586621680338618"><span class="hs-identifier hs-var">repr_fis</span></a><span>
</span><a name="line-284"></a><span>             </span><a name="local-6989586621680338623"><a href="#local-6989586621680338623"><span class="hs-identifier">pdata_tcs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier hs-var">famInstsRepTyCons</span></a><span> </span><a href="#local-6989586621680338619"><span class="hs-identifier hs-var">pdata_fis</span></a><span>
</span><a name="line-285"></a><span>             </span><a name="local-6989586621680338624"><a href="#local-6989586621680338624"><span class="hs-identifier">pdatas_tcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier hs-var">famInstsRepTyCons</span></a><span> </span><a href="#local-6989586621680338620"><span class="hs-identifier hs-var">pdatas_fis</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Global.html#updGEnv"><span class="hs-identifier hs-var">updGEnv</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Vectorise.Env.html#extendFamEnv"><span class="hs-identifier hs-var">extendFamEnv</span></a><span> </span><a href="#local-6989586621680338621"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span>           </span><span class="hs-comment">-- Generate workers for the vectorised data constructors, dfuns for the 'PA' instances of</span><span>
</span><a name="line-290"></a><span>           </span><span class="hs-comment">-- the vectorised type constructors, and associate the type constructors with their dfuns</span><span>
</span><a name="line-291"></a><span>           </span><span class="hs-comment">-- in the global environment.  We get back the dfun bindings (which we will subsequently</span><span>
</span><a name="line-292"></a><span>           </span><span class="hs-comment">-- inject into the modules toplevel).</span><span>
</span><a name="line-293"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680338629"><a href="#local-6989586621680338629"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Base.html#fixV"><span class="hs-identifier hs-var">fixV</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><a name="local-6989586621680338625"><a href="#local-6989586621680338625"><span class="hs-identifier">dfuns</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-294"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Global.html#defTyConPAs"><span class="hs-identifier hs-var">defTyConPAs</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#zipLazy"><span class="hs-identifier hs-var">zipLazy</span></a><span> </span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span> </span><a href="#local-6989586621680338625"><span class="hs-identifier hs-var">dfuns</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>                  </span><span class="hs-comment">-- Query the 'PData' instance type constructors for type constructors that have a</span><span>
</span><a name="line-297"></a><span>                  </span><span class="hs-comment">-- VECTORISE SCALAR type pragma without an explicit right-hand side (this is Item</span><span>
</span><a name="line-298"></a><span>                  </span><span class="hs-comment">--  (3) of &quot;Note [Pragmas to vectorise tycons]&quot; above).</span><span>
</span><a name="line-299"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338626"><a href="#local-6989586621680338626"><span class="hs-identifier">pdata_scalar_tcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.Utils.Base.html#pdataReprTyConExact"><span class="hs-identifier hs-var">pdataReprTyConExact</span></a><span> </span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>                  </span><span class="hs-comment">-- Build workers for all vectorised data constructors (except abstract ones)</span><span>
</span><a name="line-302"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#sequence_"><span class="hs-identifier hs-var">sequence_</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-303"></a><span>                  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><a href="Vectorise.Type.Env.html#vectDataConWorkers"><span class="hs-identifier hs-var">vectDataConWorkers</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338615"><span class="hs-identifier hs-var">orig_tcs</span></a><span>  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>                                              </span><span class="hs-special">(</span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span>  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338576"><span class="hs-identifier hs-var">scalarTyConsNoRHS</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>                                              </span><span class="hs-special">(</span><a href="#local-6989586621680338623"><span class="hs-identifier hs-var">pdata_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338626"><span class="hs-identifier hs-var">pdata_scalar_tcs</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>                  </span><span class="hs-comment">-- Build a 'PA' dictionary for all type constructors (except abstract ones &amp; those</span><span>
</span><a name="line-308"></a><span>                  </span><span class="hs-comment">-- defined with an explicit right-hand side where the dictionary is user-supplied)</span><span>
</span><a name="line-309"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338627"><a href="#local-6989586621680338627"><span class="hs-identifier">dfuns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#sequence"><span class="hs-identifier hs-var">sequence</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-310"></a><span>                           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#zipWith4"><span class="hs-identifier hs-var">zipWith4</span></a><span> </span><a href="Vectorise.Type.Env.html#buildTyConPADict"><span class="hs-identifier hs-var">buildTyConPADict</span></a><span>
</span><a name="line-311"></a><span>                                    </span><a href="#local-6989586621680338616"><span class="hs-identifier hs-var">vect_tcs</span></a><span>
</span><a name="line-312"></a><span>                                    </span><a href="#local-6989586621680338622"><span class="hs-identifier hs-var">repr_axs</span></a><span>
</span><a name="line-313"></a><span>                                    </span><a href="#local-6989586621680338623"><span class="hs-identifier hs-var">pdata_tcs</span></a><span>
</span><a name="line-314"></a><span>                                    </span><a href="#local-6989586621680338624"><span class="hs-identifier hs-var">pdatas_tcs</span></a><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338628"><a href="#local-6989586621680338628"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Utils.Hoisting.html#takeHoisted"><span class="hs-identifier hs-var">takeHoisted</span></a><span>
</span><a name="line-317"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338627"><span class="hs-identifier hs-var">dfuns</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338628"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>           </span><span class="hs-comment">-- Return the vectorised variants of type constructors as well as the generated instance</span><span>
</span><a name="line-321"></a><span>           </span><span class="hs-comment">-- type constructors, family instances, and dfun bindings.</span><span>
</span><a name="line-322"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680338608"><span class="hs-identifier hs-var">new_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338623"><span class="hs-identifier hs-var">pdata_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338624"><span class="hs-identifier hs-var">pdatas_tcs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338607"><span class="hs-identifier hs-var">syn_tcs</span></a><span>
</span><a name="line-323"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338621"><span class="hs-identifier hs-var">fam_insts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338629"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-325"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-326"></a><span>    </span><a name="local-6989586621680338557"><a href="#local-6989586621680338557"><span class="hs-identifier">addParallelTyConAndCons</span></a></a><span> </span><a name="local-6989586621680338559"><a href="#local-6989586621680338559"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-327"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-328"></a><span>        </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.html#addGlobalParallelTyCon"><span class="hs-identifier hs-var">addGlobalParallelTyCon</span></a><span> </span><a href="#local-6989586621680338559"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-329"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="Vectorise.Monad.html#addGlobalParallelVar"><span class="hs-identifier hs-var">addGlobalParallelVar</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680338561"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680338560"><a href="#local-6989586621680338560"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338559"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-330"></a><span>                                          </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#AnId"><span class="hs-identifier hs-var">AnId</span></a><span> </span><a name="local-6989586621680338561"><a href="#local-6989586621680338561"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataCon.html#dataConImplicitTyThings"><span class="hs-identifier hs-var">dataConImplicitTyThings</span></a><span> </span><a href="#local-6989586621680338560"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-331"></a><span>                                          </span><span class="hs-comment">-- Ignoring the promoted tycon; hope that's ok</span><span>
</span><a name="line-332"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>    </span><span class="hs-comment">-- Add a mapping from the original to vectorised type constructor to the vectorisation map.</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-comment">-- Unless the type constructor is abstract, also mappings from the original's data constructors</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-comment">-- to the vectorised type's data constructors.</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-338"></a><span>    </span><span class="hs-comment">-- We have three cases: (1) original and vectorised type constructor are the same, (2) the</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-comment">-- name of the vectorised type constructor is canonical (as prescribed by 'mkVectTyConOcc'), or</span><span>
</span><a name="line-340"></a><span>    </span><span class="hs-comment">-- (3) the name is not canonical.  In the third case, we additionally introduce a type synonym</span><span>
</span><a name="line-341"></a><span>    </span><span class="hs-comment">-- with the canonical name that is set equal to the non-canonical name (so that we find the</span><span>
</span><a name="line-342"></a><span>    </span><span class="hs-comment">-- right type constructor when reading vectorisation information from interface files).</span><span>
</span><a name="line-343"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-344"></a><span>    </span><a name="local-6989586621680338558"><a href="#local-6989586621680338558"><span class="hs-identifier">defTyConDataCons</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680338562"><a href="#local-6989586621680338562"><span class="hs-identifier">origTyCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680338563"><a href="#local-6989586621680338563"><span class="hs-identifier">vectTyCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680338564"><a href="#local-6989586621680338564"><span class="hs-identifier">isAbstract</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680338571"><a href="#local-6989586621680338571"><span class="hs-identifier">canonName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Naming.html#mkLocalisedName"><span class="hs-identifier hs-var">mkLocalisedName</span></a><span> </span><a href="OccName.html#mkVectTyConOcc"><span class="hs-identifier hs-var">mkVectTyConOcc</span></a><span> </span><a href="#local-6989586621680338565"><span class="hs-identifier hs-var">origName</span></a><span>
</span><a name="line-347"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span>    </span><a href="#local-6989586621680338565"><span class="hs-identifier hs-var">origName</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680338566"><span class="hs-identifier hs-var">vectName</span></a><span>                             </span><span class="hs-comment">-- Case (1)</span><span>
</span><a name="line-348"></a><span>             </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680338566"><span class="hs-identifier hs-var">vectName</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680338571"><span class="hs-identifier hs-var">canonName</span></a><span>                            </span><span class="hs-comment">-- Case (2)</span><span>
</span><a name="line-349"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-350"></a><span>          </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Global.html#defTyCon"><span class="hs-identifier hs-var">defTyCon</span></a><span> </span><a href="#local-6989586621680338562"><span class="hs-identifier hs-var">origTyCon</span></a><span> </span><a href="#local-6989586621680338563"><span class="hs-identifier hs-var">vectTyCon</span></a><span>                         </span><span class="hs-comment">-- T  --&gt; vT</span><span>
</span><a name="line-351"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680338568"><span class="hs-identifier hs-var">defDataCons</span></a><span>                                          </span><span class="hs-comment">-- Ci --&gt; vCi</span><span>
</span><a name="line-352"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-353"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-354"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>                                                 </span><span class="hs-comment">-- Case (3)</span><span>
</span><a name="line-355"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338572"><a href="#local-6989586621680338572"><span class="hs-identifier">synTyCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680338567"><span class="hs-identifier hs-var">mkSyn</span></a><span> </span><a href="#local-6989586621680338571"><span class="hs-identifier hs-var">canonName</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyConTy"><span class="hs-identifier hs-var">mkTyConTy</span></a><span> </span><a href="#local-6989586621680338563"><span class="hs-identifier hs-var">vectTyCon</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- type S = vT</span><span>
</span><a name="line-356"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="Vectorise.Monad.Global.html#defTyCon"><span class="hs-identifier hs-var">defTyCon</span></a><span> </span><a href="#local-6989586621680338562"><span class="hs-identifier hs-var">origTyCon</span></a><span> </span><a href="#local-6989586621680338572"><span class="hs-identifier hs-var">synTyCon</span></a><span>                           </span><span class="hs-comment">-- T  --&gt; S</span><span>
</span><a name="line-357"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680338568"><span class="hs-identifier hs-var">defDataCons</span></a><span>                                           </span><span class="hs-comment">-- Ci --&gt; vCi</span><span>
</span><a name="line-358"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621680338572"><span class="hs-identifier hs-var">synTyCon</span></a><span>
</span><a name="line-359"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-360"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-361"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-362"></a><span>        </span><a name="local-6989586621680338565"><a href="#local-6989586621680338565"><span class="hs-identifier">origName</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680338562"><span class="hs-identifier hs-var">origTyCon</span></a><span>
</span><a name="line-363"></a><span>        </span><a name="local-6989586621680338566"><a href="#local-6989586621680338566"><span class="hs-identifier">vectName</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680338563"><span class="hs-identifier hs-var">vectTyCon</span></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>        </span><a name="local-6989586621680338567"><a href="#local-6989586621680338567"><span class="hs-identifier">mkSyn</span></a></a><span> </span><a name="local-6989586621680338569"><a href="#local-6989586621680338569"><span class="hs-identifier">canonName</span></a></a><span> </span><a name="local-6989586621680338570"><a href="#local-6989586621680338570"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#buildSynTyCon"><span class="hs-identifier hs-var">buildSynTyCon</span></a><span> </span><a href="#local-6989586621680338569"><span class="hs-identifier hs-var">canonName</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680338570"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680338570"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>        </span><a name="local-6989586621680338568"><a href="#local-6989586621680338568"><span class="hs-identifier">defDataCons</span></a></a><span>
</span><a name="line-368"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680338564"><span class="hs-identifier hs-var">isAbstract</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-370"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier">tyConDataCons</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">origTyCon</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyConDataCons</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">vectTyCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM_"><span class="hs-identifier hs-var">zipWithM_</span></a><span> </span><a href="Vectorise.Monad.Global.html#defDataCon"><span class="hs-identifier hs-var">defDataCon</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338562"><span class="hs-identifier hs-var">origTyCon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338563"><span class="hs-identifier hs-var">vectTyCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-comment">-- Helpers --------------------------------------------------------------------</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-identifier">buildTyConPADict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>
</span><a name="line-378"></a><a name="buildTyConPADict"><a href="Vectorise.Type.Env.html#buildTyConPADict"><span class="hs-identifier">buildTyConPADict</span></a></a><span> </span><a name="local-6989586621680338630"><a href="#local-6989586621680338630"><span class="hs-identifier">vect_tc</span></a></a><span> </span><a name="local-6989586621680338631"><a href="#local-6989586621680338631"><span class="hs-identifier">prepr_ax</span></a></a><span> </span><a name="local-6989586621680338632"><a href="#local-6989586621680338632"><span class="hs-identifier">pdata_tc</span></a></a><span> </span><a name="local-6989586621680338633"><a href="#local-6989586621680338633"><span class="hs-identifier">pdatas_tc</span></a></a><span>
</span><a name="line-379"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Vectorise.Generic.Description.html#tyConRepr"><span class="hs-identifier hs-var">tyConRepr</span></a><span> </span><a href="#local-6989586621680338630"><span class="hs-identifier hs-var">vect_tc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="Vectorise.Generic.PADict.html#buildPADict"><span class="hs-identifier hs-var">buildPADict</span></a><span> </span><a href="#local-6989586621680338630"><span class="hs-identifier hs-var">vect_tc</span></a><span> </span><a href="#local-6989586621680338631"><span class="hs-identifier hs-var">prepr_ax</span></a><span> </span><a href="#local-6989586621680338632"><span class="hs-identifier hs-var">pdata_tc</span></a><span> </span><a href="#local-6989586621680338633"><span class="hs-identifier hs-var">pdatas_tc</span></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span class="hs-comment">-- Produce a custom-made worker for the data constructors of a vectorised data type.  This includes</span><span>
</span><a name="line-382"></a><span class="hs-comment">-- all data constructors that may be used in vectorised code &#8212; i.e., all data constructors of data</span><span>
</span><a name="line-383"></a><span class="hs-comment">-- types with 'VECTORISE [SCALAR] type' pragmas with an explicit right-hand side.  Also adds a mapping</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- from the original to vectorised worker into the vectorisation map.</span><span>
</span><a name="line-385"></a><span class="hs-comment">--</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- FIXME: It's not nice that we need create a special worker after the data constructors has</span><span>
</span><a name="line-387"></a><span class="hs-comment">--   already been constructed.  Also, I don't think the worker is properly added to the data</span><span>
</span><a name="line-388"></a><span class="hs-comment">--   constructor.  Seems messy.</span><span>
</span><a name="line-389"></a><span class="hs-identifier">vectDataConWorkers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Vectorise.Monad.Base.html#VM"><span class="hs-identifier hs-type">VM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><a name="vectDataConWorkers"><a href="Vectorise.Type.Env.html#vectDataConWorkers"><span class="hs-identifier">vectDataConWorkers</span></a></a><span> </span><a name="local-6989586621680338634"><a href="#local-6989586621680338634"><span class="hs-identifier">orig_tc</span></a></a><span> </span><a name="local-6989586621680338635"><a href="#local-6989586621680338635"><span class="hs-identifier">vect_tc</span></a></a><span> </span><a name="local-6989586621680338636"><a href="#local-6989586621680338636"><span class="hs-identifier">arr_tc</span></a></a><span>
</span><a name="line-391"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Vectorise.Monad.Base.html#traceVt"><span class="hs-identifier hs-var">traceVt</span></a><span> </span><span class="hs-string">&quot;Building vectorised worker for datatype&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680338634"><span class="hs-identifier hs-var">orig_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680338677"><a href="#local-6989586621680338677"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#sequence"><span class="hs-identifier hs-var">sequence</span></a><span>
</span><a name="line-394"></a><span>             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><a href="#local-6989586621680338649"><span class="hs-identifier hs-var">def_worker</span></a><span>  </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338634"><span class="hs-identifier hs-var">orig_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680338644"><span class="hs-identifier hs-var">rep_tys</span></a><span>
</span><a name="line-395"></a><span>             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#zipWith4"><span class="hs-identifier hs-var">zipWith4</span></a><span> </span><a href="#local-6989586621680338645"><span class="hs-identifier hs-var">mk_data_con</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338635"><span class="hs-identifier hs-var">vect_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>                                    </span><a href="#local-6989586621680338644"><span class="hs-identifier hs-var">rep_tys</span></a><span>
</span><a name="line-397"></a><span>                                    </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#inits"><span class="hs-identifier hs-var">inits</span></a><span> </span><a href="#local-6989586621680338644"><span class="hs-identifier hs-var">rep_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>                                    </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#tail"><span class="hs-identifier hs-var">tail</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#tails"><span class="hs-identifier hs-var">tails</span></a><span> </span><a href="#local-6989586621680338644"><span class="hs-identifier hs-var">rep_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a><span> </span><a href="Vectorise.Utils.Hoisting.html#hoistBinding"><span class="hs-identifier hs-var">hoistBinding</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680338677"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-400"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-401"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-402"></a><span>    </span><a name="local-6989586621680338637"><a href="#local-6989586621680338637"><span class="hs-identifier">tyvars</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680338635"><span class="hs-identifier hs-var">vect_tc</span></a><span>
</span><a name="line-403"></a><span>    </span><a name="local-6989586621680338638"><a href="#local-6989586621680338638"><span class="hs-identifier">var_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621680338637"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621680338639"><a href="#local-6989586621680338639"><span class="hs-identifier">ty_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621680338638"><span class="hs-identifier hs-var">var_tys</span></a><span>
</span><a name="line-405"></a><span>    </span><a name="local-6989586621680338640"><a href="#local-6989586621680338640"><span class="hs-identifier">res_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680338635"><span class="hs-identifier hs-var">vect_tc</span></a><span> </span><a href="#local-6989586621680338638"><span class="hs-identifier hs-var">var_tys</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>    </span><a name="local-6989586621680338641"><a href="#local-6989586621680338641"><span class="hs-identifier">cons</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338635"><span class="hs-identifier hs-var">vect_tc</span></a><span>
</span><a name="line-408"></a><span>    </span><a name="local-6989586621680338642"><a href="#local-6989586621680338642"><span class="hs-identifier">arity</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621680338641"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-409"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621680338643"><a href="#local-6989586621680338643"><span class="hs-identifier">arr_dc</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338636"><span class="hs-identifier hs-var">arr_tc</span></a><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span>    </span><a name="local-6989586621680338644"><a href="#local-6989586621680338644"><span class="hs-identifier">rep_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680338635"><span class="hs-identifier hs-var">vect_tc</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>    </span><a name="local-6989586621680338645"><a href="#local-6989586621680338645"><span class="hs-identifier">mk_data_con</span></a></a><span> </span><a name="local-6989586621680338650"><a href="#local-6989586621680338650"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621680338651"><a href="#local-6989586621680338651"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621680338652"><a href="#local-6989586621680338652"><span class="hs-identifier">pre</span></a></a><span> </span><a name="local-6989586621680338653"><a href="#local-6989586621680338653"><span class="hs-identifier">post</span></a></a><span>
</span><a name="line-414"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680338654"><a href="#local-6989586621680338654"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-415"></a><span>           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#liftM2"><span class="hs-identifier hs-var">liftM2</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338647"><span class="hs-identifier hs-var">vect_data_con</span></a><span> </span><a href="#local-6989586621680338650"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621680338648"><span class="hs-identifier hs-var">lift_data_con</span></a><span> </span><a href="#local-6989586621680338651"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621680338652"><span class="hs-identifier hs-var">pre</span></a><span> </span><a href="#local-6989586621680338653"><span class="hs-identifier hs-var">post</span></a><span> </span><span class="hs-special">(</span><a href="Vectorise.Utils.Base.html#mkDataConTag"><span class="hs-identifier hs-var">mkDataConTag</span></a><span> </span><a href="#local-6989586621680338654"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680338650"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>    </span><a name="local-6989586621680338646"><a href="#local-6989586621680338646"><span class="hs-identifier">sel_replicate</span></a></a><span> </span><a name="local-6989586621680338655"><a href="#local-6989586621680338655"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621680338656"><a href="#local-6989586621680338656"><span class="hs-identifier">tag</span></a></a><span>
</span><a name="line-419"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680338642"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-420"></a><span>                      </span><a name="local-6989586621680338657"><a href="#local-6989586621680338657"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.html#builtin"><span class="hs-identifier hs-var">builtin</span></a><span> </span><span class="hs-special">(</span><a href="Vectorise.Builtins.Base.html#selReplicate"><span class="hs-identifier hs-var">selReplicate</span></a><span> </span><a href="#local-6989586621680338642"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>                      </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680338657"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680338655"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338656"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span>    </span><a name="local-6989586621680338647"><a href="#local-6989586621680338647"><span class="hs-identifier">vect_data_con</span></a></a><span> </span><a name="local-6989586621680338658"><a href="#local-6989586621680338658"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="#local-6989586621680338658"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680338639"><span class="hs-identifier hs-var">ty_args</span></a><span>
</span><a name="line-426"></a><span>    </span><a name="local-6989586621680338648"><a href="#local-6989586621680338648"><span class="hs-identifier">lift_data_con</span></a></a><span> </span><a name="local-6989586621680338659"><a href="#local-6989586621680338659"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621680338660"><a href="#local-6989586621680338660"><span class="hs-identifier">pre_tys</span></a></a><span> </span><a name="local-6989586621680338661"><a href="#local-6989586621680338661"><span class="hs-identifier">post_tys</span></a></a><span> </span><a name="local-6989586621680338662"><a href="#local-6989586621680338662"><span class="hs-identifier">tag</span></a></a><span>
</span><a name="line-427"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-428"></a><span>          </span><a name="local-6989586621680338663"><a href="#local-6989586621680338663"><span class="hs-identifier">len</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.html#builtin"><span class="hs-identifier hs-var">builtin</span></a><span> </span><span class="hs-identifier">liftingContext</span><span>
</span><a name="line-429"></a><span>          </span><a name="local-6989586621680338664"><a href="#local-6989586621680338664"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="Vectorise.Monad.Naming.html#newLocalVar"><span class="hs-identifier hs-var">newLocalVar</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;xs&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>                  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.Utils.Base.html#mkPDataType"><span class="hs-identifier hs-var">mkPDataType</span></a><span> </span><a href="#local-6989586621680338659"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>          </span><a name="local-6989586621680338665"><a href="#local-6989586621680338665"><span class="hs-identifier">sel</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680338646"><span class="hs-identifier hs-var">sel_replicate</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621680338663"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680338662"><span class="hs-identifier hs-var">tag</span></a><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span>          </span><a name="local-6989586621680338666"><a href="#local-6989586621680338666"><span class="hs-identifier">pre</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.Utils.html#emptyPD"><span class="hs-identifier hs-var">emptyPD</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="#local-6989586621680338660"><span class="hs-identifier hs-var">pre_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>          </span><a name="local-6989586621680338667"><a href="#local-6989586621680338667"><span class="hs-identifier">post</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Vectorise.Utils.html#emptyPD"><span class="hs-identifier hs-var">emptyPD</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="#local-6989586621680338661"><span class="hs-identifier hs-var">post_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338663"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680338664"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>                 </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="MkId.html#wrapFamInstBody"><span class="hs-identifier hs-var">wrapFamInstBody</span></a><span> </span><a href="#local-6989586621680338636"><span class="hs-identifier hs-var">arr_tc</span></a><span> </span><a href="#local-6989586621680338638"><span class="hs-identifier hs-var">var_tys</span></a><span>
</span><a name="line-439"></a><span>                 </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="#local-6989586621680338643"><span class="hs-identifier hs-var">arr_dc</span></a><span>
</span><a name="line-440"></a><span>                 </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680338639"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338665"><span class="hs-identifier hs-var">sel</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338666"><span class="hs-identifier hs-var">pre</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621680338664"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338667"><span class="hs-identifier hs-var">post</span></a><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span>    </span><a name="local-6989586621680338649"><a href="#local-6989586621680338649"><span class="hs-identifier">def_worker</span></a></a><span> </span><a name="local-6989586621680338668"><a href="#local-6989586621680338668"><span class="hs-identifier">data_con</span></a></a><span> </span><a name="local-6989586621680338669"><a href="#local-6989586621680338669"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-6989586621680338670"><a href="#local-6989586621680338670"><span class="hs-identifier">mk_body</span></a></a><span>
</span><a name="line-443"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-444"></a><span>          </span><a name="local-6989586621680338672"><a href="#local-6989586621680338672"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Utils.Poly.html#polyArity"><span class="hs-identifier hs-var">polyArity</span></a><span> </span><a href="#local-6989586621680338637"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-445"></a><span>          </span><a name="local-6989586621680338674"><a href="#local-6989586621680338674"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Local.html#closedV"><span class="hs-identifier hs-var">closedV</span></a><span>
</span><a name="line-446"></a><span>                </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Vectorise.Monad.Local.html#inBind"><span class="hs-identifier hs-var">inBind</span></a><span> </span><a href="#local-6989586621680338671"><span class="hs-identifier hs-var">orig_worker</span></a><span>
</span><a name="line-447"></a><span>                </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Vectorise.Utils.Poly.html#polyAbstract"><span class="hs-identifier hs-var">polyAbstract</span></a><span> </span><a href="#local-6989586621680338637"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680338673"><a href="#local-6989586621680338673"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-448"></a><span>                  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#liftM"><span class="hs-identifier hs-var">liftM</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338637"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680338673"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Vectorise.Vect.html#vectorised"><span class="hs-identifier hs-var">vectorised</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>                </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Vectorise.Utils.Closure.html#buildClosures"><span class="hs-identifier hs-var">buildClosures</span></a><span> </span><a href="#local-6989586621680338637"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680338669"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621680338640"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621680338670"><span class="hs-identifier hs-var">mk_body</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>          </span><a name="local-6989586621680338675"><a href="#local-6989586621680338675"><span class="hs-identifier">raw_worker</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Vectorise.Monad.Naming.html#mkVectId"><span class="hs-identifier hs-var">mkVectId</span></a><span> </span><a href="#local-6989586621680338671"><span class="hs-identifier hs-var">orig_worker</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621680338674"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680338676"><a href="#local-6989586621680338676"><span class="hs-identifier">vect_worker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680338675"><span class="hs-identifier hs-var">raw_worker</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdUnfolding"><span class="hs-identifier hs-var">setIdUnfolding</span></a><span class="hs-special">`</span><span>
</span><a name="line-453"></a><span>                              </span><a href="CoreUnfold.html#mkInlineUnfoldingWithArity"><span class="hs-identifier hs-var">mkInlineUnfoldingWithArity</span></a><span> </span><a href="#local-6989586621680338672"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621680338674"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-454"></a><span>          </span><a href="Vectorise.Monad.Global.html#defGlobalVar"><span class="hs-identifier hs-var">defGlobalVar</span></a><span> </span><a href="#local-6989586621680338671"><span class="hs-identifier hs-var">orig_worker</span></a><span> </span><a href="#local-6989586621680338676"><span class="hs-identifier hs-var">vect_worker</span></a><span>
</span><a name="line-455"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680338676"><span class="hs-identifier hs-var">vect_worker</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680338674"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-457"></a><span>        </span><a name="local-6989586621680338671"><a href="#local-6989586621680338671"><span class="hs-identifier">orig_worker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a><span> </span><a href="#local-6989586621680338668"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-458"></a></pre></body></html>