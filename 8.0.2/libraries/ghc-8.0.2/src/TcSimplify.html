<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSimplify.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSimplify</span><span class='hs-layout'>(</span>
<a name="line-4"></a>       <span class='hs-varid'>simplifyInfer</span><span class='hs-layout'>,</span> <span class='hs-varid'>solveTopConstraints</span><span class='hs-layout'>,</span>
<a name="line-5"></a>       <span class='hs-varid'>growThetaTyVars</span><span class='hs-layout'>,</span>
<a name="line-6"></a>       <span class='hs-varid'>simplifyAmbiguityCheck</span><span class='hs-layout'>,</span>
<a name="line-7"></a>       <span class='hs-varid'>simplifyDefault</span><span class='hs-layout'>,</span>
<a name="line-8"></a>       <span class='hs-varid'>simplifyTop</span><span class='hs-layout'>,</span> <span class='hs-varid'>simplifyInteractive</span><span class='hs-layout'>,</span> <span class='hs-varid'>solveEqualities</span><span class='hs-layout'>,</span>
<a name="line-9"></a>       <span class='hs-varid'>simplifyWantedsTcM</span><span class='hs-layout'>,</span>
<a name="line-10"></a>       <span class='hs-varid'>tcCheckSatisfiability</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>       <span class='hs-comment'>-- For Rules we need these</span>
<a name="line-13"></a>       <span class='hs-varid'>solveWanteds</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSDeriveds</span>
<a name="line-14"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>         <span class='hs-layout'>(</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-varid'>classKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>classTyCon</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>WarningFlag</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Opt_WarnMonomorphism</span> <span class='hs-layout'>)</span>
<a name="line-21"></a>                     <span class='hs-layout'>,</span> <span class='hs-conid'>WarnReason</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Reason</span> <span class='hs-layout'>)</span>
<a name="line-22"></a>                     <span class='hs-layout'>,</span> <span class='hs-conid'>DynFlags</span><span class='hs-layout'>(</span> <span class='hs-varid'>solverIterations</span> <span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelInfo</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcErrors</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcInteract</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcCanonical</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>makeSuperClasses</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>   <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcSMonad</span>  <span class='hs-keyword'>as</span> <span class='hs-conid'>TcS</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>       <span class='hs-conid'>()</span> <span class='hs-comment'>-- DV: for now</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>ptrRepLiftedTy</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>tcMatchTy</span> <span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>IntWithInf</span><span class='hs-layout'>,</span> <span class='hs-varid'>intGtLimit</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>emptyMessages</span> <span class='hs-layout'>)</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-48"></a>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>     <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt; 709</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>)</span>
<a name="line-54"></a><span class='hs-cpp'>#endif</span>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-comment'>{-
<a name="line-57"></a>*********************************************************************************
<a name="line-58"></a>*                                                                               *
<a name="line-59"></a>*                           External interface                                  *
<a name="line-60"></a>*                                                                               *
<a name="line-61"></a>*********************************************************************************
<a name="line-62"></a>-}</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="simplifyTop"></a><span class='hs-definition'>simplifyTop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-comment'>-- Simplify top-level constraints</span>
<a name="line-66"></a><span class='hs-comment'>-- Usually these will be implications,</span>
<a name="line-67"></a><span class='hs-comment'>-- but when there is nothing to quantify we don't wrap</span>
<a name="line-68"></a><span class='hs-comment'>-- in a degenerate implication, so we do that here instead</span>
<a name="line-69"></a><span class='hs-definition'>simplifyTop</span> <span class='hs-varid'>wanteds</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyTop {"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"wanted = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanteds</span>
<a name="line-71"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>final_wc</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafe_ol</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>binds1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>simpl_top</span> <span class='hs-varid'>wanteds</span>
<a name="line-72"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"End simplifyTop }"</span> <span class='hs-varid'>empty</span>
<a name="line-73"></a>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved {"</span> <span class='hs-varid'>empty</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>binds2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reportUnsolved</span> <span class='hs-varid'>final_wc</span>
<a name="line-76"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved }"</span> <span class='hs-varid'>empty</span>
<a name="line-77"></a>
<a name="line-78"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved (unsafe overlapping) {"</span> <span class='hs-varid'>empty</span>
<a name="line-79"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyCts</span> <span class='hs-varid'>unsafe_ol</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-80"></a>           <span class='hs-comment'>-- grab current error messages and clear, warnAllUnsolved will</span>
<a name="line-81"></a>           <span class='hs-comment'>-- update error messages which we'll grab and then restore saved</span>
<a name="line-82"></a>           <span class='hs-comment'>-- messages.</span>
<a name="line-83"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>errs_var</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getErrsVar</span>
<a name="line-84"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>saved_msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>errs_var</span>
<a name="line-85"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>errs_var</span> <span class='hs-varid'>emptyMessages</span>
<a name="line-86"></a>
<a name="line-87"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>warnAllUnsolved</span> <span class='hs-varop'>$</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafe_ol</span>
<a name="line-88"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-89"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-90"></a>
<a name="line-91"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>whyUnsafe</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>errs_var</span>
<a name="line-92"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>errs_var</span> <span class='hs-varid'>saved_msg</span>
<a name="line-93"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>recordUnsafeInfer</span> <span class='hs-varid'>whyUnsafe</span>
<a name="line-94"></a>           <span class='hs-layout'>}</span>
<a name="line-95"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved (unsafe overlapping) }"</span> <span class='hs-varid'>empty</span>
<a name="line-96"></a>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>binds1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>binds2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="solveEqualities"></a><span class='hs-comment'>-- | Type-check a thing that emits only equality constraints, then</span>
<a name="line-100"></a><span class='hs-comment'>-- solve those constraints. Fails outright if there is trouble.</span>
<a name="line-101"></a><span class='hs-definition'>solveEqualities</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-102"></a><span class='hs-definition'>solveEqualities</span> <span class='hs-varid'>thing_inside</span>
<a name="line-103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- See Note [Fail fast on kind errors]</span>
<a name="line-104"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-105"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"solveEqualities {"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"wanted = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span>
<a name="line-106"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_wc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcSEqualities</span> <span class='hs-varop'>$</span> <span class='hs-varid'>simpl_top</span> <span class='hs-varid'>wanted</span>
<a name="line-107"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"End solveEqualities }"</span> <span class='hs-varid'>empty</span>
<a name="line-108"></a>
<a name="line-109"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportAllUnsolved {"</span> <span class='hs-varid'>empty</span>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportAllUnsolved</span> <span class='hs-varid'>final_wc</span>
<a name="line-111"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportAllUnsolved }"</span> <span class='hs-varid'>empty</span>
<a name="line-112"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-113"></a>
<a name="line-114"></a><a name="SafeOverlapFailures"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SafeOverlapFailures</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Cts</span>
<a name="line-115"></a><span class='hs-comment'>-- ^ See Note [Safe Haskell Overlapping Instances Implementation]</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="FinalConstraints"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FinalConstraints</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span> <span class='hs-conid'>SafeOverlapFailures</span><span class='hs-layout'>)</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="simpl_top"></a><span class='hs-definition'>simpl_top</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>FinalConstraints</span>
<a name="line-120"></a>    <span class='hs-comment'>-- See Note [Top-level Defaulting Plan]</span>
<a name="line-121"></a><span class='hs-definition'>simpl_top</span> <span class='hs-varid'>wanteds</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_first_go</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>solveWantedsAndDrop</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-123"></a>                            <span class='hs-comment'>-- This is where the main work happens</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wc_final</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>try_tyvar_defaulting</span> <span class='hs-varid'>wc_first_go</span>
<a name="line-125"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unsafe_ol</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSafeOverlapFailures</span>
<a name="line-126"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_final</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafe_ol</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-127"></a>  <span class='hs-keyword'>where</span>
<a name="line-128"></a>    <span class='hs-varid'>try_tyvar_defaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-129"></a>    <span class='hs-varid'>try_tyvar_defaulting</span> <span class='hs-varid'>wc</span>
<a name="line-130"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wc</span>
<a name="line-131"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wc</span>
<a name="line-132"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-133"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>free_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTyCoVarsAndFVList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfWCList</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-134"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>meta_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyVar</span> <span class='hs-varop'>&lt;&amp;&amp;&gt;</span> <span class='hs-varid'>isMetaTyVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>free_tvs</span>
<a name="line-135"></a>                   <span class='hs-comment'>-- zonkTyCoVarsAndFV: the wc_first_go is not yet zonked</span>
<a name="line-136"></a>                   <span class='hs-comment'>-- filter isMetaTyVar: we might have runtime-skolems in GHCi,</span>
<a name="line-137"></a>                   <span class='hs-comment'>-- and we definitely don't want to try to assign to those!</span>
<a name="line-138"></a>                   <span class='hs-comment'>-- the isTyVar needs to weed out coercion variables</span>
<a name="line-139"></a>
<a name="line-140"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>defaulted</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>defaultTyVarTcS</span> <span class='hs-varid'>meta_tvs</span>   <span class='hs-comment'>-- Has unification side effects</span>
<a name="line-141"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>or</span> <span class='hs-varid'>defaulted</span>
<a name="line-142"></a>             <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_residual</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>solveWanteds</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-143"></a>                            <span class='hs-comment'>-- See Note [Must simplify after defaulting]</span>
<a name="line-144"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>try_class_defaulting</span> <span class='hs-varid'>wc_residual</span> <span class='hs-layout'>}</span>
<a name="line-145"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>try_class_defaulting</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>}</span>     <span class='hs-comment'>-- No defaulting took place</span>
<a name="line-146"></a>
<a name="line-147"></a>    <span class='hs-varid'>try_class_defaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-148"></a>    <span class='hs-varid'>try_class_defaulting</span> <span class='hs-varid'>wc</span>
<a name="line-149"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wc</span>
<a name="line-150"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wc</span>
<a name="line-151"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- See Note [When to do type-class defaulting]</span>
<a name="line-152"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>something_happened</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>applyDefaultingRules</span> <span class='hs-varid'>wc</span>
<a name="line-153"></a>                                   <span class='hs-comment'>-- See Note [Top-level Defaulting Plan]</span>
<a name="line-154"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>something_happened</span>
<a name="line-155"></a>             <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_residual</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>solveWantedsAndDrop</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-156"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>try_class_defaulting</span> <span class='hs-varid'>wc_residual</span> <span class='hs-layout'>}</span>
<a name="line-157"></a>                  <span class='hs-comment'>-- See Note [Overview of implicit CallStacks] in TcEvidence</span>
<a name="line-158"></a>             <span class='hs-keyword'>else</span> <span class='hs-varid'>try_callstack_defaulting</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>}</span>
<a name="line-159"></a>
<a name="line-160"></a>    <span class='hs-varid'>try_callstack_defaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-161"></a>    <span class='hs-varid'>try_callstack_defaulting</span> <span class='hs-varid'>wc</span>
<a name="line-162"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wc</span>
<a name="line-163"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wc</span>
<a name="line-164"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-165"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defaultCallStacks</span> <span class='hs-varid'>wc</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="defaultCallStacks"></a><span class='hs-comment'>-- | Default any remaining @CallStack@ constraints to empty @CallStack@s.</span>
<a name="line-168"></a><span class='hs-definition'>defaultCallStacks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-169"></a><span class='hs-comment'>-- See Note [Overview of implicit CallStacks] in TcEvidence</span>
<a name="line-170"></a><span class='hs-definition'>defaultCallStacks</span> <span class='hs-varid'>wanteds</span>
<a name="line-171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>simples</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handle_simples</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_simple</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-172"></a>       <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>handle_implic</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-173"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanteds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a>  <span class='hs-keyword'>where</span>
<a name="line-176"></a>
<a name="line-177"></a>  <span class='hs-varid'>handle_simples</span> <span class='hs-varid'>simples</span>
<a name="line-178"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>catBagMaybes</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapBagM</span> <span class='hs-varid'>defaultCallStack</span> <span class='hs-varid'>simples</span>
<a name="line-179"></a>
<a name="line-180"></a>  <span class='hs-varid'>handle_implic</span> <span class='hs-varid'>implic</span>
<a name="line-181"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wanteds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setEvBindsTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_binds</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-182"></a>                      <span class='hs-comment'>-- defaultCallStack sets a binding, so</span>
<a name="line-183"></a>                      <span class='hs-comment'>-- we must set the correct binding group</span>
<a name="line-184"></a>                      <span class='hs-varid'>defaultCallStacks</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_wanted</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-185"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanteds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-186"></a>
<a name="line-187"></a>  <span class='hs-varid'>defaultCallStack</span> <span class='hs-varid'>ct</span>
<a name="line-188"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCallStackPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-189"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>solveCallStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-conid'>EvCsEmpty</span>
<a name="line-190"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-191"></a>
<a name="line-192"></a>  <span class='hs-varid'>defaultCallStack</span> <span class='hs-varid'>ct</span>
<a name="line-193"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-194"></a>
<a name="line-195"></a>
<a name="line-196"></a><a name="solveTopConstraints"></a><span class='hs-comment'>-- | Type-check a thing, returning the result and any EvBinds produced</span>
<a name="line-197"></a><span class='hs-comment'>-- during solving. Emits errors -- but does not fail -- if there is trouble.</span>
<a name="line-198"></a><span class='hs-definition'>solveTopConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-199"></a><span class='hs-definition'>solveTopConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>captureConstraints</span> <span class='hs-varid'>thing_inside</span>
<a name="line-201"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>wanted</span>
<a name="line-202"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-203"></a>
<a name="line-204"></a><span class='hs-comment'>{- Note [Fail fast on kind errors]
<a name="line-205"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-206"></a>solveEqualities is used to solve kind equalities when kind-checking
<a name="line-207"></a>user-written types. If solving fails we should fail outright, rather
<a name="line-208"></a>than just accumulate an error message, for two reasons:
<a name="line-209"></a>  * A kind-bogus type signature may cause a cascade of knock-on
<a name="line-210"></a>    errors if we let it pass
<a name="line-211"></a>
<a name="line-212"></a>  * More seriously, if we don't solve a constraint we'll be left
<a name="line-213"></a>    with a type that has a coercion hole in it, something like
<a name="line-214"></a>           &lt;type&gt; |&gt; co-hole
<a name="line-215"></a>    where co-hole is not filled in.  Eeek!  That un-filled-in
<a name="line-216"></a>    hole actually causes GHC to crash with "fvProv falls into a hole"
<a name="line-217"></a>    See Trac #11563, #11520, #11516, #11399
<a name="line-218"></a>
<a name="line-219"></a>So it's important to use 'checkNoErrs' here!
<a name="line-220"></a>
<a name="line-221"></a>Note [When to do type-class defaulting]
<a name="line-222"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-223"></a>In GHC 7.6 and 7.8.2, we did type-class defaulting only if insolubleWC
<a name="line-224"></a>was false, on the grounds that defaulting can't help solve insoluble
<a name="line-225"></a>constraints.  But if we *don't* do defaulting we may report a whole
<a name="line-226"></a>lot of errors that would be solved by defaulting; these errors are
<a name="line-227"></a>quite spurious because fixing the single insoluble error means that
<a name="line-228"></a>defaulting happens again, which makes all the other errors go away.
<a name="line-229"></a>This is jolly confusing: Trac #9033.
<a name="line-230"></a>
<a name="line-231"></a>So it seems better to always do type-class defaulting.
<a name="line-232"></a>
<a name="line-233"></a>However, always doing defaulting does mean that we'll do it in
<a name="line-234"></a>situations like this (Trac #5934):
<a name="line-235"></a>   run :: (forall s. GenST s) -&gt; Int
<a name="line-236"></a>   run = fromInteger 0
<a name="line-237"></a>We don't unify the return type of fromInteger with the given function
<a name="line-238"></a>type, because the latter involves foralls.  So we're left with
<a name="line-239"></a>    (Num alpha, alpha ~ (forall s. GenST s) -&gt; Int)
<a name="line-240"></a>Now we do defaulting, get alpha := Integer, and report that we can't
<a name="line-241"></a>match Integer with (forall s. GenST s) -&gt; Int.  That's not totally
<a name="line-242"></a>stupid, but perhaps a little strange.
<a name="line-243"></a>
<a name="line-244"></a>Another potential alternative would be to suppress *all* non-insoluble
<a name="line-245"></a>errors if there are *any* insoluble errors, anywhere, but that seems
<a name="line-246"></a>too drastic.
<a name="line-247"></a>
<a name="line-248"></a>Note [Must simplify after defaulting]
<a name="line-249"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-250"></a>We may have a deeply buried constraint
<a name="line-251"></a>    (t:*) ~ (a:Open)
<a name="line-252"></a>which we couldn't solve because of the kind incompatibility, and 'a' is free.
<a name="line-253"></a>Then when we default 'a' we can solve the constraint.  And we want to do
<a name="line-254"></a>that before starting in on type classes.  We MUST do it before reporting
<a name="line-255"></a>errors, because it isn't an error!  Trac #7967 was due to this.
<a name="line-256"></a>
<a name="line-257"></a>Note [Top-level Defaulting Plan]
<a name="line-258"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-259"></a>We have considered two design choices for where/when to apply defaulting.
<a name="line-260"></a>   (i) Do it in SimplCheck mode only /whenever/ you try to solve some
<a name="line-261"></a>       simple constraints, maybe deep inside the context of implications.
<a name="line-262"></a>       This used to be the case in GHC 7.4.1.
<a name="line-263"></a>   (ii) Do it in a tight loop at simplifyTop, once all other constraints have
<a name="line-264"></a>        finished. This is the current story.
<a name="line-265"></a>
<a name="line-266"></a>Option (i) had many disadvantages:
<a name="line-267"></a>   a) Firstly, it was deep inside the actual solver.
<a name="line-268"></a>   b) Secondly, it was dependent on the context (Infer a type signature,
<a name="line-269"></a>      or Check a type signature, or Interactive) since we did not want
<a name="line-270"></a>      to always start defaulting when inferring (though there is an exception to
<a name="line-271"></a>      this, see Note [Default while Inferring]).
<a name="line-272"></a>   c) It plainly did not work. Consider typecheck/should_compile/DfltProb2.hs:
<a name="line-273"></a>          f :: Int -&gt; Bool
<a name="line-274"></a>          f x = const True (\y -&gt; let w :: a -&gt; a
<a name="line-275"></a>                                      w a = const a (y+1)
<a name="line-276"></a>                                  in w y)
<a name="line-277"></a>      We will get an implication constraint (for beta the type of y):
<a name="line-278"></a>               [untch=beta] forall a. 0 =&gt; Num beta
<a name="line-279"></a>      which we really cannot default /while solving/ the implication, since beta is
<a name="line-280"></a>      untouchable.
<a name="line-281"></a>
<a name="line-282"></a>Instead our new defaulting story is to pull defaulting out of the solver loop and
<a name="line-283"></a>go with option (ii), implemented at SimplifyTop. Namely:
<a name="line-284"></a>     - First, have a go at solving the residual constraint of the whole
<a name="line-285"></a>       program
<a name="line-286"></a>     - Try to approximate it with a simple constraint
<a name="line-287"></a>     - Figure out derived defaulting equations for that simple constraint
<a name="line-288"></a>     - Go round the loop again if you did manage to get some equations
<a name="line-289"></a>
<a name="line-290"></a>Now, that has to do with class defaulting. However there exists type variable /kind/
<a name="line-291"></a>defaulting. Again this is done at the top-level and the plan is:
<a name="line-292"></a>     - At the top-level, once you had a go at solving the constraint, do
<a name="line-293"></a>       figure out /all/ the touchable unification variables of the wanted constraints.
<a name="line-294"></a>     - Apply defaulting to their kinds
<a name="line-295"></a>
<a name="line-296"></a>More details in Note [DefaultTyVar].
<a name="line-297"></a>
<a name="line-298"></a>Note [Safe Haskell Overlapping Instances]
<a name="line-299"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-300"></a>In Safe Haskell, we apply an extra restriction to overlapping instances. The
<a name="line-301"></a>motive is to prevent untrusted code provided by a third-party, changing the
<a name="line-302"></a>behavior of trusted code through type-classes. This is due to the global and
<a name="line-303"></a>implicit nature of type-classes that can hide the source of the dictionary.
<a name="line-304"></a>
<a name="line-305"></a>Another way to state this is: if a module M compiles without importing another
<a name="line-306"></a>module N, changing M to import N shouldn't change the behavior of M.
<a name="line-307"></a>
<a name="line-308"></a>Overlapping instances with type-classes can violate this principle. However,
<a name="line-309"></a>overlapping instances aren't always unsafe. They are just unsafe when the most
<a name="line-310"></a>selected dictionary comes from untrusted code (code compiled with -XSafe) and
<a name="line-311"></a>overlaps instances provided by other modules.
<a name="line-312"></a>
<a name="line-313"></a>In particular, in Safe Haskell at a call site with overlapping instances, we
<a name="line-314"></a>apply the following rule to determine if it is a 'unsafe' overlap:
<a name="line-315"></a>
<a name="line-316"></a> 1) Most specific instance, I1, defined in an `-XSafe` compiled module.
<a name="line-317"></a> 2) I1 is an orphan instance or a MPTC.
<a name="line-318"></a> 3) At least one overlapped instance, Ix, is both:
<a name="line-319"></a>    A) from a different module than I1
<a name="line-320"></a>    B) Ix is not marked `OVERLAPPABLE`
<a name="line-321"></a>
<a name="line-322"></a>This is a slightly involved heuristic, but captures the situation of an
<a name="line-323"></a>imported module N changing the behavior of existing code. For example, if
<a name="line-324"></a>condition (2) isn't violated, then the module author M must depend either on a
<a name="line-325"></a>type-class or type defined in N.
<a name="line-326"></a>
<a name="line-327"></a>Secondly, when should these heuristics be enforced? We enforced them when the
<a name="line-328"></a>type-class method call site is in a module marked `-XSafe` or `-XTrustworthy`.
<a name="line-329"></a>This allows `-XUnsafe` modules to operate without restriction, and for Safe
<a name="line-330"></a>Haskell inferrence to infer modules with unsafe overlaps as unsafe.
<a name="line-331"></a>
<a name="line-332"></a>One alternative design would be to also consider if an instance was imported as
<a name="line-333"></a>a `safe` import or not and only apply the restriction to instances imported
<a name="line-334"></a>safely. However, since instances are global and can be imported through more
<a name="line-335"></a>than one path, this alternative doesn't work.
<a name="line-336"></a>
<a name="line-337"></a>Note [Safe Haskell Overlapping Instances Implementation]
<a name="line-338"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-339"></a>
<a name="line-340"></a>How is this implemented? It's complicated! So we'll step through it all:
<a name="line-341"></a>
<a name="line-342"></a> 1) `InstEnv.lookupInstEnv` -- Performs instance resolution, so this is where
<a name="line-343"></a> we check if a particular type-class method call is safe or unsafe. We do this
<a name="line-344"></a> through the return type, `ClsInstLookupResult`, where the last parameter is a
<a name="line-345"></a> list of instances that are unsafe to overlap. When the method call is safe,
<a name="line-346"></a> the list is null.
<a name="line-347"></a>
<a name="line-348"></a> 2) `TcInteract.matchClassInst` -- This module drives the instance resolution
<a name="line-349"></a> / dictionary generation. The return type is `LookupInstResult`, which either
<a name="line-350"></a> says no instance matched, or one found, and if it was a safe or unsafe
<a name="line-351"></a> overlap.
<a name="line-352"></a>
<a name="line-353"></a> 3) `TcInteract.doTopReactDict` -- Takes a dictionary / class constraint and
<a name="line-354"></a> tries to resolve it by calling (in part) `matchClassInst`. The resolving
<a name="line-355"></a> mechanism has a work list (of constraints) that it process one at a time. If
<a name="line-356"></a> the constraint can't be resolved, it's added to an inert set. When compiling
<a name="line-357"></a> an `-XSafe` or `-XTrustworthy` module, we follow this approach as we know
<a name="line-358"></a> compilation should fail. These are handled as normal constraint resolution
<a name="line-359"></a> failures from here-on (see step 6).
<a name="line-360"></a>
<a name="line-361"></a> Otherwise, we may be inferring safety (or using `-Wunsafe`), and
<a name="line-362"></a> compilation should succeed, but print warnings and/or mark the compiled module
<a name="line-363"></a> as `-XUnsafe`. In this case, we call `insertSafeOverlapFailureTcS` which adds
<a name="line-364"></a> the unsafe (but resolved!) constraint to the `inert_safehask` field of
<a name="line-365"></a> `InertCans`.
<a name="line-366"></a>
<a name="line-367"></a> 4) `TcSimplify.simpl_top` -- Top-level function for driving the simplifier for
<a name="line-368"></a> constraint resolution. Once finished, we call `getSafeOverlapFailures` to
<a name="line-369"></a> retrieve the list of overlapping instances that were successfully resolved,
<a name="line-370"></a> but unsafe. Remember, this is only applicable for generating warnings
<a name="line-371"></a> (`-Wunsafe`) or inferring a module unsafe. `-XSafe` and `-XTrustworthy`
<a name="line-372"></a> cause compilation failure by not resolving the unsafe constraint at all.
<a name="line-373"></a> `simpl_top` returns a list of unresolved constraints (all types), and resolved
<a name="line-374"></a> (but unsafe) resolved dictionary constraints.
<a name="line-375"></a>
<a name="line-376"></a> 5) `TcSimplify.simplifyTop` -- Is the caller of `simpl_top`. For unresolved
<a name="line-377"></a> constraints, it calls `TcErrors.reportUnsolved`, while for unsafe overlapping
<a name="line-378"></a> instance constraints, it calls `TcErrors.warnAllUnsolved`. Both functions
<a name="line-379"></a> convert constraints into a warning message for the user.
<a name="line-380"></a>
<a name="line-381"></a> 6) `TcErrors.*Unsolved` -- Generates error messages for constraints by
<a name="line-382"></a> actually calling `InstEnv.lookupInstEnv` again! Yes, confusing, but all we
<a name="line-383"></a> know is the constraint that is unresolved or unsafe. For dictionary, all we
<a name="line-384"></a> know is that we need a dictionary of type C, but not what instances are
<a name="line-385"></a> available and how they overlap. So we once again call `lookupInstEnv` to
<a name="line-386"></a> figure that out so we can generate a helpful error message.
<a name="line-387"></a>
<a name="line-388"></a> 7) `TcSimplify.simplifyTop` -- In the case of `warnAllUnsolved` for resolved,
<a name="line-389"></a> but unsafe dictionary constraints, we collect the generated warning message
<a name="line-390"></a> (pop it) and call `TcRnMonad.recordUnsafeInfer` to mark the module we are
<a name="line-391"></a> compiling as unsafe, passing the warning message along as the reason.
<a name="line-392"></a>
<a name="line-393"></a> 8) `TcRnMonad.recordUnsafeInfer` -- Save the unsafe result and reason in an
<a name="line-394"></a> IORef called `tcg_safeInfer`.
<a name="line-395"></a>
<a name="line-396"></a> 9) `HscMain.tcRnModule'` -- Reads `tcg_safeInfer` after type-checking, calling
<a name="line-397"></a> `HscMain.markUnsafeInfer` (passing the reason along) when safe-inferrence
<a name="line-398"></a> failed.
<a name="line-399"></a>
<a name="line-400"></a>Note [No defaulting in the ambiguity check]
<a name="line-401"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-402"></a>When simplifying constraints for the ambiguity check, we use
<a name="line-403"></a>solveWantedsAndDrop, not simpl_top, so that we do no defaulting.
<a name="line-404"></a>Trac #11947 was an example:
<a name="line-405"></a>   f :: Num a =&gt; Int -&gt; Int
<a name="line-406"></a>This is ambiguous of course, but we don't want to default the
<a name="line-407"></a>(Num alpha) constraint to (Num Int)!  Doing so gives a defaulting
<a name="line-408"></a>warning, but no error.
<a name="line-409"></a>-}</span>
<a name="line-410"></a>
<a name="line-411"></a><a name="simplifyAmbiguityCheck"></a><span class='hs-comment'>------------------</span>
<a name="line-412"></a><span class='hs-definition'>simplifyAmbiguityCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-413"></a><span class='hs-definition'>simplifyAmbiguityCheck</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>wanteds</span>
<a name="line-414"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyAmbiguityCheck {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"type = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"wanted = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-415"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>final_wc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>solveWantedsAndDrop</span> <span class='hs-varid'>wanteds</span>
<a name="line-416"></a>             <span class='hs-comment'>-- NB: no defaulting!  See Note [No defaulting in the ambiguity check]</span>
<a name="line-417"></a>
<a name="line-418"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"End simplifyAmbiguityCheck }"</span> <span class='hs-varid'>empty</span>
<a name="line-419"></a>
<a name="line-420"></a>       <span class='hs-comment'>-- Normally report all errors; but with -XAllowAmbiguousTypes</span>
<a name="line-421"></a>       <span class='hs-comment'>-- report only insoluble ones, since they represent genuinely</span>
<a name="line-422"></a>       <span class='hs-comment'>-- inaccessible code</span>
<a name="line-423"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>allow_ambiguous</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt</span><span class='hs-varop'>.</span><span class='hs-conid'>AllowAmbiguousTypes</span>
<a name="line-424"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved(ambig) {"</span> <span class='hs-varid'>empty</span>
<a name="line-425"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-426"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>allow_ambiguous</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>final_wc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-427"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>discardResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportUnsolved</span> <span class='hs-varid'>final_wc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-428"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved(ambig) }"</span> <span class='hs-varid'>empty</span>
<a name="line-429"></a>
<a name="line-430"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-431"></a>
<a name="line-432"></a><a name="simplifyInteractive"></a><span class='hs-comment'>------------------</span>
<a name="line-433"></a><span class='hs-definition'>simplifyInteractive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-434"></a><span class='hs-definition'>simplifyInteractive</span> <span class='hs-varid'>wanteds</span>
<a name="line-435"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyInteractive"</span> <span class='hs-varid'>empty</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-436"></a>    <span class='hs-varid'>simplifyTop</span> <span class='hs-varid'>wanteds</span>
<a name="line-437"></a>
<a name="line-438"></a><a name="simplifyDefault"></a><span class='hs-comment'>------------------</span>
<a name="line-439"></a><span class='hs-definition'>simplifyDefault</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span>    <span class='hs-comment'>-- Wanted; has no type variables in it</span>
<a name="line-440"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>       <span class='hs-comment'>-- Succeeds if the constraint is soluble</span>
<a name="line-441"></a><span class='hs-definition'>simplifyDefault</span> <span class='hs-varid'>theta</span>
<a name="line-442"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyDefault"</span> <span class='hs-varid'>empty</span>
<a name="line-443"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanted</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWanteds</span> <span class='hs-conid'>DefaultOrigin</span> <span class='hs-varid'>theta</span>
<a name="line-444"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unsolved</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyWantedsTcM</span> <span class='hs-varid'>wanted</span>
<a name="line-445"></a>
<a name="line-446"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved {"</span> <span class='hs-varid'>empty</span>
<a name="line-447"></a>       <span class='hs-comment'>-- See Note [Deferring coercion errors to runtime]</span>
<a name="line-448"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportAllUnsolved</span> <span class='hs-varid'>unsolved</span>
<a name="line-449"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved }"</span> <span class='hs-varid'>empty</span>
<a name="line-450"></a>
<a name="line-451"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-452"></a>
<a name="line-453"></a><a name="tcCheckSatisfiability"></a><span class='hs-comment'>------------------</span>
<a name="line-454"></a><span class='hs-definition'>tcCheckSatisfiability</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Bool</span>
<a name="line-455"></a><span class='hs-comment'>-- Return True if satisfiable, False if definitely contradictory</span>
<a name="line-456"></a><span class='hs-definition'>tcCheckSatisfiability</span> <span class='hs-varid'>given_ids</span>
<a name="line-457"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-458"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>given_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGivenLoc</span> <span class='hs-varid'>topTcLevel</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-varid'>lcl_env</span>
<a name="line-459"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ev_binds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcS</span> <span class='hs-varop'>$</span>
<a name="line-460"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"checkSatisfiability {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>given_ids</span><span class='hs-layout'>)</span>
<a name="line-461"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>given_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGivens</span> <span class='hs-varid'>given_loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>given_ids</span><span class='hs-layout'>)</span>
<a name="line-462"></a>                     <span class='hs-comment'>-- See Note [Superclasses and satisfiability]</span>
<a name="line-463"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>insols</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveSimpleGivens</span> <span class='hs-varid'>given_cts</span>
<a name="line-464"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>insols</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>try_harder</span> <span class='hs-varid'>insols</span>
<a name="line-465"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"checkSatisfiability }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span>
<a name="line-466"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-467"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-468"></a> <span class='hs-keyword'>where</span>
<a name="line-469"></a>    <span class='hs-varid'>try_harder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-470"></a>    <span class='hs-comment'>-- Maybe we have to search up the superclass chain to find</span>
<a name="line-471"></a>    <span class='hs-comment'>-- an unsatisfiable constraint.  Example: pmcheck/T3927b.</span>
<a name="line-472"></a>    <span class='hs-comment'>-- At the moment we try just once</span>
<a name="line-473"></a>    <span class='hs-varid'>try_harder</span> <span class='hs-varid'>insols</span>
<a name="line-474"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- We've found that it's definitely unsatisfiable</span>
<a name="line-475"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>insols</span>             <span class='hs-comment'>-- Hurrah -- stop now.</span>
<a name="line-476"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-477"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pending_given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPendingScDicts</span>
<a name="line-478"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>new_given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeSuperClasses</span> <span class='hs-varid'>pending_given</span>
<a name="line-479"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>solveSimpleGivens</span> <span class='hs-varid'>new_given</span> <span class='hs-layout'>}</span>
<a name="line-480"></a>
<a name="line-481"></a><span class='hs-comment'>{- Note [Superclases and satisfiability]
<a name="line-482"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-483"></a>Expand superclasses before starting, because (Int ~ Bool), has
<a name="line-484"></a>(Int ~~ Bool) as a superclass, which in turn has (Int ~N# Bool)
<a name="line-485"></a>as a superclass, and it's the latter that is insoluble.  See
<a name="line-486"></a>Note [The equality types story] in TysPrim.
<a name="line-487"></a>
<a name="line-488"></a>If we fail to prove unsatisfiability we (arbitrarily) try just once to
<a name="line-489"></a>find superclasses, using try_harder.  Reason: we might have a type
<a name="line-490"></a>signature
<a name="line-491"></a>   f :: F op (Implements push) =&gt; ..
<a name="line-492"></a>where F is a type function.  This happened in Trac #3972.
<a name="line-493"></a>
<a name="line-494"></a>We could do more than once but we'd have to have /some/ limit: in the
<a name="line-495"></a>the recurisve case, we would go on forever in the common case where
<a name="line-496"></a>the constraints /are/ satisfiable (Trac #10592 comment:12!).
<a name="line-497"></a>
<a name="line-498"></a>For stratightforard situations without type functions the try_harder
<a name="line-499"></a>step does nothing.
<a name="line-500"></a>
<a name="line-501"></a>
<a name="line-502"></a>***********************************************************************************
<a name="line-503"></a>*                                                                                 *
<a name="line-504"></a>*                            Inference
<a name="line-505"></a>*                                                                                 *
<a name="line-506"></a>***********************************************************************************
<a name="line-507"></a>
<a name="line-508"></a>Note [Inferring the type of a let-bound variable]
<a name="line-509"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-510"></a>Consider
<a name="line-511"></a>   f x = rhs
<a name="line-512"></a>
<a name="line-513"></a>To infer f's type we do the following:
<a name="line-514"></a> * Gather the constraints for the RHS with ambient level *one more than*
<a name="line-515"></a>   the current one.  This is done by the call
<a name="line-516"></a>        pushLevelAndCaptureConstraints (tcMonoBinds...)
<a name="line-517"></a>   in TcBinds.tcPolyInfer
<a name="line-518"></a>
<a name="line-519"></a> * Call simplifyInfer to simplify the constraints and decide what to
<a name="line-520"></a>   quantify over. We pass in the level used for the RHS constraints,
<a name="line-521"></a>   here called rhs_tclvl.
<a name="line-522"></a>
<a name="line-523"></a>This ensures that the implication constraint we generate, if any,
<a name="line-524"></a>has a strictly-increased level compared to the ambient level outside
<a name="line-525"></a>the let binding.
<a name="line-526"></a>
<a name="line-527"></a>-}</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="simplifyInfer"></a><span class='hs-definition'>simplifyInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span>               <span class='hs-comment'>-- Used when generating the constraints</span>
<a name="line-530"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                  <span class='hs-comment'>-- Apply monomorphism restriction</span>
<a name="line-531"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdSigInfo</span><span class='hs-keyglyph'>]</span>         <span class='hs-comment'>-- Any signatures (possibly partial)</span>
<a name="line-532"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTauType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Variables to be generalised,</span>
<a name="line-533"></a>                                       <span class='hs-comment'>-- and their tau-types</span>
<a name="line-534"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-535"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Quantify over these type variables</span>
<a name="line-536"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- ... and these constraints (fully zonked)</span>
<a name="line-537"></a>                      <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ... binding these evidence variables</span>
<a name="line-538"></a><span class='hs-definition'>simplifyInfer</span> <span class='hs-varid'>rhs_tclvl</span> <span class='hs-varid'>apply_mr</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>name_taus</span> <span class='hs-varid'>wanteds</span>
<a name="line-539"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanteds</span>
<a name="line-540"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span>
<a name="line-541"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dep_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypesAndSplitDepVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>name_taus</span><span class='hs-layout'>)</span>
<a name="line-542"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>qtkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quantify_tvs</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-varid'>dep_vars</span>
<a name="line-543"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyInfer: empty WC"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name_taus</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>qtkvs</span><span class='hs-layout'>)</span>
<a name="line-544"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>qtkvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-545"></a>
<a name="line-546"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-547"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyInfer {"</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-548"></a>             <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"sigs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sigs</span>
<a name="line-549"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"binds ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name_taus</span>
<a name="line-550"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"rhs_tclvl ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs_tclvl</span>
<a name="line-551"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"apply_mr ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>apply_mr</span>
<a name="line-552"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(unzonked) wanted ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanteds</span>
<a name="line-553"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-554"></a>
<a name="line-555"></a>       <span class='hs-comment'>-- First do full-blown solving</span>
<a name="line-556"></a>       <span class='hs-comment'>-- NB: we must gather up all the bindings from doing</span>
<a name="line-557"></a>       <span class='hs-comment'>-- this solving; hence (runTcSWithEvBinds ev_binds_var).</span>
<a name="line-558"></a>       <span class='hs-comment'>-- And note that since there are nested implications,</span>
<a name="line-559"></a>       <span class='hs-comment'>-- calling solveWanteds will side-effect their evidence</span>
<a name="line-560"></a>       <span class='hs-comment'>-- bindings, so we can't just revert to the input</span>
<a name="line-561"></a>       <span class='hs-comment'>-- constraint.</span>
<a name="line-562"></a>
<a name="line-563"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-564"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanted_transformed_incl_derivs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setTcLevel</span> <span class='hs-varid'>rhs_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-565"></a>           <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_derived</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>concatMapM</span> <span class='hs-varid'>mkSigDerivedWanteds</span> <span class='hs-varid'>sigs</span>
<a name="line-566"></a>                  <span class='hs-comment'>-- the False says we don't really need to solve all Deriveds</span>
<a name="line-567"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-568"></a>                <span class='hs-varid'>solveWanteds</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanteds</span> <span class='hs-varop'>`addSimples`</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>sig_derived</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-569"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanted_transformed_incl_derivs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkWC</span> <span class='hs-varid'>wanted_transformed_incl_derivs</span>
<a name="line-570"></a>
<a name="line-571"></a>       <span class='hs-comment'>-- Find quant_pred_candidates, the predicates that</span>
<a name="line-572"></a>       <span class='hs-comment'>-- we'll consider quantifying over</span>
<a name="line-573"></a>       <span class='hs-comment'>-- NB: We do not do any defaulting when inferring a type, this can lead</span>
<a name="line-574"></a>       <span class='hs-comment'>-- to less polymorphic types, see Note [Default while Inferring]</span>
<a name="line-575"></a>
<a name="line-576"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-577"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wanted_transformed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropDerivedWC</span> <span class='hs-varid'>wanted_transformed_incl_derivs</span>
<a name="line-578"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quant_pred_candidates</span>   <span class='hs-comment'>-- Fully zonked</span>
<a name="line-579"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>rhs_tclvl</span> <span class='hs-varid'>wanted_transformed_incl_derivs</span>
<a name="line-580"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>   <span class='hs-comment'>-- See Note [Quantification with errors]</span>
<a name="line-581"></a>                               <span class='hs-comment'>-- NB: must include derived errors in this test,</span>
<a name="line-582"></a>                               <span class='hs-comment'>--     hence "incl_derivs"</span>
<a name="line-583"></a>
<a name="line-584"></a>              <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>quant_cand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>approximateWC</span> <span class='hs-conid'>False</span> <span class='hs-varid'>wanted_transformed</span>
<a name="line-585"></a>                            <span class='hs-varid'>meta_tvs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varop'>$</span>
<a name="line-586"></a>                                         <span class='hs-varid'>tyCoVarsOfCtsList</span> <span class='hs-varid'>quant_cand</span>
<a name="line-587"></a>
<a name="line-588"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span>
<a name="line-589"></a>                            <span class='hs-comment'>-- Miminise quant_cand.  We are not interested in any evidence</span>
<a name="line-590"></a>                            <span class='hs-comment'>-- produced, because we are going to simplify wanted_transformed</span>
<a name="line-591"></a>                            <span class='hs-comment'>-- again later. All we want here are the predicates over which to</span>
<a name="line-592"></a>                            <span class='hs-comment'>-- quantify.</span>
<a name="line-593"></a>                            <span class='hs-comment'>--</span>
<a name="line-594"></a>                            <span class='hs-comment'>-- If any meta-tyvar unifications take place (unlikely),</span>
<a name="line-595"></a>                            <span class='hs-comment'>-- we'll pick that up later.</span>
<a name="line-596"></a>
<a name="line-597"></a>                      <span class='hs-comment'>-- See Note [Promote _and_ default when inferring]</span>
<a name="line-598"></a>                      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>def_tyvar</span> <span class='hs-varid'>tv</span>
<a name="line-599"></a>                              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>gbl_tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-600"></a>                                <span class='hs-varid'>defaultTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-601"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>def_tyvar</span> <span class='hs-varid'>meta_tvs</span>
<a name="line-602"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteTyVar</span> <span class='hs-varid'>rhs_tclvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>meta_tvs</span>
<a name="line-603"></a>
<a name="line-604"></a>                      <span class='hs-layout'>;</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span> <span class='hs-layout'>}</span>
<a name="line-605"></a>                           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setTcLevel</span> <span class='hs-varid'>rhs_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-606"></a>                              <span class='hs-varid'>runTcSDeriveds</span>       <span class='hs-varop'>$</span>
<a name="line-607"></a>                              <span class='hs-varid'>solveSimpleWanteds</span>   <span class='hs-varop'>$</span>
<a name="line-608"></a>                              <span class='hs-varid'>mapBag</span> <span class='hs-varid'>toDerivedCt</span> <span class='hs-varid'>quant_cand</span>
<a name="line-609"></a>                                <span class='hs-comment'>-- NB: we don't want evidence,</span>
<a name="line-610"></a>                                <span class='hs-comment'>-- so use Derived constraints</span>
<a name="line-611"></a>
<a name="line-612"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>simples</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkSimples</span> <span class='hs-varid'>simples</span>
<a name="line-613"></a>
<a name="line-614"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>simples</span>
<a name="line-615"></a>                                             <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-616"></a>
<a name="line-617"></a>       <span class='hs-comment'>-- NB: quant_pred_candidates is already fully zonked</span>
<a name="line-618"></a>
<a name="line-619"></a>       <span class='hs-comment'>-- Decide what type variables and constraints to quantify</span>
<a name="line-620"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_taus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcType</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>name_taus</span>
<a name="line-621"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>zonked_tau_dvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitDepVarsOfTypes</span> <span class='hs-varid'>zonked_taus</span>
<a name="line-622"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bound_theta</span><span class='hs-layout'>)</span>
<a name="line-623"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>decideQuantification</span> <span class='hs-varid'>apply_mr</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>name_taus</span>
<a name="line-624"></a>                                   <span class='hs-varid'>quant_pred_candidates</span> <span class='hs-varid'>zonked_tau_dvs</span>
<a name="line-625"></a>
<a name="line-626"></a>         <span class='hs-comment'>-- Promote any type variables that are free in the inferred type</span>
<a name="line-627"></a>         <span class='hs-comment'>-- of the function:</span>
<a name="line-628"></a>         <span class='hs-comment'>--    f :: forall qtvs. bound_theta =&gt; zonked_tau</span>
<a name="line-629"></a>         <span class='hs-comment'>-- These variables now become free in the envt, and hence will show</span>
<a name="line-630"></a>         <span class='hs-comment'>-- up whenever 'f' is called.  They may currently at rhs_tclvl, but</span>
<a name="line-631"></a>         <span class='hs-comment'>-- they had better be unifiable at the outer_tclvl!</span>
<a name="line-632"></a>         <span class='hs-comment'>-- Example:   envt mentions alpha[1]</span>
<a name="line-633"></a>         <span class='hs-comment'>--            tau_ty = beta[2] -&gt; beta[2]</span>
<a name="line-634"></a>         <span class='hs-comment'>--            consraints = alpha ~ [beta]</span>
<a name="line-635"></a>         <span class='hs-comment'>-- we don't quantify over beta (since it is fixed by envt)</span>
<a name="line-636"></a>         <span class='hs-comment'>-- so we must promote it!  The inferred type is just</span>
<a name="line-637"></a>         <span class='hs-comment'>--   f :: beta -&gt; beta</span>
<a name="line-638"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonked_tau_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTyCoVarsAndFV</span> <span class='hs-varop'>$</span>
<a name="line-639"></a>                            <span class='hs-varid'>dVarSetToVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>dv_kvs</span> <span class='hs-varid'>zonked_tau_dvs</span><span class='hs-layout'>)</span>
<a name="line-640"></a>                            <span class='hs-varop'>`unionVarSet`</span>
<a name="line-641"></a>                            <span class='hs-varid'>dVarSetToVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>dv_tvs</span> <span class='hs-varid'>zonked_tau_dvs</span><span class='hs-layout'>)</span>
<a name="line-642"></a>              <span class='hs-comment'>-- decideQuantification turned some meta tyvars into</span>
<a name="line-643"></a>              <span class='hs-comment'>-- quantified skolems, so we have to zonk again</span>
<a name="line-644"></a>
<a name="line-645"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>phi_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>bound_theta</span>  <span class='hs-comment'>-- Already zonked</span>
<a name="line-646"></a>                        <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>zonked_tau_tkvs</span>
<a name="line-647"></a>             <span class='hs-varid'>promote_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>closeOverKinds</span> <span class='hs-varid'>phi_tkvs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>qtvs</span>
<a name="line-648"></a>
<a name="line-649"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>MASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>closeOverKinds</span> <span class='hs-varid'>promote_tkvs</span> <span class='hs-varop'>`subVarSet`</span> <span class='hs-varid'>promote_tkvs</span>
<a name="line-650"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>phi_tkvs</span> <span class='hs-varop'>$$</span>
<a name="line-651"></a>                   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>closeOverKinds</span> <span class='hs-varid'>phi_tkvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-652"></a>                   <span class='hs-varid'>ppr</span> <span class='hs-varid'>promote_tkvs</span> <span class='hs-varop'>$$</span>
<a name="line-653"></a>                   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>closeOverKinds</span> <span class='hs-varid'>promote_tkvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-654"></a>           <span class='hs-comment'>-- we really don't want a type to be promoted when its kind isn't!</span>
<a name="line-655"></a>
<a name="line-656"></a>           <span class='hs-comment'>-- promoteTyVar ignores coercion variables</span>
<a name="line-657"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>outer_tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-658"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteTyVar</span> <span class='hs-varid'>outer_tclvl</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>promote_tkvs</span><span class='hs-layout'>)</span>
<a name="line-659"></a>
<a name="line-660"></a>           <span class='hs-comment'>-- Emit an implication constraint for the</span>
<a name="line-661"></a>           <span class='hs-comment'>-- remaining constraints from the RHS</span>
<a name="line-662"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bound_theta_vars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>bound_theta</span>
<a name="line-663"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InferSkol</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>bound_theta</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-664"></a>                                     <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>name_taus</span> <span class='hs-keyglyph'>]</span>
<a name="line-665"></a>                        <span class='hs-comment'>-- Don't add the quantified variables here, because</span>
<a name="line-666"></a>                        <span class='hs-comment'>-- they are also bound in ic_skols and we want them</span>
<a name="line-667"></a>                        <span class='hs-comment'>-- to be tidied uniformly</span>
<a name="line-668"></a>
<a name="line-669"></a>             <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_tclvl</span>
<a name="line-670"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qtvs</span>
<a name="line-671"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-672"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bound_theta_vars</span>
<a name="line-673"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted_transformed</span>
<a name="line-674"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_status</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Unsolved</span>
<a name="line-675"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-676"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span>
<a name="line-677"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lcl_env</span> <span class='hs-layout'>}</span>
<a name="line-678"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varid'>implic</span>
<a name="line-679"></a>
<a name="line-680"></a>         <span class='hs-comment'>-- All done!</span>
<a name="line-681"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"} simplifyInfer/produced residual implication for quantification"</span> <span class='hs-varop'>$</span>
<a name="line-682"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"quant_pred_candidates ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>quant_pred_candidates</span>
<a name="line-683"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"zonked_taus"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zonked_taus</span>
<a name="line-684"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"zonked_tau_dvs="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zonked_tau_dvs</span>
<a name="line-685"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"promote_tvs="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>promote_tkvs</span>
<a name="line-686"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"bound_theta ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bound_theta</span>
<a name="line-687"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"qtvs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>qtvs</span>
<a name="line-688"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implic ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>]</span>
<a name="line-689"></a>
<a name="line-690"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bound_theta_vars</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-691"></a>
<a name="line-692"></a><a name="mkSigDerivedWanteds"></a><span class='hs-definition'>mkSigDerivedWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcIdSigInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-693"></a><span class='hs-comment'>-- See Note [Add deriveds for signature contexts]</span>
<a name="line-694"></a><span class='hs-definition'>mkSigDerivedWanteds</span> <span class='hs-layout'>(</span><span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-695"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>sig_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tau</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-696"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InferSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSigmaTy</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-697"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCtLocM</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>skol_info</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>TypeLevel</span><span class='hs-layout'>)</span>
<a name="line-698"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span>
<a name="line-699"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-700"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-701"></a><span class='hs-definition'>mkSigDerivedWanteds</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-702"></a>
<a name="line-703"></a><span class='hs-comment'>{- Note [Add deriveds for signature contexts]
<a name="line-704"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-705"></a>Consider this (Trac #11016):
<a name="line-706"></a>  f2 :: (?x :: Int) =&gt; _
<a name="line-707"></a>  f2 = ?x
<a name="line-708"></a>We'll use plan InferGen because there are holes in the type.  But we want
<a name="line-709"></a>to have the (?x :: Int) constraint floating around so that the functional
<a name="line-710"></a>dependencies kick in.  Otherwise the occurrence of ?x on the RHS produces
<a name="line-711"></a>constraint (?x :: alpha), and we wont unify alpha:=Int.
<a name="line-712"></a>
<a name="line-713"></a>Solution: in simplifyInfer, just before simplifying the constraints
<a name="line-714"></a>gathered from the RHS, add Derived constraints for the context of any
<a name="line-715"></a>type signatures.  This is rare; if there is a type signature we'll usually
<a name="line-716"></a>be doing CheckGen.  But it happens for signatures with holes.
<a name="line-717"></a>
<a name="line-718"></a>************************************************************************
<a name="line-719"></a>*                                                                      *
<a name="line-720"></a>                Quantification
<a name="line-721"></a>*                                                                      *
<a name="line-722"></a>************************************************************************
<a name="line-723"></a>
<a name="line-724"></a>Note [Deciding quantification]
<a name="line-725"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-726"></a>If the monomorphism restriction does not apply, then we quantify as follows:
<a name="line-727"></a>  * Take the global tyvars, and "grow" them using the equality constraints
<a name="line-728"></a>    E.g.  if x:alpha is in the environment, and alpha ~ [beta] (which can
<a name="line-729"></a>          happen because alpha is untouchable here) then do not quantify over
<a name="line-730"></a>          beta, because alpha fixes beta, and beta is effectively free in
<a name="line-731"></a>          the environment too
<a name="line-732"></a>    These are the mono_tvs
<a name="line-733"></a>
<a name="line-734"></a>  * Take the free vars of the tau-type (zonked_tau_tvs) and "grow" them
<a name="line-735"></a>    using all the constraints.  These are tau_tvs_plus
<a name="line-736"></a>
<a name="line-737"></a>  * Use quantifyTyVars to quantify over (tau_tvs_plus - mono_tvs), being
<a name="line-738"></a>    careful to close over kinds, and to skolemise the quantified tyvars.
<a name="line-739"></a>    (This actually unifies each quantifies meta-tyvar with a fresh skolem.)
<a name="line-740"></a>    Result is qtvs.
<a name="line-741"></a>
<a name="line-742"></a>  * Filter the constraints using pickQuantifiablePreds and the qtvs.
<a name="line-743"></a>    We have to zonk the constraints first, so they "see" the freshly
<a name="line-744"></a>    created skolems.
<a name="line-745"></a>
<a name="line-746"></a>If the MR does apply, mono_tvs includes all the constrained tyvars --
<a name="line-747"></a>including all covars -- and the quantified constraints are empty/insoluble.
<a name="line-748"></a>
<a name="line-749"></a>-}</span>
<a name="line-750"></a>
<a name="line-751"></a><a name="decideQuantification"></a><span class='hs-definition'>decideQuantification</span>
<a name="line-752"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                  <span class='hs-comment'>-- try the MR restriction?</span>
<a name="line-753"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdSigInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-754"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTauType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- variables to be generalised (for errors only)</span>
<a name="line-755"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>            <span class='hs-comment'>-- candidate theta</span>
<a name="line-756"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcDepVars</span>
<a name="line-757"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Quantify over these (skolems)</span>
<a name="line-758"></a>         <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>    <span class='hs-comment'>-- and this context (fully zonked)</span>
<a name="line-759"></a><span class='hs-comment'>-- See Note [Deciding quantification]</span>
<a name="line-760"></a><span class='hs-definition'>decideQuantification</span> <span class='hs-varid'>apply_mr</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>name_taus</span> <span class='hs-varid'>constraints</span>
<a name="line-761"></a>                     <span class='hs-varid'>zonked_dvs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dv_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonked_tau_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dv_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonked_tau_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-762"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>apply_mr</span>     <span class='hs-comment'>-- Apply the Monomorphism restriction</span>
<a name="line-763"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span>
<a name="line-764"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>zonked_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dVarSetToVarSet</span> <span class='hs-varid'>zonked_tau_kvs</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-765"></a>                           <span class='hs-varid'>dVarSetToVarSet</span> <span class='hs-varid'>zonked_tau_tvs</span>
<a name="line-766"></a>             <span class='hs-varid'>constrained_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>constraints</span> <span class='hs-varop'>`unionVarSet`</span>
<a name="line-767"></a>                               <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>zonked_tkvs</span>
<a name="line-768"></a>             <span class='hs-varid'>mono_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>constrained_tvs</span>
<a name="line-769"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>qtvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quantify_tvs</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>mono_tvs</span> <span class='hs-varid'>zonked_dvs</span>
<a name="line-770"></a>
<a name="line-771"></a>           <span class='hs-comment'>-- Warn about the monomorphism restriction</span>
<a name="line-772"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warn_mono</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnMonomorphism</span>
<a name="line-773"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mr_bites</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>constrained_tvs</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>zonked_tkvs</span>
<a name="line-774"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warnTc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnMonomorphism</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>warn_mono</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>mr_bites</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-775"></a>         <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"The Monomorphism Restriction applies to the binding"</span>
<a name="line-776"></a>               <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_bndrs</span><span class='hs-layout'>)</span>
<a name="line-777"></a>             <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Consider giving a type signature for"</span>
<a name="line-778"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>pp_bndrs</span>
<a name="line-779"></a>                                         <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"these binders"</span><span class='hs-layout'>)</span>
<a name="line-780"></a>
<a name="line-781"></a>       <span class='hs-comment'>-- All done</span>
<a name="line-782"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"decideQuantification 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>constraints</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>gbl_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mono_tvs</span>
<a name="line-783"></a>                                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mr_bites</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-784"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-785"></a>
<a name="line-786"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-787"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyCoVars</span>
<a name="line-788"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mono_tvs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>growThetaTyVars</span> <span class='hs-varid'>equality_constraints</span> <span class='hs-varid'>gbl_tvs</span>
<a name="line-789"></a>             <span class='hs-varid'>tau_tvs_plus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>growThetaTyVarsDSet</span> <span class='hs-varid'>constraints</span> <span class='hs-varid'>zonked_tau_tvs</span>
<a name="line-790"></a>             <span class='hs-varid'>dvs_plus</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DV</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dv_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonked_tau_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dv_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau_tvs_plus</span> <span class='hs-layout'>}</span>
<a name="line-791"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>qtvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quantify_tvs</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>mono_tvs</span> <span class='hs-varid'>dvs_plus</span>
<a name="line-792"></a>          <span class='hs-comment'>-- We don't grow the kvs, as there's no real need to. Recall</span>
<a name="line-793"></a>          <span class='hs-comment'>-- that quantifyTyVars uses the separation between kvs and tvs</span>
<a name="line-794"></a>          <span class='hs-comment'>-- only for defaulting, and we don't want (ever) to default a tv</span>
<a name="line-795"></a>          <span class='hs-comment'>-- to *. So, don't grow the kvs.</span>
<a name="line-796"></a>
<a name="line-797"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>constraints</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcTypes</span> <span class='hs-varid'>constraints</span>
<a name="line-798"></a>                 <span class='hs-comment'>-- quantiyTyVars turned some meta tyvars into</span>
<a name="line-799"></a>                 <span class='hs-comment'>-- quantified skolems, so we have to zonk again</span>
<a name="line-800"></a>
<a name="line-801"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>theta</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pickQuantifiablePreds</span>
<a name="line-802"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>qtvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>concatMap</span> <span class='hs-varid'>sig_theta</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span> <span class='hs-varid'>constraints</span>
<a name="line-803"></a>             <span class='hs-varid'>min_theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMinimalBySCs</span> <span class='hs-varid'>theta</span>
<a name="line-804"></a>               <span class='hs-comment'>-- See Note [Minimize by Superclasses]</span>
<a name="line-805"></a>
<a name="line-806"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"decideQuantification 2"</span>
<a name="line-807"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"constraints:"</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>constraints</span>
<a name="line-808"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"gbl_tvs:"</span>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>gbl_tvs</span>
<a name="line-809"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"mono_tvs:"</span>     <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mono_tvs</span>
<a name="line-810"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"zonked_kvs:"</span>   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>zonked_tau_kvs</span>
<a name="line-811"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tau_tvs_plus:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau_tvs_plus</span>
<a name="line-812"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"qtvs:"</span>         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>qtvs</span>
<a name="line-813"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"min_theta:"</span>    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>min_theta</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-814"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>qtvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>min_theta</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-815"></a>  <span class='hs-keyword'>where</span>
<a name="line-816"></a>    <span class='hs-varid'>bndrs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>name_taus</span>
<a name="line-817"></a>    <span class='hs-varid'>pp_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndrs</span>
<a name="line-818"></a>    <span class='hs-varid'>equality_constraints</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isEqPred</span> <span class='hs-varid'>constraints</span>
<a name="line-819"></a>
<a name="line-820"></a><a name="quantify_tvs"></a><span class='hs-definition'>quantify_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdSigInfo</span><span class='hs-keyglyph'>]</span>
<a name="line-821"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span>   <span class='hs-comment'>-- the monomorphic tvs</span>
<a name="line-822"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcDepVars</span>
<a name="line-823"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-824"></a><span class='hs-comment'>-- See Note [Which type variables to quantify]</span>
<a name="line-825"></a><span class='hs-definition'>quantify_tvs</span> <span class='hs-varid'>sigs</span> <span class='hs-varid'>mono_tvs</span> <span class='hs-varid'>dep_tvs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dv_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-826"></a>   <span class='hs-comment'>-- NB: don't use quantifyZonkedTyVars because the sig stuff might</span>
<a name="line-827"></a>   <span class='hs-comment'>-- be unzonked</span>
<a name="line-828"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>mono_tvs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>sig_qtvs</span><span class='hs-layout'>)</span>
<a name="line-829"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>dep_tvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dv_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau_tvs</span> <span class='hs-varop'>`extendDVarSetList`</span> <span class='hs-varid'>sig_qtvs</span>
<a name="line-830"></a>                                               <span class='hs-varop'>`extendDVarSetList`</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-831"></a>                   <span class='hs-comment'>-- NB: quantifyTyVars zonks its arguments</span>
<a name="line-832"></a>  <span class='hs-keyword'>where</span>
<a name="line-833"></a>    <span class='hs-varid'>sig_qtvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>skol</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>skol</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_skols</span> <span class='hs-varid'>sig</span> <span class='hs-keyglyph'>]</span>
<a name="line-834"></a>    <span class='hs-varid'>sig_wcs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>wc</span>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TISI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PartialSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sigs</span>
<a name="line-835"></a>                      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>]</span>
<a name="line-836"></a>
<a name="line-837"></a>
<a name="line-838"></a><a name="growThetaTyVars"></a><span class='hs-comment'>------------------</span>
<a name="line-839"></a><span class='hs-definition'>growThetaTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarSet</span>
<a name="line-840"></a><span class='hs-comment'>-- See Note [Growing the tau-tvs using constraints]</span>
<a name="line-841"></a><span class='hs-comment'>-- NB: only returns tyvars, never covars</span>
<a name="line-842"></a><span class='hs-definition'>growThetaTyVars</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tvs</span>
<a name="line-843"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs_only</span>
<a name="line-844"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span>
<a name="line-845"></a>                 <span class='hs-varid'>transCloVarSet</span> <span class='hs-varid'>mk_next</span> <span class='hs-varid'>seed_tvs</span>
<a name="line-846"></a>  <span class='hs-keyword'>where</span>
<a name="line-847"></a>    <span class='hs-varid'>tvs_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span>
<a name="line-848"></a>    <span class='hs-varid'>seed_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>ips</span>
<a name="line-849"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_ips</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isIPPred</span> <span class='hs-varid'>theta</span>
<a name="line-850"></a>                         <span class='hs-comment'>-- See Note [Inheriting implicit parameters] in TcType</span>
<a name="line-851"></a>
<a name="line-852"></a>    <span class='hs-varid'>mk_next</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-comment'>-- Maps current set to newly-grown ones</span>
<a name="line-853"></a>    <span class='hs-varid'>mk_next</span> <span class='hs-varid'>so_far</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>grow_one</span> <span class='hs-varid'>so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>non_ips</span>
<a name="line-854"></a>    <span class='hs-varid'>grow_one</span> <span class='hs-varid'>so_far</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>tvs</span>
<a name="line-855"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>pred_tvs</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>so_far</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>pred_tvs</span>
<a name="line-856"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-857"></a>       <span class='hs-keyword'>where</span>
<a name="line-858"></a>         <span class='hs-varid'>pred_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>pred</span>
<a name="line-859"></a>
<a name="line-860"></a><a name="growThetaTyVarsDSet"></a><span class='hs-comment'>------------------</span>
<a name="line-861"></a><span class='hs-definition'>growThetaTyVarsDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyVarSet</span>
<a name="line-862"></a><span class='hs-comment'>-- See Note [Growing the tau-tvs using constraints]</span>
<a name="line-863"></a><span class='hs-comment'>-- NB: only returns tyvars, never covars</span>
<a name="line-864"></a><span class='hs-comment'>-- It takes a deterministic set of TyCoVars and returns a deterministic set</span>
<a name="line-865"></a><span class='hs-comment'>-- of TyVars.</span>
<a name="line-866"></a><span class='hs-comment'>-- The implementation mirrors growThetaTyVars, the only difference is that</span>
<a name="line-867"></a><span class='hs-comment'>-- it avoids unionDVarSet and uses more efficient extendDVarSetList.</span>
<a name="line-868"></a><span class='hs-definition'>growThetaTyVarsDSet</span> <span class='hs-varid'>theta</span> <span class='hs-varid'>tvs</span>
<a name="line-869"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs_only</span>
<a name="line-870"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterDVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varop'>$</span>
<a name="line-871"></a>                 <span class='hs-varid'>transCloDVarSet</span> <span class='hs-varid'>mk_next</span> <span class='hs-varid'>seed_tvs</span>
<a name="line-872"></a>  <span class='hs-keyword'>where</span>
<a name="line-873"></a>    <span class='hs-varid'>tvs_only</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterDVarSet</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span>
<a name="line-874"></a>    <span class='hs-varid'>seed_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`extendDVarSetList`</span> <span class='hs-varid'>tyCoVarsOfTypesList</span> <span class='hs-varid'>ips</span>
<a name="line-875"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_ips</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isIPPred</span> <span class='hs-varid'>theta</span>
<a name="line-876"></a>                         <span class='hs-comment'>-- See Note [Inheriting implicit parameters] in TcType</span>
<a name="line-877"></a>
<a name="line-878"></a>    <span class='hs-varid'>mk_next</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DVarSet</span> <span class='hs-comment'>-- Maps current set to newly-grown ones</span>
<a name="line-879"></a>    <span class='hs-varid'>mk_next</span> <span class='hs-varid'>so_far</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>grow_one</span> <span class='hs-varid'>so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyDVarSet</span> <span class='hs-varid'>non_ips</span>
<a name="line-880"></a>    <span class='hs-varid'>grow_one</span> <span class='hs-varid'>so_far</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>tvs</span>
<a name="line-881"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemDVarSet`</span> <span class='hs-varid'>so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>pred_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`extendDVarSetList`</span> <span class='hs-varid'>pred_tvs</span>
<a name="line-882"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-883"></a>       <span class='hs-keyword'>where</span>
<a name="line-884"></a>         <span class='hs-varid'>pred_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypeList</span> <span class='hs-varid'>pred</span>
<a name="line-885"></a>
<a name="line-886"></a><span class='hs-comment'>{- Note [Which type variables to quantify]
<a name="line-887"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-888"></a>When choosing type variables to quantify, the basic plan is to
<a name="line-889"></a>quantify over all type variables that are
<a name="line-890"></a> * free in the tau_tvs, and
<a name="line-891"></a> * not forced to be monomorphic (mono_tvs),
<a name="line-892"></a>   for example by being free in the environment.
<a name="line-893"></a>
<a name="line-894"></a>However, for a pattern binding, or with wildcards, we might
<a name="line-895"></a>be doing inference *in the presence of a type signature*.
<a name="line-896"></a>Mostly, if there is a signature we use CheckGen, not InferGen,
<a name="line-897"></a>but with pattern bindings or wildcards we might do InferGen
<a name="line-898"></a>and still have a type signature.  For example:
<a name="line-899"></a>   f :: _ -&gt; a
<a name="line-900"></a>   f x = ...
<a name="line-901"></a>or
<a name="line-902"></a>   g :: (Eq _a) =&gt; _b -&gt; _b
<a name="line-903"></a>or
<a name="line-904"></a>   p :: a -&gt; a
<a name="line-905"></a>   (p,q) = e
<a name="line-906"></a>In all these cases we use plan InferGen, and hence call simplifyInfer.
<a name="line-907"></a>But those 'a' variables are skolems, and we should be sure to quantify
<a name="line-908"></a>over them, regardless of the monomorphism restriction etc.  If we
<a name="line-909"></a>don't, when reporting a type error we panic when we find that a
<a name="line-910"></a>skolem isn't bound by any enclosing implication.
<a name="line-911"></a>
<a name="line-912"></a>Moreover we must quantify over all wildcards that are not free in
<a name="line-913"></a>the environment.  In the case of 'g' for example, silly though it is,
<a name="line-914"></a>we want to get the inferred type
<a name="line-915"></a>   g :: forall t. Eq t =&gt; Int -&gt; Int
<a name="line-916"></a>and then report ambiguity, rather than *not* quantifying over 't'
<a name="line-917"></a>and getting some much more mysterious error later.  A similar case
<a name="line-918"></a>is
<a name="line-919"></a>  h :: F _a -&gt; Int
<a name="line-920"></a>
<a name="line-921"></a>That's why we pass sigs to simplifyInfer, and make sure (in
<a name="line-922"></a>quantify_tvs) that we do quantify over them.  Trac #10615 is
<a name="line-923"></a>a case in point.
<a name="line-924"></a>
<a name="line-925"></a>Note [Quantifying over equality constraints]
<a name="line-926"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-927"></a>Should we quantify over an equality constraint (s ~ t)?  In general, we don't.
<a name="line-928"></a>Doing so may simply postpone a type error from the function definition site to
<a name="line-929"></a>its call site.  (At worst, imagine (Int ~ Bool)).
<a name="line-930"></a>
<a name="line-931"></a>However, consider this
<a name="line-932"></a>         forall a. (F [a] ~ Int) =&gt; blah
<a name="line-933"></a>Should we quantify over the (F [a] ~ Int)?  Perhaps yes, because at the call
<a name="line-934"></a>site we will know 'a', and perhaps we have instance  F [Bool] = Int.
<a name="line-935"></a>So we *do* quantify over a type-family equality where the arguments mention
<a name="line-936"></a>the quantified variables.
<a name="line-937"></a>
<a name="line-938"></a>Note [Growing the tau-tvs using constraints]
<a name="line-939"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-940"></a>(growThetaTyVars insts tvs) is the result of extending the set
<a name="line-941"></a>    of tyvars, tvs, using all conceivable links from pred
<a name="line-942"></a>
<a name="line-943"></a>E.g. tvs = {a}, preds = {H [a] b, K (b,Int) c, Eq e}
<a name="line-944"></a>Then growThetaTyVars preds tvs = {a,b,c}
<a name="line-945"></a>
<a name="line-946"></a>Notice that
<a name="line-947"></a>   growThetaTyVars is conservative       if v might be fixed by vs
<a name="line-948"></a>                                         =&gt; v `elem` grow(vs,C)
<a name="line-949"></a>
<a name="line-950"></a>Note [Quantification with errors]
<a name="line-951"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-952"></a>If we find that the RHS of the definition has some absolutely-insoluble
<a name="line-953"></a>constraints, we abandon all attempts to find a context to quantify
<a name="line-954"></a>over, and instead make the function fully-polymorphic in whatever
<a name="line-955"></a>type we have found.  For two reasons
<a name="line-956"></a>  a) Minimise downstream errors
<a name="line-957"></a>  b) Avoid spurious errors from this function
<a name="line-958"></a>
<a name="line-959"></a>But NB that we must include *derived* errors in the check. Example:
<a name="line-960"></a>    (a::*) ~ Int#
<a name="line-961"></a>We get an insoluble derived error *~#, and we don't want to discard
<a name="line-962"></a>it before doing the isInsolubleWC test!  (Trac #8262)
<a name="line-963"></a>
<a name="line-964"></a>Note [Default while Inferring]
<a name="line-965"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-966"></a>Our current plan is that defaulting only happens at simplifyTop and
<a name="line-967"></a>not simplifyInfer.  This may lead to some insoluble deferred constraints.
<a name="line-968"></a>Example:
<a name="line-969"></a>
<a name="line-970"></a>instance D g =&gt; C g Int b
<a name="line-971"></a>
<a name="line-972"></a>constraint inferred = (forall b. 0 =&gt; C gamma alpha b) /\ Num alpha
<a name="line-973"></a>type inferred       = gamma -&gt; gamma
<a name="line-974"></a>
<a name="line-975"></a>Now, if we try to default (alpha := Int) we will be able to refine the implication to
<a name="line-976"></a>  (forall b. 0 =&gt; C gamma Int b)
<a name="line-977"></a>which can then be simplified further to
<a name="line-978"></a>  (forall b. 0 =&gt; D gamma)
<a name="line-979"></a>Finally, we /can/ approximate this implication with (D gamma) and infer the quantified
<a name="line-980"></a>type:  forall g. D g =&gt; g -&gt; g
<a name="line-981"></a>
<a name="line-982"></a>Instead what will currently happen is that we will get a quantified type
<a name="line-983"></a>(forall g. g -&gt; g) and an implication:
<a name="line-984"></a>       forall g. 0 =&gt; (forall b. 0 =&gt; C g alpha b) /\ Num alpha
<a name="line-985"></a>
<a name="line-986"></a>Which, even if the simplifyTop defaults (alpha := Int) we will still be left with an
<a name="line-987"></a>unsolvable implication:
<a name="line-988"></a>       forall g. 0 =&gt; (forall b. 0 =&gt; D g)
<a name="line-989"></a>
<a name="line-990"></a>The concrete example would be:
<a name="line-991"></a>       h :: C g a s =&gt; g -&gt; a -&gt; ST s a
<a name="line-992"></a>       f (x::gamma) = (\_ -&gt; x) (runST (h x (undefined::alpha)) + 1)
<a name="line-993"></a>
<a name="line-994"></a>But it is quite tedious to do defaulting and resolve the implication constraints, and
<a name="line-995"></a>we have not observed code breaking because of the lack of defaulting in inference, so
<a name="line-996"></a>we don't do it for now.
<a name="line-997"></a>
<a name="line-998"></a>
<a name="line-999"></a>
<a name="line-1000"></a>Note [Minimize by Superclasses]
<a name="line-1001"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1002"></a>When we quantify over a constraint, in simplifyInfer we need to
<a name="line-1003"></a>quantify over a constraint that is minimal in some sense: For
<a name="line-1004"></a>instance, if the final wanted constraint is (Eq alpha, Ord alpha),
<a name="line-1005"></a>we'd like to quantify over Ord alpha, because we can just get Eq alpha
<a name="line-1006"></a>from superclass selection from Ord alpha. This minimization is what
<a name="line-1007"></a>mkMinimalBySCs does. Then, simplifyInfer uses the minimal constraint
<a name="line-1008"></a>to check the original wanted.
<a name="line-1009"></a>
<a name="line-1010"></a>
<a name="line-1011"></a>Note [Avoid unnecessary constraint simplification]
<a name="line-1012"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1013"></a>    -------- NB NB NB (Jun 12) -------------
<a name="line-1014"></a>    This note not longer applies; see the notes with Trac #4361.
<a name="line-1015"></a>    But I'm leaving it in here so we remember the issue.)
<a name="line-1016"></a>    ----------------------------------------
<a name="line-1017"></a>When inferring the type of a let-binding, with simplifyInfer,
<a name="line-1018"></a>try to avoid unnecessarily simplifying class constraints.
<a name="line-1019"></a>Doing so aids sharing, but it also helps with delicate
<a name="line-1020"></a>situations like
<a name="line-1021"></a>
<a name="line-1022"></a>   instance C t =&gt; C [t] where ..
<a name="line-1023"></a>
<a name="line-1024"></a>   f :: C [t] =&gt; ....
<a name="line-1025"></a>   f x = let g y = ...(constraint C [t])...
<a name="line-1026"></a>         in ...
<a name="line-1027"></a>When inferring a type for 'g', we don't want to apply the
<a name="line-1028"></a>instance decl, because then we can't satisfy (C t).  So we
<a name="line-1029"></a>just notice that g isn't quantified over 't' and partition
<a name="line-1030"></a>the constraints before simplifying.
<a name="line-1031"></a>
<a name="line-1032"></a>This only half-works, but then let-generalisation only half-works.
<a name="line-1033"></a>
<a name="line-1034"></a>*********************************************************************************
<a name="line-1035"></a>*                                                                                 *
<a name="line-1036"></a>*                                 Main Simplifier                                 *
<a name="line-1037"></a>*                                                                                 *
<a name="line-1038"></a>***********************************************************************************
<a name="line-1039"></a>
<a name="line-1040"></a>-}</span>
<a name="line-1041"></a>
<a name="line-1042"></a><a name="simplifyWantedsTcM"></a><span class='hs-definition'>simplifyWantedsTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1043"></a><span class='hs-comment'>-- Solve the specified Wanted constraints</span>
<a name="line-1044"></a><span class='hs-comment'>-- Discard the evidence binds</span>
<a name="line-1045"></a><span class='hs-comment'>-- Discards all Derived stuff in result</span>
<a name="line-1046"></a><span class='hs-comment'>-- Postcondition: fully zonked and unflattened constraints</span>
<a name="line-1047"></a><span class='hs-definition'>simplifyWantedsTcM</span> <span class='hs-varid'>wanted</span>
<a name="line-1048"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyWantedsTcM {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-1049"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>solveWantedsAndDrop</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSimpleWC</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-1050"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkWC</span> <span class='hs-varid'>result</span>
<a name="line-1051"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"simplifyWantedsTcM }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-1052"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-1053"></a>
<a name="line-1054"></a><a name="solveWantedsAndDrop"></a><span class='hs-definition'>solveWantedsAndDrop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1055"></a><span class='hs-comment'>-- Since solveWanteds returns the residual WantedConstraints,</span>
<a name="line-1056"></a><span class='hs-comment'>-- it should always be called within a runTcS or something similar,</span>
<a name="line-1057"></a><span class='hs-comment'>-- Result is not zonked</span>
<a name="line-1058"></a><span class='hs-definition'>solveWantedsAndDrop</span> <span class='hs-varid'>wanted</span>
<a name="line-1059"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveWanteds</span> <span class='hs-varid'>wanted</span>
<a name="line-1060"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropDerivedWC</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1061"></a>
<a name="line-1062"></a><a name="solveWanteds"></a><span class='hs-definition'>solveWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1063"></a><span class='hs-comment'>-- so that the inert set doesn't mindlessly propagate.</span>
<a name="line-1064"></a><span class='hs-comment'>-- NB: wc_simples may be wanted /or/ derived now</span>
<a name="line-1065"></a><span class='hs-definition'>solveWanteds</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1066"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveWanteds {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-1067"></a>
<a name="line-1068"></a>         <span class='hs-comment'>-- Try the simple bit, including insolubles. Solving insolubles a</span>
<a name="line-1069"></a>         <span class='hs-comment'>-- second time round is a bit of a waste; but the code is simple</span>
<a name="line-1070"></a>         <span class='hs-comment'>-- and the program is wrong anyway, and we don't run the danger</span>
<a name="line-1071"></a>         <span class='hs-comment'>-- of adding Derived insolubles twice; see</span>
<a name="line-1072"></a>         <span class='hs-comment'>-- TcSMonad Note [Do not add duplicate derived insolubles]</span>
<a name="line-1073"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wc1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveSimpleWanteds</span> <span class='hs-varid'>simples</span>
<a name="line-1074"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_new_scs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSuperClasses</span> <span class='hs-varid'>wc1</span>
<a name="line-1075"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc1</span>
<a name="line-1076"></a>
<a name="line-1077"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>implics2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveNestedImplications</span> <span class='hs-layout'>(</span><span class='hs-varid'>implics</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>implics1</span><span class='hs-layout'>)</span>
<a name="line-1078"></a>
<a name="line-1079"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1080"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_wc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simpl_loop</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>solverIterations</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>floated_eqs</span> <span class='hs-varid'>no_new_scs</span>
<a name="line-1081"></a>                                <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics2</span>
<a name="line-1082"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>insols1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>
<a name="line-1084"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span>
<a name="line-1085"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveWanteds }"</span> <span class='hs-varop'>$</span>
<a name="line-1086"></a>                 <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"final wc ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_wc</span>
<a name="line-1087"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"current evbinds  ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>bb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1088"></a>
<a name="line-1089"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>final_wc</span> <span class='hs-layout'>}</span>
<a name="line-1090"></a>
<a name="line-1091"></a><a name="simpl_loop"></a><span class='hs-definition'>simpl_loop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntWithInf</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1092"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1093"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1094"></a><span class='hs-definition'>simpl_loop</span> <span class='hs-varid'>n</span> <span class='hs-varid'>limit</span> <span class='hs-varid'>floated_eqs</span> <span class='hs-varid'>no_new_scs</span>
<a name="line-1095"></a>           <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>floated_eqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_new_scs</span>
<a name="line-1097"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wc</span>  <span class='hs-comment'>-- Done!</span>
<a name="line-1098"></a>
<a name="line-1099"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`intGtLimit`</span> <span class='hs-varid'>limit</span>
<a name="line-1100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Add an error (not a warning) if we blow the limit,</span>
<a name="line-1101"></a>         <span class='hs-comment'>-- Typically if we blow the limit we are going to report some other error</span>
<a name="line-1102"></a>         <span class='hs-comment'>-- (an unsolved constraint), and we don't want that error to suppress</span>
<a name="line-1103"></a>         <span class='hs-comment'>-- the iteration limit warning!</span>
<a name="line-1104"></a>         <span class='hs-varid'>addErrTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"solveWanteds: too many iterations"</span>
<a name="line-1105"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"limit ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>limit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1106"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unsolved:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wc</span>
<a name="line-1107"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>floated_eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1108"></a>                          <span class='hs-varid'>text</span> <span class='hs-str'>"Floated equalities:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>floated_eqs</span>
<a name="line-1109"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-varid'>no_new_scs</span> <span class='hs-varop'>$</span>
<a name="line-1110"></a>                          <span class='hs-varid'>text</span> <span class='hs-str'>"New superclasses found"</span>
<a name="line-1111"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Set limit with -fconstraint-solver-iterations=n; n=0 for no limit"</span>
<a name="line-1112"></a>                  <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1113"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>}</span>
<a name="line-1114"></a>
<a name="line-1115"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1116"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n_floated</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lengthBag</span> <span class='hs-varid'>floated_eqs</span>
<a name="line-1117"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>csTraceTcS</span> <span class='hs-varop'>$</span>
<a name="line-1118"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"simpl_loop iteration="</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-1119"></a>         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"no new scs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>no_new_scs</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1120"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n_floated</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"floated eqs"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1121"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>int</span> <span class='hs-layout'>(</span><span class='hs-varid'>lengthBag</span> <span class='hs-varid'>simples</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"simples to solve"</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1122"></a>
<a name="line-1123"></a>       <span class='hs-comment'>-- solveSimples may make progress if either float_eqs hold</span>
<a name="line-1124"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reportUnifications</span> <span class='hs-varop'>$</span>
<a name="line-1125"></a>                          <span class='hs-varid'>solveSimpleWanteds</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>simples</span><span class='hs-layout'>)</span>
<a name="line-1126"></a>                               <span class='hs-comment'>-- Put floated_eqs first so they get solved first</span>
<a name="line-1127"></a>                               <span class='hs-comment'>-- NB: the floated_eqs may include /derived/ equalities</span>
<a name="line-1128"></a>                               <span class='hs-comment'>--     arising from fundeps inside an implication</span>
<a name="line-1129"></a>
<a name="line-1130"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_new_scs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSuperClasses</span> <span class='hs-varid'>wc1</span>
<a name="line-1131"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc1</span>
<a name="line-1132"></a>
<a name="line-1133"></a>       <span class='hs-comment'>-- We have already tried to solve the nested implications once</span>
<a name="line-1134"></a>       <span class='hs-comment'>-- Try again only if we have unified some meta-variables</span>
<a name="line-1135"></a>       <span class='hs-comment'>-- (which is a bit like adding more givens</span>
<a name="line-1136"></a>       <span class='hs-comment'>-- See Note [Cutting off simpl_loop]</span>
<a name="line-1137"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>implics2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>unifs1</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics1</span>
<a name="line-1138"></a>                                     <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span>
<a name="line-1139"></a>                                     <span class='hs-keyword'>else</span> <span class='hs-varid'>solveNestedImplications</span> <span class='hs-layout'>(</span><span class='hs-varid'>implics</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>implics1</span><span class='hs-layout'>)</span>
<a name="line-1140"></a>
<a name="line-1141"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>simpl_loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>limit</span> <span class='hs-varid'>floated_eqs2</span> <span class='hs-varid'>no_new_scs</span>
<a name="line-1142"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics2</span>
<a name="line-1143"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>insols1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1144"></a>
<a name="line-1145"></a><a name="expandSuperClasses"></a><span class='hs-definition'>expandSuperClasses</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>
<a name="line-1146"></a><span class='hs-comment'>-- If there are any unsolved wanteds, expand one step of superclasses for</span>
<a name="line-1147"></a><span class='hs-comment'>-- unsolved wanteds or givens</span>
<a name="line-1148"></a><span class='hs-comment'>-- See Note [The superclass story] in TcCanonical</span>
<a name="line-1149"></a><span class='hs-definition'>expandSuperClasses</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>anyBag</span> <span class='hs-varid'>superClassesMightHelp</span> <span class='hs-varid'>unsolved</span><span class='hs-layout'>)</span>
<a name="line-1151"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-1152"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"expandSuperClasses {"</span> <span class='hs-varid'>empty</span>
<a name="line-1154"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pending_wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumBagL</span> <span class='hs-varid'>get</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>unsolved</span>
<a name="line-1155"></a>             <span class='hs-varid'>get</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>isPendingScDict</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-1156"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>ct'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct'</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ct'</span><span class='hs-layout'>)</span>
<a name="line-1157"></a>                            <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc</span><span class='hs-layout'>,</span>     <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1158"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>pending_given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPendingScDicts</span>
<a name="line-1159"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>pending_given</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>pending_wanted</span>
<a name="line-1160"></a>         <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"End expandSuperClasses no-op }"</span> <span class='hs-varid'>empty</span>
<a name="line-1161"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1162"></a>         <span class='hs-keyword'>else</span>
<a name="line-1163"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_given</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeSuperClasses</span> <span class='hs-varid'>pending_given</span>
<a name="line-1164"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_insols</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveSimpleGivens</span> <span class='hs-varid'>new_given</span>
<a name="line-1165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wanted</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>makeSuperClasses</span> <span class='hs-varid'>pending_wanted</span>
<a name="line-1166"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"End expandSuperClasses }"</span>
<a name="line-1167"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Given:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pending_given</span>
<a name="line-1168"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Insols from given:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_insols</span>
<a name="line-1169"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Wanted:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_wanted</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1170"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved'</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>new_wanted</span>
<a name="line-1171"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>new_insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1172"></a>
<a name="line-1173"></a><a name="solveNestedImplications"></a><span class='hs-definition'>solveNestedImplications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-1174"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-1175"></a><span class='hs-comment'>-- Precondition: the TcS inerts may contain unsolved simples which have</span>
<a name="line-1176"></a><span class='hs-comment'>-- to be converted to givens before we go inside a nested implication.</span>
<a name="line-1177"></a><span class='hs-definition'>solveNestedImplications</span> <span class='hs-varid'>implics</span>
<a name="line-1178"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span>
<a name="line-1179"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveNestedImplications starting {"</span> <span class='hs-varid'>empty</span>
<a name="line-1182"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs_s</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_implics</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipBagM</span> <span class='hs-varid'>solveImplication</span> <span class='hs-varid'>implics</span>
<a name="line-1183"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>floated_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatBag</span> <span class='hs-varid'>floated_eqs_s</span>
<a name="line-1184"></a>
<a name="line-1185"></a>       <span class='hs-comment'>-- ... and we are back in the original TcS inerts</span>
<a name="line-1186"></a>       <span class='hs-comment'>-- Notice that the original includes the _insoluble_simples so it was safe to ignore</span>
<a name="line-1187"></a>       <span class='hs-comment'>-- them in the beginning of this function.</span>
<a name="line-1188"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveNestedImplications end }"</span> <span class='hs-varop'>$</span>
<a name="line-1189"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"all floated_eqs ="</span>  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>floated_eqs</span>
<a name="line-1190"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"unsolved_implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_implics</span> <span class='hs-keyglyph'>]</span>
<a name="line-1191"></a>
<a name="line-1192"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>catBagMaybes</span> <span class='hs-varid'>unsolved_implics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1193"></a>
<a name="line-1194"></a><a name="solveImplication"></a><span class='hs-definition'>solveImplication</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span>    <span class='hs-comment'>-- Wanted</span>
<a name="line-1195"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- All wanted or derived floated equalities: var = type</span>
<a name="line-1196"></a>                         <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Simplified implication (empty or singleton)</span>
<a name="line-1197"></a><span class='hs-comment'>-- Precondition: The TcS monad contains an empty worklist and given-only inerts</span>
<a name="line-1198"></a><span class='hs-comment'>-- which after trying to solve this implication we must restore to their original value</span>
<a name="line-1199"></a><span class='hs-definition'>solveImplication</span> <span class='hs-varid'>imp</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span>
<a name="line-1200"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m_ev_binds</span>
<a name="line-1201"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-1202"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_ids</span>
<a name="line-1203"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanteds</span>
<a name="line-1204"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span>
<a name="line-1205"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>status</span>
<a name="line-1206"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1207"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IC_Solved</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>status</span>
<a name="line-1208"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>imp</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Do nothing</span>
<a name="line-1209"></a>
<a name="line-1210"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Even for IC_Insoluble it is worth doing more work</span>
<a name="line-1211"></a>               <span class='hs-comment'>-- The insoluble stuff might be in one sub-implication</span>
<a name="line-1212"></a>               <span class='hs-comment'>-- and other unsolved goals in another; and we want to</span>
<a name="line-1213"></a>               <span class='hs-comment'>-- solve the latter as much as possible</span>
<a name="line-1214"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-1215"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveImplication {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>imp</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Inerts"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1216"></a>
<a name="line-1217"></a>         <span class='hs-comment'>-- Solve the nested constraints</span>
<a name="line-1218"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>no_given_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>given_insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>residual_wanted</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>used_tcvs</span><span class='hs-layout'>)</span>
<a name="line-1219"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nestImplicTcS</span> <span class='hs-varid'>m_ev_binds</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>skols</span> <span class='hs-varop'>++</span> <span class='hs-varid'>given_ids</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>$</span>
<a name="line-1220"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>loc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGivenLoc</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>info</span> <span class='hs-varid'>env</span>
<a name="line-1221"></a>                        <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGivens</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>given_ids</span>
<a name="line-1222"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>given_insols</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveSimpleGivens</span> <span class='hs-varid'>givens</span>
<a name="line-1223"></a>
<a name="line-1224"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>residual_wanted</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveWanteds</span> <span class='hs-varid'>wanteds</span>
<a name="line-1225"></a>                        <span class='hs-comment'>-- solveWanteds, *not* solveWantedsAndDrop, because</span>
<a name="line-1226"></a>                        <span class='hs-comment'>-- we want to retain derived equalities so we can float</span>
<a name="line-1227"></a>                        <span class='hs-comment'>-- them out in floatEqualities</span>
<a name="line-1228"></a>
<a name="line-1229"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>no_eqs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getNoGivenEqs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skols</span> <span class='hs-varid'>given_insols</span>
<a name="line-1230"></a>                        <span class='hs-comment'>-- Call getNoGivenEqs /after/ solveWanteds, because</span>
<a name="line-1231"></a>                        <span class='hs-comment'>-- solveWanteds can augment the givens, via expandSuperClasses,</span>
<a name="line-1232"></a>                        <span class='hs-comment'>-- to reveal given superclass equalities</span>
<a name="line-1233"></a>
<a name="line-1234"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>given_insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>residual_wanted</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1235"></a>
<a name="line-1236"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>residual_wanted</span><span class='hs-layout'>)</span>
<a name="line-1237"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>floatEqualities</span> <span class='hs-varid'>skols</span> <span class='hs-varid'>no_given_eqs</span> <span class='hs-varid'>residual_wanted</span>
<a name="line-1238"></a>
<a name="line-1239"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveImplication 2"</span>
<a name="line-1240"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>given_insols</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>residual_wanted</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>used_tcvs</span><span class='hs-layout'>)</span>
<a name="line-1241"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>final_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>residual_wanted</span> <span class='hs-varop'>`addInsols`</span> <span class='hs-varid'>given_insols</span>
<a name="line-1242"></a>
<a name="line-1243"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_implic</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setImplicationStatus</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_given_eqs</span>
<a name="line-1244"></a>                                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_wanted</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1245"></a>                                            <span class='hs-varid'>used_tcvs</span>
<a name="line-1246"></a>
<a name="line-1247"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>evbinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBindsMap</span>
<a name="line-1248"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"solveImplication end }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-1249"></a>             <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"no_given_eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>no_given_eqs</span>
<a name="line-1250"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"floated_eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>floated_eqs</span>
<a name="line-1251"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"res_implic ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_implic</span>
<a name="line-1252"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implication evbinds = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>evbinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1253"></a>
<a name="line-1254"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>floated_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_implic</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1255"></a>
<a name="line-1256"></a><a name="setImplicationStatus"></a><span class='hs-comment'>----------------------</span>
<a name="line-1257"></a><span class='hs-definition'>setImplicationStatus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>  <span class='hs-comment'>-- needed variables</span>
<a name="line-1258"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-1259"></a><span class='hs-comment'>-- Finalise the implication returned from solveImplication:</span>
<a name="line-1260"></a><span class='hs-comment'>--    * Set the ic_status field</span>
<a name="line-1261"></a><span class='hs-comment'>--    * Trim the ic_wanted field to remove Derived constraints</span>
<a name="line-1262"></a><span class='hs-comment'>-- Return Nothing if we can discard the implication altogether</span>
<a name="line-1263"></a><span class='hs-definition'>setImplicationStatus</span> <span class='hs-varid'>implic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m_ev_binds_var</span>
<a name="line-1264"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span>
<a name="line-1265"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lvl</span>
<a name="line-1266"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-1267"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1268"></a>                     <span class='hs-varid'>used_tcvs</span>
<a name="line-1269"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>some_insoluble</span>
<a name="line-1270"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span>
<a name="line-1271"></a>   <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Insoluble</span>
<a name="line-1272"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_simples</span>
<a name="line-1273"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_insols</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1274"></a>
<a name="line-1275"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>some_unsolved</span>
<a name="line-1276"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span>
<a name="line-1277"></a>   <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Unsolved</span>
<a name="line-1278"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_simples</span>
<a name="line-1279"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_insols</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1280"></a>
<a name="line-1281"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Everything is solved; look at the implications</span>
<a name="line-1282"></a>              <span class='hs-comment'>-- See Note [Tracking redundant constraints]</span>
<a name="line-1283"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>m_ev_binds_var</span> <span class='hs-keyword'>of</span>
<a name="line-1284"></a>                      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-varid'>ref</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-1285"></a>                      <span class='hs-conid'>Nothing</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>emptyEvBindMap</span>
<a name="line-1286"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_needs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>neededEvVars</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1287"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>used_tcvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>implic_needs</span><span class='hs-layout'>)</span>
<a name="line-1288"></a>
<a name="line-1289"></a>            <span class='hs-varid'>dead_givens</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>warnRedundantGivens</span> <span class='hs-varid'>info</span>
<a name="line-1290"></a>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>all_needs</span><span class='hs-layout'>)</span> <span class='hs-varid'>givens</span>
<a name="line-1291"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>   <span class='hs-comment'>-- None to report</span>
<a name="line-1292"></a>
<a name="line-1293"></a>            <span class='hs-varid'>final_needs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all_needs</span> <span class='hs-varop'>`delVarSetList`</span> <span class='hs-varid'>givens</span>
<a name="line-1294"></a>
<a name="line-1295"></a>            <span class='hs-varid'>discard_entire_implication</span>  <span class='hs-comment'>-- Can we discard the entire implication?</span>
<a name="line-1296"></a>              <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>null</span> <span class='hs-varid'>dead_givens</span>           <span class='hs-comment'>-- No warning from this implication</span>
<a name="line-1297"></a>              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>pruned_implics</span>  <span class='hs-comment'>-- No live children</span>
<a name="line-1298"></a>              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varid'>final_needs</span>  <span class='hs-comment'>-- No needed vars to pass up to parent</span>
<a name="line-1299"></a>
<a name="line-1300"></a>            <span class='hs-varid'>final_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC_Solved</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics_need</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_needs</span>
<a name="line-1301"></a>                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ics_dead</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dead_givens</span> <span class='hs-layout'>}</span>
<a name="line-1302"></a>            <span class='hs-varid'>final_implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_status</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>final_status</span>
<a name="line-1303"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_simples</span>
<a name="line-1304"></a>                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_insols</span>
<a name="line-1305"></a>                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pruned_implics</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1306"></a>               <span class='hs-comment'>-- We can only prune the child implications (pruned_implics)</span>
<a name="line-1307"></a>               <span class='hs-comment'>-- in the IC_Solved status case, because only then we can</span>
<a name="line-1308"></a>               <span class='hs-comment'>-- accumulate their needed evidence variales into the</span>
<a name="line-1309"></a>               <span class='hs-comment'>-- IC_Solved final_status field of the parent implication.</span>
<a name="line-1310"></a>
<a name="line-1311"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>discard_entire_implication</span>
<a name="line-1312"></a>                 <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-1313"></a>                 <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>final_implic</span> <span class='hs-layout'>}</span>
<a name="line-1314"></a> <span class='hs-keyword'>where</span>
<a name="line-1315"></a>   <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-1316"></a>
<a name="line-1317"></a>   <span class='hs-varid'>some_insoluble</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>wc</span>
<a name="line-1318"></a>   <span class='hs-varid'>some_unsolved</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>simples</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span>
<a name="line-1319"></a>                 <span class='hs-varop'>||</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_implic_needs</span>
<a name="line-1320"></a>
<a name="line-1321"></a>   <span class='hs-varid'>pruned_simples</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropDerivedSimples</span> <span class='hs-varid'>simples</span>
<a name="line-1322"></a>   <span class='hs-varid'>pruned_insols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropDerivedInsols</span> <span class='hs-varid'>insols</span>
<a name="line-1323"></a>   <span class='hs-varid'>pruned_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>need_to_keep_implic</span> <span class='hs-varid'>implics</span>
<a name="line-1324"></a>
<a name="line-1325"></a>   <span class='hs-varid'>mb_implic_needs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>VarSet</span>
<a name="line-1326"></a>        <span class='hs-comment'>-- Just vs =&gt; all implics are IC_Solved, with 'vs' needed</span>
<a name="line-1327"></a>        <span class='hs-comment'>-- Nothing =&gt; at least one implic is not IC_Solved</span>
<a name="line-1328"></a>   <span class='hs-varid'>mb_implic_needs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>add_implic</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span> <span class='hs-varid'>implics</span>
<a name="line-1329"></a>   <span class='hs-conid'>Just</span> <span class='hs-varid'>implic_needs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_implic_needs</span>
<a name="line-1330"></a>
<a name="line-1331"></a>   <span class='hs-varid'>add_implic</span> <span class='hs-varid'>implic</span> <span class='hs-varid'>acc</span>
<a name="line-1332"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>vs_acc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>acc</span>
<a name="line-1333"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>IC_Solved</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics_need</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ic_status</span> <span class='hs-varid'>implic</span>
<a name="line-1334"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>vs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>vs_acc</span><span class='hs-layout'>)</span>
<a name="line-1335"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1336"></a>
<a name="line-1337"></a>   <span class='hs-varid'>need_to_keep_implic</span> <span class='hs-varid'>ic</span>
<a name="line-1338"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IC_Solved</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics_dead</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ic_status</span> <span class='hs-varid'>ic</span>
<a name="line-1339"></a>           <span class='hs-comment'>-- Fully solved, and no redundant givens to report</span>
<a name="line-1340"></a>     <span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_impl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_wanted</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1341"></a>           <span class='hs-comment'>-- And no children that might have things to report</span>
<a name="line-1342"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1343"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1344"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1345"></a>
<a name="line-1346"></a><a name="warnRedundantGivens"></a><span class='hs-definition'>warnRedundantGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1347"></a><span class='hs-definition'>warnRedundantGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1348"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-1349"></a>       <span class='hs-conid'>FunSigCtxt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>warn_redundant</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>warn_redundant</span>
<a name="line-1350"></a>       <span class='hs-conid'>ExprSigCtxt</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1351"></a>       <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1352"></a>
<a name="line-1353"></a>  <span class='hs-comment'>-- To think about: do we want to report redundant givens for</span>
<a name="line-1354"></a>  <span class='hs-comment'>-- pattern synonyms, PatSynSigSkol? c.f Trac #9953, comment:21.</span>
<a name="line-1355"></a><span class='hs-definition'>warnRedundantGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1356"></a><span class='hs-definition'>warnRedundantGivens</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1357"></a>
<a name="line-1358"></a><a name="neededEvVars"></a><span class='hs-definition'>neededEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1359"></a><span class='hs-comment'>-- Find all the evidence variables that are "needed",</span>
<a name="line-1360"></a><span class='hs-comment'>--    and then delete all those bound by the evidence bindings</span>
<a name="line-1361"></a><span class='hs-comment'>-- See note [Tracking redundant constraints]</span>
<a name="line-1362"></a><span class='hs-definition'>neededEvVars</span> <span class='hs-varid'>ev_binds</span> <span class='hs-varid'>initial_seeds</span>
<a name="line-1363"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needed</span> <span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>bndrs</span>
<a name="line-1364"></a> <span class='hs-keyword'>where</span>
<a name="line-1365"></a>   <span class='hs-varid'>seeds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldEvBindMap</span> <span class='hs-varid'>add_wanted</span> <span class='hs-varid'>initial_seeds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1366"></a>   <span class='hs-varid'>needed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transCloVarSet</span> <span class='hs-varid'>also_needs</span> <span class='hs-varid'>seeds</span>
<a name="line-1367"></a>   <span class='hs-varid'>bndrs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldEvBindMap</span> <span class='hs-varid'>add_bndr</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1368"></a>
<a name="line-1369"></a>   <span class='hs-varid'>add_wanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1370"></a>   <span class='hs-varid'>add_wanted</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_is_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_given</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>needs</span>
<a name="line-1371"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needs</span>  <span class='hs-comment'>-- Add the rhs vars of the Wanted bindings only</span>
<a name="line-1372"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>needs</span>
<a name="line-1373"></a>
<a name="line-1374"></a>   <span class='hs-varid'>also_needs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1375"></a>   <span class='hs-varid'>also_needs</span> <span class='hs-varid'>needs</span>
<a name="line-1376"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarSet</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>needs</span>
<a name="line-1377"></a>     <span class='hs-keyword'>where</span>
<a name="line-1378"></a>       <span class='hs-varid'>add</span> <span class='hs-varid'>v</span> <span class='hs-varid'>needs</span>
<a name="line-1379"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev_bind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupEvBind</span> <span class='hs-varid'>ev_binds</span> <span class='hs-varid'>v</span>
<a name="line-1380"></a>        <span class='hs-layout'>,</span> <span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_is_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_given</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ev_bind</span>
<a name="line-1381"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>is_given</span>
<a name="line-1382"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>needs</span>
<a name="line-1383"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1384"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needs</span>
<a name="line-1385"></a>
<a name="line-1386"></a>   <span class='hs-varid'>add_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1387"></a>   <span class='hs-varid'>add_bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>v</span>
<a name="line-1388"></a>
<a name="line-1389"></a>
<a name="line-1390"></a><span class='hs-comment'>{-
<a name="line-1391"></a>Note [Tracking redundant constraints]
<a name="line-1392"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1393"></a>With Opt_WarnRedundantConstraints, GHC can report which
<a name="line-1394"></a>constraints of a type signature (or instance declaration) are
<a name="line-1395"></a>redundant, and can be omitted.  Here is an overview of how it
<a name="line-1396"></a>works:
<a name="line-1397"></a>
<a name="line-1398"></a>----- What is a redundant constraint?
<a name="line-1399"></a>
<a name="line-1400"></a>* The things that can be redundant are precisely the Given
<a name="line-1401"></a>  constraints of an implication.
<a name="line-1402"></a>
<a name="line-1403"></a>* A constraint can be redundant in two different ways:
<a name="line-1404"></a>  a) It is implied by other givens.  E.g.
<a name="line-1405"></a>       f :: (Eq a, Ord a)     =&gt; blah   -- Eq a unnecessary
<a name="line-1406"></a>       g :: (Eq a, a~b, Eq b) =&gt; blah   -- Either Eq a or Eq b unnecessary
<a name="line-1407"></a>  b) It is not needed by the Wanted constraints covered by the
<a name="line-1408"></a>     implication E.g.
<a name="line-1409"></a>       f :: Eq a =&gt; a -&gt; Bool
<a name="line-1410"></a>       f x = True  -- Equality not used
<a name="line-1411"></a>
<a name="line-1412"></a>*  To find (a), when we have two Given constraints,
<a name="line-1413"></a>   we must be careful to drop the one that is a naked variable (if poss).
<a name="line-1414"></a>   So if we have
<a name="line-1415"></a>       f :: (Eq a, Ord a) =&gt; blah
<a name="line-1416"></a>   then we may find [G] sc_sel (d1::Ord a) :: Eq a
<a name="line-1417"></a>                    [G] d2 :: Eq a
<a name="line-1418"></a>   We want to discard d2 in favour of the superclass selection from
<a name="line-1419"></a>   the Ord dictionary.  This is done by TcInteract.solveOneFromTheOther
<a name="line-1420"></a>   See Note [Replacement vs keeping].
<a name="line-1421"></a>
<a name="line-1422"></a>* To find (b) we need to know which evidence bindings are 'wanted';
<a name="line-1423"></a>  hence the eb_is_given field on an EvBind.
<a name="line-1424"></a>
<a name="line-1425"></a>----- How tracking works
<a name="line-1426"></a>
<a name="line-1427"></a>* When the constraint solver finishes solving all the wanteds in
<a name="line-1428"></a>  an implication, it sets its status to IC_Solved
<a name="line-1429"></a>
<a name="line-1430"></a>  - The ics_dead field, of IC_Solved, records the subset of this implication's
<a name="line-1431"></a>    ic_given that are redundant (not needed).
<a name="line-1432"></a>
<a name="line-1433"></a>  - The ics_need field of IC_Solved then records all the
<a name="line-1434"></a>    in-scope (given) evidence variables bound by the context, that
<a name="line-1435"></a>    were needed to solve this implication, including all its nested
<a name="line-1436"></a>    implications.  (We remove the ic_given of this implication from
<a name="line-1437"></a>    the set, of course.)
<a name="line-1438"></a>
<a name="line-1439"></a>* We compute which evidence variables are needed by an implication
<a name="line-1440"></a>  in setImplicationStatus.  A variable is needed if
<a name="line-1441"></a>    a) it is free in the RHS of a Wanted EvBind,
<a name="line-1442"></a>    b) it is free in the RHS of an EvBind whose LHS is needed,
<a name="line-1443"></a>    c) it is in the ics_need of a nested implication.
<a name="line-1444"></a>    d) it is listed in the tcs_used_tcvs field of the nested TcSEnv
<a name="line-1445"></a>
<a name="line-1446"></a>* We need to be careful not to discard an implication
<a name="line-1447"></a>  prematurely, even one that is fully solved, because we might
<a name="line-1448"></a>  thereby forget which variables it needs, and hence wrongly
<a name="line-1449"></a>  report a constraint as redundant.  But we can discard it once
<a name="line-1450"></a>  its free vars have been incorporated into its parent; or if it
<a name="line-1451"></a>  simply has no free vars. This careful discarding is also
<a name="line-1452"></a>  handled in setImplicationStatus.
<a name="line-1453"></a>
<a name="line-1454"></a>----- Reporting redundant constraints
<a name="line-1455"></a>
<a name="line-1456"></a>* TcErrors does the actual warning, in warnRedundantConstraints.
<a name="line-1457"></a>
<a name="line-1458"></a>* We don't report redundant givens for *every* implication; only
<a name="line-1459"></a>  for those which reply True to TcSimplify.warnRedundantGivens:
<a name="line-1460"></a>
<a name="line-1461"></a>   - For example, in a class declaration, the default method *can*
<a name="line-1462"></a>     use the class constraint, but it certainly doesn't *have* to,
<a name="line-1463"></a>     and we don't want to report an error there.
<a name="line-1464"></a>
<a name="line-1465"></a>   - More subtly, in a function definition
<a name="line-1466"></a>       f :: (Ord a, Ord a, Ix a) =&gt; a -&gt; a
<a name="line-1467"></a>       f x = rhs
<a name="line-1468"></a>     we do an ambiguity check on the type (which would find that one
<a name="line-1469"></a>     of the Ord a constraints was redundant), and then we check that
<a name="line-1470"></a>     the definition has that type (which might find that both are
<a name="line-1471"></a>     redundant).  We don't want to report the same error twice, so we
<a name="line-1472"></a>     disable it for the ambiguity check.  Hence using two different
<a name="line-1473"></a>     FunSigCtxts, one with the warn-redundant field set True, and the
<a name="line-1474"></a>     other set False in
<a name="line-1475"></a>        - TcBinds.tcSpecPrag
<a name="line-1476"></a>        - TcBinds.tcTySig
<a name="line-1477"></a>
<a name="line-1478"></a>  This decision is taken in setImplicationStatus, rather than TcErrors
<a name="line-1479"></a>  so that we can discard implication constraints that we don't need.
<a name="line-1480"></a>  So ics_dead consists only of the *reportable* redundant givens.
<a name="line-1481"></a>
<a name="line-1482"></a>----- Shortcomings
<a name="line-1483"></a>
<a name="line-1484"></a>Consider (see Trac #9939)
<a name="line-1485"></a>    f2 :: (Eq a, Ord a) =&gt; a -&gt; a -&gt; Bool
<a name="line-1486"></a>    -- Ord a redundant, but Eq a is reported
<a name="line-1487"></a>    f2 x y = (x == y)
<a name="line-1488"></a>
<a name="line-1489"></a>We report (Eq a) as redundant, whereas actually (Ord a) is.  But it's
<a name="line-1490"></a>really not easy to detect that!
<a name="line-1491"></a>
<a name="line-1492"></a>
<a name="line-1493"></a>Note [Cutting off simpl_loop]
<a name="line-1494"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1495"></a>It is very important not to iterate in simpl_loop unless there is a chance
<a name="line-1496"></a>of progress.  Trac #8474 is a classic example:
<a name="line-1497"></a>
<a name="line-1498"></a>  * There's a deeply-nested chain of implication constraints.
<a name="line-1499"></a>       ?x:alpha =&gt; ?y1:beta1 =&gt; ... ?yn:betan =&gt; [W] ?x:Int
<a name="line-1500"></a>
<a name="line-1501"></a>  * From the innermost one we get a [D] alpha ~ Int,
<a name="line-1502"></a>    but alpha is untouchable until we get out to the outermost one
<a name="line-1503"></a>
<a name="line-1504"></a>  * We float [D] alpha~Int out (it is in floated_eqs), but since alpha
<a name="line-1505"></a>    is untouchable, the solveInteract in simpl_loop makes no progress
<a name="line-1506"></a>
<a name="line-1507"></a>  * So there is no point in attempting to re-solve
<a name="line-1508"></a>       ?yn:betan =&gt; [W] ?x:Int
<a name="line-1509"></a>    via solveNestedImplications, because we'll just get the
<a name="line-1510"></a>    same [D] again
<a name="line-1511"></a>
<a name="line-1512"></a>  * If we *do* re-solve, we'll get an ininite loop. It is cut off by
<a name="line-1513"></a>    the fixed bound of 10, but solving the next takes 10*10*...*10 (ie
<a name="line-1514"></a>    exponentially many) iterations!
<a name="line-1515"></a>
<a name="line-1516"></a>Conclusion: we should call solveNestedImplications only if we did
<a name="line-1517"></a>some unifiction in solveSimpleWanteds; because that's the only way
<a name="line-1518"></a>we'll get more Givens (a unificaiton is like adding a Given) to
<a name="line-1519"></a>allow the implication to make progress.
<a name="line-1520"></a>-}</span>
<a name="line-1521"></a>
<a name="line-1522"></a><a name="promoteTyVar"></a><span class='hs-definition'>promoteTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1523"></a><span class='hs-comment'>-- When we float a constraint out of an implication we must restore</span>
<a name="line-1524"></a><span class='hs-comment'>-- invariant (MetaTvInv) in Note [TcLevel and untouchable type variables] in TcType</span>
<a name="line-1525"></a><span class='hs-comment'>-- See Note [Promoting unification variables]</span>
<a name="line-1526"></a><span class='hs-definition'>promoteTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span>
<a name="line-1527"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFloatedTouchableMetaTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span>
<a name="line-1528"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cloned_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1529"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setMetaTyVarTcLevel</span> <span class='hs-varid'>cloned_tv</span> <span class='hs-varid'>tclvl</span>
<a name="line-1530"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>rhs_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1531"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1532"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1533"></a>
<a name="line-1534"></a><a name="promoteTyVarTcS"></a><span class='hs-definition'>promoteTyVarTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1535"></a><span class='hs-comment'>-- When we float a constraint out of an implication we must restore</span>
<a name="line-1536"></a><span class='hs-comment'>-- invariant (MetaTvInv) in Note [TcLevel and untouchable type variables] in TcType</span>
<a name="line-1537"></a><span class='hs-comment'>-- See Note [Promoting unification variables]</span>
<a name="line-1538"></a><span class='hs-comment'>-- We don't just call promoteTyVar because we want to use unifyTyVar,</span>
<a name="line-1539"></a><span class='hs-comment'>-- not writeMetaTyVar</span>
<a name="line-1540"></a><span class='hs-definition'>promoteTyVarTcS</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span>
<a name="line-1541"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFloatedTouchableMetaTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span>
<a name="line-1542"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cloned_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1543"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rhs_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setMetaTyVarTcLevel</span> <span class='hs-varid'>cloned_tv</span> <span class='hs-varid'>tclvl</span>
<a name="line-1544"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unifyTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>rhs_tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1545"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1546"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1547"></a>
<a name="line-1548"></a><a name="defaultTyVar"></a><span class='hs-comment'>-- | If the tyvar is a RuntimeRep var, set it to PtrRepLifted. Returns whether or</span>
<a name="line-1549"></a><span class='hs-comment'>-- not this happened.</span>
<a name="line-1550"></a><span class='hs-definition'>defaultTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1551"></a><span class='hs-comment'>-- Precondition: MetaTyVars only</span>
<a name="line-1552"></a><span class='hs-comment'>-- See Note [DefaultTyVar]</span>
<a name="line-1553"></a><span class='hs-definition'>defaultTyVar</span> <span class='hs-varid'>the_tv</span>
<a name="line-1554"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRuntimeRepVar</span> <span class='hs-varid'>the_tv</span>
<a name="line-1555"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"defaultTyVar RuntimeRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_tv</span><span class='hs-layout'>)</span>
<a name="line-1556"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>the_tv</span> <span class='hs-varid'>ptrRepLiftedTy</span> <span class='hs-layout'>}</span>
<a name="line-1557"></a>
<a name="line-1558"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>    <span class='hs-comment'>-- The common case</span>
<a name="line-1559"></a>
<a name="line-1560"></a><a name="defaultTyVarTcS"></a><span class='hs-comment'>-- | Like 'defaultTyVar', but in the TcS monad.</span>
<a name="line-1561"></a><span class='hs-definition'>defaultTyVarTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-1562"></a><span class='hs-definition'>defaultTyVarTcS</span> <span class='hs-varid'>the_tv</span>
<a name="line-1563"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRuntimeRepVar</span> <span class='hs-varid'>the_tv</span>
<a name="line-1564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"defaultTyVarTcS RuntimeRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_tv</span><span class='hs-layout'>)</span>
<a name="line-1565"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unifyTyVar</span> <span class='hs-varid'>the_tv</span> <span class='hs-varid'>ptrRepLiftedTy</span>
<a name="line-1566"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1567"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1568"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- the common case</span>
<a name="line-1569"></a>
<a name="line-1570"></a><a name="approximateWC"></a><span class='hs-definition'>approximateWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1571"></a><span class='hs-comment'>-- Postcondition: Wanted or Derived Cts</span>
<a name="line-1572"></a><span class='hs-comment'>-- See Note [ApproximateWC]</span>
<a name="line-1573"></a><span class='hs-definition'>approximateWC</span> <span class='hs-varid'>float_past_equalities</span> <span class='hs-varid'>wc</span>
<a name="line-1574"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>float_wc</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>wc</span>
<a name="line-1575"></a>  <span class='hs-keyword'>where</span>
<a name="line-1576"></a>    <span class='hs-varid'>float_wc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1577"></a>    <span class='hs-varid'>float_wc</span> <span class='hs-varid'>trapping_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1578"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>is_floatable</span> <span class='hs-varid'>simples</span> <span class='hs-varop'>`unionBags`</span>
<a name="line-1579"></a>        <span class='hs-varid'>do_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>float_implic</span> <span class='hs-varid'>new_trapping_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>implics</span>
<a name="line-1580"></a>      <span class='hs-keyword'>where</span>
<a name="line-1581"></a>        <span class='hs-varid'>is_floatable</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCt</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>new_trapping_tvs</span>
<a name="line-1582"></a>        <span class='hs-varid'>new_trapping_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transCloVarSet</span> <span class='hs-varid'>grow</span> <span class='hs-varid'>trapping_tvs</span>
<a name="line-1583"></a>
<a name="line-1584"></a>        <span class='hs-varid'>grow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>  <span class='hs-comment'>-- Maps current trapped tyvars to newly-trapped ones</span>
<a name="line-1585"></a>        <span class='hs-varid'>grow</span> <span class='hs-varid'>so_far</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>grow_one</span> <span class='hs-varid'>so_far</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>simples</span>
<a name="line-1586"></a>        <span class='hs-varid'>grow_one</span> <span class='hs-varid'>so_far</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tvs</span>
<a name="line-1587"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct_tvs</span> <span class='hs-varop'>`intersectsVarSet`</span> <span class='hs-varid'>so_far</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>ct_tvs</span>
<a name="line-1588"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-1589"></a>          <span class='hs-keyword'>where</span>
<a name="line-1590"></a>            <span class='hs-varid'>ct_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCt</span> <span class='hs-varid'>ct</span>
<a name="line-1591"></a>
<a name="line-1592"></a>    <span class='hs-varid'>float_implic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1593"></a>    <span class='hs-varid'>float_implic</span> <span class='hs-varid'>trapping_tvs</span> <span class='hs-varid'>imp</span>
<a name="line-1594"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>float_past_equalities</span> <span class='hs-varop'>||</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-varid'>imp</span>
<a name="line-1595"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>float_wc</span> <span class='hs-varid'>new_trapping_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_wanted</span> <span class='hs-varid'>imp</span><span class='hs-layout'>)</span>
<a name="line-1596"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Take care with equalities</span>
<a name="line-1597"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>    <span class='hs-comment'>-- See (1) under Note [ApproximateWC]</span>
<a name="line-1598"></a>      <span class='hs-keyword'>where</span>
<a name="line-1599"></a>        <span class='hs-varid'>new_trapping_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trapping_tvs</span> <span class='hs-varop'>`extendVarSetList`</span> <span class='hs-varid'>ic_skols</span> <span class='hs-varid'>imp</span>
<a name="line-1600"></a>    <span class='hs-varid'>do_bag</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>c</span>
<a name="line-1601"></a>    <span class='hs-varid'>do_bag</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span><span class='hs-varop'>.</span><span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyBag</span>
<a name="line-1602"></a>
<a name="line-1603"></a><span class='hs-comment'>{- Note [ApproximateWC]
<a name="line-1604"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1605"></a>approximateWC takes a constraint, typically arising from the RHS of a
<a name="line-1606"></a>let-binding whose type we are *inferring*, and extracts from it some
<a name="line-1607"></a>*simple* constraints that we might plausibly abstract over.  Of course
<a name="line-1608"></a>the top-level simple constraints are plausible, but we also float constraints
<a name="line-1609"></a>out from inside, if they are not captured by skolems.
<a name="line-1610"></a>
<a name="line-1611"></a>The same function is used when doing type-class defaulting (see the call
<a name="line-1612"></a>to applyDefaultingRules) to extract constraints that that might be defaulted.
<a name="line-1613"></a>
<a name="line-1614"></a>There are two caveats:
<a name="line-1615"></a>
<a name="line-1616"></a>1.  When infering most-general types (in simplifyInfer), we do *not*
<a name="line-1617"></a>    float anything out if the implication binds equality constraints,
<a name="line-1618"></a>    because that defeats the OutsideIn story.  Consider
<a name="line-1619"></a>       data T a where
<a name="line-1620"></a>         TInt :: T Int
<a name="line-1621"></a>         MkT :: T a
<a name="line-1622"></a>
<a name="line-1623"></a>       f TInt = 3::Int
<a name="line-1624"></a>
<a name="line-1625"></a>    We get the implication (a ~ Int =&gt; res ~ Int), where so far we've decided
<a name="line-1626"></a>      f :: T a -&gt; res
<a name="line-1627"></a>    We don't want to float (res~Int) out because then we'll infer
<a name="line-1628"></a>      f :: T a -&gt; Int
<a name="line-1629"></a>    which is only on of the possible types. (GHC 7.6 accidentally *did*
<a name="line-1630"></a>    float out of such implications, which meant it would happily infer
<a name="line-1631"></a>    non-principal types.)
<a name="line-1632"></a>
<a name="line-1633"></a>   HOWEVER (Trac #12797) in findDefaultableGroups we are not worried about
<a name="line-1634"></a>   the most-general type; and we /do/ want to float out of equalities.
<a name="line-1635"></a>   Hence the boolean flag to approximateWC.
<a name="line-1636"></a>
<a name="line-1637"></a>2. We do not float out an inner constraint that shares a type variable
<a name="line-1638"></a>   (transitively) with one that is trapped by a skolem.  Eg
<a name="line-1639"></a>       forall a.  F a ~ beta, Integral beta
<a name="line-1640"></a>   We don't want to float out (Integral beta).  Doing so would be bad
<a name="line-1641"></a>   when defaulting, because then we'll default beta:=Integer, and that
<a name="line-1642"></a>   makes the error message much worse; we'd get
<a name="line-1643"></a>       Can't solve  F a ~ Integer
<a name="line-1644"></a>   rather than
<a name="line-1645"></a>       Can't solve  Integral (F a)
<a name="line-1646"></a>
<a name="line-1647"></a>   Moreover, floating out these "contaminated" constraints doesn't help
<a name="line-1648"></a>   when generalising either. If we generalise over (Integral b), we still
<a name="line-1649"></a>   can't solve the retained implication (forall a. F a ~ b).  Indeed,
<a name="line-1650"></a>   arguably that too would be a harder error to understand.
<a name="line-1651"></a>
<a name="line-1652"></a>Note [DefaultTyVar]
<a name="line-1653"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-1654"></a>defaultTyVar is used on any un-instantiated meta type variables to
<a name="line-1655"></a>default any RuntimeRep variables to PtrRepLifted.  This is important
<a name="line-1656"></a>to ensure that instance declarations match.  For example consider
<a name="line-1657"></a>
<a name="line-1658"></a>     instance Show (a-&gt;b)
<a name="line-1659"></a>     foo x = show (\_ -&gt; True)
<a name="line-1660"></a>
<a name="line-1661"></a>Then we'll get a constraint (Show (p -&gt;q)) where p has kind (TYPE r),
<a name="line-1662"></a>and that won't match the typeKind (*) in the instance decl.  See tests
<a name="line-1663"></a>tc217 and tc175.
<a name="line-1664"></a>
<a name="line-1665"></a>We look only at touchable type variables. No further constraints
<a name="line-1666"></a>are going to affect these type variables, so it's time to do it by
<a name="line-1667"></a>hand.  However we aren't ready to default them fully to () or
<a name="line-1668"></a>whatever, because the type-class defaulting rules have yet to run.
<a name="line-1669"></a>
<a name="line-1670"></a>An alternate implementation would be to emit a derived constraint setting
<a name="line-1671"></a>the RuntimeRep variable to PtrRepLifted, but this seems unnecessarily indirect.
<a name="line-1672"></a>
<a name="line-1673"></a>Note [Promote _and_ default when inferring]
<a name="line-1674"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1675"></a>When we are inferring a type, we simplify the constraint, and then use
<a name="line-1676"></a>approximateWC to produce a list of candidate constraints.  Then we MUST
<a name="line-1677"></a>
<a name="line-1678"></a>  a) Promote any meta-tyvars that have been floated out by
<a name="line-1679"></a>     approximateWC, to restore invariant (MetaTvInv) described in
<a name="line-1680"></a>     Note [TcLevel and untouchable type variables] in TcType.
<a name="line-1681"></a>
<a name="line-1682"></a>  b) Default the kind of any meta-tyyvars that are not mentioned in
<a name="line-1683"></a>     in the environment.
<a name="line-1684"></a>
<a name="line-1685"></a>To see (b), suppose the constraint is (C ((a :: OpenKind) -&gt; Int)), and we
<a name="line-1686"></a>have an instance (C ((x:*) -&gt; Int)).  The instance doesn't match -- but it
<a name="line-1687"></a>should!  If we don't solve the constraint, we'll stupidly quantify over
<a name="line-1688"></a>(C (a-&gt;Int)) and, worse, in doing so zonkQuantifiedTyVar will quantify over
<a name="line-1689"></a>(b:*) instead of (a:OpenKind), which can lead to disaster; see Trac #7332.
<a name="line-1690"></a>Trac #7641 is a simpler example.
<a name="line-1691"></a>
<a name="line-1692"></a>Note [Promoting unification variables]
<a name="line-1693"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1694"></a>When we float an equality out of an implication we must "promote" free
<a name="line-1695"></a>unification variables of the equality, in order to maintain Invariant
<a name="line-1696"></a>(MetaTvInv) from Note [TcLevel and untouchable type variables] in TcType.  for the
<a name="line-1697"></a>leftover implication.
<a name="line-1698"></a>
<a name="line-1699"></a>This is absolutely necessary. Consider the following example. We start
<a name="line-1700"></a>with two implications and a class with a functional dependency.
<a name="line-1701"></a>
<a name="line-1702"></a>    class C x y | x -&gt; y
<a name="line-1703"></a>    instance C [a] [a]
<a name="line-1704"></a>
<a name="line-1705"></a>    (I1)      [untch=beta]forall b. 0 =&gt; F Int ~ [beta]
<a name="line-1706"></a>    (I2)      [untch=beta]forall c. 0 =&gt; F Int ~ [[alpha]] /\ C beta [c]
<a name="line-1707"></a>
<a name="line-1708"></a>We float (F Int ~ [beta]) out of I1, and we float (F Int ~ [[alpha]]) out of I2.
<a name="line-1709"></a>They may react to yield that (beta := [alpha]) which can then be pushed inwards
<a name="line-1710"></a>the leftover of I2 to get (C [alpha] [a]) which, using the FunDep, will mean that
<a name="line-1711"></a>(alpha := a). In the end we will have the skolem 'b' escaping in the untouchable
<a name="line-1712"></a>beta! Concrete example is in indexed_types/should_fail/ExtraTcsUntch.hs:
<a name="line-1713"></a>
<a name="line-1714"></a>    class C x y | x -&gt; y where
<a name="line-1715"></a>     op :: x -&gt; y -&gt; ()
<a name="line-1716"></a>
<a name="line-1717"></a>    instance C [a] [a]
<a name="line-1718"></a>
<a name="line-1719"></a>    type family F a :: *
<a name="line-1720"></a>
<a name="line-1721"></a>    h :: F Int -&gt; ()
<a name="line-1722"></a>    h = undefined
<a name="line-1723"></a>
<a name="line-1724"></a>    data TEx where
<a name="line-1725"></a>      TEx :: a -&gt; TEx
<a name="line-1726"></a>
<a name="line-1727"></a>    f (x::beta) =
<a name="line-1728"></a>        let g1 :: forall b. b -&gt; ()
<a name="line-1729"></a>            g1 _ = h [x]
<a name="line-1730"></a>            g2 z = case z of TEx y -&gt; (h [[undefined]], op x [y])
<a name="line-1731"></a>        in (g1 '3', g2 undefined)
<a name="line-1732"></a>
<a name="line-1733"></a>
<a name="line-1734"></a>Note [Solving Family Equations]
<a name="line-1735"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1736"></a>After we are done with simplification we may be left with constraints of the form:
<a name="line-1737"></a>     [Wanted] F xis ~ beta
<a name="line-1738"></a>If 'beta' is a touchable unification variable not already bound in the TyBinds
<a name="line-1739"></a>then we'd like to create a binding for it, effectively "defaulting" it to be 'F xis'.
<a name="line-1740"></a>
<a name="line-1741"></a>When is it ok to do so?
<a name="line-1742"></a>    1) 'beta' must not already be defaulted to something. Example:
<a name="line-1743"></a>
<a name="line-1744"></a>           [Wanted] F Int  ~ beta   &lt;~ Will default [beta := F Int]
<a name="line-1745"></a>           [Wanted] F Char ~ beta   &lt;~ Already defaulted, can't default again. We
<a name="line-1746"></a>                                       have to report this as unsolved.
<a name="line-1747"></a>
<a name="line-1748"></a>    2) However, we must still do an occurs check when defaulting (F xis ~ beta), to
<a name="line-1749"></a>       set [beta := F xis] only if beta is not among the free variables of xis.
<a name="line-1750"></a>
<a name="line-1751"></a>    3) Notice that 'beta' can't be bound in ty binds already because we rewrite RHS
<a name="line-1752"></a>       of type family equations. See Inert Set invariants in TcInteract.
<a name="line-1753"></a>
<a name="line-1754"></a>This solving is now happening during zonking, see Note [Unflattening while zonking]
<a name="line-1755"></a>in TcMType.
<a name="line-1756"></a>
<a name="line-1757"></a>
<a name="line-1758"></a>*********************************************************************************
<a name="line-1759"></a>*                                                                               *
<a name="line-1760"></a>*                          Floating equalities                                  *
<a name="line-1761"></a>*                                                                               *
<a name="line-1762"></a>*********************************************************************************
<a name="line-1763"></a>
<a name="line-1764"></a>Note [Float Equalities out of Implications]
<a name="line-1765"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1766"></a>For ordinary pattern matches (including existentials) we float
<a name="line-1767"></a>equalities out of implications, for instance:
<a name="line-1768"></a>     data T where
<a name="line-1769"></a>       MkT :: Eq a =&gt; a -&gt; T
<a name="line-1770"></a>     f x y = case x of MkT _ -&gt; (y::Int)
<a name="line-1771"></a>We get the implication constraint (x::T) (y::alpha):
<a name="line-1772"></a>     forall a. [untouchable=alpha] Eq a =&gt; alpha ~ Int
<a name="line-1773"></a>We want to float out the equality into a scope where alpha is no
<a name="line-1774"></a>longer untouchable, to solve the implication!
<a name="line-1775"></a>
<a name="line-1776"></a>But we cannot float equalities out of implications whose givens may
<a name="line-1777"></a>yield or contain equalities:
<a name="line-1778"></a>
<a name="line-1779"></a>      data T a where
<a name="line-1780"></a>        T1 :: T Int
<a name="line-1781"></a>        T2 :: T Bool
<a name="line-1782"></a>        T3 :: T a
<a name="line-1783"></a>
<a name="line-1784"></a>      h :: T a -&gt; a -&gt; Int
<a name="line-1785"></a>
<a name="line-1786"></a>      f x y = case x of
<a name="line-1787"></a>                T1 -&gt; y::Int
<a name="line-1788"></a>                T2 -&gt; y::Bool
<a name="line-1789"></a>                T3 -&gt; h x y
<a name="line-1790"></a>
<a name="line-1791"></a>We generate constraint, for (x::T alpha) and (y :: beta):
<a name="line-1792"></a>   [untouchables = beta] (alpha ~ Int =&gt; beta ~ Int)   -- From 1st branch
<a name="line-1793"></a>   [untouchables = beta] (alpha ~ Bool =&gt; beta ~ Bool) -- From 2nd branch
<a name="line-1794"></a>   (alpha ~ beta)                                      -- From 3rd branch
<a name="line-1795"></a>
<a name="line-1796"></a>If we float the equality (beta ~ Int) outside of the first implication and
<a name="line-1797"></a>the equality (beta ~ Bool) out of the second we get an insoluble constraint.
<a name="line-1798"></a>But if we just leave them inside the implications, we unify alpha := beta and
<a name="line-1799"></a>solve everything.
<a name="line-1800"></a>
<a name="line-1801"></a>Principle:
<a name="line-1802"></a>    We do not want to float equalities out which may
<a name="line-1803"></a>    need the given *evidence* to become soluble.
<a name="line-1804"></a>
<a name="line-1805"></a>Consequence: classes with functional dependencies don't matter (since there is
<a name="line-1806"></a>no evidence for a fundep equality), but equality superclasses do matter (since
<a name="line-1807"></a>they carry evidence).
<a name="line-1808"></a>-}</span>
<a name="line-1809"></a>
<a name="line-1810"></a><a name="floatEqualities"></a><span class='hs-definition'>floatEqualities</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1811"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1812"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>
<a name="line-1813"></a><span class='hs-comment'>-- Main idea: see Note [Float Equalities out of Implications]</span>
<a name="line-1814"></a><span class='hs-comment'>--</span>
<a name="line-1815"></a><span class='hs-comment'>-- Precondition: the wc_simple of the incoming WantedConstraints are</span>
<a name="line-1816"></a><span class='hs-comment'>--               fully zonked, so that we can see their free variables</span>
<a name="line-1817"></a><span class='hs-comment'>--</span>
<a name="line-1818"></a><span class='hs-comment'>-- Postcondition: The returned floated constraints (Cts) are only</span>
<a name="line-1819"></a><span class='hs-comment'>--                Wanted or Derived</span>
<a name="line-1820"></a><span class='hs-comment'>--</span>
<a name="line-1821"></a><span class='hs-comment'>-- Also performs some unifications (via promoteTyVar), adding to</span>
<a name="line-1822"></a><span class='hs-comment'>-- monadically-carried ty_binds. These will be used when processing</span>
<a name="line-1823"></a><span class='hs-comment'>-- floated_eqs later</span>
<a name="line-1824"></a><span class='hs-comment'>--</span>
<a name="line-1825"></a><span class='hs-comment'>-- Subtleties: Note [Float equalities from under a skolem binding]</span>
<a name="line-1826"></a><span class='hs-comment'>--             Note [Skolem escape]</span>
<a name="line-1827"></a><span class='hs-definition'>floatEqualities</span> <span class='hs-varid'>skols</span> <span class='hs-varid'>no_given_eqs</span>
<a name="line-1828"></a>                <span class='hs-varid'>wanteds</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>no_given_eqs</span>  <span class='hs-comment'>-- There are some given equalities, so don't float</span>
<a name="line-1830"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Note [Float Equalities out of Implications]</span>
<a name="line-1831"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1832"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>outer_tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-1833"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteTyVarTcS</span> <span class='hs-varid'>outer_tclvl</span><span class='hs-layout'>)</span>
<a name="line-1834"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCtsList</span> <span class='hs-varid'>float_eqs</span><span class='hs-layout'>)</span>
<a name="line-1835"></a>           <span class='hs-comment'>-- See Note [Promoting unification variables]</span>
<a name="line-1836"></a>
<a name="line-1837"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"floatEqualities"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Skols ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skols</span>
<a name="line-1838"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Simples ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>simples</span>
<a name="line-1839"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Floated eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>float_eqs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1840"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>float_eqs</span>
<a name="line-1841"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>wanteds</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>remaining_simples</span> <span class='hs-layout'>}</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1842"></a>  <span class='hs-keyword'>where</span>
<a name="line-1843"></a>    <span class='hs-varid'>skol_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skols</span>
<a name="line-1844"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>float_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>remaining_simples</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>usefulToFloat</span> <span class='hs-varid'>is_useful</span><span class='hs-layout'>)</span> <span class='hs-varid'>simples</span>
<a name="line-1845"></a>    <span class='hs-varid'>is_useful</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>skol_set</span>
<a name="line-1846"></a>
<a name="line-1847"></a><a name="usefulToFloat"></a><span class='hs-definition'>usefulToFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1848"></a><span class='hs-definition'>usefulToFloat</span> <span class='hs-varid'>is_useful_pred</span> <span class='hs-varid'>ct</span>   <span class='hs-comment'>-- The constraint is un-flattened and de-canonicalised</span>
<a name="line-1849"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_meta_var_eq</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>is_useful_pred</span> <span class='hs-varid'>pred</span>
<a name="line-1850"></a>  <span class='hs-keyword'>where</span>
<a name="line-1851"></a>    <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span>
<a name="line-1852"></a>
<a name="line-1853"></a>      <span class='hs-comment'>-- Float out alpha ~ ty, or ty ~ alpha</span>
<a name="line-1854"></a>      <span class='hs-comment'>-- which might be unified outside</span>
<a name="line-1855"></a>      <span class='hs-comment'>-- See Note [Which equalities to float]</span>
<a name="line-1856"></a>    <span class='hs-varid'>is_meta_var_eq</span> <span class='hs-varid'>pred</span>
<a name="line-1857"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EqPred</span> <span class='hs-conid'>NomEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pred</span>
<a name="line-1858"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1859"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>float_tv_eq</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-1860"></a>          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>float_tv_eq</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span>
<a name="line-1861"></a>          <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1862"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1863"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1864"></a>
<a name="line-1865"></a>    <span class='hs-varid'>float_tv_eq</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>  <span class='hs-comment'>-- See Note [Which equalities to float]</span>
<a name="line-1866"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-1867"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1868"></a>
<a name="line-1869"></a><span class='hs-comment'>{- Note [Float equalities from under a skolem binding]
<a name="line-1870"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1871"></a>Which of the simple equalities can we float out?  Obviously, only
<a name="line-1872"></a>ones that don't mention the skolem-bound variables.  But that is
<a name="line-1873"></a>over-eager. Consider
<a name="line-1874"></a>   [2] forall a. F a beta[1] ~ gamma[2], G beta[1] gamma[2] ~ Int
<a name="line-1875"></a>The second constraint doesn't mention 'a'.  But if we float it,
<a name="line-1876"></a>we'll promote gamma[2] to gamma'[1].  Now suppose that we learn that
<a name="line-1877"></a>beta := Bool, and F a Bool = a, and G Bool _ = Int.  Then we'll
<a name="line-1878"></a>we left with the constraint
<a name="line-1879"></a>   [2] forall a. a ~ gamma'[1]
<a name="line-1880"></a>which is insoluble because gamma became untouchable.
<a name="line-1881"></a>
<a name="line-1882"></a>Solution: float only constraints that stand a jolly good chance of
<a name="line-1883"></a>being soluble simply by being floated, namely ones of form
<a name="line-1884"></a>      a ~ ty
<a name="line-1885"></a>where 'a' is a currently-untouchable unification variable, but may
<a name="line-1886"></a>become touchable by being floated (perhaps by more than one level).
<a name="line-1887"></a>
<a name="line-1888"></a>We had a very complicated rule previously, but this is nice and
<a name="line-1889"></a>simple.  (To see the notes, look at this Note in a version of
<a name="line-1890"></a>TcSimplify prior to Oct 2014).
<a name="line-1891"></a>
<a name="line-1892"></a>Note [Which equalities to float]
<a name="line-1893"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1894"></a>Which equalities should we float?  We want to float ones where there
<a name="line-1895"></a>is a decent chance that floating outwards will allow unification to
<a name="line-1896"></a>happen.  In particular:
<a name="line-1897"></a>
<a name="line-1898"></a>   Float out equalities of form (alpaha ~ ty) or (ty ~ alpha), where
<a name="line-1899"></a>
<a name="line-1900"></a>   * alpha is a meta-tyvar.
<a name="line-1901"></a>
<a name="line-1902"></a>   * And 'alpha' is not a SigTv with 'ty' being a non-tyvar.  In that
<a name="line-1903"></a>     case, floating out won't help either, and it may affect grouping
<a name="line-1904"></a>     of error messages.
<a name="line-1905"></a>
<a name="line-1906"></a>Note [Skolem escape]
<a name="line-1907"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-1908"></a>You might worry about skolem escape with all this floating.
<a name="line-1909"></a>For example, consider
<a name="line-1910"></a>    [2] forall a. (a ~ F beta[2] delta,
<a name="line-1911"></a>                   Maybe beta[2] ~ gamma[1])
<a name="line-1912"></a>
<a name="line-1913"></a>The (Maybe beta ~ gamma) doesn't mention 'a', so we float it, and
<a name="line-1914"></a>solve with gamma := beta. But what if later delta:=Int, and
<a name="line-1915"></a>  F b Int = b.
<a name="line-1916"></a>Then we'd get a ~ beta[2], and solve to get beta:=a, and now the
<a name="line-1917"></a>skolem has escaped!
<a name="line-1918"></a>
<a name="line-1919"></a>But it's ok: when we float (Maybe beta[2] ~ gamma[1]), we promote beta[2]
<a name="line-1920"></a>to beta[1], and that means the (a ~ beta[1]) will be stuck, as it should be.
<a name="line-1921"></a>
<a name="line-1922"></a>
<a name="line-1923"></a>*********************************************************************************
<a name="line-1924"></a>*                                                                               *
<a name="line-1925"></a>*                          Defaulting and disamgiguation                        *
<a name="line-1926"></a>*                                                                               *
<a name="line-1927"></a>*********************************************************************************
<a name="line-1928"></a>-}</span>
<a name="line-1929"></a>
<a name="line-1930"></a><a name="applyDefaultingRules"></a><span class='hs-definition'>applyDefaultingRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-1931"></a><span class='hs-comment'>-- True &lt;=&gt; I did some defaulting, by unifying a meta-tyvar</span>
<a name="line-1932"></a><span class='hs-comment'>-- Imput WantedConstraints are not necessarily zonked</span>
<a name="line-1933"></a>
<a name="line-1934"></a><span class='hs-definition'>applyDefaultingRules</span> <span class='hs-varid'>wanteds</span>
<a name="line-1935"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanteds</span>
<a name="line-1936"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-1937"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1938"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>info</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>default_tys</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDefaultInfo</span>
<a name="line-1939"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wanteds</span>               <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkWC</span> <span class='hs-varid'>wanteds</span>
<a name="line-1940"></a>
<a name="line-1941"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>groups</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDefaultableGroups</span> <span class='hs-varid'>info</span> <span class='hs-varid'>wanteds</span>
<a name="line-1942"></a>
<a name="line-1943"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"applyDefaultingRules {"</span> <span class='hs-varop'>$</span>
<a name="line-1944"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"wanteds ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanteds</span>
<a name="line-1945"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"groups  ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>groups</span>
<a name="line-1946"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"info    ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>]</span>
<a name="line-1947"></a>
<a name="line-1948"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>something_happeneds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>disambigGroup</span> <span class='hs-varid'>default_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>groups</span>
<a name="line-1949"></a>
<a name="line-1950"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"applyDefaultingRules }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>something_happeneds</span><span class='hs-layout'>)</span>
<a name="line-1951"></a>
<a name="line-1952"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>or</span> <span class='hs-varid'>something_happeneds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1953"></a>
<a name="line-1954"></a><a name="findDefaultableGroups"></a><span class='hs-definition'>findDefaultableGroups</span>
<a name="line-1955"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1956"></a>       <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span><span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>     <span class='hs-comment'>-- (Overloaded strings, extended default rules)</span>
<a name="line-1957"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>   <span class='hs-comment'>-- Unsolved (wanted or derived)</span>
<a name="line-1958"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1959"></a><span class='hs-definition'>findDefaultableGroups</span> <span class='hs-layout'>(</span><span class='hs-varid'>default_tys</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ovl_strings</span><span class='hs-layout'>,</span> <span class='hs-varid'>extended_defaults</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanteds</span>
<a name="line-1960"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>default_tys</span>
<a name="line-1961"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1962"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1963"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fstOf3</span> <span class='hs-varid'>group</span><span class='hs-layout'>)</span>
<a name="line-1964"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>group</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unary_groups</span>
<a name="line-1965"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>defaultable_tyvar</span> <span class='hs-varid'>tv</span>
<a name="line-1966"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>defaultable_classes</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>sndOf3</span> <span class='hs-varid'>group</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1967"></a>  <span class='hs-keyword'>where</span>
<a name="line-1968"></a>    <span class='hs-varid'>simples</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>approximateWC</span> <span class='hs-conid'>True</span> <span class='hs-varid'>wanteds</span>
<a name="line-1969"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>unaries</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_unaries</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>find_unary</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>simples</span><span class='hs-layout'>)</span>
<a name="line-1970"></a>    <span class='hs-varid'>unary_groups</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>equivClasses</span> <span class='hs-varid'>cmp_tv</span> <span class='hs-varid'>unaries</span>
<a name="line-1971"></a>
<a name="line-1972"></a>    <span class='hs-varid'>unary_groups</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- (C tv) constraints</span>
<a name="line-1973"></a>    <span class='hs-varid'>unaries</span>      <span class='hs-keyglyph'>::</span>  <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- (C tv) constraints</span>
<a name="line-1974"></a>    <span class='hs-varid'>non_unaries</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>                      <span class='hs-comment'>-- and *other* constraints</span>
<a name="line-1975"></a>
<a name="line-1976"></a>        <span class='hs-comment'>-- Finds unary type-class constraints</span>
<a name="line-1977"></a>        <span class='hs-comment'>-- But take account of polykinded classes like Typeable,</span>
<a name="line-1978"></a>        <span class='hs-comment'>-- which may look like (Typeable * (a:*))   (Trac #8931)</span>
<a name="line-1979"></a>    <span class='hs-varid'>find_unary</span> <span class='hs-varid'>cc</span>
<a name="line-1980"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>cc</span><span class='hs-layout'>)</span>
<a name="line-1981"></a>        <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterOutInvisibleTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1982"></a>              <span class='hs-comment'>-- Ignore invisible arguments for this purpose</span>
<a name="line-1983"></a>        <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1984"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>  <span class='hs-comment'>-- We might have runtime-skolems in GHCi, and</span>
<a name="line-1985"></a>                          <span class='hs-comment'>-- we definitely don't want to try to assign to those!</span>
<a name="line-1986"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1987"></a>    <span class='hs-varid'>find_unary</span> <span class='hs-varid'>cc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>cc</span>  <span class='hs-comment'>-- Non unary or non dictionary</span>
<a name="line-1988"></a>
<a name="line-1989"></a>    <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVarSet</span>  <span class='hs-comment'>-- TyVars mentioned by non-unaries</span>
<a name="line-1990"></a>    <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>tyCoVarsOfCt</span> <span class='hs-varid'>non_unaries</span>
<a name="line-1991"></a>
<a name="line-1992"></a>    <span class='hs-varid'>cmp_tv</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>tv2</span>
<a name="line-1993"></a>
<a name="line-1994"></a>    <span class='hs-varid'>defaultable_tyvar</span> <span class='hs-varid'>tv</span>
<a name="line-1995"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>b1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyConableTyVar</span> <span class='hs-varid'>tv</span>  <span class='hs-comment'>-- Note [Avoiding spurious errors]</span>
<a name="line-1996"></a>              <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span>
<a name="line-1997"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>b1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>b2</span>
<a name="line-1998"></a>
<a name="line-1999"></a>    <span class='hs-varid'>defaultable_classes</span> <span class='hs-varid'>clss</span>
<a name="line-2000"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>extended_defaults</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isInteractiveClass</span> <span class='hs-varid'>clss</span>
<a name="line-2001"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>is_std_class</span> <span class='hs-varid'>clss</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>is_num_class</span> <span class='hs-varid'>clss</span><span class='hs-layout'>)</span>
<a name="line-2002"></a>
<a name="line-2003"></a>    <span class='hs-comment'>-- In interactive mode, or with -XExtendedDefaultRules,</span>
<a name="line-2004"></a>    <span class='hs-comment'>-- we default Show a to Show () to avoid graututious errors on "show []"</span>
<a name="line-2005"></a>    <span class='hs-varid'>isInteractiveClass</span> <span class='hs-varid'>cls</span>
<a name="line-2006"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_num_class</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>classKey</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>showClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqClassKey</span>
<a name="line-2007"></a>                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>ordClassKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldableClassKey</span>
<a name="line-2008"></a>                                                   <span class='hs-layout'>,</span> <span class='hs-varid'>traversableClassKey</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2009"></a>
<a name="line-2010"></a>    <span class='hs-varid'>is_num_class</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNumericClass</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>ovl_strings</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>isStringClassKey</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2011"></a>    <span class='hs-comment'>-- is_num_class adds IsString to the standard numeric classes,</span>
<a name="line-2012"></a>    <span class='hs-comment'>-- when -foverloaded-strings is enabled</span>
<a name="line-2013"></a>
<a name="line-2014"></a>    <span class='hs-varid'>is_std_class</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isStandardClass</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>ovl_strings</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>isStringClassKey</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2015"></a>    <span class='hs-comment'>-- Similarly is_std_class</span>
<a name="line-2016"></a>
<a name="line-2017"></a><a name="disambigGroup"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2018"></a><span class='hs-definition'>disambigGroup</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>            <span class='hs-comment'>-- The default types</span>
<a name="line-2019"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- All classes of the form (C a)</span>
<a name="line-2020"></a>                                   <span class='hs-comment'>--  sharing same type variable</span>
<a name="line-2021"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>   <span class='hs-comment'>-- True &lt;=&gt; something happened, reflected in ty_binds</span>
<a name="line-2022"></a>
<a name="line-2023"></a><span class='hs-definition'>disambigGroup</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span>
<a name="line-2024"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-2025"></a><span class='hs-definition'>disambigGroup</span> <span class='hs-layout'>(</span><span class='hs-varid'>default_ty</span><span class='hs-conop'>:</span><span class='hs-varid'>default_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>group</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>the_tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-2026"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"disambigGroup {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>default_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>the_tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanteds</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2027"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fake_ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-2028"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-2029"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>success</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nestImplicTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fake_ev_binds_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-2030"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>pushTcLevel</span> <span class='hs-varid'>tclvl</span><span class='hs-layout'>)</span> <span class='hs-varid'>try_group</span>
<a name="line-2031"></a>
<a name="line-2032"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>success</span> <span class='hs-keyword'>then</span>
<a name="line-2033"></a>             <span class='hs-comment'>-- Success: record the type variable binding, and return</span>
<a name="line-2034"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unifyTyVar</span> <span class='hs-varid'>the_tv</span> <span class='hs-varid'>default_ty</span>
<a name="line-2035"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>wrapWarnTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>warnDefaulting</span> <span class='hs-varid'>wanteds</span> <span class='hs-varid'>default_ty</span>
<a name="line-2036"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"disambigGroup succeeded }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>default_ty</span><span class='hs-layout'>)</span>
<a name="line-2037"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-2038"></a>         <span class='hs-keyword'>else</span>
<a name="line-2039"></a>             <span class='hs-comment'>-- Failure: try with the next type</span>
<a name="line-2040"></a>             <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"disambigGroup failed, will try other default types }"</span>
<a name="line-2041"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>default_ty</span><span class='hs-layout'>)</span>
<a name="line-2042"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>disambigGroup</span> <span class='hs-varid'>default_tys</span> <span class='hs-varid'>group</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-2043"></a>  <span class='hs-keyword'>where</span>
<a name="line-2044"></a>    <span class='hs-varid'>try_group</span>
<a name="line-2045"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_subst</span>
<a name="line-2046"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcS</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-2047"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-conid'>UnkSkol</span>
<a name="line-2048"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl_env</span>
<a name="line-2049"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_t_or_k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2050"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initialSubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-2051"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>wanted_evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>)</span>
<a name="line-2052"></a>                                <span class='hs-varid'>wanteds</span>
<a name="line-2053"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varop'>$</span>
<a name="line-2054"></a>             <span class='hs-varid'>solveSimpleWanteds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>listToBag</span> <span class='hs-varop'>$</span>
<a name="line-2055"></a>             <span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>wanted_evs</span> <span class='hs-layout'>}</span>
<a name="line-2056"></a>
<a name="line-2057"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2058"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-2059"></a>
<a name="line-2060"></a>    <span class='hs-varid'>the_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>the_tv</span>
<a name="line-2061"></a>    <span class='hs-varid'>mb_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcMatchTy</span> <span class='hs-varid'>the_ty</span> <span class='hs-varid'>default_ty</span>
<a name="line-2062"></a>      <span class='hs-comment'>-- Make sure the kinds match too; hence this call to tcMatchTy</span>
<a name="line-2063"></a>      <span class='hs-comment'>-- E.g. suppose the only constraint was (Typeable k (a::k))</span>
<a name="line-2064"></a>      <span class='hs-comment'>-- With the addition of polykinded defaulting we also want to reject</span>
<a name="line-2065"></a>      <span class='hs-comment'>-- ill-kinded defaulting attempts like (Eq []) or (Foldable Int) here.</span>
<a name="line-2066"></a>
<a name="line-2067"></a>
<a name="line-2068"></a><span class='hs-comment'>{-
<a name="line-2069"></a>Note [Avoiding spurious errors]
<a name="line-2070"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2071"></a>When doing the unification for defaulting, we check for skolem
<a name="line-2072"></a>type variables, and simply don't default them.  For example:
<a name="line-2073"></a>   f = (*)      -- Monomorphic
<a name="line-2074"></a>   g :: Num a =&gt; a -&gt; a
<a name="line-2075"></a>   g x = f x x
<a name="line-2076"></a>Here, we get a complaint when checking the type signature for g,
<a name="line-2077"></a>that g isn't polymorphic enough; but then we get another one when
<a name="line-2078"></a>dealing with the (Num a) context arising from f's definition;
<a name="line-2079"></a>we try to unify a with Int (to default it), but find that it's
<a name="line-2080"></a>already been unified with the rigid variable from g's type sig.
<a name="line-2081"></a>-}</span>
</pre></body>
</html>
