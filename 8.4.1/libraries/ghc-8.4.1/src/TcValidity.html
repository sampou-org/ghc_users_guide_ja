<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP, TupleSections, ViewPatterns #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcValidity</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>  </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkValidMonoType"><span class="hs-identifier hs-var">checkValidMonoType</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>  </span><a href="TcValidity.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcValidity.html#expectedKindInCtxt"><span class="hs-identifier hs-var">expectedKindInCtxt</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>  </span><a href="TcValidity.html#checkValidTheta"><span class="hs-identifier hs-var">checkValidTheta</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkValidFamPats"><span class="hs-identifier hs-var">checkValidFamPats</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>  </span><a href="TcValidity.html#checkValidInstance"><span class="hs-identifier hs-var">checkValidInstance</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#validDerivPred"><span class="hs-identifier hs-var">validDerivPred</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>  </span><a href="TcValidity.html#checkInstTermination"><span class="hs-identifier hs-var">checkInstTermination</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkTySynRhs"><span class="hs-identifier hs-var">checkTySynRhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>  </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkValidCoAxiom"><span class="hs-identifier hs-var">checkValidCoAxiom</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkValidCoAxBranch"><span class="hs-identifier hs-var">checkValidCoAxBranch</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>  </span><a href="TcValidity.html#checkValidTyFamEqn"><span class="hs-identifier hs-var">checkValidTyFamEqn</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>  </span><a href="TcValidity.html#arityErr"><span class="hs-identifier hs-var">arityErr</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#badATErr"><span class="hs-identifier hs-var">badATErr</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>  </span><a href="TcValidity.html#checkValidTelescope"><span class="hs-identifier hs-var">checkValidTelescope</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkZonkValidTelescope"><span class="hs-identifier hs-var">checkZonkValidTelescope</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#checkValidInferredKinds"><span class="hs-identifier hs-var">checkValidInferredKinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>  </span><a href="TcValidity.html#allDistinctTyVars"><span class="hs-identifier hs-var">allDistinctTyVars</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-comment">-- friends:</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcSimplify.html#simplifyAmbiguityCheck"><span class="hs-identifier hs-var">simplifyAmbiguityCheck</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcType.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Kind.html"><span class="hs-identifier">Kind</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Class.html"><span class="hs-identifier">Class</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">-- others:</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="HsSyn.html"><span class="hs-identifier">HsSyn</span></a><span>            </span><span class="hs-comment">-- HsType</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>        </span><span class="hs-comment">-- TcType, amongst others</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="FunDeps.html"><span class="hs-identifier">FunDeps</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="InstEnv.html"><span class="hs-identifier">InstEnv</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="InstEnv.html#InstMatch"><span class="hs-identifier hs-type">InstMatch</span></a><span class="hs-special">,</span><span> </span><a href="InstEnv.html#lookupInstEnv"><span class="hs-identifier hs-var">lookupInstEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="FamInstEnv.html#isDominatedBy"><span class="hs-identifier hs-var">isDominatedBy</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var">injectiveBranches</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>                     </span><a href="FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier hs-type">InjectivityCheckResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier hs-var">makeInjectivityErrors</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSet.html"><span class="hs-identifier">UniqSet</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="Var.html#TyVarBndr"><span class="hs-identifier hs-type">TyVarBndr</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="Unique.html#mkAlphaTyVarUnique"><span class="hs-identifier hs-var">mkAlphaTyVarUnique</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../ghc-boot-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC.LanguageExtensions</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data.List</span></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
          Checking for ambiguity
*                                                                      *
************************************************************************

Note [The ambiguity check for type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
checkAmbiguity is a check on *user-supplied type signatures*.  It is
*purely* there to report functions that cannot possibly be called.  So for
example we want to reject:
   f :: C a =&gt; Int
The idea is there can be no legal calls to 'f' because every call will
give rise to an ambiguous constraint.  We could soundly omit the
ambiguity check on type signatures entirely, at the expense of
delaying ambiguity errors to call sites.  Indeed, the flag
-XAllowAmbiguousTypes switches off the ambiguity check.

What about things like this:
   class D a b | a -&gt; b where ..
   h :: D Int b =&gt; Int
The Int may well fix 'b' at the call site, so that signature should
not be rejected.  Moreover, using *visible* fundeps is too
conservative.  Consider
   class X a b where ...
   class D a b | a -&gt; b where ...
   instance D a b =&gt; X [a] b where...
   h :: X a b =&gt; a -&gt; a
Here h's type looks ambiguous in 'b', but here's a legal call:
   ...(h [True])...
That gives rise to a (X [Bool] beta) constraint, and using the
instance means we need (D Bool beta) and that fixes 'beta' via D's
fundep!

Behind all these special cases there is a simple guiding principle.
Consider

  f :: &lt;type&gt;
  f = ...blah...

  g :: &lt;type&gt;
  g = f

You would think that the definition of g would surely typecheck!
After all f has exactly the same type, and g=f. But in fact f's type
is instantiated and the instantiated constraints are solved against
the originals, so in the case an ambiguous type it won't work.
Consider our earlier example f :: C a =&gt; Int.  Then in g's definition,
we'll instantiate to (C alpha) and try to deduce (C alpha) from (C a),
and fail.

So in fact we use this as our *definition* of ambiguity.  We use a
very similar test for *inferred* types, to ensure that they are
unambiguous. See Note [Impedance matching] in TcBinds.

This test is very conveniently implemented by calling
    tcSubType &lt;type&gt; &lt;type&gt;
This neatly takes account of the functional dependecy stuff above,
and implicit parameter (see Note [Implicit parameters and ambiguity]).
And this is what checkAmbiguity does.

What about this, though?
   g :: C [a] =&gt; Int
Is every call to 'g' ambiguous?  After all, we might have
   instance C [a] where ...
at the call site.  So maybe that type is ok!  Indeed even f's
quintessentially ambiguous type might, just possibly be callable:
with -XFlexibleInstances we could have
  instance C a where ...
and now a call could be legal after all!  Well, we'll reject this
unless the instance is available *here*.

Note [When to call checkAmbiguity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We call checkAmbiguity
   (a) on user-specified type signatures
   (b) in checkValidType

Conncerning (b), you might wonder about nested foralls.  What about
    f :: forall b. (forall a. Eq a =&gt; b) -&gt; b
The nested forall is ambiguous.  Originally we called checkAmbiguity
in the forall case of check_type, but that had two bad consequences:
  * We got two error messages about (Eq b) in a nested forall like this:
       g :: forall a. Eq a =&gt; forall b. Eq b =&gt; a -&gt; a
  * If we try to check for ambiguity of a nested forall like
    (forall a. Eq a =&gt; b), the implication constraint doesn't bind
    all the skolems, which results in &quot;No skolem info&quot; in error
    messages (see Trac #10432).

To avoid this, we call checkAmbiguity once, at the top, in checkValidType.
(I'm still a bit worried about unbound skolems when the type mentions
in-scope type variables.)

In fact, because of the co/contra-variance implemented in tcSubType,
this *does* catch function f above. too.

Concerning (a) the ambiguity check is only used for *user* types, not
for types coming from inteface files.  The latter can legitimately
have ambiguous types. Example

   class S a where s :: a -&gt; (Int,Int)
   instance S Char where s _ = (1,1)
   f:: S a =&gt; [a] -&gt; Int -&gt; (Int,Int)
   f (_::[a]) x = (a*x,b)
        where (a,b) = s (undefined::a)

Here the worker for f gets the type
        fw :: forall a. S a =&gt; Int -&gt; (# Int, Int #)


Note [Implicit parameters and ambiguity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Only a *class* predicate can give rise to ambiguity
An *implicit parameter* cannot.  For example:
        foo :: (?x :: [a]) =&gt; Int
        foo = length ?x
is fine.  The call site will supply a particular 'x'

Furthermore, the type variables fixed by an implicit parameter
propagate to the others.  E.g.
        foo :: (Show a, ?x::[a]) =&gt; Int
        foo = show (?x++?x)
The type of foo looks ambiguous.  But it isn't, because at a call site
we might have
        let ?x = 5::Int in foo
and all is well.  In effect, implicit parameters are, well, parameters,
so we can take their type variables into account as part of the
&quot;tau-tvs&quot; stuff.  This is done in the function 'FunDeps.grow'.
-}</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-identifier">checkAmbiguity</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-201"></a><a name="checkAmbiguity"><a href="TcValidity.html#checkAmbiguity"><span class="hs-identifier">checkAmbiguity</span></a></a><span> </span><a name="local-6989586621680128132"><a href="#local-6989586621680128132"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128133"><a href="#local-6989586621680128133"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcValidity.html#wantAmbiguityCheck"><span class="hs-identifier hs-var">wantAmbiguityCheck</span></a><span> </span><a href="#local-6989586621680128132"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-203"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Ambiguity check for&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128133"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>         </span><span class="hs-comment">-- Solve the constraints eagerly because an ambiguous type</span><span>
</span><a name="line-205"></a><span>         </span><span class="hs-comment">-- can cause a cascade of further errors.  Since the free</span><span>
</span><a name="line-206"></a><span>         </span><span class="hs-comment">-- tyvars are skolemised, we can safely use tcSimplifyTop</span><span>
</span><a name="line-207"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128139"><a href="#local-6989586621680128139"><span class="hs-identifier">allow_ambiguous</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#AllowAmbiguousTypes"><span class="hs-identifier hs-var">LangExt.AllowAmbiguousTypes</span></a><span>
</span><a name="line-208"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680128140"><a href="#local-6989586621680128140"><span class="hs-identifier">_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128141"><a href="#local-6989586621680128141"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128134"><span class="hs-identifier hs-var">mk_msg</span></a><span> </span><a href="#local-6989586621680128139"><span class="hs-identifier hs-var">allow_ambiguous</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-209"></a><span>                            </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-210"></a><span>                            </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span> </span><a href="#local-6989586621680128132"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128133"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680128133"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-211"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSimplify.html#simplifyAmbiguityCheck"><span class="hs-identifier hs-var">simplifyAmbiguityCheck</span></a><span> </span><a href="#local-6989586621680128133"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680128141"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Done ambiguity check for&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128133"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-216"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-218"></a><span>   </span><a name="local-6989586621680128134"><a href="#local-6989586621680128134"><span class="hs-identifier">mk_msg</span></a></a><span> </span><a name="local-6989586621680128137"><a href="#local-6989586621680128137"><span class="hs-identifier">allow_ambiguous</span></a></a><span>
</span><a name="line-219"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the ambiguity check for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128136"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-220"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppUnless"><span class="hs-identifier hs-var">ppUnless</span></a><span> </span><a href="#local-6989586621680128137"><span class="hs-identifier hs-var">allow_ambiguous</span></a><span> </span><a href="#local-6989586621680128135"><span class="hs-identifier hs-var">ambig_msg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-221"></a><span>   </span><a name="local-6989586621680128135"><a href="#local-6989586621680128135"><span class="hs-identifier">ambig_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;To defer the ambiguity check to use sites, enable AllowAmbiguousTypes&quot;</span><span>
</span><a name="line-222"></a><span>   </span><a name="local-6989586621680128136"><a href="#local-6989586621680128136"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128138"><a href="#local-6989586621680128138"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#isSigMaybe"><span class="hs-identifier hs-var">isSigMaybe</span></a><span> </span><a href="#local-6989586621680128132"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128138"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a><span> </span><a href="#local-6989586621680128132"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-identifier">wantAmbiguityCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-226"></a><a name="wantAmbiguityCheck"><a href="TcValidity.html#wantAmbiguityCheck"><span class="hs-identifier">wantAmbiguityCheck</span></a></a><span> </span><a name="local-6989586621680128142"><a href="#local-6989586621680128142"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-227"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128142"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [When we don't check for ambiguity]</span><span>
</span><a name="line-228"></a><span>      </span><a href="TcType.html#GhciCtxt"><span class="hs-identifier hs-var">GhciCtxt</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-229"></a><span>      </span><a href="TcType.html#TySynCtxt"><span class="hs-identifier hs-var">TySynCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-230"></a><span>      </span><a href="TcType.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-231"></a><span>      </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-identifier">checkUserTypeError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- Check to see if the type signature mentions &quot;TypeError blah&quot;</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- anywhere in it, and fail if so.</span><span>
</span><a name="line-236"></a><span class="hs-comment">--</span><span>
</span><a name="line-237"></a><span class="hs-comment">-- Very unsatisfactorily (Trac #11144) we need to tidy the type</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- because it may have come from an /inferred/ signature, not a</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- user-supplied one.  This is really only a half-baked fix;</span><span>
</span><a name="line-240"></a><span class="hs-comment">-- the other errors in checkValidType don't do tidying, and so</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- may give bad error messages when given an inferred type.</span><span>
</span><a name="line-242"></a><a name="checkUserTypeError"><a href="TcValidity.html#checkUserTypeError"><span class="hs-identifier">checkUserTypeError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128143"><span class="hs-identifier hs-var">check</span></a><span>
</span><a name="line-243"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-244"></a><span>  </span><a name="local-6989586621680128143"><a href="#local-6989586621680128143"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-6989586621680128145"><a href="#local-6989586621680128145"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-245"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128146"><a href="#local-6989586621680128146"><span class="hs-identifier">msg</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#userTypeError_maybe"><span class="hs-identifier hs-var">userTypeError_maybe</span></a><span> </span><a href="#local-6989586621680128145"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128144"><span class="hs-identifier hs-var">fail_with</span></a><span> </span><a href="#local-6989586621680128146"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-246"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680128147"><a href="#local-6989586621680128147"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621680128145"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680128143"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621680128147"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-247"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128148"><a href="#local-6989586621680128148"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680128149"><a href="#local-6989586621680128149"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a><span> </span><a href="#local-6989586621680128145"><span class="hs-identifier hs-var">ty</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128143"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621680128148"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621680128143"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621680128149"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-248"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680128150"><a href="#local-6989586621680128150"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621680128145"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128143"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621680128150"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                               </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>  </span><a name="local-6989586621680128144"><a href="#local-6989586621680128144"><span class="hs-identifier">fail_with</span></a></a><span> </span><a name="local-6989586621680128151"><a href="#local-6989586621680128151"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128152"><a href="#local-6989586621680128152"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>
</span><a name="line-252"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680128153"><a href="#local-6989586621680128153"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128154"><a href="#local-6989586621680128154"><span class="hs-identifier">tidy_msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyOpenType"><span class="hs-identifier hs-var">tidyOpenType</span></a><span> </span><a href="#local-6989586621680128152"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621680128151"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-253"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failWithTcM"><span class="hs-identifier hs-var">failWithTcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128153"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">,</span><span> </span><a href="Type.html#pprUserTypeErrorTy"><span class="hs-identifier hs-var">pprUserTypeErrorTy</span></a><span> </span><a href="#local-6989586621680128154"><span class="hs-identifier hs-var">tidy_msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-comment">{- Note [When we don't check for ambiguity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a few places we do not want to check a user-specified type for ambiguity

* GhciCtxt: Allow ambiguous types in GHCi's :kind command
  E.g.   type family T a :: *  -- T :: forall k. k -&gt; *
  Then :k T should work in GHCi, not complain that
  (T k) is ambiguous!

* TySynCtxt: type T a b = C a b =&gt; blah
  It may be that when we /use/ T, we'll give an 'a' or 'b' that somehow
  cure the ambiguity.  So we defer the ambiguity check to the use site.

  There is also an implementation reason (Trac #11608).  In the RHS of
  a type synonym we don't (currently) instantiate 'a' and 'b' with
  TcTyVars before calling checkValidType, so we get asertion failures
  from doing an ambiguity check on a type with TyVars in it.  Fixing this
  would not be hard, but let's wait till there's a reason.

* TypeAppCtxt: visible type application
     f @ty
  No need to check ty for ambiguity


************************************************************************
*                                                                      *
          Checking validity of a user-defined type
*                                                                      *
************************************************************************

When dealing with a user-written type, we first translate it from an HsType
to a Type, performing kind checking, and then check various things that should
be true about it.  We don't want to perform these checks at the same time
as the initial translation because (a) they are unnecessary for interface-file
types and (b) when checking a mutually recursive group of type and class decls,
we can't &quot;look&quot; at the tycons/classes yet.  Also, the checks are rather
diverse, and used to really mess up the other code.

One thing we check for is 'rank'.

        Rank 0:         monotypes (no foralls)
        Rank 1:         foralls at the front only, Rank 0 inside
        Rank 2:         foralls at the front, Rank 1 on left of fn arrow,

        basic ::= tyvar | T basic ... basic

        r2  ::= forall tvs. cxt =&gt; r2a
        r2a ::= r1 -&gt; r2a | basic
        r1  ::= forall tvs. cxt =&gt; r0
        r0  ::= r0 -&gt; r0 | basic

Another thing is to check that type synonyms are saturated.
This might not necessarily show up in kind checking.
        type A i = i
        data T k = MkT (k Int)
        f :: T A        -- BAD!
-}</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-identifier">checkValidType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span class="hs-comment">-- Checks that a user-written type is valid for the given context</span><span>
</span><a name="line-316"></a><span class="hs-comment">-- Assumes argument is fully zonked</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- Not used for instance decls; checkValidInstance instead</span><span>
</span><a name="line-318"></a><a name="checkValidType"><a href="TcValidity.html#checkValidType"><span class="hs-identifier">checkValidType</span></a></a><span> </span><a name="local-6989586621680128155"><a href="#local-6989586621680128155"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128156"><a href="#local-6989586621680128156"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkValidType&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128157"><a href="#local-6989586621680128157"><span class="hs-identifier">rankn_flag</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#RankNTypes"><span class="hs-identifier hs-var">LangExt.RankNTypes</span></a><span>
</span><a name="line-321"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128158"><a href="#local-6989586621680128158"><span class="hs-identifier">impred_flag</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ImpredicativeTypes"><span class="hs-identifier hs-var">LangExt.ImpredicativeTypes</span></a><span>
</span><a name="line-322"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">gen_rank</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span>
</span><a name="line-323"></a><span>             </span><a name="local-6989586621680128159"><a href="#local-6989586621680128159"><span class="hs-identifier">gen_rank</span></a></a><span> </span><a name="local-6989586621680128165"><a href="#local-6989586621680128165"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128157"><span class="hs-identifier hs-var">rankn_flag</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span>
</span><a name="line-324"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128165"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>             </span><a name="local-6989586621680128160"><a href="#local-6989586621680128160"><span class="hs-identifier">rank1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128159"><span class="hs-identifier hs-var">gen_rank</span></a><span> </span><a href="#local-6989586621680128163"><span class="hs-identifier hs-var">r1</span></a><span>
</span><a name="line-327"></a><span>             </span><a name="local-6989586621680128161"><a href="#local-6989586621680128161"><span class="hs-identifier">rank0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128159"><span class="hs-identifier hs-var">gen_rank</span></a><span> </span><a href="#local-6989586621680128162"><span class="hs-identifier hs-var">r0</span></a><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span>             </span><a name="local-6989586621680128162"><a href="#local-6989586621680128162"><span class="hs-identifier">r0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#rankZeroMonoType"><span class="hs-identifier hs-var">rankZeroMonoType</span></a><span>
</span><a name="line-330"></a><span>             </span><a name="local-6989586621680128163"><a href="#local-6989586621680128163"><span class="hs-identifier">r1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680128162"><span class="hs-identifier hs-var">r0</span></a><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span>             </span><a name="local-6989586621680128164"><a href="#local-6989586621680128164"><span class="hs-identifier">rank</span></a></a><span>
</span><a name="line-333"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128155"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-334"></a><span>                 </span><a href="TcType.html#DefaultDeclCtxt"><span class="hs-identifier hs-var">DefaultDeclCtxt</span></a><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a><span>
</span><a name="line-335"></a><span>                 </span><a href="TcType.html#ResSigCtxt"><span class="hs-identifier hs-var">ResSigCtxt</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a><span>
</span><a name="line-336"></a><span>                 </span><a href="TcType.html#PatSigCtxt"><span class="hs-identifier hs-var">PatSigCtxt</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128161"><span class="hs-identifier hs-var">rank0</span></a><span>
</span><a name="line-337"></a><span>                 </span><a href="TcType.html#RuleSigCtxt"><span class="hs-identifier hs-var">RuleSigCtxt</span></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-338"></a><span>                 </span><a href="TcType.html#TySynCtxt"><span class="hs-identifier hs-var">TySynCtxt</span></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128161"><span class="hs-identifier hs-var">rank0</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>                 </span><a href="TcType.html#ExprSigCtxt"><span class="hs-identifier hs-var">ExprSigCtxt</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-341"></a><span>                 </span><a href="TcType.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128158"><span class="hs-identifier hs-var">impred_flag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span>
</span><a name="line-342"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#tyConArgMonoType"><span class="hs-identifier hs-var">tyConArgMonoType</span></a><span>
</span><a name="line-343"></a><span>                    </span><span class="hs-comment">-- Normally, ImpredicativeTypes is handled in check_arg_type,</span><span>
</span><a name="line-344"></a><span>                    </span><span class="hs-comment">-- but visible type applications don't go through there.</span><span>
</span><a name="line-345"></a><span>                    </span><span class="hs-comment">-- So we do this check here.</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>                 </span><a href="TcType.html#FunSigCtxt"><span class="hs-identifier hs-var">FunSigCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-348"></a><span>                 </span><a href="TcType.html#InfSigCtxt"><span class="hs-identifier hs-var">InfSigCtxt</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span>        </span><span class="hs-comment">-- Inferred type</span><span>
</span><a name="line-349"></a><span>                 </span><a href="TcType.html#ConArgCtxt"><span class="hs-identifier hs-var">ConArgCtxt</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span> </span><span class="hs-comment">-- We are given the type of the entire</span><span>
</span><a name="line-350"></a><span>                                         </span><span class="hs-comment">-- constructor, hence rank 1</span><span>
</span><a name="line-351"></a><span>                 </span><a href="TcType.html#PatSynCtxt"><span class="hs-identifier hs-var">PatSynCtxt</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>                 </span><a href="TcType.html#ForSigCtxt"><span class="hs-identifier hs-var">ForSigCtxt</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-354"></a><span>                 </span><a href="TcType.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-355"></a><span>                 </span><a href="TcType.html#ThBrackCtxt"><span class="hs-identifier hs-var">ThBrackCtxt</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128160"><span class="hs-identifier hs-var">rank1</span></a><span>
</span><a name="line-356"></a><span>                 </span><a href="TcType.html#GhciCtxt"><span class="hs-identifier hs-var">GhciCtxt</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span>
</span><a name="line-357"></a><span>                 </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;checkValidType&quot;</span><span>
</span><a name="line-358"></a><span>                                          </span><span class="hs-comment">-- Can't happen; not used for *user* sigs</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128166"><a href="#local-6989586621680128166"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>        </span><span class="hs-comment">-- Check the internal validity of the type itself</span><span>
</span><a name="line-363"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128166"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128155"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128164"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkUserTypeError"><span class="hs-identifier hs-var">checkUserTypeError</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>       </span><span class="hs-comment">-- Check for ambiguous types.  See Note [When to call checkAmbiguity]</span><span>
</span><a name="line-368"></a><span>       </span><span class="hs-comment">-- NB: this will happen even for monotypes, but that should be cheap;</span><span>
</span><a name="line-369"></a><span>       </span><span class="hs-comment">--     and there may be nested foralls for the subtype test to examine</span><span>
</span><a name="line-370"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkAmbiguity"><span class="hs-identifier hs-var">checkAmbiguity</span></a><span> </span><a href="#local-6989586621680128155"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkValidType done&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680128156"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-identifier">checkValidMonoType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span class="hs-comment">-- Assumes argument is fully zonked</span><span>
</span><a name="line-376"></a><a name="checkValidMonoType"><a href="TcValidity.html#checkValidMonoType"><span class="hs-identifier">checkValidMonoType</span></a></a><span> </span><a name="local-6989586621680128167"><a href="#local-6989586621680128167"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128168"><a href="#local-6989586621680128168"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a><span> </span><a href="#local-6989586621680128167"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128168"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="TcType.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a><span> </span><a href="TcValidity.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a><span> </span><a href="#local-6989586621680128167"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-identifier">checkTySynRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><a name="checkTySynRhs"><a href="TcValidity.html#checkTySynRhs"><span class="hs-identifier">checkTySynRhs</span></a></a><span> </span><a name="local-6989586621680128169"><a href="#local-6989586621680128169"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128170"><a href="#local-6989586621680128170"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-382"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Kind.html#returnsConstraintKind"><span class="hs-identifier hs-var">returnsConstraintKind</span></a><span> </span><a href="#local-6989586621680128171"><span class="hs-identifier hs-var">actual_kind</span></a><span>
</span><a name="line-383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128172"><a href="#local-6989586621680128172"><span class="hs-identifier">ck</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ConstraintKinds"><span class="hs-identifier hs-var">LangExt.ConstraintKinds</span></a><span>
</span><a name="line-384"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680128172"><span class="hs-identifier hs-var">ck</span></a><span>
</span><a name="line-385"></a><span>         </span><span class="hs-keyword">then</span><span>  </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="Kind.html#isConstraintKind"><span class="hs-identifier hs-var">isConstraintKind</span></a><span> </span><a href="#local-6989586621680128171"><span class="hs-identifier hs-var">actual_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>                    </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128173"><a href="#local-6989586621680128173"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-387"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_pred_ty"><span class="hs-identifier hs-var">check_pred_ty</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621680128173"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128169"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128170"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="TcRnMonad.html#addErrTcM"><span class="hs-identifier hs-var">addErrTcM</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#constraintSynErr"><span class="hs-identifier hs-var">constraintSynErr</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621680128171"><span class="hs-identifier hs-var">actual_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-391"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-393"></a><span>    </span><a name="local-6989586621680128171"><a href="#local-6989586621680128171"><span class="hs-identifier">actual_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680128170"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-comment">-- | The kind expected in a certain context.</span><span>
</span><a name="line-396"></a><span class="hs-keyword">data</span><span> </span><a name="ContextKind"><a href="TcValidity.html#ContextKind"><span class="hs-identifier">ContextKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TheKind"><a href="TcValidity.html#TheKind"><span class="hs-identifier">TheKind</span></a></a><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>   </span><span class="hs-comment">-- ^ a specific kind</span><span>
</span><a name="line-397"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="AnythingKind"><a href="TcValidity.html#AnythingKind"><span class="hs-identifier">AnythingKind</span></a></a><span>   </span><span class="hs-comment">-- ^ any kind will do</span><span>
</span><a name="line-398"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="OpenKind"><a href="TcValidity.html#OpenKind"><span class="hs-identifier">OpenKind</span></a></a><span>       </span><span class="hs-comment">-- ^ something of the form @TYPE _@</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span class="hs-comment">-- Depending on the context, we might accept any kind (for instance, in a TH</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- splice), or only certain kinds (like in type signatures).</span><span>
</span><a name="line-402"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span>
</span><a name="line-403"></a><a name="expectedKindInCtxt"><a href="TcValidity.html#expectedKindInCtxt"><span class="hs-identifier">expectedKindInCtxt</span></a></a><span> </span><span class="hs-special">(</span><a href="TcType.html#TySynCtxt"><span class="hs-identifier hs-var">TySynCtxt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#AnythingKind"><span class="hs-identifier hs-var">AnythingKind</span></a><span>
</span><a name="line-404"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><a href="TcType.html#ThBrackCtxt"><span class="hs-identifier hs-var">ThBrackCtxt</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#AnythingKind"><span class="hs-identifier hs-var">AnythingKind</span></a><span>
</span><a name="line-405"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><a href="TcType.html#GhciCtxt"><span class="hs-identifier hs-var">GhciCtxt</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#AnythingKind"><span class="hs-identifier hs-var">AnythingKind</span></a><span>
</span><a name="line-406"></a><span class="hs-comment">-- The types in a 'default' decl can have varying kinds</span><span>
</span><a name="line-407"></a><span class="hs-comment">-- See Note [Extended defaults]&quot; in TcEnv</span><span>
</span><a name="line-408"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><a href="TcType.html#DefaultDeclCtxt"><span class="hs-identifier hs-var">DefaultDeclCtxt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#AnythingKind"><span class="hs-identifier hs-var">AnythingKind</span></a><span>
</span><a name="line-409"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><a href="TcType.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#AnythingKind"><span class="hs-identifier hs-var">AnythingKind</span></a><span>
</span><a name="line-410"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#ForSigCtxt"><span class="hs-identifier hs-var">ForSigCtxt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-411"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><a href="TcType.html#InstDeclCtxt"><span class="hs-identifier hs-var">InstDeclCtxt</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><a href="TysWiredIn.html#constraintKind"><span class="hs-identifier hs-var">constraintKind</span></a><span>
</span><a name="line-412"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><a href="TcType.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><a href="TysWiredIn.html#constraintKind"><span class="hs-identifier hs-var">constraintKind</span></a><span>
</span><a name="line-413"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#OpenKind"><span class="hs-identifier hs-var">OpenKind</span></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span class="hs-comment">{-
Note [Higher rank types]
~~~~~~~~~~~~~~~~~~~~~~~~
Technically
            Int -&gt; forall a. a-&gt;a
is still a rank-1 type, but it's not Haskell 98 (Trac #5957).  So the
validity checker allow a forall after an arrow only if we allow it
before -- that is, with Rank2Types or RankNTypes
-}</span><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-keyword">data</span><span> </span><a name="Rank"><a href="TcValidity.html#Rank"><span class="hs-identifier">Rank</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ArbitraryRank"><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier">ArbitraryRank</span></a></a><span>         </span><span class="hs-comment">-- Any rank ok</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="LimitedRank"><a href="TcValidity.html#LimitedRank"><span class="hs-identifier">LimitedRank</span></a></a><span>   </span><span class="hs-comment">-- Note [Higher rank types]</span><span>
</span><a name="line-428"></a><span>                 </span><span class="hs-identifier hs-type">Bool</span><span>     </span><span class="hs-comment">-- Forall ok at top</span><span>
</span><a name="line-429"></a><span>                 </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span>     </span><span class="hs-comment">-- Use for function arguments</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="MonoType"><a href="TcValidity.html#MonoType"><span class="hs-identifier">MonoType</span></a></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>   </span><span class="hs-comment">-- Monotype, with a suggestion of how it could be a polytype</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="MustBeMonoType"><a href="TcValidity.html#MustBeMonoType"><span class="hs-identifier">MustBeMonoType</span></a></a><span>  </span><span class="hs-comment">-- Monotype regardless of flags</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span class="hs-identifier">rankZeroMonoType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tyConArgMonoType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">synArgMonoType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">constraintMonoType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span>
</span><a name="line-437"></a><a name="rankZeroMonoType"><a href="TcValidity.html#rankZeroMonoType"><span class="hs-identifier">rankZeroMonoType</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#MonoType"><span class="hs-identifier hs-var">MonoType</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Perhaps you intended to use RankNTypes or Rank2Types&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-438"></a><a name="tyConArgMonoType"><a href="TcValidity.html#tyConArgMonoType"><span class="hs-identifier">tyConArgMonoType</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#MonoType"><span class="hs-identifier hs-var">MonoType</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;GHC doesn't yet support impredicative polymorphism&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-439"></a><a name="synArgMonoType"><a href="TcValidity.html#synArgMonoType"><span class="hs-identifier">synArgMonoType</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#MonoType"><span class="hs-identifier hs-var">MonoType</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Perhaps you intended to use LiberalTypeSynonyms&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-440"></a><a name="constraintMonoType"><a href="TcValidity.html#constraintMonoType"><span class="hs-identifier">constraintMonoType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#MonoType"><span class="hs-identifier hs-var">MonoType</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A constraint must be a monotype&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-identifier">funArgResRank</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- Function argument and result</span><span>
</span><a name="line-443"></a><a name="funArgResRank"><a href="TcValidity.html#funArgResRank"><span class="hs-identifier">funArgResRank</span></a></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128174"><a href="#local-6989586621680128174"><span class="hs-identifier">arg_rank</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128174"><span class="hs-identifier hs-var">arg_rank</span></a><span class="hs-special">,</span><span> </span><a href="TcValidity.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a><span> </span><a href="#local-6989586621680128174"><span class="hs-identifier hs-var">arg_rank</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128174"><span class="hs-identifier hs-var">arg_rank</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span class="hs-identifier">funArgResRank</span><span> </span><a name="local-6989586621680128175"><a href="#local-6989586621680128175"><span class="hs-identifier">other_rank</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128175"><span class="hs-identifier hs-var">other_rank</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128175"><span class="hs-identifier hs-var">other_rank</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-identifier">forAllAllowed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-447"></a><a name="forAllAllowed"><a href="TcValidity.html#forAllAllowed"><span class="hs-identifier">forAllAllowed</span></a></a><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-448"></a><span class="hs-identifier">forAllAllowed</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a><span> </span><a name="local-6989586621680128176"><a href="#local-6989586621680128176"><span class="hs-identifier">forall_ok</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128176"><span class="hs-identifier hs-var">forall_ok</span></a><span>
</span><a name="line-449"></a><span class="hs-identifier">forAllAllowed</span><span> </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-452"></a><span class="hs-identifier">check_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span class="hs-comment">-- The args say what the *type context* requires, independent</span><span>
</span><a name="line-454"></a><span class="hs-comment">-- of *flag* settings.  You test the flag settings at usage sites.</span><span>
</span><a name="line-455"></a><span class="hs-comment">--</span><span>
</span><a name="line-456"></a><span class="hs-comment">-- Rank is allowed rank for function args</span><span>
</span><a name="line-457"></a><span class="hs-comment">-- Rank 0 means no for-alls anywhere</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><a name="check_type"><a href="TcValidity.html#check_type"><span class="hs-identifier">check_type</span></a></a><span> </span><a name="local-6989586621680128177"><a href="#local-6989586621680128177"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128178"><a href="#local-6989586621680128178"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128179"><a href="#local-6989586621680128179"><span class="hs-identifier">rank</span></a></a><span> </span><a name="local-6989586621680128180"><a href="#local-6989586621680128180"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128181"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128182"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;check_type&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128180"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a><span> </span><a href="#local-6989586621680128179"><span class="hs-identifier hs-var">rank</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#forAllAllowed"><span class="hs-identifier hs-var">forAllAllowed</span></a><span> </span><a href="#local-6989586621680128179"><span class="hs-identifier hs-var">rank</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#forAllTyErr"><span class="hs-identifier hs-var">forAllTyErr</span></a><span> </span><a href="#local-6989586621680128177"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128179"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128180"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>                </span><span class="hs-comment">-- Reject e.g. (Maybe (?x::Int =&gt; Int)),</span><span>
</span><a name="line-464"></a><span>                </span><span class="hs-comment">-- with a decent error message</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_valid_theta"><span class="hs-identifier hs-var">check_valid_theta</span></a><span> </span><a href="#local-6989586621680128185"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="TcType.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a><span> </span><a href="#local-6989586621680128182"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-467"></a><span>                </span><span class="hs-comment">-- Allow     type T = ?x::Int =&gt; Int -&gt; Int</span><span>
</span><a name="line-468"></a><span>                </span><span class="hs-comment">-- but not   type T = ?x::Int</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128185"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621680128178"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128179"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128183"><span class="hs-identifier hs-var">tau</span></a><span>      </span><span class="hs-comment">-- Allow foralls to right of arrow</span><span>
</span><a name="line-471"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621680128186"><span class="hs-identifier hs-var">phi_kind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128181"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>                   </span><span class="hs-special">(</span><a href="TcValidity.html#forAllEscapeErr"><span class="hs-identifier hs-var">forAllEscapeErr</span></a><span> </span><a href="#local-6989586621680128185"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621680128180"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680128184"><span class="hs-identifier hs-var">tau_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-474"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-475"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128181"><a href="#local-6989586621680128181"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128182"><a href="#local-6989586621680128182"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128183"><a href="#local-6989586621680128183"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a><span> </span><a href="#local-6989586621680128180"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-476"></a><span>    </span><a name="local-6989586621680128184"><a href="#local-6989586621680128184"><span class="hs-identifier">tau_kind</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680128183"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-477"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128185"><a href="#local-6989586621680128185"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyTyCoVarBndrs"><span class="hs-identifier hs-var">tidyTyCoVarBndrs</span></a><span> </span><a href="#local-6989586621680128177"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128181"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span>    </span><a name="local-6989586621680128186"><a href="#local-6989586621680128186"><span class="hs-identifier">phi_kind</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128182"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128184"><span class="hs-identifier hs-var">tau_kind</span></a><span>
</span><a name="line-480"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-481"></a><span>        </span><span class="hs-comment">-- If there are any constraints, the kind is *. (#11405)</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span class="hs-identifier">check_type</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-identifier">check_type</span><span> </span><a name="local-6989586621680128187"><a href="#local-6989586621680128187"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128188"><a href="#local-6989586621680128188"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128189"><a href="#local-6989586621680128189"><span class="hs-identifier">rank</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621680128190"><a href="#local-6989586621680128190"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-6989586621680128191"><a href="#local-6989586621680128191"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128187"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128188"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128192"><span class="hs-identifier hs-var">arg_rank</span></a><span> </span><a href="#local-6989586621680128190"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-487"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128187"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128188"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128193"><span class="hs-identifier hs-var">res_rank</span></a><span> </span><a href="#local-6989586621680128191"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128192"><a href="#local-6989586621680128192"><span class="hs-identifier">arg_rank</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128193"><a href="#local-6989586621680128193"><span class="hs-identifier">res_rank</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#funArgResRank"><span class="hs-identifier hs-var">funArgResRank</span></a><span> </span><a href="#local-6989586621680128189"><span class="hs-identifier hs-var">rank</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">check_type</span><span> </span><a name="local-6989586621680128194"><a href="#local-6989586621680128194"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128195"><a href="#local-6989586621680128195"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128196"><a href="#local-6989586621680128196"><span class="hs-identifier">rank</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621680128197"><a href="#local-6989586621680128197"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621680128198"><a href="#local-6989586621680128198"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcValidity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a><span> </span><a href="#local-6989586621680128194"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128195"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128196"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128197"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-493"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a><span> </span><a href="#local-6989586621680128194"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128195"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128196"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128198"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-identifier">check_type</span><span> </span><a name="local-6989586621680128199"><a href="#local-6989586621680128199"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128200"><a href="#local-6989586621680128200"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128201"><a href="#local-6989586621680128201"><span class="hs-identifier">rank</span></a></a><span> </span><a name="local-6989586621680128202"><a href="#local-6989586621680128202"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621680128203"><a href="#local-6989586621680128203"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680128204"><a href="#local-6989586621680128204"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a><span> </span><a href="#local-6989586621680128203"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621680128203"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-497"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#check_syn_tc_app"><span class="hs-identifier hs-var">check_syn_tc_app</span></a><span> </span><a href="#local-6989586621680128199"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128200"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128201"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128202"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680128203"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128204"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-498"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isUnboxedTupleTyCon"><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span></a><span> </span><a href="#local-6989586621680128203"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#check_ubx_tuple"><span class="hs-identifier hs-var">check_ubx_tuple</span></a><span>  </span><a href="#local-6989586621680128199"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128200"><span class="hs-identifier hs-var">ctxt</span></a><span>      </span><a href="#local-6989586621680128202"><span class="hs-identifier hs-var">ty</span></a><span>    </span><a href="#local-6989586621680128204"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-499"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a><span> </span><a href="#local-6989586621680128199"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128200"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128201"><span class="hs-identifier hs-var">rank</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128204"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-identifier">check_type</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-identifier">check_type</span><span> </span><a name="local-6989586621680128205"><a href="#local-6989586621680128205"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128206"><a href="#local-6989586621680128206"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128207"><a href="#local-6989586621680128207"><span class="hs-identifier">rank</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621680128208"><a href="#local-6989586621680128208"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128205"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128206"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128207"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128208"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-identifier">check_type</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128209"><a href="#local-6989586621680128209"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;check_type&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128209"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-508"></a><span class="hs-identifier">check_syn_tc_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span>
</span><a name="line-509"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span class="hs-comment">-- Used for type synonyms and type synonym families,</span><span>
</span><a name="line-511"></a><span class="hs-comment">-- which must be saturated,</span><span>
</span><a name="line-512"></a><span class="hs-comment">-- but not data families, which need not be saturated</span><span>
</span><a name="line-513"></a><a name="check_syn_tc_app"><a href="TcValidity.html#check_syn_tc_app"><span class="hs-identifier">check_syn_tc_app</span></a></a><span> </span><a name="local-6989586621680128210"><a href="#local-6989586621680128210"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128211"><a href="#local-6989586621680128211"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128212"><a href="#local-6989586621680128212"><span class="hs-identifier">rank</span></a></a><span> </span><a name="local-6989586621680128213"><a href="#local-6989586621680128213"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680128214"><a href="#local-6989586621680128214"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680128215"><a href="#local-6989586621680128215"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-514"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128215"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthAtLeast"><span class="hs-identifier hs-var">lengthAtLeast</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128216"><span class="hs-identifier hs-var">tc_arity</span></a><span>   </span><span class="hs-comment">-- Saturated</span><span>
</span><a name="line-515"></a><span>       </span><span class="hs-comment">-- Check that the synonym has enough args</span><span>
</span><a name="line-516"></a><span>       </span><span class="hs-comment">-- This applies equally to open and closed synonyms</span><span>
</span><a name="line-517"></a><span>       </span><span class="hs-comment">-- It's OK to have an *over-applied* type synonym</span><span>
</span><a name="line-518"></a><span>       </span><span class="hs-comment">--      data Tree a b = ...</span><span>
</span><a name="line-519"></a><span>       </span><span class="hs-comment">--      type Foo a = Tree [a]</span><span>
</span><a name="line-520"></a><span>       </span><span class="hs-comment">--      f :: Foo a b -&gt; ...</span><span>
</span><a name="line-521"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [Liberal type synonyms]</span><span>
</span><a name="line-522"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128218"><a href="#local-6989586621680128218"><span class="hs-identifier">liberal</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#LiberalTypeSynonyms"><span class="hs-identifier hs-var">LangExt.LiberalTypeSynonyms</span></a><span>
</span><a name="line-523"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680128218"><span class="hs-identifier hs-var">liberal</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621680128214"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-524"></a><span>                </span><span class="hs-comment">-- For H98 and synonym families, do check the type args</span><span>
</span><a name="line-525"></a><span>                </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680128217"><span class="hs-identifier hs-var">check_arg</span></a><span> </span><a href="#local-6989586621680128215"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>          </span><span class="hs-keyword">else</span><span>  </span><span class="hs-comment">-- In the liberal case (only for closed syns), expand then check</span><span>
</span><a name="line-528"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#tcView"><span class="hs-identifier hs-var">tcView</span></a><span> </span><a href="#local-6989586621680128213"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-529"></a><span>             </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128219"><a href="#local-6989586621680128219"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128210"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128211"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128212"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621680128219"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-530"></a><span>             </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;check_tau_type&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128213"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#GhciCtxt"><span class="hs-identifier hs-var">GhciCtxt</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680128211"><span class="hs-identifier hs-var">ctxt</span></a><span>  </span><span class="hs-comment">-- Accept under-saturated type synonyms in</span><span>
</span><a name="line-533"></a><span>                      </span><span class="hs-comment">-- GHCi :kind commands; see Trac #7586</span><span>
</span><a name="line-534"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680128217"><span class="hs-identifier hs-var">check_arg</span></a><span> </span><a href="#local-6989586621680128215"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#tyConArityErr"><span class="hs-identifier hs-var">tyConArityErr</span></a><span> </span><a href="#local-6989586621680128214"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128215"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-539"></a><span>    </span><a name="local-6989586621680128216"><a href="#local-6989586621680128216"><span class="hs-identifier">tc_arity</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621680128214"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-540"></a><span>    </span><a name="local-6989586621680128217"><a href="#local-6989586621680128217"><span class="hs-identifier">check_arg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621680128214"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#check_arg_type"><span class="hs-identifier hs-var">check_arg_type</span></a><span>  </span><a href="#local-6989586621680128210"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128211"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128212"><span class="hs-identifier hs-var">rank</span></a><span>
</span><a name="line-541"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span>      </span><a href="#local-6989586621680128210"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128211"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="TcValidity.html#synArgMonoType"><span class="hs-identifier hs-var">synArgMonoType</span></a><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-544"></a><span class="hs-identifier">check_ubx_tuple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span>
</span><a name="line-545"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-546"></a><a name="check_ubx_tuple"><a href="TcValidity.html#check_ubx_tuple"><span class="hs-identifier">check_ubx_tuple</span></a></a><span> </span><a name="local-6989586621680128220"><a href="#local-6989586621680128220"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128221"><a href="#local-6989586621680128221"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128222"><a href="#local-6989586621680128222"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680128223"><a href="#local-6989586621680128223"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128224"><a href="#local-6989586621680128224"><span class="hs-identifier">ub_tuples_allowed</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#UnboxedTuples"><span class="hs-identifier hs-var">LangExt.UnboxedTuples</span></a><span>
</span><a name="line-548"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><a href="#local-6989586621680128224"><span class="hs-identifier hs-var">ub_tuples_allowed</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#ubxArgTyErr"><span class="hs-identifier hs-var">ubxArgTyErr</span></a><span> </span><a href="#local-6989586621680128220"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128222"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128225"><a href="#local-6989586621680128225"><span class="hs-identifier">impred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ImpredicativeTypes"><span class="hs-identifier hs-var">LangExt.ImpredicativeTypes</span></a><span>
</span><a name="line-551"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128226"><a href="#local-6989586621680128226"><span class="hs-identifier">rank'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680128225"><span class="hs-identifier hs-var">impred</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="TcValidity.html#tyConArgMonoType"><span class="hs-identifier hs-var">tyConArgMonoType</span></a><span>
</span><a name="line-552"></a><span>                </span><span class="hs-comment">-- c.f. check_arg_type</span><span>
</span><a name="line-553"></a><span>                </span><span class="hs-comment">-- However, args are allowed to be unlifted, or</span><span>
</span><a name="line-554"></a><span>                </span><span class="hs-comment">-- more unboxed tuples, so can't use check_arg_ty</span><span>
</span><a name="line-555"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128220"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128221"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128226"><span class="hs-identifier hs-var">rank'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128223"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-558"></a><span class="hs-identifier">check_arg_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span class="hs-comment">-- The sort of type that can instantiate a type variable,</span><span>
</span><a name="line-560"></a><span class="hs-comment">-- or be the argument of a type constructor.</span><span>
</span><a name="line-561"></a><span class="hs-comment">-- Not an unboxed tuple, but now *can* be a forall (since impredicativity)</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- Other unboxed types are very occasionally allowed as type</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- arguments depending on the kind of the type constructor</span><span>
</span><a name="line-564"></a><span class="hs-comment">--</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- For example, we want to reject things like:</span><span>
</span><a name="line-566"></a><span class="hs-comment">--</span><span>
</span><a name="line-567"></a><span class="hs-comment">--      instance Ord a =&gt; Ord (forall s. T s a)</span><span>
</span><a name="line-568"></a><span class="hs-comment">-- and</span><span>
</span><a name="line-569"></a><span class="hs-comment">--      g :: T s (forall b.b)</span><span>
</span><a name="line-570"></a><span class="hs-comment">--</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- NB: unboxed tuples can have polymorphic or unboxed args.</span><span>
</span><a name="line-572"></a><span class="hs-comment">--     This happens in the workers for functions returning</span><span>
</span><a name="line-573"></a><span class="hs-comment">--     product types with polymorphic components.</span><span>
</span><a name="line-574"></a><span class="hs-comment">--     But not in user code.</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- Anyway, they are dealt with by a special case in check_tau_type</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><a name="check_arg_type"><a href="TcValidity.html#check_arg_type"><span class="hs-identifier">check_arg_type</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span class="hs-identifier">check_arg_type</span><span> </span><a name="local-6989586621680128227"><a href="#local-6989586621680128227"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128228"><a href="#local-6989586621680128228"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128229"><a href="#local-6989586621680128229"><span class="hs-identifier">rank</span></a></a><span> </span><a name="local-6989586621680128230"><a href="#local-6989586621680128230"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128231"><a href="#local-6989586621680128231"><span class="hs-identifier">impred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ImpredicativeTypes"><span class="hs-identifier hs-var">LangExt.ImpredicativeTypes</span></a><span>
</span><a name="line-581"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128232"><a href="#local-6989586621680128232"><span class="hs-identifier">rank'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128229"><span class="hs-identifier hs-var">rank</span></a><span> </span><span class="hs-keyword">of</span><span>          </span><span class="hs-comment">-- Predictive =&gt; must be monotype</span><span>
</span><a name="line-582"></a><span>                        </span><a href="TcValidity.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#MustBeMonoType"><span class="hs-identifier hs-var">MustBeMonoType</span></a><span>  </span><span class="hs-comment">-- Monotype, regardless</span><span>
</span><a name="line-583"></a><span>                        </span><a name="local-6989586621680128233"><a href="#local-6989586621680128233"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128231"><span class="hs-identifier hs-var">impred</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#ArbitraryRank"><span class="hs-identifier hs-var">ArbitraryRank</span></a><span>
</span><a name="line-584"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#tyConArgMonoType"><span class="hs-identifier hs-var">tyConArgMonoType</span></a><span>
</span><a name="line-585"></a><span>                        </span><span class="hs-comment">-- Make sure that MustBeMonoType is propagated,</span><span>
</span><a name="line-586"></a><span>                        </span><span class="hs-comment">-- so that we don't suggest -XImpredicativeTypes in</span><span>
</span><a name="line-587"></a><span>                        </span><span class="hs-comment">--    (Ord (forall a.a)) =&gt; a -&gt; a</span><span>
</span><a name="line-588"></a><span>                        </span><span class="hs-comment">-- and so that if it Must be a monotype, we check that it is!</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128227"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128228"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128232"><span class="hs-identifier hs-var">rank'</span></a><span> </span><a href="#local-6989586621680128230"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-593"></a><span class="hs-identifier">forAllTyErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#Rank"><span class="hs-identifier hs-type">Rank</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><a name="forAllTyErr"><a href="TcValidity.html#forAllTyErr"><span class="hs-identifier">forAllTyErr</span></a></a><span> </span><a name="local-6989586621680128234"><a href="#local-6989586621680128234"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128235"><a href="#local-6989586621680128235"><span class="hs-identifier">rank</span></a></a><span> </span><a name="local-6989586621680128236"><a href="#local-6989586621680128236"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-595"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128234"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-596"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><a href="#local-6989586621680128240"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128234"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128236"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128241"><span class="hs-identifier hs-var">suggestion</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-598"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-599"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128237"><a href="#local-6989586621680128237"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128238"><a href="#local-6989586621680128238"><span class="hs-identifier">_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128239"><a href="#local-6989586621680128239"><span class="hs-identifier">_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a><span> </span><a href="#local-6989586621680128236"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-600"></a><span>    </span><a name="local-6989586621680128240"><a href="#local-6989586621680128240"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128237"><span class="hs-identifier hs-var">tvs</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal qualified type:&quot;</span><span>
</span><a name="line-601"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal polymorphic type:&quot;</span><span>
</span><a name="line-602"></a><span>    </span><a name="local-6989586621680128241"><a href="#local-6989586621680128241"><span class="hs-identifier">suggestion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128235"><span class="hs-identifier hs-var">rank</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-603"></a><span>                   </span><a href="TcValidity.html#LimitedRank"><span class="hs-identifier hs-var">LimitedRank</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Perhaps you intended to use RankNTypes or Rank2Types&quot;</span><span>
</span><a name="line-604"></a><span>                   </span><a href="TcValidity.html#MonoType"><span class="hs-identifier hs-var">MonoType</span></a><span> </span><a name="local-6989586621680128242"><a href="#local-6989586621680128242"><span class="hs-identifier">d</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128242"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-605"></a><span>                   </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable.empty</span></a><span> </span><span class="hs-comment">-- Polytype is always illegal</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-identifier">forAllEscapeErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-608"></a><a name="forAllEscapeErr"><a href="TcValidity.html#forAllEscapeErr"><span class="hs-identifier">forAllEscapeErr</span></a></a><span> </span><a name="local-6989586621680128243"><a href="#local-6989586621680128243"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128244"><a href="#local-6989586621680128244"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680128245"><a href="#local-6989586621680128245"><span class="hs-identifier">tau_kind</span></a></a><span>
</span><a name="line-609"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128243"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-610"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Quantified type's kind mentions quantified type variable&quot;</span><span>
</span><a name="line-611"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(skolem escape)&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;   type:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128243"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128244"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-613"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;of kind:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128243"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128245"><span class="hs-identifier hs-var">tau_kind</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-identifier">ubxArgTyErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><a name="ubxArgTyErr"><a href="TcValidity.html#ubxArgTyErr"><span class="hs-identifier">ubxArgTyErr</span></a></a><span> </span><a name="local-6989586621680128246"><a href="#local-6989586621680128246"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128247"><a href="#local-6989586621680128247"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128246"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal unboxed tuple type as function argument:&quot;</span><span class="hs-special">,</span><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128246"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128247"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span class="hs-comment">{-
Note [Liberal type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If -XLiberalTypeSynonyms is on, expand closed type synonyms *before*
doing validity checking.  This allows us to instantiate a synonym defn
with a for-all type, or with a partially-applied type synonym.
        e.g.   type T a b = a
               type S m   = m ()
               f :: S (T Int)
Here, T is partially applied, so it's illegal in H98.  But if you
expand S first, then T we get just
               f :: Int
which is fine.

IMPORTANT: suppose T is a type synonym.  Then we must do validity
checking on an appliation (T ty1 ty2)

        *either* before expansion (i.e. check ty1, ty2)
        *or* after expansion (i.e. expand T ty1 ty2, and then check)
        BUT NOT BOTH

If we do both, we get exponential behaviour!!

  data TIACons1 i r c = c i ::: r c
  type TIACons2 t x = TIACons1 t (TIACons1 t x)
  type TIACons3 t x = TIACons2 t (TIACons1 t x)
  type TIACons4 t x = TIACons2 t (TIACons2 t x)
  type TIACons7 t x = TIACons4 t (TIACons3 t x)


************************************************************************
*                                                                      *
\subsection{Checking a theta or source type}
*                                                                      *
************************************************************************

Note [Implicit parameters in instance decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Implicit parameters _only_ allowed in type signatures; not in instance
decls, superclasses etc. The reason for not allowing implicit params in
instances is a bit subtle.  If we allowed
  instance (?x::Int, Eq a) =&gt; Foo [a] where ...
then when we saw
     (e :: (?x::Int) =&gt; t)
it would be unclear how to discharge all the potential uses of the ?x
in e.  For example, a constraint Foo [Int] might come out of e, and
applying the instance decl would show up two uses of ?x.  Trac #8912.
-}</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span class="hs-identifier">checkValidTheta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span class="hs-comment">-- Assumes argument is fully zonked</span><span>
</span><a name="line-669"></a><a name="checkValidTheta"><a href="TcValidity.html#checkValidTheta"><span class="hs-identifier">checkValidTheta</span></a></a><span> </span><a name="local-6989586621680128248"><a href="#local-6989586621680128248"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128249"><a href="#local-6989586621680128249"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-670"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128250"><a href="#local-6989586621680128250"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypesList"><span class="hs-identifier hs-var">tyCoVarsOfTypesList</span></a><span> </span><a href="#local-6989586621680128249"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-671"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#checkThetaCtxt"><span class="hs-identifier hs-var">checkThetaCtxt</span></a><span> </span><a href="#local-6989586621680128248"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128249"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-672"></a><span>         </span><a href="TcValidity.html#check_valid_theta"><span class="hs-identifier hs-var">check_valid_theta</span></a><span> </span><a href="#local-6989586621680128250"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128248"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128249"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-675"></a><span class="hs-identifier">check_valid_theta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><a name="check_valid_theta"><a href="TcValidity.html#check_valid_theta"><span class="hs-identifier">check_valid_theta</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-677"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span class="hs-identifier">check_valid_theta</span><span> </span><a name="local-6989586621680128251"><a href="#local-6989586621680128251"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128252"><a href="#local-6989586621680128252"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128253"><a href="#local-6989586621680128253"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-679"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128255"><a href="#local-6989586621680128255"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-680"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#warnTcM"><span class="hs-identifier hs-var">warnTcM</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><a href="DynFlags.html#Opt_WarnDuplicateConstraints"><span class="hs-identifier hs-var">Opt_WarnDuplicateConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-681"></a><span>                 </span><span class="hs-special">(</span><a href="DynFlags.html#wopt"><span class="hs-identifier hs-var">wopt</span></a><span> </span><a href="DynFlags.html#Opt_WarnDuplicateConstraints"><span class="hs-identifier hs-var">Opt_WarnDuplicateConstraints</span></a><span> </span><a href="#local-6989586621680128255"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span> </span><a href="#local-6989586621680128254"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span>
</span><a name="line-682"></a><span>                 </span><span class="hs-special">(</span><a href="TcValidity.html#dupPredWarn"><span class="hs-identifier hs-var">dupPredWarn</span></a><span> </span><a href="#local-6989586621680128251"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128254"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span>
</span><a name="line-683"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;check_valid_theta&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128253"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#check_pred_ty"><span class="hs-identifier hs-var">check_pred_ty</span></a><span> </span><a href="#local-6989586621680128251"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128255"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128252"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128253"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-686"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680128254"><a href="#local-6989586621680128254"><span class="hs-identifier">dups</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ListSetOps.html#removeDups"><span class="hs-identifier hs-var">removeDups</span></a><span> </span><a href="Type.html#nonDetCmpType"><span class="hs-identifier hs-var">nonDetCmpType</span></a><span> </span><a href="#local-6989586621680128253"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-687"></a><span>    </span><span class="hs-comment">-- It's OK to use nonDetCmpType because dups only appears in the</span><span>
</span><a name="line-688"></a><span>    </span><span class="hs-comment">-- warning</span><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-691"></a><span class="hs-comment">{- Note [Validity checking for constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We look through constraint synonyms so that we can see the underlying
constraint(s).  For example
   type Foo = ?x::Int
   instance Foo =&gt; C T
We should reject the instance because it has an implicit parameter in
the context.

But we record, in 'under_syn', whether we have looked under a synonym
to avoid requiring language extensions at the use site.  Main example
(Trac #9838):

   {-# LANGUAGE ConstraintKinds #-}
   module A where
      type EqShow a = (Eq a, Show a)

   module B where
      import A
      foo :: EqShow a =&gt; a -&gt; String

We don't want to require ConstraintKinds in module B.
-}</span><span>
</span><a name="line-714"></a><span>
</span><a name="line-715"></a><span class="hs-identifier">check_pred_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span class="hs-comment">-- Check the validity of a predicate in a signature</span><span>
</span><a name="line-717"></a><span class="hs-comment">-- See Note [Validity checking for constraints]</span><span>
</span><a name="line-718"></a><a name="check_pred_ty"><a href="TcValidity.html#check_pred_ty"><span class="hs-identifier">check_pred_ty</span></a></a><span> </span><a name="local-6989586621680128256"><a href="#local-6989586621680128256"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128257"><a href="#local-6989586621680128257"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680128258"><a href="#local-6989586621680128258"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128259"><a href="#local-6989586621680128259"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-719"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcValidity.html#check_type"><span class="hs-identifier hs-var">check_type</span></a><span> </span><a href="#local-6989586621680128256"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="TcType.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a><span> </span><a href="TcValidity.html#constraintMonoType"><span class="hs-identifier hs-var">constraintMonoType</span></a><span> </span><a href="#local-6989586621680128259"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-720"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680128256"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128257"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128258"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128259"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span class="hs-identifier">check_pred_help</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>    </span><span class="hs-comment">-- True &lt;=&gt; under a type synonym</span><span>
</span><a name="line-723"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span>
</span><a name="line-724"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span>
</span><a name="line-725"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-726"></a><a name="check_pred_help"><a href="TcValidity.html#check_pred_help"><span class="hs-identifier">check_pred_help</span></a></a><span> </span><a name="local-6989586621680128260"><a href="#local-6989586621680128260"><span class="hs-identifier">under_syn</span></a></a><span> </span><a name="local-6989586621680128261"><a href="#local-6989586621680128261"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128262"><a href="#local-6989586621680128262"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680128263"><a href="#local-6989586621680128263"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128264"><a href="#local-6989586621680128264"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-727"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128265"><a href="#local-6989586621680128265"><span class="hs-identifier">pred'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#tcView"><span class="hs-identifier hs-var">tcView</span></a><span> </span><a href="#local-6989586621680128264"><span class="hs-identifier hs-var">pred</span></a><span>  </span><span class="hs-comment">-- Switch on under_syn when going under a</span><span>
</span><a name="line-728"></a><span>                                 </span><span class="hs-comment">-- synonym (Trac #9838, yuk)</span><span>
</span><a name="line-729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680128261"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128263"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128265"><span class="hs-identifier hs-var">pred'</span></a><span>
</span><a name="line-730"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621680128264"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-732"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128266"><a href="#local-6989586621680128266"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128267"><a href="#local-6989586621680128267"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTupleTyCon"><span class="hs-identifier hs-var">isTupleTyCon</span></a><span> </span><a href="#local-6989586621680128266"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-734"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#check_tuple_pred"><span class="hs-identifier hs-var">check_tuple_pred</span></a><span> </span><a href="#local-6989586621680128260"><span class="hs-identifier hs-var">under_syn</span></a><span> </span><a href="#local-6989586621680128261"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128263"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128264"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621680128267"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-735"></a><span>           </span><span class="hs-comment">-- NB: this equality check must come first, because (~) is a class,</span><span>
</span><a name="line-736"></a><span>           </span><span class="hs-comment">-- too.</span><span>
</span><a name="line-737"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128266"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-738"></a><span>          </span><a href="#local-6989586621680128266"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqTyConKey"><span class="hs-identifier hs-var">eqTyConKey</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-739"></a><span>          </span><a href="#local-6989586621680128266"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqPrimTyConKey"><span class="hs-identifier hs-var">eqPrimTyConKey</span></a><span>
</span><a name="line-740"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#check_eq_pred"><span class="hs-identifier hs-var">check_eq_pred</span></a><span> </span><a href="#local-6989586621680128261"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128264"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621680128266"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128267"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-741"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128268"><a href="#local-6989586621680128268"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a><span> </span><a href="#local-6989586621680128266"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-742"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#check_class_pred"><span class="hs-identifier hs-var">check_class_pred</span></a><span> </span><a href="#local-6989586621680128261"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128263"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128264"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621680128268"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128267"><span class="hs-identifier hs-var">tys</span></a><span>  </span><span class="hs-comment">-- Includes Coercible</span><span>
</span><a name="line-743"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#check_irred_pred"><span class="hs-identifier hs-var">check_irred_pred</span></a><span> </span><a href="#local-6989586621680128260"><span class="hs-identifier hs-var">under_syn</span></a><span> </span><a href="#local-6989586621680128261"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128263"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128264"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span class="hs-identifier">check_eq_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-746"></a><a name="check_eq_pred"><a href="TcValidity.html#check_eq_pred"><span class="hs-identifier">check_eq_pred</span></a></a><span> </span><a name="local-6989586621680128269"><a href="#local-6989586621680128269"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128270"><a href="#local-6989586621680128270"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680128271"><a href="#local-6989586621680128271"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621680128272"><a href="#local-6989586621680128272"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680128273"><a href="#local-6989586621680128273"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-747"></a><span>  </span><span class="hs-glyph">=</span><span>         </span><span class="hs-comment">-- Equational constraints are valid in all contexts if type</span><span>
</span><a name="line-748"></a><span>            </span><span class="hs-comment">-- families are permitted</span><span>
</span><a name="line-749"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128273"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621680128272"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#tyConArityErr"><span class="hs-identifier hs-var">tyConArityErr</span></a><span> </span><a href="#local-6989586621680128272"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128273"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#TypeFamilies"><span class="hs-identifier hs-var">LangExt.TypeFamilies</span></a><span> </span><a href="#local-6989586621680128270"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-751"></a><span>                   </span><span class="hs-operator hs-var">||</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#GADTs"><span class="hs-identifier hs-var">LangExt.GADTs</span></a><span> </span><a href="#local-6989586621680128270"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>                  </span><span class="hs-special">(</span><a href="TcValidity.html#eqPredTyErr"><span class="hs-identifier hs-var">eqPredTyErr</span></a><span> </span><a href="#local-6989586621680128269"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128271"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-753"></a><span>
</span><a name="line-754"></a><span class="hs-identifier">check_tuple_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-755"></a><a name="check_tuple_pred"><a href="TcValidity.html#check_tuple_pred"><span class="hs-identifier">check_tuple_pred</span></a></a><span> </span><a name="local-6989586621680128274"><a href="#local-6989586621680128274"><span class="hs-identifier">under_syn</span></a></a><span> </span><a name="local-6989586621680128275"><a href="#local-6989586621680128275"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128276"><a href="#local-6989586621680128276"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680128277"><a href="#local-6989586621680128277"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128278"><a href="#local-6989586621680128278"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621680128279"><a href="#local-6989586621680128279"><span class="hs-identifier">ts</span></a></a><span>
</span><a name="line-756"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [ConstraintKinds in predicates]</span><span>
</span><a name="line-757"></a><span>         </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128274"><span class="hs-identifier hs-var">under_syn</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ConstraintKinds"><span class="hs-identifier hs-var">LangExt.ConstraintKinds</span></a><span> </span><a href="#local-6989586621680128276"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-758"></a><span>                  </span><span class="hs-special">(</span><a href="TcValidity.html#predTupleErr"><span class="hs-identifier hs-var">predTupleErr</span></a><span> </span><a href="#local-6989586621680128275"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128278"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#check_pred_help"><span class="hs-identifier hs-var">check_pred_help</span></a><span> </span><a href="#local-6989586621680128274"><span class="hs-identifier hs-var">under_syn</span></a><span> </span><a href="#local-6989586621680128275"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128276"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680128277"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128279"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-760"></a><span>    </span><span class="hs-comment">-- This case will not normally be executed because without</span><span>
</span><a name="line-761"></a><span>    </span><span class="hs-comment">-- -XConstraintKinds tuple types are only kind-checked as *</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span class="hs-identifier">check_irred_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-764"></a><a name="check_irred_pred"><a href="TcValidity.html#check_irred_pred"><span class="hs-identifier">check_irred_pred</span></a></a><span> </span><a name="local-6989586621680128280"><a href="#local-6989586621680128280"><span class="hs-identifier">under_syn</span></a></a><span> </span><a name="local-6989586621680128281"><a href="#local-6989586621680128281"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128282"><a href="#local-6989586621680128282"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680128283"><a href="#local-6989586621680128283"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128284"><a href="#local-6989586621680128284"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-765"></a><span>    </span><span class="hs-comment">-- The predicate looks like (X t1 t2) or (x t1 t2) :: Constraint</span><span>
</span><a name="line-766"></a><span>    </span><span class="hs-comment">-- where X is a type function</span><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- If it looks like (x t1 t2), require ConstraintKinds</span><span>
</span><a name="line-768"></a><span>         </span><span class="hs-comment">--   see Note [ConstraintKinds in predicates]</span><span>
</span><a name="line-769"></a><span>         </span><span class="hs-comment">-- But (X t1 t2) is always ok because we just require ConstraintKinds</span><span>
</span><a name="line-770"></a><span>         </span><span class="hs-comment">-- at the definition site (Trac #9838)</span><span>
</span><a name="line-771"></a><span>        </span><a href="TcRnMonad.html#failIfTcM"><span class="hs-identifier hs-var">failIfTcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680128280"><span class="hs-identifier hs-var">under_syn</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ConstraintKinds"><span class="hs-identifier hs-var">LangExt.ConstraintKinds</span></a><span> </span><a href="#local-6989586621680128282"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-772"></a><span>                                </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="TcType.html#hasTyVarHead"><span class="hs-identifier hs-var">hasTyVarHead</span></a><span> </span><a href="#local-6989586621680128284"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-773"></a><span>                  </span><span class="hs-special">(</span><a href="TcValidity.html#predIrredErr"><span class="hs-identifier hs-var">predIrredErr</span></a><span> </span><a href="#local-6989586621680128281"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128284"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span>         </span><span class="hs-comment">-- Make sure it is OK to have an irred pred in this context</span><span>
</span><a name="line-776"></a><span>         </span><span class="hs-comment">-- See Note [Irreducible predicates in superclasses]</span><span>
</span><a name="line-777"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfTcM"><span class="hs-identifier hs-var">failIfTcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128285"><span class="hs-identifier hs-var">is_superclass</span></a><span> </span><a href="#local-6989586621680128283"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-778"></a><span>                    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#UndecidableInstances"><span class="hs-identifier hs-var">LangExt.UndecidableInstances</span></a><span> </span><a href="#local-6989586621680128282"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-779"></a><span>                    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680128286"><span class="hs-identifier hs-var">has_tyfun_head</span></a><span> </span><a href="#local-6989586621680128284"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span>                   </span><span class="hs-special">(</span><a href="TcValidity.html#predSuperClassErr"><span class="hs-identifier hs-var">predSuperClassErr</span></a><span> </span><a href="#local-6989586621680128281"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128284"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-782"></a><span>    </span><a name="local-6989586621680128285"><a href="#local-6989586621680128285"><span class="hs-identifier">is_superclass</span></a></a><span> </span><a name="local-6989586621680128287"><a href="#local-6989586621680128287"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128287"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcType.html#ClassSCCtxt"><span class="hs-identifier hs-var">ClassSCCtxt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-783"></a><span>    </span><a name="local-6989586621680128286"><a href="#local-6989586621680128286"><span class="hs-identifier">has_tyfun_head</span></a></a><span> </span><a name="local-6989586621680128288"><a href="#local-6989586621680128288"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-784"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621680128288"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-785"></a><span>          </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128289"><a href="#local-6989586621680128289"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621680128289"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-786"></a><span>          </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span class="hs-comment">{- Note [ConstraintKinds in predicates]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don't check for -XConstraintKinds under a type synonym, because that
was done at the type synonym definition site; see Trac #9838
e.g.   module A where
          type C a = (Eq a, Ix a)   -- Needs -XConstraintKinds
       module B where
          import A
          f :: C a =&gt; a -&gt; a        -- Does *not* need -XConstraintKinds

Note [Irreducible predicates in superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Allowing type-family calls in class superclasses is somewhat dangerous
because we can write:

 type family Fooish x :: * -&gt; Constraint
 type instance Fooish () = Foo
 class Fooish () a =&gt; Foo a where

This will cause the constraint simplifier to loop because every time we canonicalise a
(Foo a) class constraint we add a (Fooish () a) constraint which will be immediately
solved to add+canonicalise another (Foo a) constraint.  -}</span><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-812"></a><span class="hs-identifier">check_class_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-813"></a><a name="check_class_pred"><a href="TcValidity.html#check_class_pred"><span class="hs-identifier">check_class_pred</span></a></a><span> </span><a name="local-6989586621680128290"><a href="#local-6989586621680128290"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128291"><a href="#local-6989586621680128291"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680128292"><a href="#local-6989586621680128292"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128293"><a href="#local-6989586621680128293"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621680128294"><a href="#local-6989586621680128294"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128295"><a href="#local-6989586621680128295"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-814"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isIPClass"><span class="hs-identifier hs-var">isIPClass</span></a><span> </span><a href="#local-6989586621680128294"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-815"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621680128296"><span class="hs-identifier hs-var">check_arity</span></a><span>
</span><a name="line-816"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#okIPCtxt"><span class="hs-identifier hs-var">okIPCtxt</span></a><span> </span><a href="#local-6989586621680128292"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#badIPPred"><span class="hs-identifier hs-var">badIPPred</span></a><span> </span><a href="#local-6989586621680128290"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128293"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-819"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621680128296"><span class="hs-identifier hs-var">check_arity</span></a><span>
</span><a name="line-820"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128305"><a href="#local-6989586621680128305"><span class="hs-identifier">warn_simp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="DynFlags.html#Opt_WarnSimplifiableClassConstraints"><span class="hs-identifier hs-var">Opt_WarnSimplifiableClassConstraints</span></a><span>
</span><a name="line-821"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621680128305"><span class="hs-identifier hs-var">warn_simp</span></a><span> </span><a href="#local-6989586621680128300"><span class="hs-identifier hs-var">check_simplifiable_class_constraint</span></a><span>
</span><a name="line-822"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><a href="#local-6989586621680128299"><span class="hs-identifier hs-var">arg_tys_ok</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#predTyVarErr"><span class="hs-identifier hs-var">predTyVarErr</span></a><span> </span><a href="#local-6989586621680128290"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128293"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-823"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-824"></a><span>    </span><a name="local-6989586621680128296"><a href="#local-6989586621680128296"><span class="hs-identifier">check_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128295"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="Class.html#classArity"><span class="hs-identifier hs-var">classArity</span></a><span> </span><a href="#local-6989586621680128294"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-825"></a><span>                          </span><span class="hs-special">(</span><a href="TcValidity.html#tyConArityErr"><span class="hs-identifier hs-var">tyConArityErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680128294"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128295"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span>    </span><span class="hs-comment">-- Check the arguments of a class constraint</span><span>
</span><a name="line-828"></a><span>    </span><a name="local-6989586621680128297"><a href="#local-6989586621680128297"><span class="hs-identifier">flexible_contexts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#FlexibleContexts"><span class="hs-identifier hs-var">LangExt.FlexibleContexts</span></a><span>     </span><a href="#local-6989586621680128291"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-829"></a><span>    </span><a name="local-6989586621680128298"><a href="#local-6989586621680128298"><span class="hs-identifier">undecidable_ok</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#UndecidableInstances"><span class="hs-identifier hs-var">LangExt.UndecidableInstances</span></a><span> </span><a href="#local-6989586621680128291"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-830"></a><span>    </span><a name="local-6989586621680128299"><a href="#local-6989586621680128299"><span class="hs-identifier">arg_tys_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128292"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-831"></a><span>        </span><a href="TcType.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>    </span><span class="hs-comment">-- {-# SPECIALISE instance Eq (T Int) #-} is fine</span><span>
</span><a name="line-832"></a><span>        </span><a href="TcType.html#InstDeclCtxt"><span class="hs-identifier hs-var">InstDeclCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#checkValidClsArgs"><span class="hs-identifier hs-var">checkValidClsArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128297"><span class="hs-identifier hs-var">flexible_contexts</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680128298"><span class="hs-identifier hs-var">undecidable_ok</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128294"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128295"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-833"></a><span>                                </span><span class="hs-comment">-- Further checks on head and theta</span><span>
</span><a name="line-834"></a><span>                                </span><span class="hs-comment">-- in checkInstTermination</span><span>
</span><a name="line-835"></a><span>        </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#checkValidClsArgs"><span class="hs-identifier hs-var">checkValidClsArgs</span></a><span> </span><a href="#local-6989586621680128297"><span class="hs-identifier hs-var">flexible_contexts</span></a><span> </span><a href="#local-6989586621680128294"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128295"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span>    </span><span class="hs-comment">-- See Note [Simplifiable given constraints]</span><span>
</span><a name="line-838"></a><span>    </span><a name="local-6989586621680128300"><a href="#local-6989586621680128300"><span class="hs-identifier">check_simplifiable_class_constraint</span></a></a><span>
</span><a name="line-839"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#MonoLocalBinds"><span class="hs-identifier hs-var">LangExt.MonoLocalBinds</span></a><span> </span><a href="#local-6989586621680128291"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-840"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#DataTyCtxt"><span class="hs-identifier hs-var">DataTyCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680128292"><span class="hs-identifier hs-var">ctxt</span></a><span>   </span><span class="hs-comment">-- Don't do this check for the &quot;stupid theta&quot;</span><span>
</span><a name="line-842"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>               </span><span class="hs-comment">-- of a data type declaration</span><span>
</span><a name="line-843"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-844"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128302"><a href="#local-6989586621680128302"><span class="hs-identifier">envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-845"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="InstEnv.html#lookupInstEnv"><span class="hs-identifier hs-var">lookupInstEnv</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680128302"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621680128294"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128295"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-846"></a><span>                 </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621680128303"><a href="#local-6989586621680128303"><span class="hs-identifier">m</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><a href="DynFlags.html#Opt_WarnSimplifiableClassConstraints"><span class="hs-identifier hs-var">Opt_WarnSimplifiableClassConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-847"></a><span>                                           </span><span class="hs-special">(</span><a href="#local-6989586621680128301"><span class="hs-identifier hs-var">simplifiable_constraint_warn</span></a><span> </span><a href="#local-6989586621680128303"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>                 </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span>    </span><span class="hs-identifier">simplifiable_constraint_warn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="InstEnv.html#InstMatch"><span class="hs-identifier hs-type">InstMatch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-851"></a><span>    </span><a name="local-6989586621680128301"><a href="#local-6989586621680128301"><span class="hs-identifier">simplifiable_constraint_warn</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128304"><a href="#local-6989586621680128304"><span class="hs-identifier">match</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The constraint&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621680128290"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128293"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;matches an instance declaration&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-854"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128304"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-855"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;This makes type inference for inner bindings fragile;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;either use MonoLocalBinds, or simplify it using the instance&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span class="hs-comment">{- Note [Simplifiable given constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A type signature like
   f :: Eq [(a,b)] =&gt; a -&gt; b
is very fragile, for reasons described at length in TcInteract
Note [Instance and Given overlap].  As that Note discusses, for the
most part the clever stuff in TcInteract means that we don't use a
top-level instance if a local Given might fire, so there is no
fragility. But if we /infer/ the type of a local let-binding, things
can go wrong (Trac #11948 is an example, discussed in the Note).

So this warning is switched on only if we have NoMonoLocalBinds; in
that case the warning discourages users from writing simplifiable
class constraints.

The warning only fires if the constraint in the signature
matches the top-level instances in only one way, and with no
unifiers -- that is, under the same circumstances that
TcInteract.matchInstEnv fires an interaction with the top
level instances.  For example (Trac #13526), consider

  instance {-# OVERLAPPABLE #-} Eq (T a) where ...
  instance                   Eq (T Char) where ..
  f :: Eq (T a) =&gt; ...

We don't want to complain about this, even though the context
(Eq (T a)) matches an instance, because the user may be
deliberately deferring the choice so that the Eq (T Char)
has a chance to fire when 'f' is called.  And the fragility
only matters when there's a risk that the instance might
fire instead of the local 'given'; and there is no such
risk in this case.  Just use the same rules as for instance
firing!
-}</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-894"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-895"></a><span>  </span><span class="hs-comment">-- See Note [Implicit parameters in instance decls]</span><span>
</span><a name="line-896"></a><a name="okIPCtxt"><a href="TcValidity.html#okIPCtxt"><span class="hs-identifier">okIPCtxt</span></a></a><span> </span><span class="hs-special">(</span><a href="TcType.html#FunSigCtxt"><span class="hs-identifier hs-var">FunSigCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-897"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#InfSigCtxt"><span class="hs-identifier hs-var">InfSigCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-898"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#ExprSigCtxt"><span class="hs-identifier hs-var">ExprSigCtxt</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-899"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#TypeAppCtxt"><span class="hs-identifier hs-var">TypeAppCtxt</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-900"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#PatSigCtxt"><span class="hs-identifier hs-var">PatSigCtxt</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-901"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#ResSigCtxt"><span class="hs-identifier hs-var">ResSigCtxt</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-902"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-903"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#ConArgCtxt"><span class="hs-identifier hs-var">ConArgCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-904"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#ForSigCtxt"><span class="hs-identifier hs-var">ForSigCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-comment">-- ??</span><span>
</span><a name="line-905"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#ThBrackCtxt"><span class="hs-identifier hs-var">ThBrackCtxt</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-906"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#GhciCtxt"><span class="hs-identifier hs-var">GhciCtxt</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-907"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#SigmaCtxt"><span class="hs-identifier hs-var">SigmaCtxt</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-908"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#DataTyCtxt"><span class="hs-identifier hs-var">DataTyCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-909"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#PatSynCtxt"><span class="hs-identifier hs-var">PatSynCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-910"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#TySynCtxt"><span class="hs-identifier hs-var">TySynCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- e.g.   type Blah = ?x::Int</span><span>
</span><a name="line-911"></a><span>                                         </span><span class="hs-comment">-- Trac #11466</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#ClassSCCtxt"><span class="hs-identifier hs-var">ClassSCCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-914"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#InstDeclCtxt"><span class="hs-identifier hs-var">InstDeclCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-915"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-916"></a><span class="hs-identifier">okIPCtxt</span><span> </span><span class="hs-special">(</span><a href="TcType.html#RuleSigCtxt"><span class="hs-identifier hs-var">RuleSigCtxt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-917"></a><span class="hs-identifier">okIPCtxt</span><span> </span><a href="TcType.html#DefaultDeclCtxt"><span class="hs-identifier hs-var">DefaultDeclCtxt</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-918"></a><span>
</span><a name="line-919"></a><span class="hs-comment">{-
Note [Kind polymorphic type classes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
MultiParam check:

    class C f where...   -- C :: forall k. k -&gt; Constraint
    instance C Maybe where...

  The dictionary gets type [C * Maybe] even if it's not a MultiParam
  type class.

Flexibility check:

    class C f where...   -- C :: forall k. k -&gt; Constraint
    data D a = D a
    instance C D where

  The dictionary gets type [C * (D *)]. IA0_TODO it should be
  generalized actually.
-}</span><span>
</span><a name="line-939"></a><span>
</span><a name="line-940"></a><span class="hs-identifier">checkThetaCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-941"></a><a name="checkThetaCtxt"><a href="TcValidity.html#checkThetaCtxt"><span class="hs-identifier">checkThetaCtxt</span></a></a><span> </span><a name="local-6989586621680128306"><a href="#local-6989586621680128306"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128307"><a href="#local-6989586621680128307"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621680128308"><a href="#local-6989586621680128308"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-942"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128308"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-943"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the context:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TyCoRep.html#pprTheta"><span class="hs-identifier hs-var">pprTheta</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyTypes"><span class="hs-identifier hs-var">tidyTypes</span></a><span> </span><a href="#local-6989586621680128308"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128307"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-944"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;While checking&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcType.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a><span> </span><a href="#local-6989586621680128306"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span class="hs-identifier">eqPredTyErr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">predTupleErr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">predIrredErr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">predSuperClassErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-947"></a><a name="eqPredTyErr"><a href="TcValidity.html#eqPredTyErr"><span class="hs-identifier">eqPredTyErr</span></a></a><span>  </span><a name="local-6989586621680128309"><a href="#local-6989586621680128309"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128310"><a href="#local-6989586621680128310"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-948"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128309"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-949"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal equational constraint&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128309"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128310"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-950"></a><span>      </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use GADTs or TypeFamilies to permit this&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-951"></a><a name="predTupleErr"><a href="TcValidity.html#predTupleErr"><span class="hs-identifier">predTupleErr</span></a></a><span> </span><a name="local-6989586621680128311"><a href="#local-6989586621680128311"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128312"><a href="#local-6989586621680128312"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-952"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128311"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-953"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal tuple constraint:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128311"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128312"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-954"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#constraintKindsMsg"><span class="hs-identifier hs-var">constraintKindsMsg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-955"></a><a name="predIrredErr"><a href="TcValidity.html#predIrredErr"><span class="hs-identifier">predIrredErr</span></a></a><span> </span><a name="local-6989586621680128313"><a href="#local-6989586621680128313"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128314"><a href="#local-6989586621680128314"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-956"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128313"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-957"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal constraint:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128313"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128314"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-958"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#constraintKindsMsg"><span class="hs-identifier hs-var">constraintKindsMsg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-959"></a><a name="predSuperClassErr"><a href="TcValidity.html#predSuperClassErr"><span class="hs-identifier">predSuperClassErr</span></a></a><span> </span><a name="local-6989586621680128315"><a href="#local-6989586621680128315"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128316"><a href="#local-6989586621680128316"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-960"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128315"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-961"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal constraint&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128315"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128316"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-962"></a><span>            </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in a superclass context&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#undecidableMsg"><span class="hs-identifier hs-var">undecidableMsg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span class="hs-identifier">predTyVarErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-966"></a><a name="predTyVarErr"><a href="TcValidity.html#predTyVarErr"><span class="hs-identifier">predTyVarErr</span></a></a><span> </span><a name="local-6989586621680128317"><a href="#local-6989586621680128317"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128318"><a href="#local-6989586621680128318"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-967"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128317"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-968"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Non type-variable argument&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>                </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in the constraint:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128317"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128318"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-970"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use FlexibleContexts to permit this&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>
</span><a name="line-972"></a><span class="hs-identifier">badIPPred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-973"></a><a name="badIPPred"><a href="TcValidity.html#badIPPred"><span class="hs-identifier">badIPPred</span></a></a><span> </span><a name="local-6989586621680128319"><a href="#local-6989586621680128319"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128320"><a href="#local-6989586621680128320"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-974"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128319"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-975"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal implicit parameter&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128319"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128320"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-identifier">constraintSynErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-978"></a><a name="constraintSynErr"><a href="TcValidity.html#constraintSynErr"><span class="hs-identifier">constraintSynErr</span></a></a><span> </span><a name="local-6989586621680128321"><a href="#local-6989586621680128321"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128322"><a href="#local-6989586621680128322"><span class="hs-identifier">kind</span></a></a><span>
</span><a name="line-979"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128321"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-980"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal constraint synonym of kind:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128321"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128322"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#constraintKindsMsg"><span class="hs-identifier hs-var">constraintKindsMsg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>
</span><a name="line-983"></a><span class="hs-identifier">dupPredWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NE.NonEmpty</span></a><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><a name="dupPredWarn"><a href="TcValidity.html#dupPredWarn"><span class="hs-identifier">dupPredWarn</span></a></a><span> </span><a name="local-6989586621680128323"><a href="#local-6989586621680128323"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128324"><a href="#local-6989586621680128324"><span class="hs-identifier">dups</span></a></a><span>
</span><a name="line-985"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680128323"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-986"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Duplicate constraint&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#plural"><span class="hs-identifier hs-var">plural</span></a><span> </span><a href="#local-6989586621680128325"><span class="hs-identifier hs-var">primaryDups</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;:&quot;</span><span>
</span><a name="line-987"></a><span>      </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#pprWithCommas"><span class="hs-identifier hs-var">pprWithCommas</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier hs-var">ppr_tidy</span></a><span> </span><a href="#local-6989586621680128323"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128325"><span class="hs-identifier hs-var">primaryDups</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-989"></a><span>    </span><a name="local-6989586621680128325"><a href="#local-6989586621680128325"><span class="hs-identifier">primaryDups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.NonEmpty.html#head"><span class="hs-identifier hs-var">NE.head</span></a><span> </span><a href="#local-6989586621680128324"><span class="hs-identifier hs-var">dups</span></a><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span class="hs-identifier">tyConArityErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-992"></a><span class="hs-comment">-- For type-constructor arity errors, be careful to report</span><span>
</span><a name="line-993"></a><span class="hs-comment">-- the number of /visible/ arguments required and supplied,</span><span>
</span><a name="line-994"></a><span class="hs-comment">-- ignoring the /invisible/ arguments, which the user does not see.</span><span>
</span><a name="line-995"></a><span class="hs-comment">-- (e.g. Trac #10516)</span><span>
</span><a name="line-996"></a><a name="tyConArityErr"><a href="TcValidity.html#tyConArityErr"><span class="hs-identifier">tyConArityErr</span></a></a><span> </span><a name="local-6989586621680128326"><a href="#local-6989586621680128326"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680128327"><a href="#local-6989586621680128327"><span class="hs-identifier">tks</span></a></a><span>
</span><a name="line-997"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#arityErr"><span class="hs-identifier hs-var">arityErr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConFlavour"><span class="hs-identifier hs-var">tyConFlavour</span></a><span> </span><a href="#local-6989586621680128326"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680128326"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>             </span><a href="#local-6989586621680128329"><span class="hs-identifier hs-var">tc_type_arity</span></a><span> </span><a href="#local-6989586621680128330"><span class="hs-identifier hs-var">tc_type_args</span></a><span>
</span><a name="line-999"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1000"></a><span>    </span><a name="local-6989586621680128328"><a href="#local-6989586621680128328"><span class="hs-identifier">vis_tks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><a href="#local-6989586621680128326"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128327"><span class="hs-identifier hs-var">tks</span></a><span>
</span><a name="line-1001"></a><span>
</span><a name="line-1002"></a><span>    </span><span class="hs-comment">-- tc_type_arity = number of *type* args expected</span><span>
</span><a name="line-1003"></a><span>    </span><span class="hs-comment">-- tc_type_args  = number of *type* args encountered</span><span>
</span><a name="line-1004"></a><span>    </span><a name="local-6989586621680128329"><a href="#local-6989586621680128329"><span class="hs-identifier">tc_type_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="TyCon.html#isVisibleTyConBinder"><span class="hs-identifier hs-var">isVisibleTyConBinder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621680128326"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1005"></a><span>    </span><a name="local-6989586621680128330"><a href="#local-6989586621680128330"><span class="hs-identifier">tc_type_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621680128328"><span class="hs-identifier hs-var">vis_tks</span></a><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><span class="hs-identifier">arityErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621680128131"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128131"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1008"></a><a name="arityErr"><a href="TcValidity.html#arityErr"><span class="hs-identifier">arityErr</span></a></a><span> </span><a name="local-6989586621680128331"><a href="#local-6989586621680128331"><span class="hs-identifier">what</span></a></a><span> </span><a name="local-6989586621680128332"><a href="#local-6989586621680128332"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680128333"><a href="#local-6989586621680128333"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680128334"><a href="#local-6989586621680128334"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-1009"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128331"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128332"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;should have&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1010"></a><span>           </span><a href="#local-6989586621680128335"><span class="hs-identifier hs-var">n_arguments</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but has been given&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1011"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680128334"><span class="hs-identifier hs-var">m</span></a><span class="hs-operator hs-var">==</span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;none&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-6989586621680128334"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">]</span><span>
</span><a name="line-1012"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1013"></a><span>        </span><a name="local-6989586621680128335"><a href="#local-6989586621680128335"><span class="hs-identifier">n_arguments</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128333"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;no arguments&quot;</span><span>
</span><a name="line-1014"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128333"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;1 argument&quot;</span><span>
</span><a name="line-1015"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-6989586621680128333"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;arguments&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Checking for a decent instance head type}
*                                                                      *
************************************************************************

@checkValidInstHead@ checks the type {\em and} its syntactic constraints:
it must normally look like: @instance Foo (Tycon a b c ...) ...@

The exceptions to this syntactic checking: (1)~if the @GlasgowExts@
flag is on, or (2)~the instance is imported (they must have been
compiled elsewhere). In these cases, we let them go through anyway.

We can also have instances for functions: @instance Foo (a -&gt; b) ...@.
-}</span><span>
</span><a name="line-1033"></a><span>
</span><a name="line-1034"></a><span class="hs-identifier">checkValidInstHead</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1035"></a><a name="checkValidInstHead"><a href="TcValidity.html#checkValidInstHead"><span class="hs-identifier">checkValidInstHead</span></a></a><span> </span><a name="local-6989586621680128336"><a href="#local-6989586621680128336"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128337"><a href="#local-6989586621680128337"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621680128338"><a href="#local-6989586621680128338"><span class="hs-identifier">cls_args</span></a></a><span>
</span><a name="line-1036"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128344"><a href="#local-6989586621680128344"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1037"></a><span>
</span><a name="line-1038"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128345"><a href="#local-6989586621680128345"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a><span>
</span><a name="line-1039"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#notElem"><span class="hs-identifier hs-var">notElem</span></a><span class="hs-special">`</span><span> </span><a href="TcValidity.html#abstractClassKeys"><span class="hs-identifier hs-var">abstractClassKeys</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1040"></a><span>                  </span><a href="Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680128345"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1041"></a><span>                 </span><span class="hs-special">(</span><a href="TcValidity.html#instTypeErr"><span class="hs-identifier hs-var">instTypeErr</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128338"><span class="hs-identifier hs-var">cls_args</span></a><span> </span><a href="#local-6989586621680128343"><span class="hs-identifier hs-var">abstract_class_msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1042"></a><span>
</span><a name="line-1043"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#hasFieldClassNameKey"><span class="hs-identifier hs-var">hasFieldClassNameKey</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1044"></a><span>             </span><a href="TcValidity.html#checkHasFieldInst"><span class="hs-identifier hs-var">checkHasFieldInst</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128338"><span class="hs-identifier hs-var">cls_args</span></a><span>
</span><a name="line-1045"></a><span>
</span><a name="line-1046"></a><span>           </span><span class="hs-comment">-- Check language restrictions;</span><span>
</span><a name="line-1047"></a><span>           </span><span class="hs-comment">-- but not for SPECIALISE instance pragmas</span><span>
</span><a name="line-1048"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128346"><a href="#local-6989586621680128346"><span class="hs-identifier">ty_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128338"><span class="hs-identifier hs-var">cls_args</span></a><span>
</span><a name="line-1049"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-6989586621680128339"><span class="hs-identifier hs-var">spec_inst_prag</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1050"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#TypeSynonymInstances"><span class="hs-identifier hs-var">LangExt.TypeSynonymInstances</span></a><span> </span><a href="#local-6989586621680128344"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1051"></a><span>                       </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="TcValidity.html#tcInstHeadTyNotSynonym"><span class="hs-identifier hs-var">tcInstHeadTyNotSynonym</span></a><span> </span><a href="#local-6989586621680128346"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>                 </span><span class="hs-special">(</span><a href="TcValidity.html#instTypeErr"><span class="hs-identifier hs-var">instTypeErr</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128338"><span class="hs-identifier hs-var">cls_args</span></a><span> </span><a href="#local-6989586621680128340"><span class="hs-identifier hs-var">head_type_synonym_msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1053"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#FlexibleInstances"><span class="hs-identifier hs-var">LangExt.FlexibleInstances</span></a><span> </span><a href="#local-6989586621680128344"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1054"></a><span>                       </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="TcValidity.html#tcInstHeadTyAppAllTyVars"><span class="hs-identifier hs-var">tcInstHeadTyAppAllTyVars</span></a><span> </span><a href="#local-6989586621680128346"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1055"></a><span>                 </span><span class="hs-special">(</span><a href="TcValidity.html#instTypeErr"><span class="hs-identifier hs-var">instTypeErr</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128338"><span class="hs-identifier hs-var">cls_args</span></a><span> </span><a href="#local-6989586621680128341"><span class="hs-identifier hs-var">head_type_args_tyvars_msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1056"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#MultiParamTypeClasses"><span class="hs-identifier hs-var">LangExt.MultiParamTypeClasses</span></a><span> </span><a href="#local-6989586621680128344"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1057"></a><span>                       </span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span> </span><a href="#local-6989586621680128346"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">||</span><span>  </span><span class="hs-comment">-- Only count type arguments</span><span>
</span><a name="line-1058"></a><span>                       </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#NullaryTypeClasses"><span class="hs-identifier hs-var">LangExt.NullaryTypeClasses</span></a><span> </span><a href="#local-6989586621680128344"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1059"></a><span>                        </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128346"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1060"></a><span>                 </span><span class="hs-special">(</span><a href="TcValidity.html#instTypeErr"><span class="hs-identifier hs-var">instTypeErr</span></a><span> </span><a href="#local-6989586621680128337"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128338"><span class="hs-identifier hs-var">cls_args</span></a><span> </span><a href="#local-6989586621680128342"><span class="hs-identifier hs-var">head_one_type_msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1061"></a><span>
</span><a name="line-1062"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="TcValidity.html#checkValidTypePat"><span class="hs-identifier hs-var">checkValidTypePat</span></a><span> </span><a href="#local-6989586621680128346"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1063"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1064"></a><span>    </span><a name="local-6989586621680128339"><a href="#local-6989586621680128339"><span class="hs-identifier">spec_inst_prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128336"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcType.html#SpecInstCtxt"><span class="hs-identifier hs-var">SpecInstCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1065"></a><span>
</span><a name="line-1066"></a><span>    </span><a name="local-6989586621680128340"><a href="#local-6989586621680128340"><span class="hs-identifier">head_type_synonym_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1067"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;All instance types must be of the form (T t1 ... tn)&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1068"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;where T is not a synonym.&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1069"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use TypeSynonymInstances if you want to disable this.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1070"></a><span>
</span><a name="line-1071"></a><span>    </span><a name="local-6989586621680128341"><a href="#local-6989586621680128341"><span class="hs-identifier">head_type_args_tyvars_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-1072"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;All instance types must be of the form (T a1 ... an)&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1073"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;where a1 ... an are *distinct type variables*,&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1074"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;and each type variable appears at most once in the instance head.&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1075"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use FlexibleInstances if you want to disable this.&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><span>
</span><a name="line-1077"></a><span>    </span><a name="local-6989586621680128342"><a href="#local-6989586621680128342"><span class="hs-identifier">head_one_type_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1078"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Only one type can be given in an instance head.&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1079"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use MultiParamTypeClasses if you want to allow more, or zero.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1080"></a><span>
</span><a name="line-1081"></a><span>    </span><a name="local-6989586621680128343"><a href="#local-6989586621680128343"><span class="hs-identifier">abstract_class_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1082"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Manual instances of this class are not permitted.&quot;</span><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span class="hs-identifier">tcInstHeadTyNotSynonym</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1085"></a><span class="hs-comment">-- Used in Haskell-98 mode, for the argument types of an instance head</span><span>
</span><a name="line-1086"></a><span class="hs-comment">-- These must not be type synonyms, but everywhere else type synonyms</span><span>
</span><a name="line-1087"></a><span class="hs-comment">-- are transparent, so we need a special function here</span><span>
</span><a name="line-1088"></a><a name="tcInstHeadTyNotSynonym"><a href="TcValidity.html#tcInstHeadTyNotSynonym"><span class="hs-identifier">tcInstHeadTyNotSynonym</span></a></a><span> </span><a name="local-6989586621680128347"><a href="#local-6989586621680128347"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1089"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128347"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Do not use splitTyConApp,</span><span>
</span><a name="line-1090"></a><span>                </span><span class="hs-comment">-- because that expands synonyms!</span><span>
</span><a name="line-1091"></a><span>        </span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621680128348"><a href="#local-6989586621680128348"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a><span> </span><a href="#local-6989586621680128348"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1093"></a><span>
</span><a name="line-1094"></a><span class="hs-identifier">tcInstHeadTyAppAllTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1095"></a><span class="hs-comment">-- Used in Haskell-98 mode, for the argument types of an instance head</span><span>
</span><a name="line-1096"></a><span class="hs-comment">-- These must be a constructor applied to type variable arguments.</span><span>
</span><a name="line-1097"></a><span class="hs-comment">-- But we allow kind instantiations.</span><span>
</span><a name="line-1098"></a><a name="tcInstHeadTyAppAllTyVars"><a href="TcValidity.html#tcInstHeadTyAppAllTyVars"><span class="hs-identifier">tcInstHeadTyAppAllTyVars</span></a></a><span> </span><a name="local-6989586621680128349"><a href="#local-6989586621680128349"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1099"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128353"><a href="#local-6989586621680128353"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128354"><a href="#local-6989586621680128354"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128349"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128350"><span class="hs-identifier hs-var">ok</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><a href="#local-6989586621680128353"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128354"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- avoid kinds</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1103"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1104"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1105"></a><span>        </span><span class="hs-comment">-- Check that all the types are type variables,</span><span>
</span><a name="line-1106"></a><span>        </span><span class="hs-comment">-- and that each is distinct</span><span>
</span><a name="line-1107"></a><span>    </span><a name="local-6989586621680128350"><a href="#local-6989586621680128350"><span class="hs-identifier">ok</span></a></a><span> </span><a name="local-6989586621680128351"><a href="#local-6989586621680128351"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span> </span><a href="#local-6989586621680128352"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680128351"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="ListSetOps.html#hasNoDups"><span class="hs-identifier hs-var">hasNoDups</span></a><span> </span><a href="#local-6989586621680128352"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1108"></a><span>           </span><span class="hs-keyword">where</span><span>
</span><a name="line-1109"></a><span>             </span><a name="local-6989586621680128352"><a href="#local-6989586621680128352"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a><span> </span><a href="TcType.html#tcGetTyVar_maybe"><span class="hs-identifier hs-var">tcGetTyVar_maybe</span></a><span> </span><a href="#local-6989586621680128351"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1110"></a><span>
</span><a name="line-1111"></a><span class="hs-identifier">dropCasts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1112"></a><span class="hs-comment">-- See Note [Casts during validity checking]</span><span>
</span><a name="line-1113"></a><span class="hs-comment">-- This function can turn a well-kinded type into an ill-kinded</span><span>
</span><a name="line-1114"></a><span class="hs-comment">-- one, so I've kept it local to this module</span><span>
</span><a name="line-1115"></a><span class="hs-comment">-- To consider: drop only HoleCo casts</span><span>
</span><a name="line-1116"></a><a name="dropCasts"><a href="TcValidity.html#dropCasts"><span class="hs-identifier">dropCasts</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621680128355"><a href="#local-6989586621680128355"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128355"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1117"></a><span class="hs-identifier">dropCasts</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621680128356"><a href="#local-6989586621680128356"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621680128357"><a href="#local-6989586621680128357"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkAppTy"><span class="hs-identifier hs-var">mkAppTy</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128356"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128357"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1118"></a><span class="hs-identifier">dropCasts</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621680128358"><a href="#local-6989586621680128358"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621680128359"><a href="#local-6989586621680128359"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128358"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128359"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1119"></a><span class="hs-identifier">dropCasts</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621680128360"><a href="#local-6989586621680128360"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680128361"><a href="#local-6989586621680128361"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680128360"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128361"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1120"></a><span class="hs-identifier">dropCasts</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><a name="local-6989586621680128362"><a href="#local-6989586621680128362"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680128363"><a href="#local-6989586621680128363"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCastsB"><span class="hs-identifier hs-var">dropCastsB</span></a><span> </span><a href="#local-6989586621680128362"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#dropCasts"><span class="hs-identifier hs-var">dropCasts</span></a><span> </span><a href="#local-6989586621680128363"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1121"></a><span class="hs-identifier">dropCasts</span><span> </span><a name="local-6989586621680128364"><a href="#local-6989586621680128364"><span class="hs-identifier">ty</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128364"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- LitTy, TyVarTy, CoercionTy</span><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span class="hs-identifier">dropCastsB</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVarBinder"><span class="hs-identifier hs-type">TyVarBinder</span></a><span>
</span><a name="line-1124"></a><a name="dropCastsB"><a href="TcValidity.html#dropCastsB"><span class="hs-identifier">dropCastsB</span></a></a><span> </span><a name="local-6989586621680128365"><a href="#local-6989586621680128365"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128365"><span class="hs-identifier hs-var">b</span></a><span>   </span><span class="hs-comment">-- Don't bother in the kind of a forall</span><span>
</span><a name="line-1125"></a><span>
</span><a name="line-1126"></a><span class="hs-identifier">abstractClassKeys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">]</span><span>
</span><a name="line-1127"></a><a name="abstractClassKeys"><a href="TcValidity.html#abstractClassKeys"><span class="hs-identifier">abstractClassKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="PrelNames.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a><span>
</span><a name="line-1128"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="PrelNames.html#eqTyConKey"><span class="hs-identifier hs-var">eqTyConKey</span></a><span>
</span><a name="line-1129"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="PrelNames.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a><span>
</span><a name="line-1130"></a><span>                    </span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- See Note [Equality class instances]</span><span>
</span><a name="line-1131"></a><span>
</span><a name="line-1132"></a><span class="hs-identifier">instTypeErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1133"></a><a name="instTypeErr"><a href="TcValidity.html#instTypeErr"><span class="hs-identifier">instTypeErr</span></a></a><span> </span><a name="local-6989586621680128366"><a href="#local-6989586621680128366"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128367"><a href="#local-6989586621680128367"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621680128368"><a href="#local-6989586621680128368"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1134"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal instance declaration for&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprClassPred"><span class="hs-identifier hs-var">pprClassPred</span></a><span> </span><a href="#local-6989586621680128366"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128367"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1136"></a><span>       </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621680128368"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1137"></a><span>
</span><a name="line-1138"></a><span class="hs-comment">-- | See Note [Validity checking of HasField instances]</span><span>
</span><a name="line-1139"></a><span class="hs-identifier">checkHasFieldInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1140"></a><a name="checkHasFieldInst"><a href="TcValidity.html#checkHasFieldInst"><span class="hs-identifier">checkHasFieldInst</span></a></a><span> </span><a name="local-6989586621680128369"><a href="#local-6989586621680128369"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128370"><a href="#local-6989586621680128370"><span class="hs-identifier">tys</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><a name="local-6989586621680128371"><a href="#local-6989586621680128371"><span class="hs-identifier">_k_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128372"><a href="#local-6989586621680128372"><span class="hs-identifier">x_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128373"><a href="#local-6989586621680128373"><span class="hs-identifier">r_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128374"><a href="#local-6989586621680128374"><span class="hs-identifier">_a_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1141"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621680128373"><span class="hs-identifier hs-var">r_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1142"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128375"><span class="hs-identifier hs-var">whoops</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Record data type must be specified&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1143"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128376"><a href="#local-6989586621680128376"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1144"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a><span> </span><a href="#local-6989586621680128376"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1145"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128375"><span class="hs-identifier hs-var">whoops</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Record data type may not be a data family&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1146"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#isStrLitTy"><span class="hs-identifier hs-var">isStrLitTy</span></a><span> </span><a href="#local-6989586621680128372"><span class="hs-identifier hs-var">x_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1147"></a><span>       </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128377"><a href="#local-6989586621680128377"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-1148"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#lookupTyConFieldLabel"><span class="hs-identifier hs-var">lookupTyConFieldLabel</span></a><span> </span><a href="#local-6989586621680128377"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680128376"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128375"><span class="hs-identifier hs-var">whoops</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128376"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;already has a field&quot;</span><span>
</span><a name="line-1150"></a><span>                                       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128377"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1151"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1152"></a><span>       </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1153"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConFieldLabels"><span class="hs-identifier hs-var">tyConFieldLabels</span></a><span> </span><a href="#local-6989586621680128376"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128375"><span class="hs-identifier hs-var">whoops</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128376"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has fields&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1156"></a><span>    </span><a name="local-6989586621680128375"><a href="#local-6989586621680128375"><span class="hs-identifier">whoops</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcValidity.html#instTypeErr"><span class="hs-identifier hs-var">instTypeErr</span></a><span> </span><a href="#local-6989586621680128369"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128370"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1157"></a><span class="hs-identifier">checkHasFieldInst</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128378"><a href="#local-6989586621680128378"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;checkHasFieldInst&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128378"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span class="hs-comment">{- Note [Casts during validity checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the (bogus)
     instance Eq Char#
We elaborate to  'Eq (Char# |&gt; UnivCo(hole))'  where the hole is an
insoluble equality constraint for * ~ #.  We'll report the insoluble
constraint separately, but we don't want to *also* complain that Eq is
not applied to a type constructor.  So we look gaily look through
CastTys here.

Another example:  Eq (Either a).  Then we actually get a cast in
the middle:
   Eq ((Either |&gt; g) a)


Note [Validity checking of HasField instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The HasField class has magic constraint solving behaviour (see Note
[HasField instances] in TcInteract).  However, we permit users to
declare their own instances, provided they do not clash with the
built-in behaviour.  In particular, we forbid:

  1. `HasField _ r _` where r is a variable

  2. `HasField _ (T ...) _` if T is a data family
     (because it might have fields introduced later)

  3. `HasField x (T ...) _` where x is a variable,
      if T has any fields at all

  4. `HasField &quot;foo&quot; (T ...) _` if T has a &quot;foo&quot; field

The usual functional dependency checks also apply.


Note [Valid 'deriving' predicate]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
validDerivPred checks for OK 'deriving' context.  See Note [Exotic
derived instance contexts] in TcDeriv.  However the predicate is
here because it uses sizeTypes, fvTypes.

It checks for three things

  * No repeated variables (hasNoDups fvs)

  * No type constructors.  This is done by comparing
        sizeTypes tys == length (fvTypes tys)
    sizeTypes counts variables and constructors; fvTypes returns variables.
    So if they are the same, there must be no constructors.  But there
    might be applications thus (f (g x)).

    Note that tys only includes the visible arguments of the class type
    constructor. Including the non-visible arguments can cause the following,
    perfectly valid instance to be rejected:
       class Category (cat :: k -&gt; k -&gt; *) where ...
       newtype T (c :: * -&gt; * -&gt; *) a b = MkT (c a b)
       instance Category c =&gt; Category (T c) where ...
    since the first argument to Category is a non-visible *, which sizeTypes
    would count as a constructor! See Trac #11833.

  * Also check for a bizarre corner case, when the derived instance decl
    would look like
       instance C a b =&gt; D (T a) where ...
    Note that 'b' isn't a parameter of T.  This gives rise to all sorts of
    problems; in particular, it's hard to compare solutions for equality
    when finding the fixpoint, and that means the inferContext loop does
    not converge.  See Trac #5287.

Note [Equality class instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We can't have users writing instances for the equality classes. But we
still need to be able to write instances for them ourselves. So we allow
instances only in the defining module.

-}</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span class="hs-identifier">validDerivPred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1236"></a><span class="hs-comment">-- See Note [Valid 'deriving' predicate]</span><span>
</span><a name="line-1237"></a><a name="validDerivPred"><a href="TcValidity.html#validDerivPred"><span class="hs-identifier">validDerivPred</span></a></a><span> </span><a name="local-6989586621680128379"><a href="#local-6989586621680128379"><span class="hs-identifier">tv_set</span></a></a><span> </span><a name="local-6989586621680128380"><a href="#local-6989586621680128380"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-1238"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a><span> </span><a href="#local-6989586621680128380"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1239"></a><span>       </span><a href="Type.html#ClassPred"><span class="hs-identifier hs-var">ClassPred</span></a><span> </span><a name="local-6989586621680128386"><a href="#local-6989586621680128386"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128387"><a href="#local-6989586621680128387"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128386"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#typeableClassKey"><span class="hs-identifier hs-var">typeableClassKey</span></a><span>
</span><a name="line-1240"></a><span>                </span><span class="hs-comment">-- Typeable constraints are bigger than they appear due</span><span>
</span><a name="line-1241"></a><span>                </span><span class="hs-comment">-- to kind polymorphism, but that's OK</span><span>
</span><a name="line-1242"></a><span>                       </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680128381"><span class="hs-identifier hs-var">check_tys</span></a><span> </span><a href="#local-6989586621680128386"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680128387"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1243"></a><span>       </span><a href="Type.html#EqPred"><span class="hs-identifier hs-var">EqPred</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- reject equality constraints</span><span>
</span><a name="line-1244"></a><span>       </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- Non-class predicates are ok</span><span>
</span><a name="line-1245"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1246"></a><span>    </span><a name="local-6989586621680128381"><a href="#local-6989586621680128381"><span class="hs-identifier">check_tys</span></a></a><span> </span><a name="local-6989586621680128382"><a href="#local-6989586621680128382"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128383"><a href="#local-6989586621680128383"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1247"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="ListSetOps.html#hasNoDups"><span class="hs-identifier hs-var">hasNoDups</span></a><span> </span><a href="#local-6989586621680128385"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1248"></a><span>                   </span><span class="hs-comment">-- use sizePred to ignore implicit args</span><span>
</span><a name="line-1249"></a><span>                </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span> </span><a href="#local-6989586621680128385"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#sizePred"><span class="hs-identifier hs-var">sizePred</span></a><span> </span><a href="#local-6989586621680128380"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-1250"></a><span>                </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128379"><span class="hs-identifier hs-var">tv_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128385"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1251"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680128384"><a href="#local-6989586621680128384"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680128382"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128383"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1252"></a><span>            </span><a name="local-6989586621680128385"><a href="#local-6989586621680128385"><span class="hs-identifier">fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvTypes"><span class="hs-identifier hs-var">fvTypes</span></a><span> </span><a href="#local-6989586621680128384"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-1253"></a><span>
</span><a name="line-1254"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Checking instance for termination}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1261"></a><span>
</span><a name="line-1262"></a><span class="hs-comment">{- Note [Instances and constraint synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Currently, we don't allow instances for constraint synonyms at all.
Consider these (Trac #13267):
  type C1 a = Show (a -&gt; Bool)
  instance C1 Int where    -- I1
    show _ = &quot;ur&quot;

This elicits &quot;show is not a (visible) method of class C1&quot;, which isn't
a great message. But it comes from the renamer, so it's hard to improve.

This needs a bit more care:
  type C2 a = (Show a, Show Int)
  instance C2 Int           -- I2

If we use (splitTyConApp_maybe tau) in checkValidInstance to decompose
the instance head, we'll expand the synonym on fly, and it'll look like
  instance (%,%) (Show Int, Show Int)
and we /really/ don't want that.  So we carefully do /not/ expand
synonyms, by matching on TyConApp directly.
-}</span><span>
</span><a name="line-1283"></a><span>
</span><a name="line-1284"></a><span class="hs-identifier">checkValidInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsTypes.html#LHsSigType"><span class="hs-identifier hs-type">LHsSigType</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1285"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">,</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1286"></a><a name="checkValidInstance"><a href="TcValidity.html#checkValidInstance"><span class="hs-identifier">checkValidInstance</span></a></a><span> </span><a name="local-6989586621680128388"><a href="#local-6989586621680128388"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680128389"><a href="#local-6989586621680128389"><span class="hs-identifier">hs_type</span></a></a><span> </span><a name="local-6989586621680128390"><a href="#local-6989586621680128390"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1287"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680128394"><span class="hs-identifier hs-var">is_tc_app</span></a><span>
</span><a name="line-1288"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Instance head is not headed by a class&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-6989586621680128397"><span class="hs-identifier hs-var">mb_cls</span></a><span>
</span><a name="line-1291"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal instance for a&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConFlavour"><span class="hs-identifier hs-var">tyConFlavour</span></a><span> </span><a href="#local-6989586621680128395"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A class instance must be for a class&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680128399"><span class="hs-identifier hs-var">arity_ok</span></a><span>
</span><a name="line-1295"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Arity mis-match in instance head&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1296"></a><span>
</span><a name="line-1297"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680128400"><span class="hs-identifier hs-var">head_loc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#checkValidInstHead"><span class="hs-identifier hs-var">checkValidInstHead</span></a><span> </span><a href="#local-6989586621680128388"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128398"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128396"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkValidInstance {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128390"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1300"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidTheta"><span class="hs-identifier hs-var">checkValidTheta</span></a><span> </span><a href="#local-6989586621680128388"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128392"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1301"></a><span>
</span><a name="line-1302"></a><span>        </span><span class="hs-comment">-- The Termination and Coverate Conditions</span><span>
</span><a name="line-1303"></a><span>        </span><span class="hs-comment">-- Check that instance inference will terminate (if we care)</span><span>
</span><a name="line-1304"></a><span>        </span><span class="hs-comment">-- For Haskell 98 this will already have been done by checkValidTheta,</span><span>
</span><a name="line-1305"></a><span>        </span><span class="hs-comment">-- but as we may be using other extensions we need to check.</span><span>
</span><a name="line-1306"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1307"></a><span>        </span><span class="hs-comment">-- Note that the Termination Condition is *more conservative* than</span><span>
</span><a name="line-1308"></a><span>        </span><span class="hs-comment">-- the checkAmbiguity test we do on other type signatures</span><span>
</span><a name="line-1309"></a><span>        </span><span class="hs-comment">--   e.g.  Bar a =&gt; Bar Int is ambiguous, but it also fails</span><span>
</span><a name="line-1310"></a><span>        </span><span class="hs-comment">--   the termination condition, because 'a' appears more often</span><span>
</span><a name="line-1311"></a><span>        </span><span class="hs-comment">--   in the constraint than in the head</span><span>
</span><a name="line-1312"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128401"><a href="#local-6989586621680128401"><span class="hs-identifier">undecidable_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#UndecidableInstances"><span class="hs-identifier hs-var">LangExt.UndecidableInstances</span></a><span>
</span><a name="line-1313"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680128401"><span class="hs-identifier hs-var">undecidable_ok</span></a><span>
</span><a name="line-1314"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="TcValidity.html#checkAmbiguity"><span class="hs-identifier hs-var">checkAmbiguity</span></a><span> </span><a href="#local-6989586621680128388"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680128390"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1315"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="TcValidity.html#checkInstTermination"><span class="hs-identifier hs-var">checkInstTermination</span></a><span> </span><a href="#local-6989586621680128396"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-6989586621680128392"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;cvi 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128390"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1318"></a><span>
</span><a name="line-1319"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="FunDeps.html#checkInstCoverage"><span class="hs-identifier hs-var">checkInstCoverage</span></a><span> </span><a href="#local-6989586621680128401"><span class="hs-identifier hs-var">undecidable_ok</span></a><span> </span><a href="#local-6989586621680128398"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128392"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621680128396"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1320"></a><span>            </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Check succeeded</span><span>
</span><a name="line-1321"></a><span>            </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a name="local-6989586621680128402"><a href="#local-6989586621680128402"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#instTypeErr"><span class="hs-identifier hs-var">instTypeErr</span></a><span> </span><a href="#local-6989586621680128398"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680128396"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-6989586621680128402"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;End checkValidInstance }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128391"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128392"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128398"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128396"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1326"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1327"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128391"><a href="#local-6989586621680128391"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128392"><a href="#local-6989586621680128392"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128393"><a href="#local-6989586621680128393"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a><span> </span><a href="#local-6989586621680128390"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1328"></a><span>    </span><a name="local-6989586621680128394"><a href="#local-6989586621680128394"><span class="hs-identifier">is_tc_app</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680128393"><span class="hs-identifier hs-var">tau</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1329"></a><span>    </span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621680128395"><a href="#local-6989586621680128395"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680128396"><a href="#local-6989586621680128396"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128393"><span class="hs-identifier hs-var">tau</span></a><span>   </span><span class="hs-comment">-- See Note [Instances and constraint synonyms]</span><span>
</span><a name="line-1330"></a><span>    </span><a name="local-6989586621680128397"><a href="#local-6989586621680128397"><span class="hs-identifier">mb_cls</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a><span> </span><a href="#local-6989586621680128395"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1331"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128398"><a href="#local-6989586621680128398"><span class="hs-identifier">clas</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128397"><span class="hs-identifier hs-var">mb_cls</span></a><span>
</span><a name="line-1332"></a><span>    </span><a name="local-6989586621680128399"><a href="#local-6989586621680128399"><span class="hs-identifier">arity_ok</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128396"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="Class.html#classArity"><span class="hs-identifier hs-var">classArity</span></a><span> </span><a href="#local-6989586621680128398"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-1333"></a><span>
</span><a name="line-1334"></a><span>        </span><span class="hs-comment">-- The location of the &quot;head&quot; of the instance</span><span>
</span><a name="line-1335"></a><span>    </span><a name="local-6989586621680128400"><a href="#local-6989586621680128400"><span class="hs-identifier">head_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#getLoc"><span class="hs-identifier hs-var">getLoc</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#getLHsInstDeclHead"><span class="hs-identifier hs-var">getLHsInstDeclHead</span></a><span> </span><a href="#local-6989586621680128389"><span class="hs-identifier hs-var">hs_type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1336"></a><span>
</span><a name="line-1337"></a><span class="hs-comment">{-
Note [Paterson conditions]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Termination test: the so-called &quot;Paterson conditions&quot; (see Section 5 of
&quot;Understanding functional dependencies via Constraint Handling Rules,
JFP Jan 2007).

We check that each assertion in the context satisfies:
 (1) no variable has more occurrences in the assertion than in the head, and
 (2) the assertion has fewer constructors and variables (taken together
     and counting repetitions) than the head.
This is only needed with -fglasgow-exts, as Haskell 98 restrictions
(which have already been checked) guarantee termination.

The underlying idea is that

    for any ground substitution, each assertion in the
    context has fewer type constructors than the head.
-}</span><span>
</span><a name="line-1356"></a><span>
</span><a name="line-1357"></a><span class="hs-identifier">checkInstTermination</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1358"></a><span class="hs-comment">-- See Note [Paterson conditions]</span><span>
</span><a name="line-1359"></a><a name="checkInstTermination"><a href="TcValidity.html#checkInstTermination"><span class="hs-identifier">checkInstTermination</span></a></a><span> </span><a name="local-6989586621680128403"><a href="#local-6989586621680128403"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621680128404"><a href="#local-6989586621680128404"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-1360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128407"><span class="hs-identifier hs-var">check_preds</span></a><span> </span><a href="#local-6989586621680128404"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1361"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1362"></a><span>   </span><a name="local-6989586621680128405"><a href="#local-6989586621680128405"><span class="hs-identifier">head_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvTypes"><span class="hs-identifier hs-var">fvTypes</span></a><span> </span><a href="#local-6989586621680128403"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1363"></a><span>   </span><a name="local-6989586621680128406"><a href="#local-6989586621680128406"><span class="hs-identifier">head_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><a href="#local-6989586621680128403"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1364"></a><span>
</span><a name="line-1365"></a><span>   </span><span class="hs-identifier">check_preds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1366"></a><span>   </span><a name="local-6989586621680128407"><a href="#local-6989586621680128407"><span class="hs-identifier">check_preds</span></a></a><span> </span><a name="local-6989586621680128410"><a href="#local-6989586621680128410"><span class="hs-identifier">preds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680128408"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621680128410"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-1367"></a><span>
</span><a name="line-1368"></a><span>   </span><span class="hs-identifier">check</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1369"></a><span>   </span><a name="local-6989586621680128408"><a href="#local-6989586621680128408"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-6989586621680128411"><a href="#local-6989586621680128411"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-1370"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a><span> </span><a href="#local-6989586621680128411"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1371"></a><span>         </span><a href="Type.html#EqPred"><span class="hs-identifier hs-var">EqPred</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Trac #4200.</span><span>
</span><a name="line-1372"></a><span>         </span><a href="Type.html#IrredPred"><span class="hs-identifier hs-var">IrredPred</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128409"><span class="hs-identifier hs-var">check2</span></a><span> </span><a href="#local-6989586621680128411"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128411"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-1373"></a><span>         </span><a href="Type.html#ClassPred"><span class="hs-identifier hs-var">ClassPred</span></a><span> </span><a name="local-6989586621680128412"><a href="#local-6989586621680128412"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128413"><a href="#local-6989586621680128413"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1374"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="TcValidity.html#isTerminatingClass"><span class="hs-identifier hs-var">isTerminatingClass</span></a><span> </span><a href="#local-6989586621680128412"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1375"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>
</span><a name="line-1377"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isCTupleClass"><span class="hs-identifier hs-var">isCTupleClass</span></a><span> </span><a href="#local-6989586621680128412"><span class="hs-identifier hs-var">cls</span></a><span>  </span><span class="hs-comment">-- Look inside tuple predicates; Trac #8359</span><span>
</span><a name="line-1378"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128407"><span class="hs-identifier hs-var">check_preds</span></a><span> </span><a href="#local-6989586621680128413"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1379"></a><span>
</span><a name="line-1380"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1381"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680128409"><span class="hs-identifier hs-var">check2</span></a><span> </span><a href="#local-6989586621680128411"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680128412"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128413"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1382"></a><span>                       </span><span class="hs-comment">-- Other ClassPreds</span><span>
</span><a name="line-1383"></a><span>
</span><a name="line-1384"></a><span>   </span><a name="local-6989586621680128409"><a href="#local-6989586621680128409"><span class="hs-identifier">check2</span></a></a><span> </span><a name="local-6989586621680128414"><a href="#local-6989586621680128414"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621680128415"><a href="#local-6989586621680128415"><span class="hs-identifier">pred_size</span></a></a><span>
</span><a name="line-1385"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128417"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#noMoreMsg"><span class="hs-identifier hs-var">noMoreMsg</span></a><span> </span><a href="#local-6989586621680128417"><span class="hs-identifier hs-var">bad_tvs</span></a><span> </span><a href="#local-6989586621680128416"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-1386"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128415"><span class="hs-identifier hs-var">pred_size</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621680128406"><span class="hs-identifier hs-var">head_size</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#smallerMsg"><span class="hs-identifier hs-var">smallerMsg</span></a><span> </span><a href="#local-6989586621680128416"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-1387"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1388"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-1389"></a><span>        </span><a name="local-6989586621680128416"><a href="#local-6989586621680128416"><span class="hs-identifier">what</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;constraint&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128414"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-1390"></a><span>        </span><a name="local-6989586621680128417"><a href="#local-6989586621680128417"><span class="hs-identifier">bad_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128414"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a><span> </span><a href="#local-6989586621680128405"><span class="hs-identifier hs-var">head_fvs</span></a><span>
</span><a name="line-1391"></a><span>
</span><a name="line-1392"></a><span class="hs-identifier">smallerMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1393"></a><a name="smallerMsg"><a href="TcValidity.html#smallerMsg"><span class="hs-identifier">smallerMsg</span></a></a><span> </span><a name="local-6989586621680128418"><a href="#local-6989586621680128418"><span class="hs-identifier">what</span></a></a><span>
</span><a name="line-1394"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128418"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-1395"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is no smaller than the instance head&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1396"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#undecidableMsg"><span class="hs-identifier hs-var">undecidableMsg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1397"></a><span>
</span><a name="line-1398"></a><span class="hs-identifier">noMoreMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1399"></a><a name="noMoreMsg"><a href="TcValidity.html#noMoreMsg"><span class="hs-identifier">noMoreMsg</span></a></a><span> </span><a name="local-6989586621680128419"><a href="#local-6989586621680128419"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680128420"><a href="#local-6989586621680128420"><span class="hs-identifier">what</span></a></a><span>
</span><a name="line-1400"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Variable&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#plural"><span class="hs-identifier hs-var">plural</span></a><span> </span><a href="#local-6989586621680128419"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#pprWithCommas"><span class="hs-identifier hs-var">pprWithCommas</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128419"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1401"></a><span>                </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128421"><span class="hs-identifier hs-var">occurs</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;more often&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1402"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in the&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128420"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-1403"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;than in the instance head&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1404"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#undecidableMsg"><span class="hs-identifier hs-var">undecidableMsg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1405"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1406"></a><span>   </span><a name="local-6989586621680128421"><a href="#local-6989586621680128421"><span class="hs-identifier">occurs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Util.html#isSingleton"><span class="hs-identifier hs-var">isSingleton</span></a><span> </span><a href="#local-6989586621680128419"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;occurs&quot;</span><span>
</span><a name="line-1407"></a><span>                               </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;occur&quot;</span><span>
</span><a name="line-1408"></a><span>
</span><a name="line-1409"></a><span class="hs-identifier">undecidableMsg</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">constraintKindsMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1410"></a><a name="undecidableMsg"><a href="TcValidity.html#undecidableMsg"><span class="hs-identifier">undecidableMsg</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use UndecidableInstances to permit this&quot;</span><span>
</span><a name="line-1411"></a><a name="constraintKindsMsg"><a href="TcValidity.html#constraintKindsMsg"><span class="hs-identifier">constraintKindsMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use ConstraintKinds to permit this&quot;</span><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span class="hs-comment">{-
Note [Associated type instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We allow this:
  class C a where
    type T x a
  instance C Int where
    type T (S y) Int = y
    type T Z     Int = Char

Note that
  a) The variable 'x' is not bound by the class decl
  b) 'x' is instantiated to a non-type-variable in the instance
  c) There are several type instance decls for T in the instance

All this is fine.  Of course, you can't give any *more* instances
for (T ty Int) elsewhere, because it's an *associated* type.

Note [Checking consistent instantiation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See Trac #11450 for background discussion on this check.

  class C a b where
    type T a x b

With this class decl, if we have an instance decl
  instance C ty1 ty2 where ...
then the type instance must look like
     type T ty1 v ty2 = ...
with exactly 'ty1' for 'a', 'ty2' for 'b', and some type 'v' for 'x'.
For example:

  instance C [p] Int
    type T [p] y Int = (p,y,y)

Note that

* We used to allow completely different bound variables in the
  associated type instance; e.g.
    instance C [p] Int
      type T [q] y Int = ...
  But from GHC 8.2 onwards, we don't.  It's much simpler this way.
  See Trac #11450.

* When the class variable isn't used on the RHS of the type instance,
  it's tempting to allow wildcards, thus
    instance C [p] Int
      type T [_] y Int = (y,y)
  But it's awkward to do the test, and it doesn't work if the
  variable is repeated:
    instance C (p,p) Int
      type T (_,_) y Int = (y,y)
  Even though 'p' is not used on the RHS, we still need to use 'p'
  on the LHS to establish the repeated pattern.  So to keep it simple
  we just require equality.

* For variables in associated type families that are not bound by the class
  itself, we do _not_ check if they are over-specific. In other words,
  it's perfectly acceptable to have an instance like this:

    instance C [p] Int where
      type T [p] (Maybe x) Int = x

  While the first and third arguments to T are required to be exactly [p] and
  Int, respectively, since they are bound by C, the second argument is allowed
  to be more specific than just a type variable. Furthermore, it is permissible
  to define multiple equations for T that differ only in the non-class-bound
  argument:

    instance C [p] Int where
      type T [p] (Maybe x)    Int = x
      type T [p] (Either x y) Int = x -&gt; y

  We once considered requiring that non-class-bound variables in associated
  type family instances be instantiated with distinct type variables. However,
  that requirement proved too restrictive in practice, as there were examples
  of extremely simple associated type family instances that this check would
  reject, and fixing them required tiresome boilerplate in the form of
  auxiliary type families. For instance, you would have to define the above
  example as:

    instance C [p] Int where
      type T [p] x Int = CAux x

    type family CAux x where
      CAux (Maybe x)    = x
      CAux (Either x y) = x -&gt; y

  We decided that this restriction wasn't buying us much, so we opted not
  to pursue that design (see also GHC Trac #13398).

Implementation
  * Form the mini-envt from the class type variables a,b
    to the instance decl types [p],Int:   [a-&gt;[p], b-&gt;Int]

  * Look at the tyvars a,x,b of the type family constructor T
    (it shares tyvars with the class C)

  * Apply the mini-evnt to them, and check that the result is
    consistent with the instance types [p] y Int. (where y can be any type, as
    it is not scoped over the class type variables.

We make all the instance type variables scope over the
type instances, of course, which picks up non-obvious kinds.  Eg
   class Foo (a :: k) where
      type F a
   instance Foo (b :: k -&gt; k) where
      type F b = Int
Here the instance is kind-indexed and really looks like
      type F (k-&gt;k) (b::k-&gt;k) = Int
But if the 'b' didn't scope, we would make F's instance too
poly-kinded.
-}</span><span>
</span><a name="line-1526"></a><span>
</span><a name="line-1527"></a><span class="hs-comment">-- | Extra information about the parent instance declaration, needed</span><span>
</span><a name="line-1528"></a><span class="hs-comment">-- when type-checking associated types. The 'Class' is the enclosing</span><span>
</span><a name="line-1529"></a><span class="hs-comment">-- class, the [TyVar] are the type variable of the instance decl,</span><span>
</span><a name="line-1530"></a><span class="hs-comment">-- and and the @VarEnv Type@ maps class variables to their instance</span><span>
</span><a name="line-1531"></a><span class="hs-comment">-- types.</span><span>
</span><a name="line-1532"></a><span class="hs-keyword">type</span><span> </span><a name="ClsInstInfo"><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier">ClsInstInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="VarEnv.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1533"></a><span>
</span><a name="line-1534"></a><span class="hs-keyword">type</span><span> </span><a name="AssocInstArgShape"><a href="TcValidity.html#AssocInstArgShape"><span class="hs-identifier">AssocInstArgShape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1535"></a><span>  </span><span class="hs-comment">-- AssocInstArgShape is used only for associated family instances</span><span>
</span><a name="line-1536"></a><span>  </span><span class="hs-comment">--    (mb_exp, actual)</span><span>
</span><a name="line-1537"></a><span>  </span><span class="hs-comment">-- mb_exp = Just ty  =&gt; this arg corresponds to a class variable</span><span>
</span><a name="line-1538"></a><span>  </span><span class="hs-comment">--        = Nothing  =&gt; it doesn't correspond to a class variable</span><span>
</span><a name="line-1539"></a><span>  </span><span class="hs-comment">-- e.g.  class C b where</span><span>
</span><a name="line-1540"></a><span>  </span><span class="hs-comment">--          type F a b c</span><span>
</span><a name="line-1541"></a><span>  </span><span class="hs-comment">--       instance C [x] where</span><span>
</span><a name="line-1542"></a><span>  </span><span class="hs-comment">--          type F p [x] q</span><span>
</span><a name="line-1543"></a><span>  </span><span class="hs-comment">-- We get [AssocInstArgShape] = [ (Nothing,  p)</span><span>
</span><a name="line-1544"></a><span>  </span><span class="hs-comment">--                              , (Just [x], [x])</span><span>
</span><a name="line-1545"></a><span>  </span><span class="hs-comment">--                              , (Nothing,  q)]</span><span>
</span><a name="line-1546"></a><span>
</span><a name="line-1547"></a><span class="hs-identifier">checkConsistentFamInst</span><span>
</span><a name="line-1548"></a><span>               </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span>
</span><a name="line-1549"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>              </span><span class="hs-comment">-- ^ Family tycon</span><span>
</span><a name="line-1550"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- ^ Type patterns from instance</span><span>
</span><a name="line-1551"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>               </span><span class="hs-comment">-- ^ pretty-printed user-written instance head</span><span>
</span><a name="line-1552"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1553"></a><span class="hs-comment">-- See Note [Checking consistent instantiation]</span><span>
</span><a name="line-1554"></a><span>
</span><a name="line-1555"></a><a name="checkConsistentFamInst"><a href="TcValidity.html#checkConsistentFamInst"><span class="hs-identifier">checkConsistentFamInst</span></a></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1556"></a><span class="hs-identifier">checkConsistentFamInst</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128422"><a href="#local-6989586621680128422"><span class="hs-identifier">clas</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128423"><a href="#local-6989586621680128423"><span class="hs-identifier">inst_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128424"><a href="#local-6989586621680128424"><span class="hs-identifier">mini_env</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680128425"><a href="#local-6989586621680128425"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680128426"><a href="#local-6989586621680128426"><span class="hs-identifier">at_tys</span></a></a><span> </span><a name="local-6989586621680128427"><a href="#local-6989586621680128427"><span class="hs-identifier">pp_hs_pats</span></a></a><span>
</span><a name="line-1557"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check that the associated type indeed comes from this class</span><span>
</span><a name="line-1558"></a><span>         </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621680128422"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="TyCon.html#tyConAssoc_maybe"><span class="hs-identifier hs-var">tyConAssoc_maybe</span></a><span> </span><a href="#local-6989586621680128425"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1559"></a><span>                 </span><span class="hs-special">(</span><a href="TcValidity.html#badATErr"><span class="hs-identifier hs-var">badATErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">className</span><span> </span><a href="#local-6989586621680128422"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680128425"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1560"></a><span>
</span><a name="line-1561"></a><span>       </span><span class="hs-comment">-- Check type args first (more comprehensible)</span><span>
</span><a name="line-1562"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-6989586621680128431"><span class="hs-identifier hs-var">check_arg</span></a><span> </span><a href="#local-6989586621680128430"><span class="hs-identifier hs-var">type_shapes</span></a><span class="hs-special">)</span><span>   </span><a href="#local-6989586621680128432"><span class="hs-identifier hs-var">pp_wrong_at_arg</span></a><span>
</span><a name="line-1563"></a><span>
</span><a name="line-1564"></a><span>       </span><span class="hs-comment">-- And now kind args</span><span>
</span><a name="line-1565"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-6989586621680128431"><span class="hs-identifier hs-var">check_arg</span></a><span> </span><a href="#local-6989586621680128429"><span class="hs-identifier hs-var">kind_shapes</span></a><span class="hs-special">)</span><span>
</span><a name="line-1566"></a><span>                  </span><span class="hs-special">(</span><a href="#local-6989586621680128435"><span class="hs-identifier hs-var">tidy_env2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128432"><span class="hs-identifier hs-var">pp_wrong_at_arg</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="TyCoRep.html#ppSuggestExplicitKinds"><span class="hs-identifier hs-var">ppSuggestExplicitKinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1567"></a><span>
</span><a name="line-1568"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;cfi&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128423"><span class="hs-identifier hs-var">inst_tvs</span></a><span>
</span><a name="line-1569"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128428"><span class="hs-identifier hs-var">arg_shapes</span></a><span>
</span><a name="line-1570"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128424"><span class="hs-identifier hs-var">mini_env</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1571"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1572"></a><span>    </span><span class="hs-identifier">arg_shapes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcValidity.html#AssocInstArgShape"><span class="hs-identifier hs-type">AssocInstArgShape</span></a><span class="hs-special">]</span><span>
</span><a name="line-1573"></a><span>    </span><a name="local-6989586621680128428"><a href="#local-6989586621680128428"><span class="hs-identifier">arg_shapes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621680128424"><span class="hs-identifier hs-var">mini_env</span></a><span> </span><a href="#local-6989586621680128440"><span class="hs-identifier hs-var">fam_tc_tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128441"><span class="hs-identifier hs-var">at_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1574"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680128440"><a href="#local-6989586621680128440"><span class="hs-identifier">fam_tc_tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128441"><a href="#local-6989586621680128441"><span class="hs-identifier">at_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680128425"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128426"><span class="hs-identifier hs-var">at_tys</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1575"></a><span>
</span><a name="line-1576"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128429"><a href="#local-6989586621680128429"><span class="hs-identifier">kind_shapes</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128430"><a href="#local-6989586621680128430"><span class="hs-identifier">type_shapes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#partitionInvisibles"><span class="hs-identifier hs-var">partitionInvisibles</span></a><span> </span><a href="#local-6989586621680128425"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="#local-6989586621680128428"><span class="hs-identifier hs-var">arg_shapes</span></a><span>
</span><a name="line-1577"></a><span>
</span><a name="line-1578"></a><span>    </span><span class="hs-identifier">check_arg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcValidity.html#AssocInstArgShape"><span class="hs-identifier hs-type">AssocInstArgShape</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1579"></a><span>    </span><a name="local-6989586621680128431"><a href="#local-6989586621680128431"><span class="hs-identifier">check_arg</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128442"><a href="#local-6989586621680128442"><span class="hs-identifier">exp_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128443"><a href="#local-6989586621680128443"><span class="hs-identifier">at_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128442"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128443"><span class="hs-identifier hs-var">at_ty</span></a><span>
</span><a name="line-1580"></a><span>    </span><span class="hs-identifier">check_arg</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span>     </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- Arg position does not correspond</span><span>
</span><a name="line-1581"></a><span>                                          </span><span class="hs-comment">-- to a class variable</span><span>
</span><a name="line-1582"></a><span>
</span><a name="line-1583"></a><span>    </span><a name="local-6989586621680128432"><a href="#local-6989586621680128432"><span class="hs-identifier">pp_wrong_at_arg</span></a></a><span>
</span><a name="line-1584"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type indexes must match class instance head&quot;</span><span>
</span><a name="line-1585"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128433"><span class="hs-identifier hs-var">pp_exp_act</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1586"></a><span>
</span><a name="line-1587"></a><span>    </span><a name="local-6989586621680128433"><a href="#local-6989586621680128433"><span class="hs-identifier">pp_exp_act</span></a></a><span>
</span><a name="line-1588"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expected:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680128425"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680128436"><span class="hs-identifier hs-var">expected_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1589"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;  Actual:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128427"><span class="hs-identifier hs-var">pp_hs_pats</span></a><span>
</span><a name="line-1590"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#sdocWithDynFlags"><span class="hs-identifier hs-var">sdocWithDynFlags</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680128444"><a href="#local-6989586621680128444"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1591"></a><span>               </span><a href="Outputable.html#ppWhen"><span class="hs-identifier hs-var">ppWhen</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128439"><span class="hs-identifier hs-var">has_poly_args</span></a><span> </span><a href="#local-6989586621680128444"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1592"></a><span>               </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;where the `&lt;tv&gt;' arguments are type variables,&quot;</span><span>
</span><a name="line-1593"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;distinct from each other and from the instance variables&quot;</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1594"></a><span>
</span><a name="line-1595"></a><span>    </span><span class="hs-comment">-- We need to tidy, since it's possible that expected_args will contain</span><span>
</span><a name="line-1596"></a><span>    </span><span class="hs-comment">-- inferred kind variables with names identical to those in at_tys. If we</span><span>
</span><a name="line-1597"></a><span>    </span><span class="hs-comment">-- don't, we'll end up with horrible messages like this one (#13972):</span><span>
</span><a name="line-1598"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1599"></a><span>    </span><span class="hs-comment">--   Expected: T (a -&gt; Either a b)</span><span>
</span><a name="line-1600"></a><span>    </span><span class="hs-comment">--     Actual: T (a -&gt; Either a b)</span><span>
</span><a name="line-1601"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128434"><a href="#local-6989586621680128434"><span class="hs-identifier">tidy_env1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyOpenTypes"><span class="hs-identifier hs-var">tidyOpenTypes</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621680128426"><span class="hs-identifier hs-var">at_tys</span></a><span>
</span><a name="line-1602"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128435"><a href="#local-6989586621680128435"><span class="hs-identifier">tidy_env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128436"><a href="#local-6989586621680128436"><span class="hs-identifier">expected_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1603"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyOpenTypes"><span class="hs-identifier hs-var">tidyOpenTypes</span></a><span> </span><a href="#local-6989586621680128434"><span class="hs-identifier hs-var">tidy_env1</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680128445"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128437"><span class="hs-identifier hs-var">mk_tv</span></a><span> </span><a href="#local-6989586621680128446"><span class="hs-identifier hs-var">at_ty</span></a><span>
</span><a name="line-1604"></a><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680128445"><a href="#local-6989586621680128445"><span class="hs-identifier">exp_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128446"><a href="#local-6989586621680128446"><span class="hs-identifier">at_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680128428"><span class="hs-identifier hs-var">arg_shapes</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1605"></a><span>    </span><a name="local-6989586621680128437"><a href="#local-6989586621680128437"><span class="hs-identifier">mk_tv</span></a></a><span> </span><a name="local-6989586621680128447"><a href="#local-6989586621680128447"><span class="hs-identifier">at_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a><span> </span><a href="#local-6989586621680128438"><span class="hs-identifier hs-var">tv_name</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680128447"><span class="hs-identifier hs-var">at_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1606"></a><span>    </span><a name="local-6989586621680128438"><a href="#local-6989586621680128438"><span class="hs-identifier">tv_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a><span> </span><span class="hs-special">(</span><a href="Unique.html#mkAlphaTyVarUnique"><span class="hs-identifier hs-var">mkAlphaTyVarUnique</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="OccName.html#mkTyVarOcc"><span class="hs-identifier hs-var">mkTyVarOcc</span></a><span> </span><span class="hs-string">&quot;&lt;tv&gt;&quot;</span><span class="hs-special">)</span><span> </span><a href="SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a><span>
</span><a name="line-1607"></a><span>
</span><a name="line-1608"></a><span>    </span><a name="local-6989586621680128439"><a href="#local-6989586621680128439"><span class="hs-identifier">has_poly_args</span></a></a><span> </span><a name="local-6989586621680128448"><a href="#local-6989586621680128448"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128449"><span class="hs-identifier hs-var">shapes</span></a><span>
</span><a name="line-1609"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1610"></a><span>        </span><a name="local-6989586621680128449"><a href="#local-6989586621680128449"><span class="hs-identifier">shapes</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_PrintExplicitKinds"><span class="hs-identifier hs-var">Opt_PrintExplicitKinds</span></a><span> </span><a href="#local-6989586621680128448"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128428"><span class="hs-identifier hs-var">arg_shapes</span></a><span>
</span><a name="line-1611"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128430"><span class="hs-identifier hs-var">type_shapes</span></a><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span class="hs-identifier">badATErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1614"></a><a name="badATErr"><a href="TcValidity.html#badATErr"><span class="hs-identifier">badATErr</span></a></a><span> </span><a name="local-6989586621680128450"><a href="#local-6989586621680128450"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621680128451"><a href="#local-6989586621680128451"><span class="hs-identifier">op</span></a></a><span>
</span><a name="line-1615"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Class&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128450"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1616"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;does not have an associated type&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128451"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1617"></a><span>
</span><a name="line-1618"></a><span>
</span><a name="line-1619"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Checking type instance well-formedness and termination
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1626"></a><span>
</span><a name="line-1627"></a><span class="hs-identifier">checkValidCoAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1628"></a><a name="checkValidCoAxiom"><a href="TcValidity.html#checkValidCoAxiom"><span class="hs-identifier">checkValidCoAxiom</span></a></a><span> </span><a name="local-6989586621680128452"><a href="#local-6989586621680128452"><span class="hs-identifier">ax</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128453"><a href="#local-6989586621680128453"><span class="hs-identifier">fam_tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128454"><a href="#local-6989586621680128454"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1629"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#checkValidCoAxBranch"><span class="hs-identifier hs-var">checkValidCoAxBranch</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680128453"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128455"><span class="hs-identifier hs-var">branch_list</span></a><span>
</span><a name="line-1630"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="MonadUtils.html#foldlM_"><span class="hs-identifier hs-var">foldlM_</span></a><span> </span><a href="#local-6989586621680128457"><span class="hs-identifier hs-var">check_branch_compat</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680128455"><span class="hs-identifier hs-var">branch_list</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1631"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1632"></a><span>    </span><a name="local-6989586621680128455"><a href="#local-6989586621680128455"><span class="hs-identifier">branch_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a><span> </span><a href="#local-6989586621680128454"><span class="hs-identifier hs-var">branches</span></a><span>
</span><a name="line-1633"></a><span>    </span><a name="local-6989586621680128456"><a href="#local-6989586621680128456"><span class="hs-identifier">injectivity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConInjectivityInfo"><span class="hs-identifier hs-var">tyConInjectivityInfo</span></a><span> </span><a href="#local-6989586621680128453"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1634"></a><span>
</span><a name="line-1635"></a><span>    </span><span class="hs-identifier">check_branch_compat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- previous branches in reverse order</span><span>
</span><a name="line-1636"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>      </span><span class="hs-comment">-- current branch</span><span>
</span><a name="line-1637"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span class="hs-comment">-- current branch : previous branches</span><span>
</span><a name="line-1638"></a><span>    </span><span class="hs-comment">-- Check for</span><span>
</span><a name="line-1639"></a><span>    </span><span class="hs-comment">--   (a) this branch is dominated by previous ones</span><span>
</span><a name="line-1640"></a><span>    </span><span class="hs-comment">--   (b) failure of injectivity</span><span>
</span><a name="line-1641"></a><span>    </span><a name="local-6989586621680128457"><a href="#local-6989586621680128457"><span class="hs-identifier">check_branch_compat</span></a></a><span> </span><a name="local-6989586621680128461"><a href="#local-6989586621680128461"><span class="hs-identifier">prev_branches</span></a></a><span> </span><a name="local-6989586621680128462"><a href="#local-6989586621680128462"><span class="hs-identifier">cur_branch</span></a></a><span>
</span><a name="line-1642"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128462"><span class="hs-identifier hs-var">cur_branch</span></a><span> </span><span class="hs-special">`</span><a href="FamInstEnv.html#isDominatedBy"><span class="hs-identifier hs-var">isDominatedBy</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128461"><span class="hs-identifier hs-var">prev_branches</span></a><span>
</span><a name="line-1643"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span> </span><a href="DynFlags.html#NoReason"><span class="hs-identifier hs-var">NoReason</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxBranchSpan"><span class="hs-identifier hs-var">coAxBranchSpan</span></a><span> </span><a href="#local-6989586621680128462"><span class="hs-identifier hs-var">cur_branch</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1644"></a><span>             </span><a href="TcValidity.html#inaccessibleCoAxBranch"><span class="hs-identifier hs-var">inaccessibleCoAxBranch</span></a><span> </span><a href="#local-6989586621680128452"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621680128462"><span class="hs-identifier hs-var">cur_branch</span></a><span>
</span><a name="line-1645"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680128461"><span class="hs-identifier hs-var">prev_branches</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1646"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1647"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621680128458"><span class="hs-identifier hs-var">check_injectivity</span></a><span> </span><a href="#local-6989586621680128461"><span class="hs-identifier hs-var">prev_branches</span></a><span> </span><a href="#local-6989586621680128462"><span class="hs-identifier hs-var">cur_branch</span></a><span>
</span><a name="line-1648"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128462"><span class="hs-identifier hs-var">cur_branch</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680128461"><span class="hs-identifier hs-var">prev_branches</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1649"></a><span>
</span><a name="line-1650"></a><span>     </span><span class="hs-comment">-- Injectivity check: check whether a new (CoAxBranch) can extend</span><span>
</span><a name="line-1651"></a><span>     </span><span class="hs-comment">-- already checked equations without violating injectivity</span><span>
</span><a name="line-1652"></a><span>     </span><span class="hs-comment">-- annotation supplied by the user.</span><span>
</span><a name="line-1653"></a><span>     </span><span class="hs-comment">-- See Note [Verifying injectivity annotation] in FamInstEnv</span><span>
</span><a name="line-1654"></a><span>    </span><a name="local-6989586621680128458"><a href="#local-6989586621680128458"><span class="hs-identifier">check_injectivity</span></a></a><span> </span><a name="local-6989586621680128463"><a href="#local-6989586621680128463"><span class="hs-identifier">prev_branches</span></a></a><span> </span><a name="local-6989586621680128464"><a href="#local-6989586621680128464"><span class="hs-identifier">cur_branch</span></a></a><span>
</span><a name="line-1655"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a name="local-6989586621680128465"><a href="#local-6989586621680128465"><span class="hs-identifier">inj</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680128456"><span class="hs-identifier hs-var">injectivity</span></a><span>
</span><a name="line-1656"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128466"><a href="#local-6989586621680128466"><span class="hs-identifier">conflicts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1657"></a><span>                     </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128459"><span class="hs-identifier hs-var">gather_conflicts</span></a><span> </span><a href="#local-6989586621680128465"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621680128463"><span class="hs-identifier hs-var">prev_branches</span></a><span> </span><a href="#local-6989586621680128464"><span class="hs-identifier hs-var">cur_branch</span></a><span class="hs-special">)</span><span>
</span><a name="line-1658"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128463"><span class="hs-identifier hs-var">prev_branches</span></a><span>
</span><a name="line-1659"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680128467"><a href="#local-6989586621680128467"><span class="hs-identifier">err</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128468"><a href="#local-6989586621680128468"><span class="hs-identifier">span</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680128468"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-6989586621680128467"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-1660"></a><span>                   </span><span class="hs-special">(</span><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier hs-var">makeInjectivityErrors</span></a><span> </span><a href="#local-6989586621680128452"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621680128464"><span class="hs-identifier hs-var">cur_branch</span></a><span> </span><a href="#local-6989586621680128465"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621680128466"><span class="hs-identifier hs-var">conflicts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1661"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1662"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>    </span><a name="local-6989586621680128459"><a href="#local-6989586621680128459"><span class="hs-identifier">gather_conflicts</span></a></a><span> </span><a name="local-6989586621680128469"><a href="#local-6989586621680128469"><span class="hs-identifier">inj</span></a></a><span> </span><a name="local-6989586621680128470"><a href="#local-6989586621680128470"><span class="hs-identifier">prev_branches</span></a></a><span> </span><a name="local-6989586621680128471"><a href="#local-6989586621680128471"><span class="hs-identifier">cur_branch</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128472"><a href="#local-6989586621680128472"><span class="hs-identifier">acc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128473"><a href="#local-6989586621680128473"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680128474"><a href="#local-6989586621680128474"><span class="hs-identifier">branch</span></a></a><span>
</span><a name="line-1665"></a><span>               </span><span class="hs-comment">-- n is 0-based index of branch in prev_branches</span><span>
</span><a name="line-1666"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var">injectiveBranches</span></a><span> </span><a href="#local-6989586621680128469"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621680128471"><span class="hs-identifier hs-var">cur_branch</span></a><span> </span><a href="#local-6989586621680128474"><span class="hs-identifier hs-var">branch</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1667"></a><span>          </span><a href="FamInstEnv.html#InjectivityUnified"><span class="hs-identifier hs-var">InjectivityUnified</span></a><span> </span><a name="local-6989586621680128475"><a href="#local-6989586621680128475"><span class="hs-identifier">ax1</span></a></a><span> </span><a name="local-6989586621680128476"><a href="#local-6989586621680128476"><span class="hs-identifier">ax2</span></a></a><span>
</span><a name="line-1668"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128475"><span class="hs-identifier hs-var">ax1</span></a><span> </span><span class="hs-special">`</span><a href="FamInstEnv.html#isDominatedBy"><span class="hs-identifier hs-var">isDominatedBy</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128460"><span class="hs-identifier hs-var">replace_br</span></a><span> </span><a href="#local-6989586621680128470"><span class="hs-identifier hs-var">prev_branches</span></a><span> </span><a href="#local-6989586621680128473"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680128476"><span class="hs-identifier hs-var">ax2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1669"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128472"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128473"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1670"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1671"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128474"><span class="hs-identifier hs-var">branch</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680128472"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128473"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1672"></a><span>          </span><a href="FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128472"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128473"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1673"></a><span>
</span><a name="line-1674"></a><span>    </span><span class="hs-comment">-- Replace n-th element in the list. Assumes 0-based indexing.</span><span>
</span><a name="line-1675"></a><span>    </span><span class="hs-identifier">replace_br</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span>
</span><a name="line-1676"></a><span>    </span><a name="local-6989586621680128460"><a href="#local-6989586621680128460"><span class="hs-identifier">replace_br</span></a></a><span> </span><a name="local-6989586621680128477"><a href="#local-6989586621680128477"><span class="hs-identifier">brs</span></a></a><span> </span><a name="local-6989586621680128478"><a href="#local-6989586621680128478"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680128479"><a href="#local-6989586621680128479"><span class="hs-identifier">br</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a><span> </span><a href="#local-6989586621680128478"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680128477"><span class="hs-identifier hs-var">brs</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680128479"><span class="hs-identifier hs-var">br</span></a><span class="hs-special">]</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128478"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128477"><span class="hs-identifier hs-var">brs</span></a><span>
</span><a name="line-1677"></a><span>
</span><a name="line-1678"></a><span>
</span><a name="line-1679"></a><span class="hs-comment">-- Check that a &quot;type instance&quot; is well-formed (which includes decidability</span><span>
</span><a name="line-1680"></a><span class="hs-comment">-- unless -XUndecidableInstances is given).</span><span>
</span><a name="line-1681"></a><span class="hs-comment">--</span><span>
</span><a name="line-1682"></a><span class="hs-identifier">checkValidCoAxBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span>
</span><a name="line-1683"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1684"></a><a name="checkValidCoAxBranch"><a href="TcValidity.html#checkValidCoAxBranch"><span class="hs-identifier">checkValidCoAxBranch</span></a></a><span> </span><a name="local-6989586621680128480"><a href="#local-6989586621680128480"><span class="hs-identifier">mb_clsinfo</span></a></a><span> </span><a name="local-6989586621680128481"><a href="#local-6989586621680128481"><span class="hs-identifier">fam_tc</span></a></a><span>
</span><a name="line-1685"></a><span>                    </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128482"><a href="#local-6989586621680128482"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128483"><a href="#local-6989586621680128483"><span class="hs-identifier">cvs</span></a></a><span>
</span><a name="line-1686"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128484"><a href="#local-6989586621680128484"><span class="hs-identifier">typats</span></a></a><span>
</span><a name="line-1687"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128485"><a href="#local-6989586621680128485"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680128486"><a href="#local-6989586621680128486"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1688"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#checkValidTyFamEqn"><span class="hs-identifier hs-var">checkValidTyFamEqn</span></a><span> </span><a href="#local-6989586621680128480"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span> </span><a href="#local-6989586621680128481"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680128482"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680128483"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621680128484"><span class="hs-identifier hs-var">typats</span></a><span> </span><a href="#local-6989586621680128485"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680128487"><span class="hs-identifier hs-var">pp_lhs</span></a><span> </span><a href="#local-6989586621680128486"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1689"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1690"></a><span>    </span><a name="local-6989586621680128487"><a href="#local-6989586621680128487"><span class="hs-identifier">pp_lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680128481"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680128484"><span class="hs-identifier hs-var">typats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>
</span><a name="line-1692"></a><span class="hs-comment">-- | Do validity checks on a type family equation, including consistency</span><span>
</span><a name="line-1693"></a><span class="hs-comment">-- with any enclosing class instance head, termination, and lack of</span><span>
</span><a name="line-1694"></a><span class="hs-comment">-- polytypes.</span><span>
</span><a name="line-1695"></a><span class="hs-identifier">checkValidTyFamEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span>
</span><a name="line-1696"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>   </span><span class="hs-comment">-- ^ of the type family</span><span>
</span><a name="line-1697"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ bound tyvars in the equation</span><span>
</span><a name="line-1698"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ bound covars in the equation</span><span>
</span><a name="line-1699"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ type patterns</span><span>
</span><a name="line-1700"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>    </span><span class="hs-comment">-- ^ rhs</span><span>
</span><a name="line-1701"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>    </span><span class="hs-comment">-- ^ user-written LHS</span><span>
</span><a name="line-1702"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span>
</span><a name="line-1703"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1704"></a><a name="checkValidTyFamEqn"><a href="TcValidity.html#checkValidTyFamEqn"><span class="hs-identifier">checkValidTyFamEqn</span></a></a><span> </span><a name="local-6989586621680128488"><a href="#local-6989586621680128488"><span class="hs-identifier">mb_clsinfo</span></a></a><span> </span><a name="local-6989586621680128489"><a href="#local-6989586621680128489"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680128490"><a href="#local-6989586621680128490"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680128491"><a href="#local-6989586621680128491"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621680128492"><a href="#local-6989586621680128492"><span class="hs-identifier">typats</span></a></a><span> </span><a name="local-6989586621680128493"><a href="#local-6989586621680128493"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621680128494"><a href="#local-6989586621680128494"><span class="hs-identifier">pp_lhs</span></a></a><span> </span><a name="local-6989586621680128495"><a href="#local-6989586621680128495"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1705"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680128495"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1706"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcValidity.html#checkValidFamPats"><span class="hs-identifier hs-var">checkValidFamPats</span></a><span> </span><a href="#local-6989586621680128488"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span> </span><a href="#local-6989586621680128489"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680128490"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680128491"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621680128492"><span class="hs-identifier hs-var">typats</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680128494"><span class="hs-identifier hs-var">pp_lhs</span></a><span>
</span><a name="line-1707"></a><span>
</span><a name="line-1708"></a><span>         </span><span class="hs-comment">-- The argument patterns, and RHS, are all boxed tau types</span><span>
</span><a name="line-1709"></a><span>         </span><span class="hs-comment">-- E.g  Reject type family F (a :: k1) :: k2</span><span>
</span><a name="line-1710"></a><span>         </span><span class="hs-comment">--             type instance F (forall a. a-&gt;a) = ...</span><span>
</span><a name="line-1711"></a><span>         </span><span class="hs-comment">--             type instance F Int#             = ...</span><span>
</span><a name="line-1712"></a><span>         </span><span class="hs-comment">--             type instance F Int              = forall a. a-&gt;a</span><span>
</span><a name="line-1713"></a><span>         </span><span class="hs-comment">--             type instance F Int              = Int#</span><span>
</span><a name="line-1714"></a><span>         </span><span class="hs-comment">-- See Trac #9357</span><span>
</span><a name="line-1715"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidMonoType"><span class="hs-identifier hs-var">checkValidMonoType</span></a><span> </span><a href="#local-6989586621680128493"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1716"></a><span>
</span><a name="line-1717"></a><span>         </span><span class="hs-comment">-- We have a decidable instance unless otherwise permitted</span><span>
</span><a name="line-1718"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680128496"><a href="#local-6989586621680128496"><span class="hs-identifier">undecidable_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.4.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#UndecidableInstances"><span class="hs-identifier hs-var">LangExt.UndecidableInstances</span></a><span>
</span><a name="line-1719"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-6989586621680128496"><span class="hs-identifier hs-var">undecidable_ok</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1720"></a><span>           </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#checkFamInstRhs"><span class="hs-identifier hs-var">checkFamInstRhs</span></a><span> </span><a href="#local-6989586621680128492"><span class="hs-identifier hs-var">typats</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#tcTyFamInsts"><span class="hs-identifier hs-var">tcTyFamInsts</span></a><span> </span><a href="#local-6989586621680128493"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1721"></a><span>
</span><a name="line-1722"></a><span class="hs-comment">-- Make sure that each type family application is</span><span>
</span><a name="line-1723"></a><span class="hs-comment">--   (1) strictly smaller than the lhs,</span><span>
</span><a name="line-1724"></a><span class="hs-comment">--   (2) mentions no type variable more often than the lhs, and</span><span>
</span><a name="line-1725"></a><span class="hs-comment">--   (3) does not contain any further type family instances.</span><span>
</span><a name="line-1726"></a><span class="hs-comment">--</span><span>
</span><a name="line-1727"></a><span class="hs-identifier">checkFamInstRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- lhs</span><span>
</span><a name="line-1728"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- type family instances</span><span>
</span><a name="line-1729"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span class="hs-special">]</span><span>
</span><a name="line-1730"></a><a name="checkFamInstRhs"><a href="TcValidity.html#checkFamInstRhs"><span class="hs-identifier">checkFamInstRhs</span></a></a><span> </span><a name="local-6989586621680128497"><a href="#local-6989586621680128497"><span class="hs-identifier">lhsTys</span></a></a><span> </span><a name="local-6989586621680128498"><a href="#local-6989586621680128498"><span class="hs-identifier">famInsts</span></a></a><span>
</span><a name="line-1731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a><span> </span><a href="#local-6989586621680128501"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621680128498"><span class="hs-identifier hs-var">famInsts</span></a><span>
</span><a name="line-1732"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1733"></a><span>   </span><a name="local-6989586621680128499"><a href="#local-6989586621680128499"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><a href="#local-6989586621680128497"><span class="hs-identifier hs-var">lhsTys</span></a><span>
</span><a name="line-1734"></a><span>   </span><a name="local-6989586621680128500"><a href="#local-6989586621680128500"><span class="hs-identifier">fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvTypes"><span class="hs-identifier hs-var">fvTypes</span></a><span> </span><a href="#local-6989586621680128497"><span class="hs-identifier hs-var">lhsTys</span></a><span>
</span><a name="line-1735"></a><span>   </span><a name="local-6989586621680128501"><a href="#local-6989586621680128501"><span class="hs-identifier">check</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128502"><a href="#local-6989586621680128502"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680128503"><a href="#local-6989586621680128503"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1736"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="TcType.html#isTyFamFree"><span class="hs-identifier hs-var">isTyFamFree</span></a><span> </span><a href="#local-6989586621680128503"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#nestedMsg"><span class="hs-identifier hs-var">nestedMsg</span></a><span> </span><a href="#local-6989586621680128504"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128505"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#noMoreMsg"><span class="hs-identifier hs-var">noMoreMsg</span></a><span> </span><a href="#local-6989586621680128505"><span class="hs-identifier hs-var">bad_tvs</span></a><span> </span><a href="#local-6989586621680128504"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-1738"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128499"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="TcValidity.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><a href="#local-6989586621680128503"><span class="hs-identifier hs-var">tys</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#smallerMsg"><span class="hs-identifier hs-var">smallerMsg</span></a><span> </span><a href="#local-6989586621680128504"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-1739"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1740"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1741"></a><span>        </span><a name="local-6989586621680128504"><a href="#local-6989586621680128504"><span class="hs-identifier">what</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type family application&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprType"><span class="hs-identifier hs-var">pprType</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a href="#local-6989586621680128502"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680128503"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1742"></a><span>        </span><a name="local-6989586621680128505"><a href="#local-6989586621680128505"><span class="hs-identifier">bad_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvTypes"><span class="hs-identifier hs-var">fvTypes</span></a><span> </span><a href="#local-6989586621680128503"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#%5C%5C"><span class="hs-operator hs-var">\\</span></a><span> </span><a href="#local-6989586621680128500"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1743"></a><span>
</span><a name="line-1744"></a><span class="hs-identifier">checkValidFamPats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1745"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ patterns the user wrote</span><span>
</span><a name="line-1746"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ &quot;extra&quot; patterns from a data instance kind sig</span><span>
</span><a name="line-1747"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>     </span><span class="hs-comment">-- ^ pretty-printed user-written instance head</span><span>
</span><a name="line-1748"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1749"></a><span class="hs-comment">-- Patterns in a 'type instance' or 'data instance' decl should</span><span>
</span><a name="line-1750"></a><span class="hs-comment">-- a) contain no type family applications</span><span>
</span><a name="line-1751"></a><span class="hs-comment">--    (vanilla synonyms are fine, though)</span><span>
</span><a name="line-1752"></a><span class="hs-comment">-- b) properly bind all their free type variables</span><span>
</span><a name="line-1753"></a><span class="hs-comment">--    e.g. we disallow (Trac #7536)</span><span>
</span><a name="line-1754"></a><span class="hs-comment">--         type T a = Int</span><span>
</span><a name="line-1755"></a><span class="hs-comment">--         type instance F (T a) = a</span><span>
</span><a name="line-1756"></a><span class="hs-comment">-- c) For associated types, are consistently instantiated</span><span>
</span><a name="line-1757"></a><a name="checkValidFamPats"><a href="TcValidity.html#checkValidFamPats"><span class="hs-identifier">checkValidFamPats</span></a></a><span> </span><a name="local-6989586621680128506"><a href="#local-6989586621680128506"><span class="hs-identifier">mb_clsinfo</span></a></a><span> </span><a name="local-6989586621680128507"><a href="#local-6989586621680128507"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680128508"><a href="#local-6989586621680128508"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680128509"><a href="#local-6989586621680128509"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621680128510"><a href="#local-6989586621680128510"><span class="hs-identifier">user_ty_pats</span></a></a><span> </span><a name="local-6989586621680128511"><a href="#local-6989586621680128511"><span class="hs-identifier">extra_ty_pats</span></a></a><span> </span><a name="local-6989586621680128512"><a href="#local-6989586621680128512"><span class="hs-identifier">pp_hs_pats</span></a></a><span>
</span><a name="line-1758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="TcValidity.html#checkValidTypePat"><span class="hs-identifier hs-var">checkValidTypePat</span></a><span> </span><a href="#local-6989586621680128510"><span class="hs-identifier hs-var">user_ty_pats</span></a><span>
</span><a name="line-1759"></a><span>
</span><a name="line-1760"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128513"><a href="#local-6989586621680128513"><span class="hs-identifier">unbound_tcvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TcType.html#exactTyCoVarsOfTypes"><span class="hs-identifier hs-var">exactTyCoVarsOfTypes</span></a><span> </span><a href="#local-6989586621680128510"><span class="hs-identifier hs-var">user_ty_pats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1761"></a><span>                                      </span><span class="hs-special">(</span><a href="#local-6989586621680128508"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680128509"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1762"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680128513"><span class="hs-identifier hs-var">unbound_tcvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#famPatErr"><span class="hs-identifier hs-var">famPatErr</span></a><span> </span><a href="#local-6989586621680128507"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680128513"><span class="hs-identifier hs-var">unbound_tcvs</span></a><span> </span><a href="#local-6989586621680128510"><span class="hs-identifier hs-var">user_ty_pats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1763"></a><span>
</span><a name="line-1764"></a><span>         </span><span class="hs-comment">-- Check that type patterns match the class instance head</span><span>
</span><a name="line-1765"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkConsistentFamInst"><span class="hs-identifier hs-var">checkConsistentFamInst</span></a><span> </span><a href="#local-6989586621680128506"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span> </span><a href="#local-6989586621680128507"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128510"><span class="hs-identifier hs-var">user_ty_pats</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128511"><span class="hs-identifier hs-var">extra_ty_pats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128512"><span class="hs-identifier hs-var">pp_hs_pats</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1766"></a><span>
</span><a name="line-1767"></a><span class="hs-identifier">checkValidTypePat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1768"></a><span class="hs-comment">-- Used for type patterns in class instances,</span><span>
</span><a name="line-1769"></a><span class="hs-comment">-- and in type/data family instances</span><span>
</span><a name="line-1770"></a><a name="checkValidTypePat"><a href="TcValidity.html#checkValidTypePat"><span class="hs-identifier">checkValidTypePat</span></a></a><span> </span><a name="local-6989586621680128514"><a href="#local-6989586621680128514"><span class="hs-identifier">pat_ty</span></a></a><span>
</span><a name="line-1771"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check that pat_ty is a monotype</span><span>
</span><a name="line-1772"></a><span>         </span><a href="TcValidity.html#checkValidMonoType"><span class="hs-identifier hs-var">checkValidMonoType</span></a><span> </span><a href="#local-6989586621680128514"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-1773"></a><span>             </span><span class="hs-comment">-- One could imagine generalising to allow</span><span>
</span><a name="line-1774"></a><span>             </span><span class="hs-comment">--      instance C (forall a. a-&gt;a)</span><span>
</span><a name="line-1775"></a><span>             </span><span class="hs-comment">-- but we don't know what all the consequences might be</span><span>
</span><a name="line-1776"></a><span>
</span><a name="line-1777"></a><span>          </span><span class="hs-comment">-- Ensure that no type family instances occur a type pattern</span><span>
</span><a name="line-1778"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#isTyFamFree"><span class="hs-identifier hs-var">isTyFamFree</span></a><span> </span><a href="#local-6989586621680128514"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1779"></a><span>         </span><a href="TcValidity.html#tyFamInstIllegalErr"><span class="hs-identifier hs-var">tyFamInstIllegalErr</span></a><span> </span><a href="#local-6989586621680128514"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1780"></a><span>
</span><a name="line-1781"></a><span class="hs-comment">-- Error messages</span><span>
</span><a name="line-1782"></a><span>
</span><a name="line-1783"></a><span class="hs-identifier">inaccessibleCoAxBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-6989586621680128130"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1784"></a><a name="inaccessibleCoAxBranch"><a href="TcValidity.html#inaccessibleCoAxBranch"><span class="hs-identifier">inaccessibleCoAxBranch</span></a></a><span> </span><a name="local-6989586621680128515"><a href="#local-6989586621680128515"><span class="hs-identifier">fi_ax</span></a></a><span> </span><a name="local-6989586621680128516"><a href="#local-6989586621680128516"><span class="hs-identifier">cur_branch</span></a></a><span>
</span><a name="line-1785"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type family instance equation is overlapped:&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1786"></a><span>    </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#pprCoAxBranch"><span class="hs-identifier hs-var">pprCoAxBranch</span></a><span> </span><a href="#local-6989586621680128515"><span class="hs-identifier hs-var">fi_ax</span></a><span> </span><a href="#local-6989586621680128516"><span class="hs-identifier hs-var">cur_branch</span></a><span class="hs-special">)</span><span>
</span><a name="line-1787"></a><span>
</span><a name="line-1788"></a><span class="hs-identifier">tyFamInstIllegalErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1789"></a><a name="tyFamInstIllegalErr"><a href="TcValidity.html#tyFamInstIllegalErr"><span class="hs-identifier">tyFamInstIllegalErr</span></a></a><span> </span><a name="local-6989586621680128517"><a href="#local-6989586621680128517"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1790"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal type synonym family application in instance&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-1791"></a><span>         </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1792"></a><span>      </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128517"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1793"></a><span>
</span><a name="line-1794"></a><span class="hs-identifier">nestedMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1795"></a><a name="nestedMsg"><a href="TcValidity.html#nestedMsg"><span class="hs-identifier">nestedMsg</span></a></a><span> </span><a name="local-6989586621680128518"><a href="#local-6989586621680128518"><span class="hs-identifier">what</span></a></a><span>
</span><a name="line-1796"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal nested&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128518"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-1797"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="TcValidity.html#undecidableMsg"><span class="hs-identifier hs-var">undecidableMsg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1798"></a><span>
</span><a name="line-1799"></a><span class="hs-identifier">famPatErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1800"></a><a name="famPatErr"><a href="TcValidity.html#famPatErr"><span class="hs-identifier">famPatErr</span></a></a><span> </span><a name="local-6989586621680128519"><a href="#local-6989586621680128519"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680128520"><a href="#local-6989586621680128520"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680128521"><a href="#local-6989586621680128521"><span class="hs-identifier">pats</span></a></a><span>
</span><a name="line-1801"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Family instance purports to bind type variable&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#plural"><span class="hs-identifier hs-var">plural</span></a><span> </span><a href="#local-6989586621680128520"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1802"></a><span>          </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#pprQuotedList"><span class="hs-identifier hs-var">pprQuotedList</span></a><span> </span><a href="#local-6989586621680128520"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1803"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but the real LHS (expanding synonyms) is:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1804"></a><span>             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprTypeApp"><span class="hs-identifier hs-var">pprTypeApp</span></a><span> </span><a href="#local-6989586621680128519"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Type.html#expandTypeSynonyms"><span class="hs-identifier hs-var">expandTypeSynonyms</span></a><span> </span><a href="#local-6989586621680128521"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1805"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;= ...&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1806"></a><span>
</span><a name="line-1807"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
   Telescope checking
*                                                                      *
************************************************************************

Note [Bad telescopes]
~~~~~~~~~~~~~~~~~~~~~
Now that we can mix type and kind variables, there are an awful lot of
ways to shoot yourself in the foot. Here are some.

  data SameKind :: k -&gt; k -&gt; *   -- just to force unification

1.  data T1 a k (b :: k) (x :: SameKind a b)

The problem here is that we discover that a and b should have the same
kind. But this kind mentions k, which is bound *after* a.
(Testcase: dependent/should_fail/BadTelescope)

2.  data T2 a (c :: Proxy b) (d :: Proxy a) (x :: SameKind b d)

Note that b is not bound. Yet its kind mentions a. Because we have
a nice rule that all implicitly bound variables come before others,
this is bogus. (We could probably figure out to put b between a and c.
But I think this is doing users a disservice, in the long run.)
(Testcase: dependent/should_fail/BadTelescope4)

3. t3 :: forall a. (forall k (b :: k). SameKind a b) -&gt; ()

This is a straightforward skolem escape. Note that a and b need to have
the same kind.
(Testcase: polykinds/T11142)

How do we deal with all of this? For TyCons, we have checkValidTyConTyVars.
That function looks to see if any of the tyConTyVars are repeated, but
it's really a telescope check. It works because all tycons are kind-generalized.
If there is a bad telescope, the kind-generalization will end up generalizing
over a variable bound later in the telescope.

For non-tycons, we do scope checking when we bring tyvars into scope,
in tcImplicitTKBndrs and tcExplicitTKBndrs. Note that we also have to
sort implicit binders into a well-scoped order whenever we have implicit
binders to worry about. This is done in quantifyTyVars and in
tcImplicitTKBndrs.
-}</span><span>
</span><a name="line-1853"></a><span>
</span><a name="line-1854"></a><span class="hs-comment">-- | Check a list of binders to see if they make a valid telescope.</span><span>
</span><a name="line-1855"></a><span class="hs-comment">-- The key property we're checking for is scoping. For example:</span><span>
</span><a name="line-1856"></a><span class="hs-comment">-- &gt; data SameKind :: k -&gt; k -&gt; *</span><span>
</span><a name="line-1857"></a><span class="hs-comment">-- &gt; data X a k (b :: k) (c :: SameKind a b)</span><span>
</span><a name="line-1858"></a><span class="hs-comment">-- Kind inference says that a's kind should be k. But that's impossible,</span><span>
</span><a name="line-1859"></a><span class="hs-comment">-- because k isn't in scope when a is bound. This check has to come before</span><span>
</span><a name="line-1860"></a><span class="hs-comment">-- general validity checking, because once we kind-generalise, this sort</span><span>
</span><a name="line-1861"></a><span class="hs-comment">-- of problem is harder to spot (as we'll generalise over the unbound</span><span>
</span><a name="line-1862"></a><span class="hs-comment">-- k in a's type.) See also Note [Bad telescopes].</span><span>
</span><a name="line-1863"></a><span class="hs-identifier">checkValidTelescope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>        </span><span class="hs-comment">-- the original user-written telescope</span><span>
</span><a name="line-1864"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- explicit vars (not necessarily zonked)</span><span>
</span><a name="line-1865"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>        </span><span class="hs-comment">-- note to put at bottom of message</span><span>
</span><a name="line-1866"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1867"></a><a name="checkValidTelescope"><a href="TcValidity.html#checkValidTelescope"><span class="hs-identifier">checkValidTelescope</span></a></a><span> </span><a name="local-6989586621680128522"><a href="#local-6989586621680128522"><span class="hs-identifier">hs_tvs</span></a></a><span> </span><a name="local-6989586621680128523"><a href="#local-6989586621680128523"><span class="hs-identifier">orig_tvs</span></a></a><span> </span><a name="local-6989586621680128524"><a href="#local-6989586621680128524"><span class="hs-identifier">extra</span></a></a><span>
</span><a name="line-1868"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcValidity.html#checkZonkValidTelescope"><span class="hs-identifier hs-var">checkZonkValidTelescope</span></a><span> </span><a href="#local-6989586621680128522"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><a href="#local-6989586621680128523"><span class="hs-identifier hs-var">orig_tvs</span></a><span> </span><a href="#local-6989586621680128524"><span class="hs-identifier hs-var">extra</span></a><span>
</span><a name="line-1869"></a><span>
</span><a name="line-1870"></a><span class="hs-comment">-- | Like 'checkZonkValidTelescope', but returns the zonked tyvars</span><span>
</span><a name="line-1871"></a><span class="hs-identifier">checkZonkValidTelescope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1872"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1873"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1874"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1875"></a><a name="checkZonkValidTelescope"><a href="TcValidity.html#checkZonkValidTelescope"><span class="hs-identifier">checkZonkValidTelescope</span></a></a><span> </span><a name="local-6989586621680128525"><a href="#local-6989586621680128525"><span class="hs-identifier">hs_tvs</span></a></a><span> </span><a name="local-6989586621680128526"><a href="#local-6989586621680128526"><span class="hs-identifier">orig_tvs</span></a></a><span> </span><a name="local-6989586621680128527"><a href="#local-6989586621680128527"><span class="hs-identifier">extra</span></a></a><span>
</span><a name="line-1876"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680128536"><a href="#local-6989586621680128536"><span class="hs-identifier">orig_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcMType.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a><span> </span><a href="#local-6989586621680128526"><span class="hs-identifier hs-var">orig_tvs</span></a><span>
</span><a name="line-1877"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680128537"><a href="#local-6989586621680128537"><span class="hs-identifier">sorted_tidied_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyTyCoVarBndrs"><span class="hs-identifier hs-var">tidyTyCoVarBndrs</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1878"></a><span>                                      </span><a href="Type.html#toposortTyVars"><span class="hs-identifier hs-var">toposortTyVars</span></a><span> </span><a href="#local-6989586621680128536"><span class="hs-identifier hs-var">orig_tvs</span></a><span>
</span><a name="line-1879"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128528"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-6989586621680128536"><span class="hs-identifier hs-var">orig_tvs</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1880"></a><span>         </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1881"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;These kind and type variables:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680128525"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1882"></a><span>                      </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;are out of dependency order. Perhaps try this ordering:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1883"></a><span>                   </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TyCoRep.html#pprTyVar"><span class="hs-identifier hs-var">pprTyVar</span></a><span> </span><a href="#local-6989586621680128537"><span class="hs-identifier hs-var">sorted_tidied_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1884"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128527"><span class="hs-identifier hs-var">extra</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1885"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680128536"><span class="hs-identifier hs-var">orig_tvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1888"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- misplaced variables</span><span>
</span><a name="line-1889"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1890"></a><span>    </span><a name="local-6989586621680128528"><a href="#local-6989586621680128528"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621680128529"><a href="#local-6989586621680128529"><span class="hs-identifier">errs</span></a></a><span> </span><a name="local-6989586621680128530"><a href="#local-6989586621680128530"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128530"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128529"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1891"></a><span>        </span><span class="hs-comment">-- report an error only when the variable in the kind is brought</span><span>
</span><a name="line-1892"></a><span>        </span><span class="hs-comment">-- into scope later in the telescope. Otherwise, we'll just quantify</span><span>
</span><a name="line-1893"></a><span>        </span><span class="hs-comment">-- over it in kindGeneralize, as we should.</span><span>
</span><a name="line-1894"></a><span>
</span><a name="line-1895"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680128531"><a href="#local-6989586621680128531"><span class="hs-identifier">errs</span></a></a><span> </span><a name="local-6989586621680128532"><a href="#local-6989586621680128532"><span class="hs-identifier">in_scope</span></a></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621680128533"><a href="#local-6989586621680128533"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680128534"><a href="#local-6989586621680128534"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128535"><a href="#local-6989586621680128535"><span class="hs-identifier">bad_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128532"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1897"></a><span>                      </span><a href="TyCoRep.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680128533"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1898"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621680128528"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128535"><span class="hs-identifier hs-var">bad_tvs</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680128531"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128532"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#extendVarSet"><span class="hs-identifier hs-var">extendVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128533"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128534"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1899"></a><span>
</span><a name="line-1900"></a><span class="hs-comment">-- | After inferring kinds of type variables, check to make sure that the</span><span>
</span><a name="line-1901"></a><span class="hs-comment">-- inferred kinds any of the type variables bound in a smaller scope.</span><span>
</span><a name="line-1902"></a><span class="hs-comment">-- This is a skolem escape check. See also Note [Bad telescopes].</span><span>
</span><a name="line-1903"></a><span class="hs-identifier">checkValidInferredKinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- ^ vars to check (zonked)</span><span>
</span><a name="line-1904"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span>    </span><span class="hs-comment">-- ^ vars out of scope</span><span>
</span><a name="line-1905"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>        </span><span class="hs-comment">-- ^ suffix to error message</span><span>
</span><a name="line-1906"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1907"></a><a name="checkValidInferredKinds"><a href="TcValidity.html#checkValidInferredKinds"><span class="hs-identifier">checkValidInferredKinds</span></a></a><span> </span><a name="local-6989586621680128538"><a href="#local-6989586621680128538"><span class="hs-identifier">orig_kvs</span></a></a><span> </span><a name="local-6989586621680128539"><a href="#local-6989586621680128539"><span class="hs-identifier">out_of_scope</span></a></a><span> </span><a name="local-6989586621680128540"><a href="#local-6989586621680128540"><span class="hs-identifier">extra</span></a></a><span>
</span><a name="line-1908"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680128543"><a href="#local-6989586621680128543"><span class="hs-identifier">bad_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128546"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680128545"><span class="hs-identifier hs-var">kv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1909"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680128545"><a href="#local-6989586621680128545"><span class="hs-identifier">kv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680128538"><span class="hs-identifier hs-var">orig_kvs</span></a><span>
</span><a name="line-1910"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128546"><a href="#local-6989586621680128546"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#lookupVarSet"><span class="hs-identifier hs-var">lookupVarSet</span></a><span> </span><a href="#local-6989586621680128539"><span class="hs-identifier hs-var">out_of_scope</span></a><span class="hs-special">)</span><span>
</span><a name="line-1911"></a><span>                                          </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypeList"><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680128545"><span class="hs-identifier hs-var">kv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1912"></a><span>             </span><a name="local-6989586621680128544"><a href="#local-6989586621680128544"><span class="hs-identifier">report</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyTyVarOcc"><span class="hs-identifier hs-var">tidyTyVarOcc</span></a><span> </span><a href="#local-6989586621680128542"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680128547"><a href="#local-6989586621680128547"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tidyTyVarOcc"><span class="hs-identifier hs-var">tidyTyVarOcc</span></a><span> </span><a href="#local-6989586621680128542"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a name="local-6989586621680128548"><a href="#local-6989586621680128548"><span class="hs-identifier">kv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1913"></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1914"></a><span>                 </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The kind of variable&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1915"></a><span>                 </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128548"><span class="hs-identifier hs-var">kv</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;, namely&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1916"></a><span>                 </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680128548"><span class="hs-identifier hs-var">kv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1917"></a><span>                 </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;depends on variable&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1918"></a><span>                 </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128547"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;from an inner scope&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1919"></a><span>                 </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Perhaps bind&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128548"><span class="hs-identifier hs-var">kv</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1920"></a><span>                 </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;sometime after binding&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1921"></a><span>                 </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128547"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1922"></a><span>                 </span><a href="#local-6989586621680128540"><span class="hs-identifier hs-var">extra</span></a><span>
</span><a name="line-1923"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680128544"><span class="hs-identifier hs-var">report</span></a><span> </span><a href="#local-6989586621680128543"><span class="hs-identifier hs-var">bad_pairs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1924"></a><span>
</span><a name="line-1925"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1926"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128541"><a href="#local-6989586621680128541"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyTyCoVarBndrs"><span class="hs-identifier hs-var">tidyTyCoVarBndrs</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621680128538"><span class="hs-identifier hs-var">orig_kvs</span></a><span>
</span><a name="line-1927"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680128542"><a href="#local-6989586621680128542"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyTyCoVarBndrs"><span class="hs-identifier hs-var">tidyTyCoVarBndrs</span></a><span> </span><a href="#local-6989586621680128541"><span class="hs-identifier hs-var">env1</span></a><span>         </span><span class="hs-special">(</span><a href="UniqSet.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a><span> </span><a href="#local-6989586621680128539"><span class="hs-identifier hs-var">out_of_scope</span></a><span class="hs-special">)</span><span>
</span><a name="line-1928"></a><span>      </span><span class="hs-comment">-- It's OK to use nonDetEltsUniqSet here because it's only used for</span><span>
</span><a name="line-1929"></a><span>      </span><span class="hs-comment">-- generating the error message</span><span>
</span><a name="line-1930"></a><span>
</span><a name="line-1931"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Auxiliary functions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1938"></a><span>
</span><a name="line-1939"></a><span class="hs-comment">-- Free variables of a type, retaining repetitions, and expanding synonyms</span><span>
</span><a name="line-1940"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1941"></a><a name="fvType"><a href="TcValidity.html#fvType"><span class="hs-identifier">fvType</span></a></a><span> </span><a name="local-6989586621680128549"><a href="#local-6989586621680128549"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128550"><a href="#local-6989586621680128550"><span class="hs-identifier">exp_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#tcView"><span class="hs-identifier hs-var">tcView</span></a><span> </span><a href="#local-6989586621680128549"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128550"><span class="hs-identifier hs-var">exp_ty</span></a><span>
</span><a name="line-1942"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621680128551"><a href="#local-6989586621680128551"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680128551"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">]</span><span>
</span><a name="line-1943"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128552"><a href="#local-6989586621680128552"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvTypes"><span class="hs-identifier hs-var">fvTypes</span></a><span> </span><a href="#local-6989586621680128552"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1944"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1945"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621680128553"><a href="#local-6989586621680128553"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621680128554"><a href="#local-6989586621680128554"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128553"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128554"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1946"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621680128555"><a href="#local-6989586621680128555"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621680128556"><a href="#local-6989586621680128556"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128555"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128556"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1947"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#TvBndr"><span class="hs-identifier hs-var">TvBndr</span></a><span> </span><a name="local-6989586621680128557"><a href="#local-6989586621680128557"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680128558"><a href="#local-6989586621680128558"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1948"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680128557"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-1949"></a><span>    </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621680128557"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128558"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1950"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621680128559"><a href="#local-6989586621680128559"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680128560"><a href="#local-6989586621680128560"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128559"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128560"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1951"></a><span class="hs-identifier">fvType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621680128561"><a href="#local-6989586621680128561"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128561"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1952"></a><span>
</span><a name="line-1953"></a><span class="hs-identifier">fvTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1954"></a><a name="fvTypes"><a href="TcValidity.html#fvTypes"><span class="hs-identifier">fvTypes</span></a></a><span> </span><a name="local-6989586621680128562"><a href="#local-6989586621680128562"><span class="hs-identifier">tys</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128562"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1955"></a><span>
</span><a name="line-1956"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1957"></a><a name="fvCo"><a href="TcValidity.html#fvCo"><span class="hs-identifier">fvCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128563"><a href="#local-6989586621680128563"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128563"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1958"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128564"><a href="#local-6989586621680128564"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128564"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1959"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621680128565"><a href="#local-6989586621680128565"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621680128566"><a href="#local-6989586621680128566"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128565"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128566"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1960"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621680128567"><a href="#local-6989586621680128567"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621680128568"><a href="#local-6989586621680128568"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621680128569"><a href="#local-6989586621680128569"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621680128567"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128569"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128568"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-1961"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128570"><a href="#local-6989586621680128570"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621680128571"><a href="#local-6989586621680128571"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128570"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128571"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1962"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621680128572"><a href="#local-6989586621680128572"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680128572"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>
</span><a name="line-1963"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128573"><a href="#local-6989586621680128573"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128573"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1964"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-6989586621680128574"><a href="#local-6989586621680128574"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128575"><a href="#local-6989586621680128575"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621680128576"><a href="#local-6989586621680128576"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvProv"><span class="hs-identifier hs-var">fvProv</span></a><span> </span><a href="#local-6989586621680128574"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128575"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvType"><span class="hs-identifier hs-var">fvType</span></a><span> </span><a href="#local-6989586621680128576"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1965"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621680128577"><a href="#local-6989586621680128577"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128577"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1966"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621680128578"><a href="#local-6989586621680128578"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621680128579"><a href="#local-6989586621680128579"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128578"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128579"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1967"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128580"><a href="#local-6989586621680128580"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128580"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1968"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128581"><a href="#local-6989586621680128581"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128581"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1969"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621680128582"><a href="#local-6989586621680128582"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621680128583"><a href="#local-6989586621680128583"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128582"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128583"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1970"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoherenceCo"><span class="hs-identifier hs-var">CoherenceCo</span></a><span> </span><a name="local-6989586621680128584"><a href="#local-6989586621680128584"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621680128585"><a href="#local-6989586621680128585"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128584"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128585"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1971"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a name="local-6989586621680128586"><a href="#local-6989586621680128586"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128586"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1972"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-6989586621680128587"><a href="#local-6989586621680128587"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128587"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1973"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128588"><a href="#local-6989586621680128588"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128588"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-1974"></a><span class="hs-identifier">fvCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><a name="local-6989586621680128589"><a href="#local-6989586621680128589"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;fvCo falls into a hole&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680128589"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-1975"></a><span>
</span><a name="line-1976"></a><span class="hs-identifier">fvProv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#UnivCoProvenance"><span class="hs-identifier hs-type">UnivCoProvenance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1977"></a><a name="fvProv"><a href="TcValidity.html#fvProv"><span class="hs-identifier">fvProv</span></a></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1978"></a><span class="hs-identifier">fvProv</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-6989586621680128590"><a href="#local-6989586621680128590"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128590"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1979"></a><span class="hs-identifier">fvProv</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-6989586621680128591"><a href="#local-6989586621680128591"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#fvCo"><span class="hs-identifier hs-var">fvCo</span></a><span> </span><a href="#local-6989586621680128591"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1980"></a><span class="hs-identifier">fvProv</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1981"></a><span>
</span><a name="line-1982"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1983"></a><span class="hs-comment">-- Size of a type: the number of variables and constructors</span><span>
</span><a name="line-1984"></a><a name="sizeType"><a href="TcValidity.html#sizeType"><span class="hs-identifier">sizeType</span></a></a><span> </span><a name="local-6989586621680128592"><a href="#local-6989586621680128592"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128593"><a href="#local-6989586621680128593"><span class="hs-identifier">exp_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#tcView"><span class="hs-identifier hs-var">tcView</span></a><span> </span><a href="#local-6989586621680128592"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128593"><span class="hs-identifier hs-var">exp_ty</span></a><span>
</span><a name="line-1985"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1986"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128594"><a href="#local-6989586621680128594"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><a href="#local-6989586621680128594"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1987"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1988"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621680128595"><a href="#local-6989586621680128595"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621680128596"><a href="#local-6989586621680128596"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128595"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128596"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1989"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621680128597"><a href="#local-6989586621680128597"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621680128598"><a href="#local-6989586621680128598"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128597"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128598"><span class="hs-identifier hs-var">res</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1990"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680128599"><a href="#local-6989586621680128599"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128599"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1991"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621680128600"><a href="#local-6989586621680128600"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128600"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1992"></a><span class="hs-identifier">sizeType</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1993"></a><span>
</span><a name="line-1994"></a><span class="hs-identifier">sizeTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1995"></a><a name="sizeTypes"><a href="TcValidity.html#sizeTypes"><span class="hs-identifier">sizeTypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#sum"><span class="hs-identifier hs-var">sum</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span>
</span><a name="line-1996"></a><span>
</span><a name="line-1997"></a><span class="hs-comment">-- Size of a predicate</span><span>
</span><a name="line-1998"></a><span class="hs-comment">--</span><span>
</span><a name="line-1999"></a><span class="hs-comment">-- We are considering whether class constraints terminate.</span><span>
</span><a name="line-2000"></a><span class="hs-comment">-- Equality constraints and constraints for the implicit</span><span>
</span><a name="line-2001"></a><span class="hs-comment">-- parameter class always terminate so it is safe to say &quot;size 0&quot;.</span><span>
</span><a name="line-2002"></a><span class="hs-comment">-- (Implicit parameter constraints always terminate because</span><span>
</span><a name="line-2003"></a><span class="hs-comment">-- there are no instances for them---they are only solved by</span><span>
</span><a name="line-2004"></a><span class="hs-comment">-- &quot;local instances&quot; in expressions).</span><span>
</span><a name="line-2005"></a><span class="hs-comment">-- See Trac #4200.</span><span>
</span><a name="line-2006"></a><span class="hs-identifier">sizePred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-2007"></a><a name="sizePred"><a href="TcValidity.html#sizePred"><span class="hs-identifier">sizePred</span></a></a><span> </span><a name="local-6989586621680128601"><a href="#local-6989586621680128601"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128602"><span class="hs-identifier hs-var">goClass</span></a><span> </span><a href="#local-6989586621680128601"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2008"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2009"></a><span>    </span><a name="local-6989586621680128602"><a href="#local-6989586621680128602"><span class="hs-identifier">goClass</span></a></a><span> </span><a name="local-6989586621680128604"><a href="#local-6989586621680128604"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680128603"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a><span> </span><a href="#local-6989586621680128604"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-2010"></a><span>
</span><a name="line-2011"></a><span>    </span><a name="local-6989586621680128603"><a href="#local-6989586621680128603"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Type.html#ClassPred"><span class="hs-identifier hs-var">ClassPred</span></a><span> </span><a name="local-6989586621680128605"><a href="#local-6989586621680128605"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680128606"><a href="#local-6989586621680128606"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2012"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TcValidity.html#isTerminatingClass"><span class="hs-identifier hs-var">isTerminatingClass</span></a><span> </span><a href="#local-6989586621680128605"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2013"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeTypes"><span class="hs-identifier hs-var">sizeTypes</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680128605"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128606"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2014"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Type.html#EqPred"><span class="hs-identifier hs-var">EqPred</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2015"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Type.html#IrredPred"><span class="hs-identifier hs-var">IrredPred</span></a><span> </span><a name="local-6989586621680128607"><a href="#local-6989586621680128607"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcValidity.html#sizeType"><span class="hs-identifier hs-var">sizeType</span></a><span> </span><a href="#local-6989586621680128607"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2016"></a><span>
</span><a name="line-2017"></a><span class="hs-comment">-- | When this says &quot;True&quot;, ignore this class constraint during</span><span>
</span><a name="line-2018"></a><span class="hs-comment">-- a termination check</span><span>
</span><a name="line-2019"></a><span class="hs-identifier">isTerminatingClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2020"></a><a name="isTerminatingClass"><a href="TcValidity.html#isTerminatingClass"><span class="hs-identifier">isTerminatingClass</span></a></a><span> </span><a name="local-6989586621680128608"><a href="#local-6989586621680128608"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-2021"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#isIPClass"><span class="hs-identifier hs-var">isIPClass</span></a><span> </span><a href="#local-6989586621680128608"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-2022"></a><span>    </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680128608"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#typeableClassKey"><span class="hs-identifier hs-var">typeableClassKey</span></a><span>
</span><a name="line-2023"></a><span>    </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680128608"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a><span>
</span><a name="line-2024"></a><span>    </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680128608"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqTyConKey"><span class="hs-identifier hs-var">eqTyConKey</span></a><span>
</span><a name="line-2025"></a><span>    </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680128608"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a><span>
</span><a name="line-2026"></a><span>
</span><a name="line-2027"></a><span class="hs-comment">-- | Tidy before printing a type</span><span>
</span><a name="line-2028"></a><span class="hs-identifier">ppr_tidy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2029"></a><a name="ppr_tidy"><a href="TcValidity.html#ppr_tidy"><span class="hs-identifier">ppr_tidy</span></a></a><span> </span><a name="local-6989586621680128609"><a href="#local-6989586621680128609"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680128610"><a href="#local-6989586621680128610"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#pprType"><span class="hs-identifier hs-var">pprType</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621680128609"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680128610"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2030"></a><span>
</span><a name="line-2031"></a><span class="hs-identifier">allDistinctTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2032"></a><span class="hs-comment">-- (allDistinctTyVars tvs tys) returns True if tys are</span><span>
</span><a name="line-2033"></a><span class="hs-comment">-- a) all tyvars</span><span>
</span><a name="line-2034"></a><span class="hs-comment">-- b) all distinct</span><span>
</span><a name="line-2035"></a><span class="hs-comment">-- c) disjoint from tvs</span><span>
</span><a name="line-2036"></a><a name="allDistinctTyVars"><a href="TcValidity.html#allDistinctTyVars"><span class="hs-identifier">allDistinctTyVars</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2037"></a><span class="hs-identifier">allDistinctTyVars</span><span> </span><a name="local-6989586621680128611"><a href="#local-6989586621680128611"><span class="hs-identifier">tkvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680128612"><a href="#local-6989586621680128612"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680128613"><a href="#local-6989586621680128613"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2038"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a><span> </span><a href="#local-6989586621680128612"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2039"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2040"></a><span>      </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680128614"><a href="#local-6989586621680128614"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680128614"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128611"><span class="hs-identifier hs-var">tkvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2041"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcValidity.html#allDistinctTyVars"><span class="hs-identifier hs-var">allDistinctTyVars</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680128611"><span class="hs-identifier hs-var">tkvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#extendVarSet"><span class="hs-identifier hs-var">extendVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680128614"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680128613"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2042"></a></pre></body></html>